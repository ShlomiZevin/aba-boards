<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>◊ú◊ï◊ó ◊û◊©◊ô◊û◊ï◊™</title>

    <!-- Prevent caching -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- Doing Theme -->
    <link rel="stylesheet" href="doing-theme-light.css">

    <style>
        /* Color Schema CSS Variables */
        /* Pastel palettes inspired by the Doing logo - suitable for autistic children */
        :root {
            --primary-start: #A8D5E5;
            --primary-end: #89C4B8;
            --primary-color: #5BA4B5;
            --text-on-primary: #2D4A53;
            /* Completed: lighter/brighter version - "lit up" effect */
            --card-completed-start: #D4EEF5;
            --card-completed-end: #C0E8E0;
            --card-completed-text: #1A3A42;
        }

        /* Teal & Mint - Calming (default) - inspired by logo blue/teal */
        body.schema-purple {
            --primary-start: #A8D5E5;
            --primary-end: #89C4B8;
            --primary-color: #5BA4B5;
            --text-on-primary: #2D4A53;
            /* Completed: lighter teal/mint with cream tint - glowing effect */
            --card-completed-start: #D4EEF5;
            --card-completed-end: #C0E8E0;
            --card-completed-text: #1A3A42;
        }

        /* Coral & Peach - Warm (inspired by logo coral/orange) */
        body.schema-pink {
            --primary-start: #F5C6AA;
            --primary-end: #E8A07E;
            --primary-color: #D4896A;
            --text-on-primary: #4A3228;
            /* Completed: lighter peach/cream - glowing warm effect */
            --card-completed-start: #FDE8D8;
            --card-completed-end: #F8D8C4;
            --card-completed-text: #3A2218;
        }

        /* Sky & Lavender - Dreamy (soft blue variant) */
        body.schema-blue {
            --primary-start: #B8D4E8;
            --primary-end: #C5B8E8;
            --primary-color: #7BA3C4;
            --text-on-primary: #2D3A4A;
            /* Completed: lighter sky/lavender - ethereal glow */
            --card-completed-start: #E0EEFA;
            --card-completed-end: #E8E0F8;
            --card-completed-text: #1D2A3A;
        }

        /* Soft Navy & Sage - Dark Mode (muted, low-stimulation) */
        body.schema-dark {
            --primary-start: #3D5A6C;
            --primary-end: #2C4A52;
            --primary-color: #89B5A5;
            --text-on-primary: #E8F0ED;
            /* Completed: lighter navy/slate - subtle glow, same family */
            --card-completed-start: #5A7A8C;
            --card-completed-end: #4A6A7A;
            --card-completed-text: #F0F8F5;
        }

        /* Override doing-theme styles with color schema */
        body.doing-theme.schema-purple,
        body.doing-theme.schema-pink,
        body.doing-theme.schema-blue,
        body.doing-theme.schema-dark {
            background: linear-gradient(135deg, var(--primary-start) 0%, var(--primary-end) 100%) !important;
        }

        body.doing-theme.schema-purple .task-card.completed,
        body.doing-theme.schema-pink .task-card.completed,
        body.doing-theme.schema-blue .task-card.completed,
        body.doing-theme.schema-dark .task-card.completed {
            background: linear-gradient(135deg, var(--card-completed-start) 0%, var(--card-completed-end) 100%) !important;
            color: var(--card-completed-text, var(--text-on-primary)) !important;
        }

        body.doing-theme.schema-purple .progress-bar,
        body.doing-theme.schema-pink .progress-bar,
        body.doing-theme.schema-blue .progress-bar,
        body.doing-theme.schema-dark .progress-bar {
            background: linear-gradient(90deg, var(--primary-start), var(--primary-end)) !important;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, var(--primary-start) 0%, var(--primary-end) 100%);
            min-height: 100vh;
            padding: 20px;
            direction: rtl;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 25px;
            padding: 0;
            background: none !important;
            border: none !important;
        }

        .header h1 {
            color: white;
            text-shadow: 2px 2px 8px rgba(0,0,0,0.3);
            margin: 0;
        }

        /* Section Headers - all sizes */
        .section-header {
            text-align: center;
            margin-bottom: 18px;
        }

        .section-header h2 {
            margin: 0;
            font-weight: 700;
            color: white;
            text-shadow: 2px 2px 6px rgba(0,0,0,0.35);
            display: inline-block;
            padding: 8px 20px;
            background: rgba(255, 255, 255, 0.12);
            border-radius: 30px;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .section-header.size-large h2 {
            font-size: 2em;
            padding: 10px 28px;
        }

        .section-header.size-medium h2 {
            font-size: 1.65em;
            padding: 8px 22px;
        }

        .section-header.size-small h2 {
            font-size: 1.4em;
            padding: 7px 18px;
        }

        .section-header.size-large {
            margin-top: 30px;
        }

        .section-header.size-medium {
            margin-top: 30px;
        }

        .section-header.size-small {
            margin-top: 22px;
        }

        @media (max-width: 600px) {
            .header h1 {
                font-size: 1.8em;
            }

            .section-header h2 {
                padding: 6px 14px;
            }

            .section-header.size-large h2 {
                font-size: 1.5em;
                padding: 8px 20px;
            }

            .section-header.size-medium h2 {
                font-size: 1.3em;
                padding: 7px 16px;
            }

            .section-header.size-small h2 {
                font-size: 1.15em;
                padding: 6px 14px;
            }

            .section-header.size-large {
                margin-top: 24px;
            }

            .section-header.size-medium {
                margin-top: 24px;
            }

            .section-header.size-small {
                margin-top: 18px;
            }
        }

        .piggy-bank-section {
            background: linear-gradient(145deg, #FDF8E8 0%, #F8F0D8 50%, #F5E6B8 100%);
            padding: 30px 25px;
            border-radius: 25px;
            margin-bottom: 25px;
            box-shadow:
                0 10px 40px rgba(232, 200, 109, 0.25),
                0 2px 10px rgba(0,0,0,0.08),
                inset 0 -3px 0 rgba(232, 200, 109, 0.25);
            border: 3px solid rgba(232, 200, 109, 0.5);
            position: relative;
            overflow: hidden;
            text-align: center;
        }

        .piggy-bank-section::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 60%);
            pointer-events: none;
        }

        .piggy-bank-icon {
            width: 100px;
            height: 100px;
            margin: 0 auto 15px;
            animation: float 3s ease-in-out infinite;
            border-radius: 50%;
            overflow: hidden;
            box-shadow:
                0 8px 25px rgba(0,0,0,0.15),
                0 0 0 4px rgba(255,255,255,0.8),
                0 0 0 8px rgba(232, 200, 109, 0.35);
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            position: relative;
            z-index: 1;
        }

        .piggy-bank-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }

        .money-counter {
            font-size: 2.8em;
            font-weight: 800;
            color: #D4896A;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.15));
            margin: 8px 0;
            position: relative;
            z-index: 1;
        }

        .money-label {
            font-size: 1.1em;
            color: #6b5b4f;
            font-weight: 600;
            letter-spacing: 0.5px;
            position: relative;
            z-index: 1;
        }

        .bank-extra-info {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px dashed rgba(232, 200, 109, 0.4);
            position: relative;
            z-index: 1;
            display: flex;
            gap: 20px;
            align-items: center;
            justify-content: center;
        }

        .daily-potential {
            font-size: 0.9em;
            color: #7a6a5e;
            text-align: center;
        }

        .daily-potential .potential-label {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .daily-potential .potential-value {
            font-weight: 700;
            color: #4CAF50;
        }

        .next-goal-preview {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 15px;
        }

        .next-goal-preview.hidden {
            display: none;
        }

        .next-goal-mini {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(145deg, #ffffff 0%, #f0f0f0 100%);
            border: 2px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3em;
            flex-shrink: 0;
        }

        .next-goal-mini img {
            width: 30px;
            height: 30px;
            object-fit: contain;
        }

        .next-goal-info {
            text-align: right;
        }

        .next-goal-info .goal-label {
            font-size: 0.8em;
            color: #888;
            margin-bottom: 2px;
        }

        .next-goal-info .goal-name {
            font-weight: 700;
            color: #5a4a3e;
            font-size: 0.95em;
        }

        .next-goal-info .goal-remaining {
            font-size: 0.85em;
            color: #E8A86D;
            font-weight: 600;
            margin-top: 2px;
        }

        @media (max-width: 600px) {
            .bank-extra-info {
                margin-top: 12px;
                padding-top: 12px;
                flex-direction: column;
                gap: 12px;
            }

            .daily-potential {
                font-size: 0.85em;
            }

            .next-goal-preview {
                padding: 10px;
                gap: 10px;
                width: 100%;
                justify-content: center;
            }

            .next-goal-mini {
                width: 40px;
                height: 40px;
                font-size: 1.1em;
            }

            .next-goal-mini img {
                width: 25px;
                height: 25px;
            }

            .next-goal-info .goal-name {
                font-size: 0.85em;
            }

            .next-goal-info .goal-remaining {
                font-size: 0.8em;
            }
        }

        .coins-animation {
            position: fixed;
            font-size: 3em;
            animation: coinFall 2s ease-out;
            pointer-events: none;
            z-index: 1001;
        }

        @keyframes coinFall {
            0% {
                transform: translateY(-100px) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(80vh) rotate(720deg);
                opacity: 0;
            }
        }

        h1 {
            color: #2D4A53;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .progress-container {
            margin-top: 20px;
            background: linear-gradient(180deg, #e8e8e8 0%, #f5f5f5 100%);
            border-radius: 20px;
            height: 36px;
            overflow: hidden;
            position: relative;
            box-shadow:
                inset 0 2px 6px rgba(0,0,0,0.15),
                0 2px 4px rgba(255,255,255,0.8);
            border: 2px solid rgba(255,255,255,0.5);
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(180deg,
                color-mix(in srgb, var(--primary-start) 100%, white 20%) 0%,
                var(--primary-start) 50%,
                var(--primary-end) 100%);
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-on-primary);
            font-weight: 700;
            font-size: 0.95em;
            text-shadow: 0 1px 2px rgba(255,255,255,0.5);
            border-radius: 18px;
            position: relative;
            box-shadow:
                0 2px 10px rgba(0, 0, 0, 0.15),
                inset 0 1px 0 rgba(255,255,255,0.3);
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 10px;
            right: 10px;
            height: 8px;
            background: linear-gradient(180deg, rgba(255,255,255,0.4) 0%, transparent 100%);
            border-radius: 10px;
        }

        /* Progress section wrapper */
        .progress-section {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 25px 30px;
            border-radius: 20px;
            margin-bottom: 25px;
            box-shadow:
                0 8px 32px rgba(0,0,0,0.1),
                inset 0 1px 0 rgba(255,255,255,0.6);
            border: 1px solid rgba(255,255,255,0.5);
        }

        .progress-title {
            font-size: 1.3em;
            font-weight: 700;
            color: #2D4A53;
            text-align: center;
            margin-bottom: 15px;
            letter-spacing: 0.5px;
        }

        .progress-section .progress-container {
            margin-top: 0;
        }

        /* Glowing progress bar when all tasks complete */
        .progress-section.all-done .progress-container {
            animation: containerGlow 2s ease-in-out infinite;
        }

        .progress-section.all-done .progress-bar {
            animation: barGlow 2s ease-in-out infinite;
            position: relative;
        }

        @keyframes containerGlow {
            0%, 100% {
                box-shadow:
                    0 4px 15px rgba(232, 200, 109, 0.3),
                    0 0 20px rgba(232, 200, 109, 0.2),
                    inset 0 2px 4px rgba(255,255,255,0.8);
            }
            50% {
                box-shadow:
                    0 4px 25px rgba(232, 200, 109, 0.5),
                    0 0 35px rgba(232, 200, 109, 0.4),
                    inset 0 2px 4px rgba(255,255,255,0.8);
            }
        }

        @keyframes barGlow {
            0%, 100% {
                box-shadow:
                    0 2px 10px rgba(0, 0, 0, 0.15),
                    0 0 15px rgba(232, 200, 109, 0.4),
                    inset 0 1px 0 rgba(255,255,255,0.3);
            }
            50% {
                box-shadow:
                    0 2px 15px rgba(0, 0, 0, 0.15),
                    0 0 25px rgba(232, 200, 109, 0.6),
                    inset 0 1px 0 rgba(255,255,255,0.3);
            }
        }

        /* Golden shimmer sweep effect */
        .progress-section.all-done .progress-bar::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 50%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 223, 150, 0.4),
                rgba(255, 240, 180, 0.6),
                rgba(255, 223, 150, 0.4),
                transparent
            );
            animation: shimmerSweep 2.5s ease-in-out infinite;
            border-radius: 18px;
        }

        @keyframes shimmerSweep {
            0% {
                left: -50%;
            }
            100% {
                left: 100%;
            }
        }

        /* Sparkle elements container - overlays the progress bar */
        .progress-sparkles {
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 60px;
            transform: translateY(-50%);
            pointer-events: none;
            overflow: visible;
            z-index: 5;
        }

        .sparkle {
            position: absolute;
            font-size: 1.2em;
            opacity: 0;
            filter: drop-shadow(0 0 3px rgba(255, 215, 100, 0.8));
        }

        .progress-section.all-done .sparkle {
            animation: sparkleGlimmer 2s ease-in-out infinite;
        }

        @keyframes sparkleGlimmer {
            0%, 100% {
                opacity: 0.3;
                transform: scale(0.8) rotate(0deg);
            }
            25% {
                opacity: 1;
                transform: scale(1.1) rotate(10deg);
            }
            50% {
                opacity: 0.6;
                transform: scale(0.9) rotate(-5deg);
            }
            75% {
                opacity: 1;
                transform: scale(1.2) rotate(5deg);
            }
        }

        /* Floating golden feather */
        .golden-feather {
            position: absolute;
            font-size: 1.8em;
            opacity: 0;
            filter: drop-shadow(0 2px 6px rgba(218, 165, 32, 0.6))
                    drop-shadow(0 0 10px rgba(255, 215, 100, 0.4));
            z-index: 10;
        }

        .progress-section.all-done .golden-feather {
            animation: featherFloat 4s ease-in-out infinite;
        }

        @keyframes featherFloat {
            0%, 100% {
                opacity: 0.7;
                transform: translateY(0) rotate(-10deg) scale(1);
            }
            25% {
                opacity: 1;
                transform: translateY(-5px) rotate(5deg) scale(1.1);
            }
            50% {
                opacity: 0.9;
                transform: translateY(-8px) rotate(-5deg) scale(1.05);
            }
            75% {
                opacity: 1;
                transform: translateY(-3px) rotate(8deg) scale(1.1);
            }
        }

        .tasks-grid, .bonus-tasks-grid, .calm-down-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .task-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .task-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .task-card.completed {
            background: linear-gradient(135deg, var(--card-completed-start) 0%, var(--card-completed-end) 100%);
            color: var(--card-completed-text, var(--text-on-primary));
        }

        /* Bonus task styles */
        .bonus-task-card {
            background: white;
            border: 3px solid #E8C86D;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(232, 200, 109, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            color: #2D4A53;
        }

        .bonus-task-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 30px rgba(232, 200, 109, 0.5);
        }

        .bonus-task-card.completed {
            background: linear-gradient(135deg, #F5E6B8 0%, #E8D68D 100%);
            color: #4A3F28;
            border-color: #D4B85A;
        }

        .bonus-reward-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #E8C86D;
            color: #4A3F28;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(232, 200, 109, 0.4);
        }

        .bonus-task-card.completed .bonus-reward-badge {
            background: #D4B85A;
        }

        /* Queued bonus reward - task completed but money waiting for regular tasks */
        .bonus-task-card.reward-queued {
            background: linear-gradient(135deg, #E8E0C8 0%, #D8D0B5 100%);
            border-color: #C4B890;
        }

        .bonus-task-card.reward-queued .bonus-reward-badge {
            background: linear-gradient(135deg, #9E9E9E 0%, #757575 100%);
            color: white;
            animation: pulse-queue 2s ease-in-out infinite;
        }

        @keyframes pulse-queue {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Calm down task styles */
        .calm-down-card {
            background: linear-gradient(135deg, #C8E6E4 0%, #E8D5DC 100%);
            border: 3px solid #A8D5E5;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(168, 213, 229, 0.4);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            color: #2D4A53;
        }

        .calm-down-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 30px rgba(168, 213, 229, 0.6);
        }

        /* Goal / Reward card styles */
        .goals-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin: 20px 0;
            justify-items: center;
        }

        .goal-wrapper {
            display: flex;
            justify-content: center;
        }

        .goal-card {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            background: linear-gradient(145deg, #ffffff 0%, #f0f0f0 100%);
            border: 4px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all 0.4s ease;
            box-shadow:
                0 8px 25px rgba(0,0,0,0.1),
                inset 0 -3px 10px rgba(0,0,0,0.05);
            overflow: visible;
        }

        .goal-card .goal-glow {
            position: absolute;
            inset: -5px;
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .goal-card .goal-icon {
            font-size: 2.2em;
            margin-bottom: 5px;
            filter: grayscale(50%);
            transition: filter 0.4s ease;
        }

        .goal-card .goal-icon img {
            width: 50px;
            height: 50px;
            object-fit: contain;
            filter: grayscale(50%);
            transition: filter 0.4s ease;
        }

        .goal-card .goal-title {
            font-size: 0.85em;
            font-weight: 700;
            color: #666;
            text-align: center;
            padding: 0 10px;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .goal-card .goal-points {
            font-size: 0.75em;
            color: #999;
            margin-top: 3px;
        }

        .goal-card .goal-achieved-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transform: scale(0);
            transition: all 0.4s ease;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.4);
            color: white;
            font-size: 14px;
        }

        /* Achieved state */
        .goal-card.achieved {
            background: linear-gradient(145deg, #fff9e6 0%, #ffeeba 100%);
            border-color: #ffd700;
            box-shadow:
                0 10px 35px rgba(255, 215, 0, 0.4),
                0 0 20px rgba(255, 215, 0, 0.3),
                inset 0 -3px 10px rgba(255, 200, 0, 0.2);
            animation: goalPulse 2s ease-in-out infinite;
        }

        .goal-card.achieved .goal-glow {
            background: radial-gradient(circle, rgba(255,215,0,0.4) 0%, transparent 70%);
            opacity: 1;
            animation: goalGlowPulse 2s ease-in-out infinite;
        }

        .goal-card.achieved .goal-icon {
            filter: grayscale(0%);
        }

        .goal-card.achieved .goal-icon img {
            filter: grayscale(0%);
        }

        .goal-card.achieved .goal-title {
            color: #856404;
        }

        .goal-card.achieved .goal-points {
            color: #9a7d0a;
        }

        .goal-card.achieved .goal-achieved-badge {
            opacity: 1;
            transform: scale(1);
        }

        @keyframes goalPulse {
            0%, 100% { box-shadow: 0 10px 35px rgba(255, 215, 0, 0.4), 0 0 20px rgba(255, 215, 0, 0.3); }
            50% { box-shadow: 0 10px 40px rgba(255, 215, 0, 0.6), 0 0 30px rgba(255, 215, 0, 0.5); }
        }

        @keyframes goalGlowPulse {
            0%, 100% { opacity: 0.7; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.05); }
        }

        @media (max-width: 600px) {
            .goals-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 15px;
            }

            .goal-card {
                width: 100px;
                height: 100px;
            }

            .goal-card .goal-icon {
                font-size: 1.6em;
                margin-bottom: 3px;
            }

            .goal-card .goal-icon img {
                width: 35px;
                height: 35px;
            }

            .goal-card .goal-title {
                font-size: 0.7em;
                max-width: 85px;
            }

            .goal-card .goal-points {
                font-size: 0.6em;
            }

            .goal-card .goal-achieved-badge {
                width: 22px;
                height: 22px;
                font-size: 11px;
                top: -3px;
                right: -3px;
            }
        }

        /* Dino container - fixed position, transparent */
        .dino-container {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 200px;
            height: 260px;
            z-index: 1000;
            overflow: visible;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: transparent;
            touch-action: none;
        }

        .dino-container.dragging {
            transition: none;
            cursor: grabbing;
        }

        .dino-drag-handle {
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 20px;
            background: rgba(255, 255, 255, 0.85);
            border-radius: 10px;
            cursor: grab;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 10;
        }

        .dino-drag-handle::before {
            content: '‚ãÆ‚ãÆ';
            font-size: 12px;
            color: #666;
            letter-spacing: 2px;
        }

        .dino-drag-handle:hover {
            background: rgba(255, 255, 255, 1);
        }

        .dino-container.dragging .dino-drag-handle {
            cursor: grabbing;
        }

        .dino-container iframe {
            width: 100%;
            height: 100%;
            border: none;
            pointer-events: auto;
        }

        .dino-container.minimized {
            width: 65px;
            height: 65px;
            border-radius: 50%;
            cursor: grab;
            animation: dinoFloat 3s ease-in-out infinite;
            background: linear-gradient(135deg, #a8e6cf 0%, #88d8b0 100%);
            box-shadow: 0 4px 15px rgba(0,0,0,0.25);
        }

        .dino-container.minimized.dragging {
            cursor: grabbing;
            animation: none;
        }

        .dino-container.minimized:hover {
            transform: scale(1.15);
            animation: none;
        }

        .dino-container.minimized .dino-drag-handle {
            display: none;
        }

        @keyframes dinoFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-6px); }
        }

        .dino-container.minimized iframe {
            display: none;
        }

        .dino-toggle {
            display: none;
            width: 100%;
            height: 100%;
            background: transparent;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            border-radius: 50%;
        }

        .dino-container.minimized .dino-toggle {
            display: flex;
        }

        /* Mobile: dino on bottom right - bigger size */
        @media (max-width: 600px) {
            .dino-container {
                width: 180px;
                height: 230px;
            }

            .dino-container.minimized {
                width: 60px;
                height: 60px;
            }

            .dino-toggle {
                font-size: 32px;
            }

            .dino-drag-handle {
                width: 44px;
                height: 18px;
            }
        }

        /* Very small screens - still decent size */
        @media (max-width: 400px) {
            .dino-container {
                width: 160px;
                height: 200px;
            }

            .dino-container.minimized {
                width: 55px;
                height: 55px;
            }

            .dino-toggle {
                font-size: 28px;
            }

            .dino-drag-handle {
                width: 40px;
                height: 16px;
            }
        }

        .task-icon {
            font-size: 3em;
            margin-bottom: 15px;
            text-align: center;
        }

        .task-title {
            font-size: 1.3em;
            font-weight: bold;
            text-align: center;
            margin-bottom: 10px;
        }

        .checkmark {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 40px;
            height: 40px;
            background: #4CAF50;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5em;
            animation: checkPop 0.5s ease;
        }

        .task-card.completed .checkmark {
            display: flex;
        }

        .bonus-task-card.completed .checkmark {
            display: flex;
        }

        @keyframes checkPop {
            0% { transform: scale(0) rotate(0deg); }
            50% { transform: scale(1.2) rotate(180deg); }
            100% { transform: scale(1) rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
        }

        .task-card.started {
            border: 3px solid #E8A07E;
            box-shadow: 0 0 20px rgba(232, 160, 126, 0.4);
        }

        .bonus-task-card.started {
            border: 3px solid #E8A07E;
            box-shadow: 0 0 20px rgba(232, 160, 126, 0.4);
        }

        /* Testimony indicators */
        .testimony-badge {
            position: absolute;
            top: 10px;
            left: 60px;
            font-size: 1.2em;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .testimony-indicator {
            position: absolute;
            bottom: 10px;
            right: 10px;
            font-size: 1.5em;
            background: rgba(137, 196, 184, 0.3);
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            animation: pulse 2s ease-in-out infinite;
        }

        .testimony-indicator:hover {
            background: rgba(137, 196, 184, 0.5);
            transform: scale(1.1);
        }

        /* Celebration animation */
        .celebration {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #f0f;
            animation: confettiFall 3s linear;
        }

        @keyframes confettiFall {
            to {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        .star {
            position: absolute;
            font-size: 2em;
            animation: starBurst 1s ease-out;
            pointer-events: none;
        }

        @keyframes starBurst {
            0% {
                transform: scale(0) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: scale(3) rotate(360deg);
                opacity: 0;
            }
        }

        .encouragement {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(145deg, #fff9e6 0%, #fff3cd 100%);
            padding: 30px 40px;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2), inset 0 0 0 3px #ffc107;
            font-size: 1.5em;
            font-weight: bold;
            color: #856404;
            text-align: center;
            direction: rtl;
            animation: encouragePop 2.5s ease;
            pointer-events: none;
            z-index: 999;
            display: none;
        }

        @keyframes encouragePop {
            0%, 100% { opacity: 0; transform: translate(-50%, -50%) scale(0); }
            8%, 85% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            92% { opacity: 0.5; transform: translate(-50%, -50%) scale(0.95); }
        }

        .reset-info {
            text-align: center;
            color: white;
            font-size: 0.9em;
            margin-top: 20px;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
        }

        .testimony-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .testimony-modal.active {
            display: flex;
        }

        .testimony-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 90%;
            text-align: center;
            direction: rtl;
        }

        .testimony-content h2 {
            color: #2D4A53;
            margin-bottom: 20px;
            font-size: 1.4em;
            font-weight: 700;
        }

        .testimony-content textarea {
            width: 100%;
            padding: 14px;
            border: 2px solid #ddd;
            border-radius: 12px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
            margin-bottom: 20px;
            direction: rtl;
            text-align: right;
            box-sizing: border-box;
        }

        .testimony-content textarea:focus {
            outline: none;
            border-color: #5BA4B5;
        }

        .testimony-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .testimony-buttons button {
            padding: 12px 28px;
            border: none;
            border-radius: 25px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
        }

        .testimony-buttons .submit-btn {
            background: var(--primary-color, #5BA4B5);
            color: white;
        }

        .testimony-buttons .cancel-btn {
            background: #e8e8e8;
            color: #555;
        }

        @media (max-width: 600px) {
            .tasks-grid {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 1.8em;
            }

            .testimony-content {
                padding: 24px 20px;
                width: 92%;
                max-width: none;
            }

            .testimony-content h2 {
                font-size: 1.2em;
                margin-bottom: 16px;
            }

            .testimony-content textarea {
                min-height: 80px;
                font-size: 15px;
                padding: 12px;
            }

            .testimony-buttons {
                flex-direction: column;
                gap: 8px;
            }

            .testimony-buttons button {
                width: 100%;
                padding: 14px;
            }

            .encouragement {
                padding: 24px 28px;
                font-size: 1.3em;
            }
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.5em;
            color: white;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
        }

        .error-message {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: #4A3228;
            background: rgba(232, 160, 126, 0.4);
            border-radius: 15px;
            margin: 20px;
            border: 2px solid rgba(232, 160, 126, 0.6);
        }
    </style>
</head>
<body class="doing-theme">
    <!-- Loading State -->
    <div id="loadingState" class="loading">◊ò◊ï◊¢◊ü...</div>

    <!-- Kid/Parent Page -->
    <div id="kidPage" class="container hidden">
        <!-- Dynamic board content will be rendered here -->
        <div id="boardContent"></div>

        <div class="reset-info">
            ◊î◊ú◊ï◊ó ◊û◊™◊ê◊§◊° ◊õ◊ú ◊ô◊ï◊ù ◊ë◊ó◊¶◊ï◊™
        </div>
    </div>

    <div class="celebration" id="celebration"></div>
    <div class="encouragement" id="encouragement"></div>

    <!-- Dino Avatar -->
    <div class="dino-container hidden" id="dinoContainer">
        <div class="dino-drag-handle" id="dinoDragHandle"></div>
        <div class="dino-toggle" onclick="toggleDino()">ü¶ï</div>
        <iframe id="dinoFrame" src="./dino.html" allow="microphone"></iframe>
    </div>

    <!-- Calm Down Activity Modal -->
    <div class="testimony-modal" id="calmDownModal">
        <div class="testimony-content" style="max-width: 90vw; max-height: 90vh; width: 100%; height: 80vh; padding: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 id="calmDownTitle">◊§◊¢◊ô◊ú◊ï◊™ ◊î◊®◊í◊¢◊î</h2>
                <button class="submit-btn" onclick="taskBoard.closeCalmDownActivity()" style="padding: 8px 20px;">◊°◊í◊ï◊®</button>
            </div>
            <iframe id="calmDownFrame" style="width: 100%; height: calc(100% - 100px); border: 2px solid #5BA4B5; border-radius: 15px;"></iframe>
            <div id="calmDownFallback" style="display: none; text-align: center; padding: 10px; margin-top: 10px;">
                <a id="calmDownFallbackLink" href="#" target="_blank" style="color: #5BA4B5; text-decoration: none; font-size: 1.1em; display: inline-flex; align-items: center; gap: 8px;">
                    ◊ê◊ù ◊î◊°◊®◊ò◊ï◊ü ◊ú◊ê ◊†◊§◊™◊ó, ◊ú◊ó◊• ◊õ◊ê◊ü ◊ú◊§◊™◊ô◊ó◊î ◊ë◊ô◊ï◊ò◊ô◊ï◊ë
                </a>
            </div>
        </div>
    </div>

    <!-- Testimony Modal -->
    <div class="testimony-modal" id="testimonyModal">
        <div class="testimony-content">
            <h2 id="testimonyTitle">◊°◊§◊® ◊ú◊†◊ï ◊û◊î ◊ß◊®◊î</h2>
            <textarea id="testimonyInput" placeholder="◊ê◊ô◊ö ◊î◊©◊ú◊û◊™ ◊ê◊™ ◊î◊û◊©◊ô◊û◊î?"></textarea>
            <div class="testimony-buttons">
                <button class="submit-btn" onclick="taskBoard.submitTestimony()">◊©◊ú◊ó</button>
                <button class="cancel-btn" onclick="taskBoard.cancelTestimony()">◊ë◊ô◊ò◊ï◊ú</button>
            </div>
        </div>
    </div>

    <!-- Testimony Reader Modal -->
    <div class="testimony-modal" id="testimonyReaderModal">
        <div class="testimony-content">
            <h2 id="testimonyReaderTitle">◊î◊¢◊ì◊ï◊™ ◊©◊ú◊ö</h2>
            <div id="testimonyReaderText" style="padding: 20px; background: #f5f5f5; border-radius: 10px; font-size: 1.1em; line-height: 1.6; min-height: 80px; text-align: right; white-space: pre-wrap;"></div>
            <div class="testimony-buttons" style="margin-top: 20px;">
                <button class="submit-btn" onclick="taskBoard.closeTestimonyReader()">◊°◊í◊ï◊®</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDHE7FKHJ92rXXfz_3hLX8e9s8lC9g9g9o",
            authDomain: "aba-ai-d74f5.firebaseapp.com",
            projectId: "aba-ai-d74f5",
            storageBucket: "aba-ai-d74f5.firebasestorage.app",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef123456"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const encouragementMessages = [
            '◊õ◊ú ◊î◊õ◊ë◊ï◊ì!',
            '◊ê◊ú◊ï◊£ ◊ê◊ú◊ï◊§◊ô◊ù!',
            '◊û◊¶◊ï◊ô◊ü!',
            '◊¢◊ë◊ï◊ì◊î ◊û◊¢◊ï◊ú◊î!',
            '◊í◊ê◊î ◊ë◊ö!',
            '◊î◊û◊©◊ö ◊õ◊ö!',
            '◊§◊©◊ï◊ò ◊û◊ì◊î◊ô◊ù!'
        ];

        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const kidId = urlParams.get('kid');
        const isParent = urlParams.get('mode') === 'parent';

        // Route to kid/parent page
        if (kidId) {
            showKidPage(kidId, isParent);
        } else {
            document.getElementById('loadingState').innerHTML = '<div class="error-message">◊ú◊ê ◊¶◊ï◊ô◊ü ◊û◊ñ◊î◊î ◊ô◊ú◊ì ◊ë◊õ◊™◊ï◊ë◊™</div>';
        }

        // TaskBoard class - only handles new boardLayout format
        class TaskBoard {
            constructor(kidId, kidData, isParentMode) {
                this.kidId = kidId;
                this.kidData = kidData;
                this.isParentMode = isParentMode;

                // Get current day of week (0 = Sunday, 6 = Saturday)
                this.currentDay = new Date().getDay();

                // Board layout (new format only)
                this.boardLayout = kidData.boardLayout?.items || [];

                this.completedTasks = new Set();
                this.completedBonusTasks = new Set();
                this.bonusRewardsEarned = {};
                this.queuedBonusRewards = {}; // For 'after-regular' bonus tasks - money queued until all regular tasks done
                this.todayRewardGiven = false;
                this.isCelebrating = false;

                // Testimony tracking
                this.testimonies = {};
                this.pendingTestimonyTaskId = null;
                this.pendingTestimonyIsBonus = false;

                // Time tracking
                this.startedTasks = new Set();
                this.taskStartTimes = {};
                this.taskDurations = {};

                // Coin style configuration
                this.coinStyle = kidData.coinStyle || 'dollar';
                this.coinImageName = kidData.coinImageName || '';

                this.init();
            }

            getCoinSymbol() {
                switch (this.coinStyle) {
                    case 'shekel':
                        return '‚Ç™';
                    case 'custom':
                        return '';
                    case 'dollar':
                    default:
                        return '$';
                }
            }

            getCoinImageSrc() {
                if (this.coinImageName.startsWith('data:')) {
                    return this.coinImageName;
                } else {
                    const timestamp = new Date().getTime();
                    return `${this.coinImageName}?t=${timestamp}`;
                }
            }

            formatMoney(amount) {
                const symbol = this.getCoinSymbol();
                if (this.coinStyle === 'custom') {
                    const coinSrc = this.getCoinImageSrc();
                    return `<img src="${coinSrc}" style="width: 20px; height: 20px; vertical-align: middle; margin: 0 3px;" /> ${amount.toFixed(2)}`;
                }
                return `${symbol}${amount.toFixed(2)}`;
            }

            formatMoneySimple(amount) {
                const symbol = this.getCoinSymbol();
                if (this.coinStyle === 'custom') {
                    return amount.toFixed(2);
                }
                return `${symbol}${amount.toFixed(2)}`;
            }

            formatDuration(seconds) {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const secs = seconds % 60;

                if (hours > 0) {
                    return `${hours}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
                } else if (minutes > 0) {
                    return `${minutes}:${String(secs).padStart(2, '0')}`;
                } else {
                    return `${secs}s`;
                }
            }

            getElapsedTime(taskId) {
                if (!this.taskStartTimes[taskId]) return 0;
                return Math.floor((Date.now() - this.taskStartTimes[taskId]) / 1000);
            }

            async init() {
                await this.checkDailyReset();
                await this.loadState();
                this.render();
                this.updateProgress(false); // false = don't trigger celebration on initial load
                this.updateMoneyDisplay();
            }

            async checkDailyReset() {
                const today = new Date().toDateString();

                if (this.kidData.lastResetDate !== today) {
                    await db.collection('kids').doc(this.kidId).update({
                        completedTasks: [],
                        completedBonusTasks: [],
                        bonusRewardsEarned: {},
                        queuedBonusRewards: {},
                        todayRewardGiven: false,
                        testimonies: {},
                        startedTasks: [],
                        taskStartTimes: {},
                        taskDurations: {},
                        lastResetDate: today
                    });
                    this.completedTasks.clear();
                    this.completedBonusTasks.clear();
                    this.bonusRewardsEarned = {};
                    this.queuedBonusRewards = {};
                    this.todayRewardGiven = false;
                    this.testimonies = {};
                    this.startedTasks.clear();
                    this.taskStartTimes = {};
                    this.taskDurations = {};
                }
            }

            async loadState() {
                const doc = await db.collection('kids').doc(this.kidId).get();
                const data = doc.data();
                this.completedTasks = new Set(data.completedTasks || []);
                this.completedBonusTasks = new Set(data.completedBonusTasks || []);
                this.bonusRewardsEarned = data.bonusRewardsEarned || {};
                this.queuedBonusRewards = data.queuedBonusRewards || {};
                this.todayRewardGiven = data.todayRewardGiven || false;
                this.testimonies = data.testimonies || {};
                this.startedTasks = new Set(data.startedTasks || []);
                this.taskStartTimes = data.taskStartTimes || {};
                this.taskDurations = data.taskDurations || {};
                this.kidData.totalMoney = data.totalMoney || 0;
            }

            async saveState() {
                await db.collection('kids').doc(this.kidId).update({
                    completedTasks: Array.from(this.completedTasks),
                    completedBonusTasks: Array.from(this.completedBonusTasks),
                    bonusRewardsEarned: this.bonusRewardsEarned,
                    queuedBonusRewards: this.queuedBonusRewards,
                    todayRewardGiven: this.todayRewardGiven,
                    testimonies: this.testimonies,
                    startedTasks: Array.from(this.startedTasks),
                    taskStartTimes: this.taskStartTimes,
                    taskDurations: this.taskDurations
                });
            }

            async addMoney(amount) {
                this.kidData.totalMoney += amount;
                await db.collection('kids').doc(this.kidId).update({
                    totalMoney: this.kidData.totalMoney
                });
                this.updateMoneyDisplay();
            }

            updateMoneyDisplay() {
                const counter = document.getElementById('moneyCounter');
                if (!counter) return;

                if (this.coinStyle === 'custom' && this.coinImageName) {
                    const coinSrc = this.getCoinImageSrc();
                    counter.innerHTML = `<img src="${coinSrc}" style="width: 50px; height: 50px; vertical-align: middle; margin: 0 5px;" /> ${this.kidData.totalMoney.toFixed(2)}`;
                } else {
                    counter.textContent = this.formatMoneySimple(this.kidData.totalMoney);
                }

                // Update daily potential
                this.updateDailyPotential();

                // Update next goal preview
                this.updateNextGoalPreview();

                // Update goals display
                this.updateGoalsDisplay();
            }

            calculateDailyPotential() {
                const dailyReward = this.kidData.dailyReward || 0;
                let minBonus = 0;
                let maxBonus = 0;

                // Get bonus tasks active today
                const bonusTasks = this.boardLayout.filter(item => {
                    if (item.type !== 'task' || item.taskType !== 'bonus') return false;
                    const taskData = item.taskData;
                    if (!taskData) return false;
                    const activeDays = taskData.activeDays || [0, 1, 2, 3, 4, 5, 6];
                    return activeDays.includes(this.currentDay);
                });

                bonusTasks.forEach(item => {
                    const taskData = item.taskData;
                    minBonus += taskData.minReward || 0;
                    maxBonus += taskData.maxReward || 0;
                });

                return {
                    min: dailyReward + minBonus,
                    max: dailyReward + maxBonus
                };
            }

            updateDailyPotential() {
                const dailyPotentialEl = document.getElementById('dailyPotential');
                if (!dailyPotentialEl) return;

                const potential = this.calculateDailyPotential();
                const symbol = this.getCoinSymbol();

                if (potential.max === 0) {
                    dailyPotentialEl.innerHTML = '';
                    return;
                }

                let potentialText;
                if (potential.min === potential.max) {
                    potentialText = `${symbol}${potential.min.toFixed(1)}`;
                } else {
                    potentialText = `${symbol}${potential.min.toFixed(1)} - ${symbol}${potential.max.toFixed(1)}`;
                }

                dailyPotentialEl.innerHTML = `
                    <div class="potential-label">◊ê◊§◊©◊® ◊ú◊î◊®◊ï◊ï◊ô◊ó ◊î◊ô◊ï◊ù:</div>
                    <div class="potential-value">${potentialText}</div>
                `;
            }

            updateNextGoalPreview() {
                const previewEl = document.getElementById('nextGoalPreview');
                if (!previewEl) return;

                const nextGoal = this.getNextGoal();
                if (!nextGoal) {
                    previewEl.classList.add('hidden');
                    previewEl.innerHTML = '';
                    return;
                }

                previewEl.classList.remove('hidden');

                let iconDisplay;
                if (nextGoal.icon && nextGoal.icon.startsWith('IMG:')) {
                    const imageName = nextGoal.icon.substring(4);
                    iconDisplay = `<img src="emojis/${imageName}" />`;
                } else {
                    iconDisplay = nextGoal.icon || 'üèÜ';
                }

                const remaining = nextGoal.pointsRequired - this.kidData.totalMoney;
                const symbol = this.getCoinSymbol();

                previewEl.innerHTML = `
                    <div class="next-goal-mini">${iconDisplay}</div>
                    <div class="next-goal-info">
                        <div class="goal-label">◊î◊ô◊¢◊ì ◊î◊ë◊ê:</div>
                        <div class="goal-name">${nextGoal.title}</div>
                        <div class="goal-remaining">◊ó◊°◊®◊ô◊ù ${symbol}${remaining.toFixed(1)}</div>
                    </div>
                `;
            }

            findTask(taskId, taskType) {
                const layoutItem = this.boardLayout.find(i =>
                    i.type === 'task' && i.taskType === taskType && i.taskData?.id === taskId
                );
                return layoutItem?.taskData;
            }

            async toggleTask(taskId) {
                if (this.isParentMode) return;

                const task = this.findTask(taskId, 'regular');
                if (!task) return;

                if (this.completedTasks.has(taskId)) {
                    this.completedTasks.delete(taskId);
                    delete this.testimonies[taskId];
                    this.startedTasks.delete(taskId);
                    delete this.taskStartTimes[taskId];
                    delete this.taskDurations[taskId];
                    await this.saveState();
                    this.render();
                    this.updateProgress(false); // Don't trigger celebration when uncompleting
                } else if (task.trackTime && !this.startedTasks.has(taskId)) {
                    this.startedTasks.add(taskId);
                    this.taskStartTimes[taskId] = Date.now();
                    await this.saveState();
                    this.render();
                } else if (task.trackTime && this.startedTasks.has(taskId)) {
                    const duration = Math.floor((Date.now() - this.taskStartTimes[taskId]) / 1000);
                    this.taskDurations[taskId] = duration;

                    if (task.requiresTestimony) {
                        this.showTestimonyModal(taskId, false);
                    } else {
                        this.completedTasks.add(taskId);
                        this.celebrate();
                        await this.saveState();
                        this.render();
                        this.updateProgress();
                    }
                } else {
                    if (task.requiresTestimony) {
                        this.showTestimonyModal(taskId, false);
                    } else {
                        this.completedTasks.add(taskId);
                        this.celebrate();
                        await this.saveState();
                        this.render();
                        this.updateProgress();
                    }
                }
            }

            async toggleBonusTask(taskId) {
                if (this.isParentMode) return;

                const task = this.findTask(taskId, 'bonus');
                if (!task) return;

                if (this.completedBonusTasks.has(taskId)) {
                    const rewardAmount = this.bonusRewardsEarned[taskId] || 0;
                    const wasQueued = this.queuedBonusRewards[taskId] !== undefined;
                    this.completedBonusTasks.delete(taskId);
                    delete this.bonusRewardsEarned[taskId];
                    delete this.queuedBonusRewards[taskId]; // Remove from queue if was queued
                    delete this.testimonies[taskId];
                    this.startedTasks.delete(taskId);
                    delete this.taskStartTimes[taskId];
                    delete this.taskDurations[taskId];

                    // Only subtract money if it was actually awarded (not just queued)
                    if (rewardAmount > 0 && !wasQueued) {
                        await this.addMoney(-rewardAmount);
                    }
                    await this.saveState();
                    this.render();
                } else if (task.trackTime && !this.startedTasks.has(taskId)) {
                    this.startedTasks.add(taskId);
                    this.taskStartTimes[taskId] = Date.now();
                    await this.saveState();
                    this.render();
                } else if (task.trackTime && this.startedTasks.has(taskId)) {
                    const duration = Math.floor((Date.now() - this.taskStartTimes[taskId]) / 1000);
                    this.taskDurations[taskId] = duration;

                    if (task.requiresTestimony) {
                        this.showTestimonyModal(taskId, true);
                    } else {
                        this.completeBonusTask(task, taskId);
                    }
                } else {
                    if (task.requiresTestimony) {
                        this.showTestimonyModal(taskId, true);
                    } else {
                        this.completeBonusTask(task, taskId);
                    }
                }
            }

            async completeBonusTask(task, taskId) {
                this.completedBonusTasks.add(taskId);

                const minReward = task.minReward || 0;
                const maxReward = task.maxReward || 0;
                const rewardAmount = minReward === maxReward
                    ? minReward
                    : parseFloat((Math.random() * (maxReward - minReward) + minReward).toFixed(1));

                this.bonusRewardsEarned[taskId] = rewardAmount;

                // Check if this is an instant bonus or after-regular bonus
                const bonusType = task.bonusType || 'instant'; // Default to instant
                const allRegularTasksCompleted = this.areAllRegularTasksCompleted();

                if (bonusType === 'instant' || allRegularTasksCompleted) {
                    // Award money immediately
                    await this.saveState();
                    this.render();
                    this.celebrateBonus(rewardAmount);
                    this.animateMoneyIncrease(rewardAmount);
                } else {
                    // Queue the reward until all regular tasks are done
                    this.queuedBonusRewards[taskId] = rewardAmount;
                    await this.saveState();
                    this.render();
                    this.celebrateBonusQueued(rewardAmount);
                }
            }

            // Check if all regular tasks active today are completed
            areAllRegularTasksCompleted() {
                const regularLayoutTasks = this.boardLayout.filter(item => {
                    if (item.type !== 'task' || item.taskType !== 'regular') return false;
                    const taskData = item.taskData;
                    if (!taskData) return false;
                    const activeDays = taskData.activeDays || [0, 1, 2, 3, 4, 5, 6];
                    return activeDays.includes(this.currentDay);
                });

                return regularLayoutTasks.length > 0 &&
                    regularLayoutTasks.every(item => this.completedTasks.has(item.taskData.id));
            }

            // Celebration for queued bonus (task completed but money waiting)
            celebrateBonusQueued(amount) {
                if (this.isCelebrating) return;

                this.isCelebrating = true;
                const encouragement = document.getElementById('encouragement');

                encouragement.style.animation = 'none';
                encouragement.style.display = 'none';

                const symbol = this.getCoinSymbol();
                const coinSrc = this.getCoinImageSrc();
                const rewardColor = this.getRewardColor();
                const moneyDisplay = this.coinStyle === 'custom'
                    ? `<img src="${coinSrc}" style="width: 40px; height: 40px; vertical-align: middle;" /> +${amount.toFixed(1)}`
                    : `+${symbol}${amount.toFixed(1)}`;

                encouragement.innerHTML = `
                    <div style="font-size: 1.5em;">◊ë◊ï◊†◊ï◊°!</div>
                    <div style="font-size: 1.5em; margin-top: 10px; color: ${rewardColor}; font-weight: 700;">
                        ${moneyDisplay}
                    </div>
                    <div style="font-size: 0.9em; margin-top: 10px; opacity: 0.8;">
                        ‚è≥ ◊û◊û◊™◊ô◊ü ◊¢◊ì ◊©◊™◊°◊ô◊ô◊ù ◊ê◊™ ◊õ◊ú ◊î◊û◊©◊ô◊û◊ï◊™
                    </div>
                `;

                encouragement.style.display = 'block';
                encouragement.style.opacity = '1';
                encouragement.style.transform = 'translate(-50%, -50%) scale(1)';

                this.createConfetti(30);

                setTimeout(() => {
                    encouragement.style.display = 'none';
                    encouragement.style.animation = '';
                    this.isCelebrating = false;
                }, 3000);
            }

            render() {
                const boardContent = document.getElementById('boardContent');
                boardContent.innerHTML = '';

                if (!this.boardLayout || this.boardLayout.length === 0) {
                    boardContent.innerHTML = '<div class="error-message">◊ú◊ê ◊†◊û◊¶◊ê ◊ú◊ï◊ó ◊û◊ï◊í◊ì◊® ◊ú◊ô◊ú◊ì ◊ñ◊î</div>';
                    return;
                }

                // Always render logo at the top
                // Use white tagline logo for dark theme, dark tagline for light themes
                const isDarkTheme = document.body.classList.contains('schema-dark');
                const logoSrc = isDarkTheme ? 'doing-logo-transparent.png' : 'doing-logo-transparent2.png';

                const logoSection = document.createElement('div');
                logoSection.className = 'logo-section';
                logoSection.style.cssText = 'text-align: center; margin-bottom: 20px;';
                logoSection.innerHTML = `
                    <img src="${logoSrc}" alt="Doing - Being. Doing. Playing." class="app-logo" style="max-width: 200px; height: auto;">
                `;
                boardContent.appendChild(logoSection);

                let currentTasksGrid = null;
                let currentTasksType = null;

                this.boardLayout.forEach((item, index) => {
                    if (item.type === 'header') {
                        currentTasksGrid = null;
                        currentTasksType = null;

                        const header = document.createElement('div');
                        header.className = `section-header size-${item.size || 'medium'}`;
                        header.innerHTML = `<h2>${this.replaceNamePlaceholder(item.text)}</h2>`;
                        boardContent.appendChild(header);

                    } else if (item.type === 'progress') {
                        currentTasksGrid = null;
                        currentTasksType = null;

                        const progressTitle = this.replaceNamePlaceholder(item.title || '◊î◊î◊™◊ß◊ì◊û◊ï◊™ ◊©◊ú◊ô ◊î◊ô◊ï◊ù');
                        const progressSection = document.createElement('div');
                        progressSection.className = 'progress-section';
                        progressSection.id = 'progressSection';
                        progressSection.innerHTML = `
                            <div class="progress-title">${progressTitle}</div>
                            <div class="progress-container" style="position: relative;">
                                <div class="progress-bar" id="progressBar">0%</div>
                                <div class="progress-sparkles" id="progressSparkles"></div>
                                <div class="golden-feather" id="goldenFeather" style="right: 15px; top: 50%; transform: translateY(-50%);">‚≠ê</div>
                            </div>
                        `;
                        boardContent.appendChild(progressSection);

                    } else if (item.type === 'bank') {
                        currentTasksGrid = null;
                        currentTasksType = null;

                        const bankSection = document.createElement('div');
                        bankSection.className = 'piggy-bank-section';
                        bankSection.innerHTML = `
                            <div class="piggy-bank-icon">
                                <img id="kidImage" src="${this.getKidImageSrc()}" alt="${this.kidData.name}">
                            </div>
                            <div class="money-counter" id="moneyCounter">$0</div>
                            <div class="money-label" id="moneyLabel">${this.replaceNamePlaceholder(item.label || '◊ß◊ï◊§◊™ ◊î◊ó◊ô◊°◊õ◊ï◊ü')}</div>
                            <div class="bank-extra-info">
                                <div class="daily-potential" id="dailyPotential"></div>
                                <div class="next-goal-preview" id="nextGoalPreview"></div>
                            </div>
                        `;
                        boardContent.appendChild(bankSection);

                    } else if (item.type === 'task') {
                        const taskData = item.taskData;
                        if (!taskData) return;

                        const activeDays = taskData.activeDays || [0, 1, 2, 3, 4, 5, 6];
                        if (!activeDays.includes(this.currentDay)) return;

                        if (currentTasksType !== item.taskType) {
                            currentTasksGrid = document.createElement('div');
                            currentTasksGrid.className = item.taskType === 'bonus' ? 'bonus-tasks-grid' :
                                                        item.taskType === 'calm-down' ? 'calm-down-grid' : 'tasks-grid';
                            currentTasksGrid.style.marginBottom = '30px';
                            boardContent.appendChild(currentTasksGrid);
                            currentTasksType = item.taskType;
                        }

                        const card = this.createTaskCard(taskData, item.taskType);
                        currentTasksGrid.appendChild(card);
                    } else if (item.type === 'goal') {
                        // Check if we need a new goals grid or reuse existing
                        if (currentTasksType !== 'goal') {
                            currentTasksGrid = document.createElement('div');
                            currentTasksGrid.className = 'goals-grid';
                            currentTasksGrid.style.marginBottom = '30px';
                            boardContent.appendChild(currentTasksGrid);
                            currentTasksType = 'goal';
                        }

                        const goalCard = this.createGoalCard(item);
                        currentTasksGrid.appendChild(goalCard);
                    }
                });

                this.updateMoneyDisplay();
                this.updateGoalsDisplay();
                this.updateProgress(false); // Don't trigger celebration on render
            }

            replaceNamePlaceholder(text) {
                return (text || '').replace(/\[◊©◊ù\]/g, this.kidData.name);
            }

            getKidImageSrc() {
                const imageSrc = this.kidData.imageName || 'me-default-small.jpg';
                if (imageSrc.startsWith('data:')) {
                    return imageSrc;
                }
                return imageSrc + '?t=' + new Date().getTime();
            }

            createTaskCard(task, taskType) {
                const card = document.createElement('div');

                if (taskType === 'bonus') {
                    card.className = 'bonus-task-card';
                    if (this.completedBonusTasks.has(task.id)) {
                        card.classList.add('completed');
                    }
                } else if (taskType === 'calm-down') {
                    card.className = 'calm-down-card';
                } else {
                    card.className = 'task-card';
                    if (this.completedTasks.has(task.id)) {
                        card.classList.add('completed');
                    }
                }

                let iconDisplay;
                if (task.icon && task.icon.startsWith('IMG:')) {
                    const imageName = task.icon.substring(4);
                    const timestamp = new Date().getTime();
                    iconDisplay = `<img src="emojis/${imageName}?t=${timestamp}" style="width: 60px; height: 60px; object-fit: contain;" />`;
                } else {
                    iconDisplay = task.icon || 'üéØ';
                }

                if (taskType === 'calm-down') {
                    card.innerHTML = `
                        <div class="task-icon">${iconDisplay}</div>
                        <div class="task-title">${task.title}</div>
                    `;
                    card.style.cursor = 'pointer';
                    card.addEventListener('click', () => this.openCalmDownActivity(task));
                    return card;
                }

                const testimonyBadge = task.requiresTestimony ? '<div class="testimony-badge">üìù</div>' : '';
                const hasTestimony = this.testimonies[task.id];
                const testimonyIndicator = hasTestimony ? '<div class="testimony-indicator" title="◊ú◊ó◊• ◊ú◊ß◊®◊ô◊ê◊™ ◊î◊¢◊ì◊ï◊™">üí¨</div>' : '';

                let timeTrackingDisplay = '';
                if (task.trackTime) {
                    const isStarted = this.startedTasks.has(task.id);
                    const isCompleted = taskType === 'bonus' ? this.completedBonusTasks.has(task.id) : this.completedTasks.has(task.id);

                    if (isCompleted && this.taskDurations[task.id] !== undefined) {
                        const duration = this.formatDuration(this.taskDurations[task.id]);
                        timeTrackingDisplay = `<div class="time-badge" style="position: absolute; bottom: 10px; right: 10px; background: #4CAF50; color: white; padding: 5px 8px; border-radius: 8px; font-size: 12px; font-weight: bold;">‚è±Ô∏è ${duration}</div>`;
                    } else if (isStarted) {
                        const elapsed = this.getElapsedTime(task.id);
                        const elapsedDisplay = this.formatDuration(elapsed);
                        timeTrackingDisplay = `<div class="time-badge started" style="position: absolute; bottom: 10px; right: 10px; background: #FF9800; color: white; padding: 5px 8px; border-radius: 8px; font-size: 12px; font-weight: bold; animation: pulse 1.5s ease-in-out infinite;">‚è±Ô∏è ${elapsedDisplay} - ◊ë◊™◊î◊ú◊ô◊ö</div>`;
                        card.classList.add('started');
                    } else {
                        timeTrackingDisplay = `<div class="time-badge" style="position: absolute; top: 10px; right: 10px; background: #9E9E9E; color: white; padding: 5px 8px; border-radius: 8px; font-size: 12px;">‚è±Ô∏è</div>`;
                    }
                }

                if (taskType === 'bonus') {
                    const symbol = this.getCoinSymbol();
                    const rewardText = task.minReward === task.maxReward
                        ? `${symbol}${task.minReward.toFixed(1)}`
                        : `${symbol}${task.minReward.toFixed(1)}-${symbol}${task.maxReward.toFixed(1)}`;

                    // Check if reward is queued (waiting for regular tasks to complete)
                    const isQueued = this.queuedBonusRewards[task.id] !== undefined;
                    let earnedText = '';
                    if (this.bonusRewardsEarned[task.id]) {
                        if (isQueued) {
                            earnedText = ` (‚è≥ ${symbol}${this.bonusRewardsEarned[task.id].toFixed(1)})`;
                        } else {
                            earnedText = ` (+${symbol}${this.bonusRewardsEarned[task.id].toFixed(1)})`;
                        }
                    }

                    // Add queued indicator class for styling
                    if (isQueued) {
                        card.classList.add('reward-queued');
                    }

                    card.innerHTML = `
                        <div class="bonus-reward-badge">${rewardText}${earnedText}</div>
                        <div class="checkmark">‚úì</div>
                        <div class="task-icon">${iconDisplay}</div>
                        <div class="task-title">${task.title}</div>
                        ${testimonyBadge}
                        ${testimonyIndicator}
                        ${timeTrackingDisplay}
                    `;

                    if (hasTestimony && this.completedBonusTasks.has(task.id)) {
                        card.addEventListener('click', (e) => {
                            if (e.target.classList.contains('testimony-indicator') || e.target.closest('.testimony-indicator')) {
                                this.showTestimonyReader(task.id);
                            } else if (!this.isParentMode) {
                                this.toggleBonusTask(task.id);
                            }
                        });
                        card.style.cursor = this.isParentMode ? 'default' : 'pointer';
                        if (this.isParentMode) card.style.opacity = '0.8';
                    } else if (!this.isParentMode) {
                        card.style.cursor = 'pointer';
                        card.addEventListener('click', () => this.toggleBonusTask(task.id));
                    } else {
                        card.style.cursor = 'default';
                        card.style.opacity = '0.8';
                    }
                } else {
                    card.innerHTML = `
                        <div class="checkmark">‚úì</div>
                        <div class="task-icon">${iconDisplay}</div>
                        <div class="task-title">${task.title}</div>
                        ${testimonyBadge}
                        ${testimonyIndicator}
                        ${timeTrackingDisplay}
                    `;

                    if (hasTestimony && this.completedTasks.has(task.id)) {
                        card.addEventListener('click', (e) => {
                            if (e.target.classList.contains('testimony-indicator') || e.target.closest('.testimony-indicator')) {
                                this.showTestimonyReader(task.id);
                            } else if (!this.isParentMode) {
                                this.toggleTask(task.id);
                            }
                        });
                        card.style.cursor = this.isParentMode ? 'default' : 'pointer';
                        if (this.isParentMode) card.style.opacity = '0.8';
                    } else if (!this.isParentMode) {
                        card.style.cursor = 'pointer';
                        card.addEventListener('click', () => this.toggleTask(task.id));
                    } else {
                        card.style.cursor = 'default';
                        card.style.opacity = '0.8';
                    }
                }

                return card;
            }

            createGoalCard(goalItem) {
                const wrapper = document.createElement('div');
                wrapper.className = 'goal-wrapper';
                wrapper.dataset.goalId = goalItem.id;
                wrapper.dataset.pointsRequired = goalItem.pointsRequired;

                const isAchieved = this.kidData.totalMoney >= goalItem.pointsRequired;

                let iconDisplay;
                if (goalItem.icon && goalItem.icon.startsWith('IMG:')) {
                    const imageName = goalItem.icon.substring(4);
                    const timestamp = new Date().getTime();
                    iconDisplay = `<img src="emojis/${imageName}?t=${timestamp}" />`;
                } else {
                    iconDisplay = goalItem.icon || 'üèÜ';
                }

                wrapper.innerHTML = `
                    <div class="goal-card ${isAchieved ? 'achieved' : ''}">
                        <div class="goal-glow"></div>
                        <div class="goal-icon">${iconDisplay}</div>
                        <div class="goal-title">${goalItem.title}</div>
                        <div class="goal-points">${goalItem.pointsRequired} ◊†◊ß◊ï◊ì◊ï◊™</div>
                        <div class="goal-achieved-badge">‚úì</div>
                    </div>
                `;

                return wrapper;
            }

            updateGoalsDisplay() {
                const goalWrappers = document.querySelectorAll('.goal-wrapper');
                goalWrappers.forEach(wrapper => {
                    const pointsRequired = parseFloat(wrapper.dataset.pointsRequired);
                    const isAchieved = this.kidData.totalMoney >= pointsRequired;
                    const card = wrapper.querySelector('.goal-card');
                    if (isAchieved) {
                        card.classList.add('achieved');
                    } else {
                        card.classList.remove('achieved');
                    }
                });
            }

            getGoalsFromLayout() {
                return this.boardLayout.filter(item => item.type === 'goal');
            }

            getNextGoal() {
                const goals = this.getGoalsFromLayout();
                const unachievedGoals = goals.filter(g => this.kidData.totalMoney < g.pointsRequired);
                if (unachievedGoals.length === 0) return null;
                // Return the goal with lowest points required that is not yet achieved
                return unachievedGoals.sort((a, b) => a.pointsRequired - b.pointsRequired)[0];
            }

            updateProgress(triggerCelebration = true) {
                const regularLayoutTasks = this.boardLayout.filter(item => {
                    if (item.type !== 'task' || item.taskType !== 'regular') return false;
                    const taskData = item.taskData;
                    if (!taskData) return false;
                    const activeDays = taskData.activeDays || [0, 1, 2, 3, 4, 5, 6];
                    return activeDays.includes(this.currentDay);
                });

                const totalRegularTasks = regularLayoutTasks.length;
                const completedCount = regularLayoutTasks.filter(item =>
                    this.completedTasks.has(item.taskData.id)
                ).length;

                const progress = totalRegularTasks > 0
                    ? (completedCount / totalRegularTasks) * 100
                    : 0;

                const progressBar = document.getElementById('progressBar');
                const progressSection = document.getElementById('progressSection');

                if (progressBar) {
                    progressBar.style.width = progress + '%';

                    // Show special indicator when all tasks are done
                    if (progress === 100 && totalRegularTasks > 0) {
                        progressBar.textContent = '‚úì 100%';
                        progressBar.style.background = 'linear-gradient(90deg, var(--card-completed-start), var(--card-completed-end))';
                        // Add glowing animation
                        if (progressSection) {
                            progressSection.classList.add('all-done');
                            this.createProgressSparkles();
                        }
                    } else {
                        progressBar.textContent = Math.round(progress) + '%';
                        // Remove glow when not complete
                        if (progressSection) {
                            progressSection.classList.remove('all-done');
                            this.clearProgressSparkles();
                        }
                    }
                }

                // Only show mega celebration when user actually completes the last task
                // (not on page load or when toggling bonus tasks)
                if (triggerCelebration && progress === 100 && totalRegularTasks > 0 && !this.isParentMode) {
                    this.showMegaCelebration();
                }
            }

            celebrate() {
                const msg = encouragementMessages[Math.floor(Math.random() * encouragementMessages.length)];
                const encouragement = document.getElementById('encouragement');
                encouragement.textContent = msg;
                encouragement.style.display = 'block';
                setTimeout(() => {
                    encouragement.style.display = 'none';
                }, 2000);

                this.createConfetti(15);
                this.createStars();
            }

            // Get theme-appropriate reward text color (pastel gold tones)
            getRewardColor() {
                const isDarkTheme = document.body.classList.contains('schema-dark');
                if (isDarkTheme) {
                    return '#C9B896'; // Soft gold for dark theme
                }
                // Pastel gold that matches the logo star - readable on white popup
                return '#B8956A';
            }

            celebrateBonus(amount) {
                if (this.isCelebrating) return;

                this.isCelebrating = true;
                const encouragement = document.getElementById('encouragement');

                encouragement.style.animation = 'none';
                encouragement.style.display = 'none';

                const symbol = this.getCoinSymbol();
                const coinSrc = this.getCoinImageSrc();
                const rewardColor = this.getRewardColor();
                const moneyDisplay = this.coinStyle === 'custom'
                    ? `<img src="${coinSrc}" style="width: 40px; height: 40px; vertical-align: middle;" /> +${amount.toFixed(1)}`
                    : `+${symbol}${amount.toFixed(1)}`;

                encouragement.innerHTML = `
                    <div style="font-size: 1.5em;">◊ë◊ï◊†◊ï◊°!</div>
                    <div style="font-size: 2em; margin-top: 10px; color: ${rewardColor}; font-weight: 700;">
                        ${moneyDisplay}
                    </div>
                `;

                encouragement.style.display = 'block';
                encouragement.style.opacity = '1';
                encouragement.style.transform = 'translate(-50%, -50%) scale(1)';

                this.createMassiveCoinSplash();
                this.createConfetti(50);

                setTimeout(() => {
                    encouragement.style.display = 'none';
                    encouragement.style.animation = '';
                    this.isCelebrating = false;
                }, 3000);
            }

            createConfetti(count) {
                const celebration = document.getElementById('celebration');
                // Pastel confetti colors matching the logo palette
                const colors = ['#A8D5E5', '#89C4B8', '#F5C6AA', '#E8A07E', '#B8D4E8', '#C5B8E8', '#E8C86D'];

                for (let i = 0; i < count; i++) {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDelay = Math.random() * 0.5 + 's';
                    celebration.appendChild(confetti);
                    setTimeout(() => confetti.remove(), 3000);
                }
            }

            createStars() {
                const celebration = document.getElementById('celebration');
                const starEmojis = ['‚≠ê', 'üåü', '‚ú®', 'üí´'];

                for (let i = 0; i < 5; i++) {
                    const star = document.createElement('div');
                    star.className = 'star';
                    star.textContent = starEmojis[Math.floor(Math.random() * starEmojis.length)];
                    star.style.left = Math.random() * 100 + '%';
                    star.style.top = Math.random() * 100 + '%';
                    celebration.appendChild(star);
                    setTimeout(() => star.remove(), 1000);
                }
            }

            // Create floating sparkles around the progress bar
            createProgressSparkles() {
                const sparklesContainer = document.getElementById('progressSparkles');
                if (!sparklesContainer || sparklesContainer.children.length > 0) return;

                const sparkleEmojis = ['‚ú®', '‚≠ê', 'üåü', '‚ú®', 'üí´', '‚ú®'];
                // Positions centered on the progress bar (top: 50% means middle of the 60px container)
                const positions = [
                    { left: '5%', top: '20px' },
                    { left: '18%', top: '35px' },
                    { left: '32%', top: '22px' },
                    { left: '48%', top: '38px' },
                    { left: '62%', top: '25px' },
                    { left: '78%', top: '32px' },
                ];

                positions.forEach((pos, i) => {
                    const sparkle = document.createElement('div');
                    sparkle.className = 'sparkle';
                    sparkle.textContent = sparkleEmojis[i % sparkleEmojis.length];
                    sparkle.style.left = pos.left;
                    sparkle.style.top = pos.top;
                    sparkle.style.animationDelay = (i * 0.3) + 's';
                    sparklesContainer.appendChild(sparkle);
                });
            }

            // Clear sparkles when progress is not 100%
            clearProgressSparkles() {
                const sparklesContainer = document.getElementById('progressSparkles');
                if (sparklesContainer) {
                    sparklesContainer.innerHTML = '';
                }
            }

            async showMegaCelebration() {
                // Only show the mega celebration once per day
                if (this.todayRewardGiven) {
                    // Even if reward was already given, we should still award any newly queued bonuses
                    await this.awardQueuedBonuses();
                    return;
                }

                this.todayRewardGiven = true;

                const dailyReward = this.kidData.dailyReward || 0.5;
                const symbol = this.getCoinSymbol();
                const coinSrc = this.getCoinImageSrc();
                const rewardColor = this.getRewardColor();

                // Calculate total queued bonus rewards
                const queuedBonusTotal = Object.values(this.queuedBonusRewards).reduce((sum, amt) => sum + amt, 0);
                const totalReward = dailyReward + queuedBonusTotal;

                const rewardDisplay = this.coinStyle === 'custom'
                    ? `<img src="${coinSrc}" style="width: 35px; height: 35px; vertical-align: middle;" /> ${dailyReward.toFixed(2)}`
                    : `${symbol}${dailyReward.toFixed(2)}`;

                let celebrationMessage = `
                    <div>◊°◊ô◊ô◊û◊™ ◊ê◊™ ◊õ◊ú ◊î◊û◊©◊ô◊û◊ï◊™! ◊ê◊™◊î ◊ê◊ú◊ï◊£!</div>
                    <div style="font-size: 1.5em; margin-top: 20px; color: ${rewardColor}; font-weight: 700;">
                        ◊ß◊ô◊ë◊ú◊™ ${rewardDisplay} ◊ú◊ß◊ï◊§◊™ ◊î◊ó◊ô◊°◊õ◊ï◊ü!
                    </div>
                `;

                // If there are queued bonuses, add them to the message
                if (queuedBonusTotal > 0) {
                    const bonusDisplay = this.coinStyle === 'custom'
                        ? `<img src="${coinSrc}" style="width: 30px; height: 30px; vertical-align: middle;" /> ${queuedBonusTotal.toFixed(2)}`
                        : `${symbol}${queuedBonusTotal.toFixed(2)}`;
                    celebrationMessage += `
                        <div style="font-size: 1.2em; margin-top: 15px; color: ${rewardColor}; font-weight: 600;">
                            + ◊ë◊ï◊†◊ï◊°◊ô◊ù ◊©◊î◊û◊™◊ô◊†◊ï: ${bonusDisplay}
                        </div>
                    `;
                }

                const encouragement = document.getElementById('encouragement');
                encouragement.innerHTML = celebrationMessage;
                encouragement.style.display = 'block';

                this.createConfetti(100);
                this.createStars();
                this.createFallingCoins();

                // Award the daily reward
                setTimeout(() => {
                    this.animateMoneyIncrease(dailyReward);
                }, 1000);

                // Award queued bonuses after daily reward animation
                if (queuedBonusTotal > 0) {
                    setTimeout(() => {
                        this.awardQueuedBonuses();
                    }, 2000);
                }

                await this.saveState();

                setTimeout(() => {
                    encouragement.style.display = 'none';
                }, queuedBonusTotal > 0 ? 5000 : 4000);
            }

            // Award all queued bonus rewards and clear the queue
            async awardQueuedBonuses() {
                const queuedTotal = Object.values(this.queuedBonusRewards).reduce((sum, amt) => sum + amt, 0);
                if (queuedTotal > 0) {
                    await this.animateMoneyIncrease(queuedTotal);
                    this.queuedBonusRewards = {};
                    await this.saveState();
                    this.render(); // Re-render to update badge displays
                }
            }

            createFallingCoins() {
                const celebration = document.getElementById('celebration');
                const coinEmojis = ['ü™ô', 'üí∞', 'üíµ', 'üí¥', 'üí∂', 'üí∑'];

                for (let i = 0; i < 30; i++) {
                    const coin = document.createElement('div');
                    coin.className = 'coins-animation';
                    coin.textContent = coinEmojis[Math.floor(Math.random() * coinEmojis.length)];
                    coin.style.left = Math.random() * 100 + '%';
                    coin.style.animationDelay = Math.random() * 1 + 's';
                    celebration.appendChild(coin);
                    setTimeout(() => coin.remove(), 3000);
                }
            }

            createMassiveCoinSplash() {
                const celebration = document.getElementById('celebration');

                for (let i = 0; i < 120; i++) {
                    const coin = document.createElement('div');
                    coin.style.position = 'fixed';
                    coin.style.fontSize = (20 + Math.random() * 40) + 'px';
                    coin.style.zIndex = '1001';
                    coin.style.pointerEvents = 'none';
                    coin.style.left = '50%';
                    coin.style.top = '50%';

                    if (this.coinStyle === 'custom' && this.coinImageName && this.coinImageName.trim() !== '') {
                        const coinSrc = this.getCoinImageSrc();
                        coin.innerHTML = `<img src="${coinSrc}" style="width: ${30 + Math.random() * 30}px; height: ${30 + Math.random() * 30}px;" />`;
                    } else {
                        const size = 30 + Math.random() * 30;
                        coin.innerHTML = `<div style="width: ${size}px; height: ${size}px; background: radial-gradient(circle, #ffd700, #ffed4e, #ffd700); border: 2px solid #b8860b; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: ${size * 0.6}px; color: #b8860b; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">$</div>`;
                        coin.style.fontSize = '';
                    }

                    celebration.appendChild(coin);

                    const angle = Math.random() * Math.PI * 2;
                    const velocity = 200 + Math.random() * 400;
                    const vx = Math.cos(angle) * velocity;
                    const vy = Math.sin(angle) * velocity;
                    const spin = (Math.random() - 0.5) * 1080;

                    const startTime = Date.now();
                    const duration = 2000 + Math.random() * 1000;

                    const animate = () => {
                        const elapsed = Date.now() - startTime;
                        const progress = elapsed / duration;

                        if (progress < 1) {
                            const t = elapsed / 1000;
                            const gravity = 500;

                            const x = vx * t;
                            const y = vy * t + 0.5 * gravity * t * t;
                            const rotation = spin * progress;

                            coin.style.transform = `translate(${x}px, ${y}px) rotate(${rotation}deg)`;
                            coin.style.opacity = 1 - (progress * 0.5);

                            requestAnimationFrame(animate);
                        } else {
                            coin.remove();
                        }
                    };

                    requestAnimationFrame(animate);
                }
            }

            animateMoneyIncrease(amount) {
                const counter = document.getElementById('moneyCounter');
                const startMoney = this.kidData.totalMoney;
                const duration = 1500;
                const startTime = Date.now();

                const animate = () => {
                    const elapsed = Date.now() - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    const easeProgress = 1 - Math.pow(1 - progress, 3);
                    const currentMoney = startMoney + (amount * easeProgress);

                    if (this.coinStyle === 'custom') {
                        const coinSrc = this.getCoinImageSrc();
                        counter.innerHTML = `<img src="${coinSrc}" style="width: 30px; height: 30px; vertical-align: middle; margin: 0 5px;" /> ${currentMoney.toFixed(2)}`;
                    } else {
                        const symbol = this.getCoinSymbol();
                        counter.textContent = `${symbol}${currentMoney.toFixed(2)}`;
                    }
                    counter.style.transform = `scale(${1 + Math.sin(progress * Math.PI) * 0.3})`;

                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    } else {
                        this.addMoney(amount);
                        counter.style.transform = 'scale(1)';
                    }
                };

                animate();
            }

            showTestimonyModal(taskId, isBonus) {
                this.pendingTestimonyTaskId = taskId;
                this.pendingTestimonyIsBonus = isBonus;

                const modal = document.getElementById('testimonyModal');
                const input = document.getElementById('testimonyInput');

                input.value = '';

                const task = this.findTask(taskId, isBonus ? 'bonus' : 'regular');

                if (task) {
                    document.getElementById('testimonyTitle').textContent = `◊°◊§◊® ◊ú◊†◊ï ◊ê◊ô◊ö ◊î◊©◊ú◊û◊™: ${task.title}`;
                }

                modal.classList.add('active');
                input.focus();
            }

            cancelTestimony() {
                const modal = document.getElementById('testimonyModal');
                modal.classList.remove('active');
                this.pendingTestimonyTaskId = null;
                this.pendingTestimonyIsBonus = false;
            }

            async submitTestimony() {
                const testimony = document.getElementById('testimonyInput').value.trim();

                if (!testimony) {
                    alert('◊†◊ê ◊ú◊î◊ñ◊ô◊ü ◊™◊ô◊ê◊ï◊® ◊©◊ú ◊ê◊ô◊ö ◊î◊©◊ú◊û◊™ ◊ê◊™ ◊î◊û◊©◊ô◊û◊î');
                    return;
                }

                const taskId = this.pendingTestimonyTaskId;
                const isBonus = this.pendingTestimonyIsBonus;

                this.cancelTestimony();

                this.testimonies[taskId] = testimony;

                if (isBonus) {
                    const task = this.findTask(taskId, 'bonus');
                    await this.completeBonusTask(task, taskId);
                } else {
                    this.completedTasks.add(taskId);
                    this.celebrate();
                    await this.saveState();
                    this.render();
                    this.updateProgress();
                }
            }

            showTestimonyReader(taskId) {
                const testimony = this.testimonies[taskId];
                if (!testimony) return;

                const task = this.findTask(taskId, 'regular') || this.findTask(taskId, 'bonus');

                const modal = document.getElementById('testimonyReaderModal');
                const titleEl = document.getElementById('testimonyReaderTitle');
                const textEl = document.getElementById('testimonyReaderText');

                if (task) {
                    titleEl.textContent = `◊î◊¢◊ì◊ï◊™ ◊©◊ú◊ö - ${task.title}`;
                }

                textEl.textContent = testimony;
                modal.classList.add('active');
            }

            closeTestimonyReader() {
                const modal = document.getElementById('testimonyReaderModal');
                modal.classList.remove('active');
            }

            openCalmDownActivity(task) {
                const modal = document.getElementById('calmDownModal');
                const frame = document.getElementById('calmDownFrame');
                const title = document.getElementById('calmDownTitle');
                const fallbackDiv = document.getElementById('calmDownFallback');
                const fallbackLink = document.getElementById('calmDownFallbackLink');

                title.textContent = task.title;

                let url = '';
                let isYouTube = false;
                let originalUrl = '';

                if (task.activityType === 'paint') {
                    url = 'paint.html';
                } else if (task.activityType === 'bubbles') {
                    url = 'bubbles.html';
                } else if (task.activityType === 'xylophone') {
                    url = 'xylophone.html';
                } else if (task.activityType === 'breathing') {
                    url = 'breathing.html';
                } else if (task.activityType === 'scooter') {
                    url = 'scooter.html';
                } else if (task.activityType === 'link' && task.activityUrl) {
                    originalUrl = task.activityUrl;
                    if (task.activityUrl.includes('youtube.com/watch')) {
                        const urlObj = new URL(task.activityUrl);
                        const videoId = urlObj.searchParams.get('v');
                        url = `https://www.youtube.com/embed/${videoId}?autoplay=0&rel=0&modestbranding=1`;
                        isYouTube = true;
                    } else if (task.activityUrl.includes('youtu.be/')) {
                        const videoId = task.activityUrl.split('youtu.be/')[1].split('?')[0];
                        url = `https://www.youtube.com/embed/${videoId}?autoplay=0&rel=0&modestbranding=1`;
                        isYouTube = true;
                    } else {
                        url = task.activityUrl;
                    }
                }

                if (url) {
                    frame.style.display = 'block';
                    frame.src = url;

                    if (isYouTube) {
                        fallbackDiv.style.display = 'block';
                        fallbackLink.href = originalUrl;
                    } else {
                        fallbackDiv.style.display = 'none';
                    }

                    modal.classList.add('active');

                    // Add keyboard listener to forward space/arrow keys to iframe
                    this._calmDownKeyHandler = (e) => {
                        if (e.code === 'Space' || e.code === 'ArrowUp') {
                            e.preventDefault();
                            if (frame.contentWindow) {
                                frame.contentWindow.postMessage('jump', '*');
                            }
                        }
                        // Close on Escape
                        if (e.code === 'Escape') {
                            this.closeCalmDownActivity();
                        }
                    };
                    document.addEventListener('keydown', this._calmDownKeyHandler);

                    // Focus iframe after it loads
                    frame.onload = () => {
                        frame.contentWindow.focus();
                    };
                }
            }

            closeCalmDownActivity() {
                const modal = document.getElementById('calmDownModal');
                const frame = document.getElementById('calmDownFrame');
                frame.src = '';
                modal.classList.remove('active');

                // Remove keyboard listener
                if (this._calmDownKeyHandler) {
                    document.removeEventListener('keydown', this._calmDownKeyHandler);
                    this._calmDownKeyHandler = null;
                }
            }
        }

        // Show Kid/Parent Page
        async function showKidPage(kidId, isParentMode) {
            try {
                const doc = await db.collection('kids').doc(kidId).get();
                if (!doc.exists) {
                    document.getElementById('loadingState').innerHTML = '<div class="error-message">◊ô◊ú◊ì ◊ú◊ê ◊†◊û◊¶◊ê</div>';
                    return;
                }

                const kidData = doc.data();

                // Check if this kid has boardLayout
                if (!kidData.boardLayout || !kidData.boardLayout.items || kidData.boardLayout.items.length === 0) {
                    document.getElementById('loadingState').innerHTML = '<div class="error-message">◊ú◊ê ◊†◊û◊¶◊ê ◊ú◊ï◊ó ◊û◊ï◊í◊ì◊® ◊ú◊ô◊ú◊ì ◊ñ◊î.<br>◊†◊ê ◊ú◊î◊©◊™◊û◊© ◊ë◊ë◊†◊î ◊ú◊ï◊ó ◊õ◊ì◊ô ◊ú◊ô◊¶◊ï◊® ◊ú◊ï◊ó ◊ó◊ì◊©.</div>';
                    return;
                }

                // Apply color schema
                const colorSchema = kidData.colorSchema || 'purple';
                document.body.classList.add(`schema-${colorSchema}`);

                // Show Dino if enabled
                if (kidData.showDino) {
                    document.getElementById('dinoContainer').classList.remove('hidden');
                    // Pass kid parameter to dino iframe
                    const dinoFrame = document.getElementById('dinoFrame');
                    dinoFrame.src = `./dino.html?kid=${encodeURIComponent(kidId)}`;
                }

                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('kidPage').classList.remove('hidden');

                window.taskBoard = new TaskBoard(kidId, kidData, isParentMode);
            } catch (error) {
                console.error('Error loading kid page:', error);
                document.getElementById('loadingState').innerHTML = '<div class="error-message">◊©◊í◊ô◊ê◊î ◊ë◊ò◊¢◊ô◊†◊î</div>';
            }
        }

        // Toggle Dino minimized state
        function toggleDino() {
            const container = document.getElementById('dinoContainer');
            container.classList.toggle('minimized');
        }

        // Dino Drag Functionality
        (function initDinoDrag() {
            const container = document.getElementById('dinoContainer');
            const handle = document.getElementById('dinoDragHandle');

            let isDragging = false;
            let dragStartX, dragStartY;
            let containerStartX, containerStartY;

            function getContainerPosition() {
                const rect = container.getBoundingClientRect();
                return { x: rect.left, y: rect.top };
            }

            function startDrag(e) {
                // For minimized state, the whole container is draggable
                // For expanded state, only the handle is draggable
                const isMinimized = container.classList.contains('minimized');
                const target = e.target;

                if (!isMinimized && target !== handle) return;
                if (isMinimized && target.classList.contains('dino-toggle')) {
                    // Allow click on toggle to work
                    return;
                }

                e.preventDefault();
                isDragging = true;
                container.classList.add('dragging');

                const pos = getContainerPosition();
                containerStartX = pos.x;
                containerStartY = pos.y;

                if (e.type === 'touchstart') {
                    dragStartX = e.touches[0].clientX;
                    dragStartY = e.touches[0].clientY;
                } else {
                    dragStartX = e.clientX;
                    dragStartY = e.clientY;
                }

                // Remove bottom/left/right positioning, use top/left
                container.style.bottom = 'auto';
                container.style.right = 'auto';
                container.style.left = containerStartX + 'px';
                container.style.top = containerStartY + 'px';
            }

            function drag(e) {
                if (!isDragging) return;
                e.preventDefault();

                let currentX, currentY;
                if (e.type === 'touchmove') {
                    currentX = e.touches[0].clientX;
                    currentY = e.touches[0].clientY;
                } else {
                    currentX = e.clientX;
                    currentY = e.clientY;
                }

                const deltaX = currentX - dragStartX;
                const deltaY = currentY - dragStartY;

                let newX = containerStartX + deltaX;
                let newY = containerStartY + deltaY;

                // Keep within viewport
                const rect = container.getBoundingClientRect();
                const maxX = window.innerWidth - rect.width;
                const maxY = window.innerHeight - rect.height;

                newX = Math.max(0, Math.min(newX, maxX));
                newY = Math.max(0, Math.min(newY, maxY));

                container.style.left = newX + 'px';
                container.style.top = newY + 'px';
            }

            function endDrag() {
                if (!isDragging) return;
                isDragging = false;
                container.classList.remove('dragging');
            }

            // Mouse events
            handle.addEventListener('mousedown', startDrag);
            container.addEventListener('mousedown', function(e) {
                if (container.classList.contains('minimized')) {
                    startDrag(e);
                }
            });
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', endDrag);

            // Touch events
            handle.addEventListener('touchstart', startDrag, { passive: false });
            container.addEventListener('touchstart', function(e) {
                if (container.classList.contains('minimized')) {
                    startDrag(e);
                }
            }, { passive: false });
            document.addEventListener('touchmove', drag, { passive: false });
            document.addEventListener('touchend', endDrag);
        })();
    </script>
</body>
</html>
