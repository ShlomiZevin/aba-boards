<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×¡×˜×˜×™×¡×˜×™×§×” - ABA</title>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Doing Theme -->
    <link rel="stylesheet" href="doing-theme-light.css">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            direction: rtl;
        }

        .stats-container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .stats-header {
            background: white;
            padding: 25px 30px;
            border-radius: 20px;
            text-align: center;
            margin-bottom: 24px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.12);
        }

        .stats-header .logo-container {
            margin-bottom: 12px;
        }

        .stats-header .logo-container img {
            max-height: 60px;
            width: auto;
        }

        .stats-header h1 {
            color: #4a5568;
            margin-bottom: 8px;
            font-size: 1.75em;
            font-weight: 700;
        }

        .kid-name {
            color: #667eea;
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-top: 8px;
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.95em;
            padding: 8px 16px;
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .back-link:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .controls-section {
            background: white;
            padding: 20px 24px;
            border-radius: 20px;
            margin-bottom: 24px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.12);
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: space-between;
            align-items: center;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-group label {
            font-weight: 600;
            color: #475569;
            font-size: 0.95em;
        }

        .btn-group {
            display: flex;
            gap: 6px;
        }

        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            font-size: 14px;
            background: #e2e8f0;
            color: #475569;
        }

        .btn:hover {
            background: #cbd5e1;
        }

        .btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .chart-section {
            background: white;
            padding: 24px;
            border-radius: 20px;
            margin-bottom: 24px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.12);
        }

        .chart-title {
            color: #2d3748;
            font-size: 1.2em;
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
        }

        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
        }

        .legend-section {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid #e2e8f0;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95em;
            color: #475569;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

        .legend-color.regular {
            background: #667eea;
        }

        .legend-color.bonus {
            background: #f5a623;
        }

        .legend-color.total {
            background: #10b981;
        }

        .summary-section {
            background: white;
            padding: 24px;
            border-radius: 20px;
            margin-bottom: 24px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.12);
        }

        .summary-title {
            color: #2d3748;
            font-size: 1.2em;
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .summary-card {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .summary-value {
            font-size: 2em;
            font-weight: 700;
            color: #2d3748;
        }

        .summary-value.regular {
            color: #667eea;
        }

        .summary-value.bonus {
            color: #f5a623;
        }

        .summary-label {
            font-size: 0.9em;
            color: #64748b;
            margin-top: 6px;
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
            font-size: 1.3em;
            color: white;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #94a3b8;
        }

        .empty-state .icon {
            font-size: 4em;
            margin-bottom: 16px;
        }

        .empty-state p {
            font-size: 1.1em;
            line-height: 1.6;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            body {
                padding: 12px;
            }

            .stats-header {
                padding: 20px;
            }

            .stats-header h1 {
                font-size: 1.4em;
            }

            .controls-section {
                flex-direction: column;
                align-items: stretch;
                gap: 16px;
            }

            .control-group {
                flex-direction: column;
                align-items: stretch;
                gap: 8px;
            }

            .btn-group {
                flex-wrap: wrap;
                justify-content: center;
            }

            .chart-container {
                height: 300px;
            }

            .legend-section {
                flex-direction: column;
                align-items: center;
                gap: 12px;
            }

            .summary-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 400px) {
            .summary-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body class="doing-theme">
    <div id="loadingState" class="loading">×˜×•×¢×Ÿ...</div>

    <div id="statsContainer" class="stats-container" style="display: none;">
        <div class="stats-header">
            <div class="logo-container">
                <img src="doing-logo-transparent2.png" alt="Doing - Being. Doing. Playing." class="app-logo">
            </div>
            <h1>×¡×˜×˜×™×¡×˜×™×§×”</h1>
            <div id="kidName" class="kid-name"></div>
            <a href="admin.html" class="back-link">â† ×—×–×¨×” ×œ× ×™×”×•×œ</a>
        </div>

        <div class="controls-section">
            <div class="control-group">
                <label>×˜×•×•×— ×–××Ÿ:</label>
                <div class="btn-group" id="dateRangeButtons">
                    <button class="btn" data-range="7">7 ×™××™×</button>
                    <button class="btn active" data-range="30">30 ×™××™×</button>
                    <button class="btn" data-range="90">90 ×™××™×</button>
                    <button class="btn" data-range="all">×”×›×œ</button>
                </div>
            </div>
            <div class="control-group">
                <label>×ª×¦×•×’×”:</label>
                <div class="btn-group" id="viewButtons">
                    <button class="btn active" data-view="daily">×™×•××™</button>
                    <button class="btn" data-view="aggregated">××¦×˜×‘×¨</button>
                </div>
            </div>
        </div>

        <div class="summary-section">
            <h2 class="summary-title">×¡×™×›×•×</h2>
            <div class="summary-grid">
                <div class="summary-card">
                    <div id="totalPoints" class="summary-value">0</div>
                    <div class="summary-label">×¡×”"×› × ×§×•×“×•×ª ×‘×ª×§×•×¤×”</div>
                </div>
                <div class="summary-card">
                    <div id="regularTotal" class="summary-value regular">0</div>
                    <div class="summary-label">× ×§×•×“×•×ª ××©×™××•×ª ×¨×’×™×œ×•×ª</div>
                </div>
                <div class="summary-card">
                    <div id="bonusTotal" class="summary-value bonus">0</div>
                    <div class="summary-label">× ×§×•×“×•×ª ×‘×•× ×•×¡</div>
                </div>
                <div class="summary-card">
                    <div id="activeDays" class="summary-value">0</div>
                    <div class="summary-label">×™××™× ×¤×¢×™×œ×™×</div>
                </div>
            </div>
        </div>

        <div class="chart-section">
            <h2 class="chart-title" id="chartTitle">× ×§×•×“×•×ª ×œ×¤×™ ×™×•×</h2>
            <div class="chart-container">
                <canvas id="statsChart"></canvas>
            </div>
            <div class="legend-section" id="legendSection">
                <div class="legend-item">
                    <div class="legend-color regular"></div>
                    <span>××©×™××•×ª ×¨×’×™×œ×•×ª</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color bonus"></div>
                    <span>×‘×•× ×•×¡</span>
                </div>
                <div class="legend-item legend-total" style="display: none;">
                    <div class="legend-color total"></div>
                    <span>×¡×”"×›</span>
                </div>
            </div>
        </div>

        <div id="emptyState" class="chart-section" style="display: none;">
            <div class="empty-state">
                <div class="icon">ğŸ“Š</div>
                <p>××™×Ÿ × ×ª×•× ×™× ×œ×”×¦×’×” ×¢×“×™×™×Ÿ</p>
                <p style="margin-top: 10px;">×”× ×ª×•× ×™× ×™×•×¤×™×¢×• ×œ××—×¨ ×©×”×™×œ×“ ×™×©×œ×™× ××©×™××•×ª</p>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDHE7FKHJ92rXXfz_3hLX8e9s8lC9g9g9o",
            authDomain: "aba-ai-d74f5.firebaseapp.com",
            projectId: "aba-ai-d74f5",
            storageBucket: "aba-ai-d74f5.firebasestorage.app",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef123456"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let kidId = null;
        let kidData = null;
        let statsData = null;
        let chart = null;
        let currentRange = 30;
        let currentView = 'daily';

        // Initialize
        window.onload = async function() {
            const urlParams = new URLSearchParams(window.location.search);
            kidId = urlParams.get('kid');

            if (!kidId) {
                alert('×œ× ×¦×•×™×Ÿ ×™×œ×“');
                window.location.href = 'admin.html';
                return;
            }

            await loadData();
            setupEventListeners();

            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('statsContainer').style.display = 'block';

            renderChart();
        };

        async function loadData() {
            // Load kid data
            const kidDoc = await db.collection('kids').doc(kidId).get();
            if (!kidDoc.exists) {
                alert('×™×œ×“ ×œ× × ××¦×');
                window.location.href = 'admin.html';
                return;
            }
            kidData = kidDoc.data();
            document.getElementById('kidName').textContent = kidData.name;

            // Load stats data
            const statsDoc = await db.collection('kidStats').doc(kidId).get();
            if (statsDoc.exists) {
                statsData = statsDoc.data();
            } else {
                statsData = { kidId: kidId, dailyStats: {} };
            }
        }

        function setupEventListeners() {
            // Date range buttons
            document.querySelectorAll('#dateRangeButtons .btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('#dateRangeButtons .btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentRange = btn.dataset.range === 'all' ? 'all' : parseInt(btn.dataset.range);
                    renderChart();
                });
            });

            // View buttons
            document.querySelectorAll('#viewButtons .btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('#viewButtons .btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentView = btn.dataset.view;
                    document.getElementById('chartTitle').textContent =
                        currentView === 'daily' ? '× ×§×•×“×•×ª ×œ×¤×™ ×™×•×' : '× ×§×•×“×•×ª ××¦×˜×‘×¨×•×ª';
                    // Show/hide total legend based on view
                    document.querySelector('.legend-total').style.display =
                        currentView === 'aggregated' ? 'flex' : 'none';
                    renderChart();
                });
            });
        }

        function getFilteredData() {
            const dailyStats = statsData.dailyStats || {};
            const dates = Object.keys(dailyStats).sort();

            if (dates.length === 0) return [];

            let filteredDates = dates;

            if (currentRange !== 'all') {
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - currentRange);
                const cutoffStr = cutoffDate.toISOString().split('T')[0];
                filteredDates = dates.filter(d => d >= cutoffStr);
            }

            return filteredDates.map(date => ({
                date,
                regularPoints: dailyStats[date].regularPoints || 0,
                bonusPoints: dailyStats[date].bonusPoints || 0
            }));
        }

        function formatDateLabel(dateStr) {
            const date = new Date(dateStr);
            const day = date.getDate();
            const month = date.getMonth() + 1;
            return `${day}/${month}`;
        }

        function updateSummary(data) {
            let totalRegular = 0;
            let totalBonus = 0;
            let activeDays = 0;

            data.forEach(d => {
                totalRegular += d.regularPoints;
                totalBonus += d.bonusPoints;
                if (d.regularPoints > 0 || d.bonusPoints > 0) {
                    activeDays++;
                }
            });

            const total = totalRegular + totalBonus;

            document.getElementById('totalPoints').textContent = total.toFixed(1);
            document.getElementById('regularTotal').textContent = totalRegular.toFixed(1);
            document.getElementById('bonusTotal').textContent = totalBonus.toFixed(1);
            document.getElementById('activeDays').textContent = activeDays;
        }

        function renderChart() {
            const data = getFilteredData();

            // Show/hide empty state
            const chartSection = document.querySelector('.chart-section');
            const emptyState = document.getElementById('emptyState');

            if (data.length === 0) {
                chartSection.style.display = 'none';
                emptyState.style.display = 'block';
                updateSummary([]);
                return;
            } else {
                chartSection.style.display = 'block';
                emptyState.style.display = 'none';
            }

            updateSummary(data);

            const labels = data.map(d => formatDateLabel(d.date));
            let regularData, bonusData;

            let totalData = [];

            if (currentView === 'daily') {
                regularData = data.map(d => d.regularPoints);
                bonusData = data.map(d => d.bonusPoints);
            } else {
                // Aggregated view - cumulative sum
                let cumRegular = 0;
                let cumBonus = 0;
                let cumTotal = 0;
                regularData = data.map(d => {
                    cumRegular += d.regularPoints;
                    return cumRegular;
                });
                bonusData = data.map(d => {
                    cumBonus += d.bonusPoints;
                    return cumBonus;
                });
                totalData = data.map(d => {
                    cumTotal += d.regularPoints + d.bonusPoints;
                    return cumTotal;
                });
            }

            const ctx = document.getElementById('statsChart').getContext('2d');

            if (chart) {
                chart.destroy();
            }

            const chartType = currentView === 'daily' ? 'bar' : 'line';

            chart = new Chart(ctx, {
                type: chartType,
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: '××©×™××•×ª ×¨×’×™×œ×•×ª',
                            data: regularData,
                            backgroundColor: 'rgba(102, 126, 234, 0.8)',
                            borderColor: '#667eea',
                            borderWidth: currentView === 'aggregated' ? 3 : 0,
                            pointRadius: currentView === 'aggregated' ? 4 : 0,
                            pointBackgroundColor: '#667eea',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            fill: false,
                            tension: 0.3
                        },
                        {
                            label: '×‘×•× ×•×¡',
                            data: bonusData,
                            backgroundColor: 'rgba(245, 166, 35, 0.8)',
                            borderColor: '#f5a623',
                            borderWidth: currentView === 'aggregated' ? 3 : 0,
                            pointRadius: currentView === 'aggregated' ? 4 : 0,
                            pointBackgroundColor: '#f5a623',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            fill: false,
                            tension: 0.3
                        },
                        // Total line - only shown in aggregated view
                        ...(currentView === 'aggregated' ? [{
                            label: '×¡×”"×›',
                            data: totalData,
                            backgroundColor: 'rgba(16, 185, 129, 0.8)',
                            borderColor: '#10b981',
                            borderWidth: 3,
                            pointRadius: 4,
                            pointBackgroundColor: '#10b981',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            fill: false,
                            tension: 0.3
                        }] : [])
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false // We have our own custom legend
                        },
                        tooltip: {
                            rtl: true,
                            textDirection: 'rtl',
                            callbacks: {
                                title: function(context) {
                                    const index = context[0].dataIndex;
                                    return data[index].date;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: currentView === 'daily',
                            grid: {
                                display: false
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 0
                            }
                        },
                        y: {
                            stacked: currentView === 'daily',
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return value.toFixed(1);
                                }
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
