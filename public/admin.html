<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>× ×™×”×•×œ ×™×œ×“×™× - ABA</title>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- Doing Theme -->
    <link rel="stylesheet" href="doing-theme-light.css">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            direction: rtl;
        }

        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .admin-header {
            background: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .admin-header h1 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .back-link {
            display: inline-block;
            margin-top: 10px;
            color: #667eea;
            text-decoration: none;
            font-weight: bold;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        .kids-list {
            background: white;
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .kids-list h2 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .kid-item {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .kid-item:last-child {
            border-bottom: none;
        }

        .kid-info h3 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .kid-tasks {
            font-size: 0.9em;
            color: #666;
        }

        .kid-links {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .add-kid-form {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .add-kid-form h2 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #667eea;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 2px solid #eee;
            border-radius: 10px;
            font-size: 1em;
            direction: rtl;
            text-align: right;
        }

        .tasks-builder {
            margin-top: 20px;
        }

        .tasks-builder h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .task-input-row {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
        }

        .task-main-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .task-input-row input {
            flex: 1;
            padding: 10px;
            border: 2px solid #eee;
            border-radius: 10px;
            direction: rtl;
            text-align: right;
        }

        .task-input-row button {
            padding: 10px 15px;
            border: none;
            border-radius: 10px;
            background: #ff6b6b;
            color: white;
            cursor: pointer;
        }

        .emoji-display {
            width: 60px;
            height: 42px;
            text-align: center;
            font-size: 1.5em;
            border: 2px solid #eee;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background: white;
            transition: all 0.3s ease;
        }

        .emoji-display:hover {
            border-color: #667eea;
            transform: scale(1.05);
        }

        /* Color Schema Options */
        .color-schema-option:has(input:checked) {
            border-color: #667eea;
            background: #f0f0ff;
        }

        .color-schema-option:hover {
            border-color: #999;
        }

        /* Emoji Picker Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .modal.active {
            display: flex !important;
            align-items: center;
            justify-content: center;
        }

        body.modal-open {
            overflow: hidden;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-height: 90vh;
            overflow-y: auto;
            margin: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #667eea;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #666;
        }

        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }

        .emoji-item {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            cursor: pointer;
            border: 2px solid #eee;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .emoji-item:hover {
            transform: scale(1.2);
            border-color: #667eea;
            background: #f0f0ff;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.5em;
            color: white;
        }

        @media (max-width: 600px) {
            .kid-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .kid-links {
                width: 100%;
            }

            .emoji-grid {
                grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            }

            .modal-content {
                padding: 15px;
                margin: 10px;
                width: 95%;
                max-height: 95vh;
            }

            #cropCanvas {
                max-width: 100%;
                height: auto;
            }

            .resize-handle {
                width: 30px !important;
                height: 30px !important;
                top: -10px !important;
                left: -10px !important;
            }

            .resize-handle.resize-ne {
                right: -10px !important;
                left: auto !important;
            }

            .resize-handle.resize-sw {
                bottom: -10px !important;
                top: auto !important;
            }

            .resize-handle.resize-se {
                right: -10px !important;
                bottom: -10px !important;
                top: auto !important;
                left: auto !important;
            }
        }
    </style>
</head>
<body class="doing-theme">
    <div id="loadingState" class="loading">×˜×•×¢×Ÿ...</div>

    <div id="adminContainer" class="admin-container" style="display: none;">
        <div class="admin-header">
            <div class="logo-container">
                <img src="doing-logo-transparent2.png" alt="Doing - Being. Doing. Playing." class="app-logo">
            </div>
            <h1>ğŸ¯ × ×™×”×•×œ ×™×œ×“×™× ×•××©×™××•×ª ğŸ¯</h1>
            <a href="index.html" class="back-link">â† ×—×–×¨×” ×œ×œ×•×— ×¨××©×™</a>
        </div>

        <div class="kids-list">
            <h2>×¨×©×™××ª ×™×œ×“×™×</h2>
            <div id="kidsList"></div>
        </div>

        <div class="add-kid-form">
            <h2 id="formTitle">×”×•×¡×£ ×™×œ×“ ×—×“×©</h2>

            <div class="form-group">
                <label>×©× ×”×™×œ×“:</label>
                <input type="text" id="newKidName" placeholder="×”×›× ×¡ ×©×">
            </div>

            <div class="form-group">
                <label>×ª××•× ×ª ×¤×¨×•×¤×™×œ:</label>
                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <input type="file" id="kidImageUpload" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                    <button type="button" class="btn btn-secondary" onclick="document.getElementById('kidImageUpload').click()">ğŸ“¤ ×”×¢×œ×” ×ª××•× ×”</button>
                    <div id="imagePreview" style="display: none; position: relative;">
                        <img id="previewImg" style="width: 100px; height: 100px; object-fit: cover; border-radius: 50%; border: 3px solid #667eea;">
                        <button type="button" onclick="removeImage()" style="position: absolute; top: -5px; right: -5px; width: 25px; height: 25px; border-radius: 50%; background: #ff6b6b; color: white; border: none; cursor: pointer; font-weight: bold;">Ã—</button>
                    </div>
                    <small style="color: #666; width: 100%;">××• ×”×©×ª××© ×‘×©× ×§×•×‘×¥ ×§×™×™×:</small>
                    <input type="text" id="kidImageName" placeholder="×œ×“×•×’××”: lenny-small.png" style="flex: 1;">
                </div>
                <input type="hidden" id="kidImageData">
            </div>

            <div class="form-group">
                <label>×¡×›×•× ×›×¡×£ ($):</label>
                <input type="number" id="kidMoney" placeholder="0.00" step="0.01" min="0">
            </div>

            <div class="form-group">
                <label>×¤×¨×¡ ×™×•××™ ×‘×¢×‘×•×¨ ×¡×™×•× ×›×œ ×”××©×™××•×ª ($):</label>
                <input type="number" id="kidDailyReward" placeholder="0.50" step="0.01" min="0" value="0.50">
            </div>

            <div class="form-group">
                <label>×¡×•×’ ××˜×‘×¢:</label>
                <select id="coinStyle" onchange="toggleCoinImageInput()">
                    <option value="dollar">×“×•×œ×¨ ($)</option>
                    <option value="shekel">×©×§×œ (â‚ª)</option>
                    <option value="custom">×ª××•× ×” ××•×ª×××ª ××™×©×™×ª</option>
                </select>
            </div>

            <div class="form-group" id="coinImageGroup" style="display: none;">
                <label>×ª××•× ×ª ××˜×‘×¢:</label>
                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <input type="file" id="coinImageUpload" accept="image/*" style="display: none;" onchange="handleCoinImageUpload(event)">
                    <button type="button" class="btn btn-secondary" onclick="document.getElementById('coinImageUpload').click()">ğŸ“¤ ×”×¢×œ×” ×ª××•× ×”</button>
                    <div id="coinImagePreview" style="display: none; position: relative;">
                        <img id="coinPreviewImg" style="width: 50px; height: 50px; object-fit: cover; border-radius: 50%; border: 3px solid #ffd700;">
                        <button type="button" onclick="removeCoinImage()" style="position: absolute; top: -5px; right: -5px; width: 25px; height: 25px; border-radius: 50%; background: #ff6b6b; color: white; border: none; cursor: pointer; font-weight: bold;">Ã—</button>
                    </div>
                    <small style="color: #666; width: 100%;">××• ×”×©×ª××© ×‘×©× ×§×•×‘×¥ ×§×™×™×:</small>
                    <input type="text" id="coinImageName" placeholder="×œ×“×•×’××”: coin.png" style="flex: 1;">
                </div>
                <input type="hidden" id="coinImageData">
            </div>

            <div class="form-group">
                <label>×¢×¨×›×ª ×¦×‘×¢×™×:</label>
                <div class="color-schema-options" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px;">
                    <label class="color-schema-option" style="display: flex; align-items: center; gap: 10px; padding: 12px; border: 3px solid #eee; border-radius: 12px; cursor: pointer; transition: all 0.2s;">
                        <input type="radio" name="colorSchema" value="purple" checked style="display: none;">
                        <div style="width: 40px; height: 40px; border-radius: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); box-shadow: 0 2px 8px rgba(102,126,234,0.4);"></div>
                        <span style="font-weight: bold; color: #333;">×¡×’×•×œ ×§×œ××¡×™</span>
                    </label>
                    <label class="color-schema-option" style="display: flex; align-items: center; gap: 10px; padding: 12px; border: 3px solid #eee; border-radius: 12px; cursor: pointer; transition: all 0.2s;">
                        <input type="radio" name="colorSchema" value="pink" style="display: none;">
                        <div style="width: 40px; height: 40px; border-radius: 10px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); box-shadow: 0 2px 8px rgba(240,147,251,0.4);"></div>
                        <span style="font-weight: bold; color: #333;">×•×¨×•×“ ×—×œ×•××™</span>
                    </label>
                    <label class="color-schema-option" style="display: flex; align-items: center; gap: 10px; padding: 12px; border: 3px solid #eee; border-radius: 12px; cursor: pointer; transition: all 0.2s;">
                        <input type="radio" name="colorSchema" value="blue" style="display: none;">
                        <div style="width: 40px; height: 40px; border-radius: 10px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); box-shadow: 0 2px 8px rgba(79,172,254,0.4);"></div>
                        <span style="font-weight: bold; color: #333;">×›×—×•×œ ×©××™×™×</span>
                    </label>
                    <label class="color-schema-option" style="display: flex; align-items: center; gap: 10px; padding: 12px; border: 3px solid #eee; border-radius: 12px; cursor: pointer; transition: all 0.2s;">
                        <input type="radio" name="colorSchema" value="dark" style="display: none;">
                        <div style="width: 40px; height: 40px; border-radius: 10px; background: linear-gradient(135deg, #2c3e50 0%, #1a1a2e 100%); box-shadow: 0 2px 8px rgba(44,62,80,0.4);"></div>
                        <span style="font-weight: bold; color: #333;">×›×”×” ××•×“×¨× ×™</span>
                    </label>
                </div>
            </div>

            <div class="form-group">
                <label>×›×•×ª×¨×ª ×”×“×£ (×‘×¨×™×¨×ª ××—×“×œ: "ğŸŒŸ ×”××©×™××•×ª ×©×œ [×©×] ğŸŒŸ"):</label>
                <input type="text" id="headerLabel" placeholder='×œ×“×•×’××”: "ğŸ¯ ×œ×•×— ×”××©×™××•×ª ×©×œ [×©×]" ××• "âœ¨ [×©×] âœ¨"'>
                <small style="color: #666; font-size: 0.9em;">×”×©××¨ ×¨×™×§ ×œ×˜×§×¡×˜ ×‘×¨×™×¨×ª ××—×“×œ. ×”×©×ª××© ×‘-[×©×] ×œ×”×›×œ×œ×ª ×©× ×”×™×œ×“.</small>
            </div>

            <div class="form-group">
                <label>×˜×§×¡×˜ ×§×•×¤×ª ×”×—×™×¡×›×•×Ÿ (×‘×¨×™×¨×ª ××—×“×œ: "×§×•×¤×ª ×”×—×™×¡×›×•×Ÿ ×©×œ [×©×]"):</label>
                <input type="text" id="savingsLabel" placeholder='×œ×“×•×’××”: "×”×—×™×¡×›×•×Ÿ ×©×œ×™" ××• "×”×›×¡×£ ×©×œ [×©×]"'>
                <small style="color: #666; font-size: 0.9em;">×”×©××¨ ×¨×™×§ ×œ×˜×§×¡×˜ ×‘×¨×™×¨×ª ××—×“×œ. ×”×©×ª××© ×‘-[×©×] ×œ×”×›×œ×œ×ª ×©× ×”×™×œ×“.</small>
            </div>

            <div class="form-group">
                <label>×›×•×ª×¨×ª ××©×™××•×ª ×¨×’×™×œ×•×ª (×‘×¨×™×¨×ª ××—×“×œ: "××©×™××•×ª ×¨×’×™×œ×•×ª"):</label>
                <input type="text" id="regularTasksHeader" placeholder='×œ×“×•×’××”: "ğŸ“ ×”××©×™××•×ª ×©×œ×™" ××• ×”×©××¨ ×¨×™×§ ×œ×”×¡×ª×¨×”'>
                <small style="color: #666; font-size: 0.9em;">×”×©××¨ ×¨×™×§ ×œ×”×¡×ª×¨×ª ×”×›×•×ª×¨×ª ×œ×’××¨×™.</small>
            </div>

            <div class="form-group">
                <label>×›×•×ª×¨×ª ××©×™××•×ª ×‘×•× ×•×¡ (×‘×¨×™×¨×ª ××—×“×œ: "ğŸ’° ××©×™××•×ª ×‘×•× ×•×¡ ğŸ’°"):</label>
                <input type="text" id="bonusTasksHeader" placeholder='×œ×“×•×’××”: "ğŸ ××©×™××•×ª ××™×•×—×“×•×ª" ××• ×”×©××¨ ×¨×™×§ ×œ×”×¡×ª×¨×”'>
                <small style="color: #666; font-size: 0.9em;">×”×©××¨ ×¨×™×§ ×œ×”×¡×ª×¨×ª ×”×›×•×ª×¨×ª ×œ×’××¨×™.</small>
            </div>

            <div class="form-group">
                <label>×›×•×ª×¨×ª ×¤×™× ×ª ×”×¨×’×¢×” (×‘×¨×™×¨×ª ××—×“×œ: "ğŸ§˜ ×¤×™× ×ª ×”×”×¨×’×¢×” ğŸ§˜"):</label>
                <input type="text" id="calmDownHeader" placeholder='×œ×“×•×’××”: "ğŸ˜Œ ×× ×•×—×” ×•×¨×’×™×¢×”" ××• ×”×©××¨ ×¨×™×§ ×œ×”×¡×ª×¨×”'>
                <small style="color: #666; font-size: 0.9em;">×”×©××¨ ×¨×™×§ ×œ×”×¡×ª×¨×ª ×”×›×•×ª×¨×ª ×œ×’××¨×™.</small>
            </div>

            <div class="tasks-builder">
                <h3>××©×™××•×ª:</h3>
                <div id="tasksList"></div>
                <button class="btn btn-secondary" onclick="addTaskRow()">+ ×”×•×¡×£ ××©×™××”</button>
            </div>

            <button class="btn btn-primary" id="saveButton" onclick="saveKid()" style="margin-top: 20px; width: 100%;">×©××•×¨ ×™×œ×“</button>
            <button class="btn btn-secondary" id="cancelButton" onclick="cancelEdit()" style="margin-top: 10px; width: 100%; display: none;">×‘×™×˜×•×œ</button>
        </div>
    </div>

    <!-- Image Crop Modal -->
    <div id="cropModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>×—×ª×•×š ×ª××•× ×”</h3>
                <button class="close-btn" onclick="closeCropModal()">Ã—</button>
            </div>
            <div style="text-align: center; padding: 20px;">
                <div style="position: relative; display: inline-block; max-width: 100%;">
                    <canvas id="cropCanvas" style="max-width: 100%; border: 2px solid #667eea; border-radius: 10px;"></canvas>
                    <div id="cropBox" style="position: absolute; border: 3px solid #ffd700; cursor: move; box-shadow: 0 0 0 9999px rgba(0,0,0,0.5);">
                        <!-- Resize handles -->
                        <div class="resize-handle resize-nw" style="position: absolute; top: -5px; left: -5px; width: 20px; height: 20px; background: #ffd700; border: 2px solid white; border-radius: 50%; cursor: nw-resize;"></div>
                        <div class="resize-handle resize-ne" style="position: absolute; top: -5px; right: -5px; width: 20px; height: 20px; background: #ffd700; border: 2px solid white; border-radius: 50%; cursor: ne-resize;"></div>
                        <div class="resize-handle resize-sw" style="position: absolute; bottom: -5px; left: -5px; width: 20px; height: 20px; background: #ffd700; border: 2px solid white; border-radius: 50%; cursor: sw-resize;"></div>
                        <div class="resize-handle resize-se" style="position: absolute; bottom: -5px; right: -5px; width: 20px; height: 20px; background: #ffd700; border: 2px solid white; border-radius: 50%; cursor: se-resize;"></div>
                    </div>
                </div>
                <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: center;">
                    <button class="btn btn-primary" onclick="applyCrop()">âœ‚ï¸ ×—×ª×•×š</button>
                    <button class="btn btn-secondary" onclick="closeCropModal()">×‘×™×˜×•×œ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Emoji Picker Modal -->
    <div id="emojiModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>×‘×—×¨ ××™×™×§×•×Ÿ</h3>
                <button class="close-btn" onclick="closeEmojiPicker()">Ã—</button>
            </div>
            <div class="emoji-grid" id="emojiGrid"></div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDHE7FKHJ92rXXfz_3hLX8e9s8lC9g9g9o",
            authDomain: "aba-ai-d74f5.firebaseapp.com",
            projectId: "aba-ai-d74f5",
            storageBucket: "aba-ai-d74f5.firebasestorage.app",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef123456"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Custom emoji images from emojis/ directory
        // Add your image filenames here (they should be in the emojis/ folder)
        const emojiImages = [
            'irobot-icon.png',
            'friendship.png','hold.png','listen.png','solving.png','strength.png'
            // Example: 'star.png', 'heart.png', 'trophy.png'
            // Add all your emoji image filenames here
        ];

        // Emoji categories
        const emojis = [
            // Faces & Emotions
            'ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜…', 'ğŸ˜‚', 'ğŸ¤£', 'ğŸ˜Š', 'ğŸ˜‡', 'ğŸ™‚', 'ğŸ™ƒ', 'ğŸ˜‰', 'ğŸ˜Œ', 'ğŸ˜', 'ğŸ¥°', 'ğŸ˜˜',
            'ğŸ˜—', 'ğŸ˜™', 'ğŸ˜š', 'ğŸ˜‹', 'ğŸ˜›', 'ğŸ˜', 'ğŸ˜œ', 'ğŸ¤ª', 'ğŸ¤¨', 'ğŸ§', 'ğŸ¤“', 'ğŸ˜', 'ğŸ¤©', 'ğŸ¥³', 'ğŸ˜', 'ğŸ˜’',
            'ğŸ™ˆ', 'ğŸ«£',

            // Activities & Objects
            'ğŸ¯', 'ğŸ®', 'ğŸ²', 'ğŸ­', 'ğŸ¨', 'ğŸ¬', 'ğŸª', 'ğŸ°', 'ğŸ¸', 'ğŸ¹', 'ğŸº', 'ğŸ»', 'ğŸ¥', 'ğŸ¤', 'ğŸ§', 'ğŸ¼',
            'âš½', 'ğŸ€', 'ğŸˆ', 'âš¾', 'ğŸ¥', 'ğŸ¾', 'ğŸ', 'ğŸ‰', 'ğŸ¥', 'ğŸ±', 'ğŸª€', 'ğŸ“', 'ğŸ¸', 'ğŸ’', 'ğŸ‘', 'ğŸ¥',
            'ğŸ§’', 'ğŸ‘§', 'ğŸ‘¦', 'ğŸ‘¶', 'ğŸ–ï¸', 'ğŸ›', 'ğŸ¤', 'ğŸ‘«', 'ğŸ‘¬', 'ğŸ‘­',

            // Nature
            'ğŸŒ¸', 'ğŸŒº', 'ğŸŒ»', 'ğŸŒ·', 'ğŸŒ¹', 'ğŸ¥€', 'ğŸŒ¼', 'ğŸŒ±', 'ğŸŒ²', 'ğŸŒ³', 'ğŸŒ´', 'ğŸŒµ', 'ğŸŒ¾', 'ğŸŒ¿', 'â˜˜ï¸', 'ğŸ€',
            'â­', 'ğŸŒŸ', 'âœ¨', 'ğŸ’«', 'âš¡', 'ğŸ”¥', 'ğŸ’¥', 'â˜€ï¸', 'ğŸŒ™', 'â­', 'ğŸŒˆ', 'â˜ï¸', 'â›…', 'ğŸŒ¤ï¸', 'â›ˆï¸', 'ğŸŒ©ï¸',

            // Animals
            'ğŸ¶', 'ğŸ±', 'ğŸ­', 'ğŸ¹', 'ğŸ°', 'ğŸ¦Š', 'ğŸ»', 'ğŸ¼', 'ğŸ¨', 'ğŸ¯', 'ğŸ¦', 'ğŸ®', 'ğŸ·', 'ğŸ¸', 'ğŸµ', 'ğŸ”',
            'ğŸ§', 'ğŸ¦', 'ğŸ¤', 'ğŸ¦†', 'ğŸ¦…', 'ğŸ¦‰', 'ğŸ¦‡', 'ğŸº', 'ğŸ—', 'ğŸ´', 'ğŸ¦„', 'ğŸ', 'ğŸ›', 'ğŸ¦‹', 'ğŸŒ', 'ğŸ',

            // Food
            'ğŸ', 'ğŸ', 'ğŸŠ', 'ğŸ‹', 'ğŸŒ', 'ğŸ‰', 'ğŸ‡', 'ğŸ“', 'ğŸˆ', 'ğŸ’', 'ğŸ‘', 'ğŸ¥­', 'ğŸ', 'ğŸ¥¥', 'ğŸ¥', 'ğŸ…',
            'ğŸ¥‘', 'ğŸ†', 'ğŸ¥”', 'ğŸ¥•', 'ğŸŒ½', 'ğŸŒ¶ï¸', 'ğŸ¥’', 'ğŸ¥¬', 'ğŸ¥¦', 'ğŸ§„', 'ğŸ§…', 'ğŸ„', 'ğŸ¥œ', 'ğŸŒ°', 'ğŸ', 'ğŸ¥',

            // Activities & Daily Tasks
            'ğŸª¥', 'ğŸ§¸', 'ğŸ‘•', 'ğŸ’§', 'ğŸ¥ª', 'ğŸ‘Ÿ', 'ğŸ§¼', 'ğŸš¿', 'ğŸš½', 'ğŸ¥¤', 'ğŸ›', 'ğŸ§´', 'ğŸ§»', 'ğŸ§¹', 'ğŸ§º', 'ğŸ§½',
            'â°', 'â±ï¸', 'âŒš', 'ğŸ“š', 'ğŸ“–', 'âœï¸', 'âœ’ï¸', 'ğŸ–Šï¸', 'ğŸ–ï¸', 'ğŸ“', 'ğŸ’', 'ğŸ“', 'ğŸ“', 'ğŸ“', 'ğŸ“Œ', 'ğŸ“',
            'ğŸ›ï¸', 'ğŸ›‹ï¸', 'ğŸª‘', 'ğŸšª', 'ğŸªŸ', 'ğŸ ', 'ğŸ¡', 'ğŸ¢',

            // Electronics & Screens
            'ğŸ“±', 'ğŸ’»', 'ğŸ–¥ï¸', 'âŒ¨ï¸', 'ğŸ–±ï¸', 'ğŸ–¨ï¸', 'ğŸ“º', 'ğŸ“·', 'ğŸ“¹', 'ğŸ¥', 'ğŸ“', 'â˜ï¸', 'ğŸ“Ÿ', 'ğŸ“ ', 'ğŸ”‹', 'ğŸ”Œ',

            // Symbols
            'ğŸ’°', 'ğŸ’µ', 'ğŸ’´', 'ğŸ’¶', 'ğŸ’·', 'ğŸª™', 'ğŸ’³', 'ğŸ†', 'ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰', 'ğŸ–ï¸', 'ğŸ…', 'ğŸ—ï¸', 'âœ…', 'â˜‘ï¸',
            'â¤ï¸', 'ğŸ§¡', 'ğŸ’›', 'ğŸ’š', 'ğŸ’™', 'ğŸ’œ', 'ğŸ–¤', 'ğŸ¤', 'ğŸ¤', 'ğŸ’–', 'ğŸ’', 'ğŸ’—', 'ğŸ’“', 'ğŸ’', 'ğŸ’•', 'ğŸ’Œ'
        ];

        let currentTaskRow = null;
        let editingKidId = null;

        // Initialize
        window.onload = async function() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('adminContainer').style.display = 'block';

            await loadKidsList();
            addTaskRow(); // Add first task row
            initEmojiGrid();
        };

        // Initialize emoji grid
        function initEmojiGrid() {
            const emojiGrid = document.getElementById('emojiGrid');

            // Add regular emojis
            emojis.forEach(emoji => {
                const emojiItem = document.createElement('div');
                emojiItem.className = 'emoji-item';
                emojiItem.textContent = emoji;
                emojiItem.onclick = () => selectEmoji(emoji);
                emojiGrid.appendChild(emojiItem);
            });

            // Add custom emoji images from emojis/ directory
            emojiImages.forEach(imageName => {
                const emojiItem = document.createElement('div');
                emojiItem.className = 'emoji-item';
                emojiItem.innerHTML = `<img src="emojis/${imageName}" style="width: 40px; height: 40px; object-fit: contain;" />`;
                emojiItem.onclick = () => selectEmoji(`IMG:${imageName}`);
                emojiGrid.appendChild(emojiItem);
            });
        }

        // Load kids list
        async function loadKidsList() {
            const snapshot = await db.collection('kids').get();
            const kidsList = document.getElementById('kidsList');
            kidsList.innerHTML = '';

            if (snapshot.empty) {
                kidsList.innerHTML = '<p style="text-align: center; color: #666;">××™×Ÿ ×™×œ×“×™× ×‘××¢×¨×›×ª</p>';
                return;
            }

            snapshot.forEach(doc => {
                const kid = doc.data();
                const kidDiv = document.createElement('div');
                kidDiv.className = 'kid-item';
                // Check if kid has new board layout
                const hasNewBoard = kid.boardLayout && kid.boardLayout.items && kid.boardLayout.items.length > 0;
                const boardUrl = hasNewBoard ? 'board.html' : 'index.html';

                kidDiv.innerHTML = `
                    <div class="kid-info">
                        <h3>${kid.name}</h3>
                        <div class="kid-tasks">${kid.tasks.length} ××©×™××•×ª | $${(kid.totalMoney || 0).toFixed(2)}</div>
                    </div>
                    <div class="kid-links">
                        <a href="${boardUrl}?kid=${doc.id}" class="btn btn-primary">×œ×•×— ×™×œ×“</a>
                        <a href="${boardUrl}?kid=${doc.id}&mode=parent" class="btn btn-secondary">×œ×•×— ×”×•×¨×”</a>
                        <a href="board-builder.html?kid=${doc.id}" class="btn btn-primary" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">ğŸ¨ ×‘× ×” ×œ×•×—</a>
                        <button class="btn btn-primary" onclick="editKid('${doc.id}')">×¢×¨×•×š</button>
                        <button class="btn btn-secondary" onclick="copyKid('${doc.id}')">×”×¢×ª×§</button>
                    </div>
                `;
                kidsList.appendChild(kidDiv);
            });
        }

        // Task row management
        let taskCounter = 0;
        function addTaskRow() {
            const tasksList = document.getElementById('tasksList');
            const taskRow = document.createElement('div');
            taskRow.className = 'task-input-row';
            taskRow.id = `task-${taskCounter}`;

            taskRow.innerHTML = `
                <div class="task-main-row">
                    <div class="emoji-display" onclick="openEmojiPicker('task-${taskCounter}')" data-task-id="task-${taskCounter}">ğŸ¯</div>
                    <input type="text" placeholder="×ª×™××•×¨ ×”××©×™××”" data-type="title">
                    <input type="number" placeholder="×›××•×ª" data-type="quantity" min="1" value="1" style="width: 70px; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;" title="×›××•×ª ××©×™××•×ª (×‘×¨×™×¨×ª ××—×“×œ: 1)">
                    <select data-type="taskType" onchange="toggleTaskTypeInputs('task-${taskCounter}')" style="padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
                        <option value="regular">××©×™××” ×¨×’×™×œ×”</option>
                        <option value="bonus">××©×™××ª ×‘×•× ×•×¡</option>
                        <option value="calm-down">×¤×¢×™×œ×•×ª ×”×¨×’×¢×”</option>
                    </select>
                    <div class="reward-inputs" id="reward-task-${taskCounter}" style="display: none; gap: 10px;">
                        <input type="number" placeholder="××™× ×™××•× $" data-type="minReward" step="0.01" min="0" style="width: 100px; padding: 10px; border: 2px solid #ffd700; border-radius: 8px;">
                        <input type="number" placeholder="××§×¡×™××•× $" data-type="maxReward" step="0.01" min="0" style="width: 100px; padding: 10px; border: 2px solid #ffd700; border-radius: 8px;">
                    </div>
                    <div class="calm-down-inputs" id="calmdown-task-${taskCounter}" style="display: none; gap: 10px; flex-direction: column;">
                        <select data-type="activityType" style="padding: 10px; border: 2px solid #89CFF0; border-radius: 8px;">
                            <option value="paint">×œ×•×— ×¦×™×•×¨</option>
                            <option value="bubbles">××©×—×§ ×¤×™×¦×•×¥ ×‘×•×¢×•×ª</option>
                            <option value="xylophone">×§×¡×™×œ×•×¤×•×Ÿ ×¦×‘×¢×•× ×™</option>
                            <option value="breathing">×ª×¨×’×™×œ × ×©×™××•×ª</option>
                            <option value="link">×§×™×©×•×¨ (×¡×¨×˜×•×Ÿ/××ª×¨)</option>
                        </select>
                        <input type="text" placeholder="URL (×¨×§ ×× ×‘×—×¨×ª ×§×™×©×•×¨)" data-type="activityUrl" style="padding: 10px; border: 2px solid #89CFF0; border-radius: 8px;">
                    </div>
                    <label style="display: flex; align-items: center; gap: 5px; padding: 5px;">
                        <input type="checkbox" data-type="requiresTestimony" style="width: 20px; height: 20px;">
                        <span style="font-size: 14px;">×“×•×¨×© ×¢×“×•×ª</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 5px; padding: 5px;">
                        <input type="checkbox" data-type="trackTime" style="width: 20px; height: 20px;">
                        <span style="font-size: 14px;">â±ï¸ ××¢×§×‘ ×–××Ÿ</span>
                    </label>
                    <button onclick="removeTaskRow('task-${taskCounter}')">ğŸ—‘ï¸</button>
                </div>
            `;

            // Add days of week selector
            const daysContainer = document.createElement('div');
            daysContainer.className = 'days-selector';
            daysContainer.style.cssText = 'display: flex; gap: 8px; padding: 8px; margin-top: 5px; background: #f8f9fa; border-radius: 8px; flex-wrap: wrap;';
            daysContainer.innerHTML = `
                <span style="font-size: 13px; font-weight: bold; color: #667eea; align-self: center;">×™××™× ×¤×¢×™×œ×™×:</span>
                <label style="display: flex; align-items: center; gap: 3px; font-size: 12px;">
                    <input type="checkbox" data-day="0" checked style="width: 16px; height: 16px;">
                    <span>××³</span>
                </label>
                <label style="display: flex; align-items: center; gap: 3px; font-size: 12px;">
                    <input type="checkbox" data-day="1" checked style="width: 16px; height: 16px;">
                    <span>×‘×³</span>
                </label>
                <label style="display: flex; align-items: center; gap: 3px; font-size: 12px;">
                    <input type="checkbox" data-day="2" checked style="width: 16px; height: 16px;">
                    <span>×’×³</span>
                </label>
                <label style="display: flex; align-items: center; gap: 3px; font-size: 12px;">
                    <input type="checkbox" data-day="3" checked style="width: 16px; height: 16px;">
                    <span>×“×³</span>
                </label>
                <label style="display: flex; align-items: center; gap: 3px; font-size: 12px;">
                    <input type="checkbox" data-day="4" checked style="width: 16px; height: 16px;">
                    <span>×”×³</span>
                </label>
                <label style="display: flex; align-items: center; gap: 3px; font-size: 12px;">
                    <input type="checkbox" data-day="5" checked style="width: 16px; height: 16px;">
                    <span>×•×³</span>
                </label>
                <label style="display: flex; align-items: center; gap: 3px; font-size: 12px;">
                    <input type="checkbox" data-day="6" checked style="width: 16px; height: 16px;">
                    <span>×©×‘×ª</span>
                </label>
            `;
            taskRow.appendChild(daysContainer);

            tasksList.appendChild(taskRow);
            taskCounter++;
        }

        function toggleTaskTypeInputs(taskId) {
            const taskRow = document.getElementById(taskId);
            const taskType = taskRow.querySelector('[data-type="taskType"]').value;
            const rewardInputs = taskRow.querySelector('.reward-inputs');
            const calmDownInputs = taskRow.querySelector('.calm-down-inputs');

            if (taskType === 'bonus') {
                rewardInputs.style.display = 'flex';
                calmDownInputs.style.display = 'none';
            } else if (taskType === 'calm-down') {
                rewardInputs.style.display = 'none';
                calmDownInputs.style.display = 'flex';
            } else {
                rewardInputs.style.display = 'none';
                calmDownInputs.style.display = 'none';
            }
        }

        // Keep old name for backward compatibility
        function toggleRewardInputs(taskId) {
            toggleTaskTypeInputs(taskId);
        }

        // Image upload and crop functionality
        let currentImage = null;
        let cropState = {
            x: 0,
            y: 0,
            size: 200,
            isDragging: false,
            isResizing: false,
            resizeHandle: null,
            startX: 0,
            startY: 0,
            startSize: 0,
            startCropX: 0,
            startCropY: 0,
            minSize: 50
        };

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                alert('× × ×œ×‘×—×•×¨ ×§×•×‘×¥ ×ª××•× ×”');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    currentImage = img;
                    showCropModal();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function showCropModal() {
            const modal = document.getElementById('cropModal');
            const canvas = document.getElementById('cropCanvas');
            const ctx = canvas.getContext('2d');
            const cropBox = document.getElementById('cropBox');

            // Use the appropriate image (coin or kid)
            const imageToUse = isCoinCrop ? currentCoinImage : currentImage;

            // Calculate canvas size - smaller on mobile
            const isMobile = window.innerWidth <= 600;
            const maxSize = isMobile ? Math.min(window.innerWidth - 60, 400) : 500;
            let width = imageToUse.width;
            let height = imageToUse.height;

            if (width > maxSize || height > maxSize) {
                if (width > height) {
                    height = (height / width) * maxSize;
                    width = maxSize;
                } else {
                    width = (width / height) * maxSize;
                    height = maxSize;
                }
            }

            canvas.width = width;
            canvas.height = height;

            // Draw image
            ctx.drawImage(imageToUse, 0, 0, width, height);

            // Initialize crop box (square in center)
            const cropSize = Math.min(width, height) * 0.7;
            cropState.size = cropSize;
            cropState.x = (width - cropSize) / 2;
            cropState.y = (height - cropSize) / 2;

            updateCropBox();

            // Add drag handlers for crop box
            cropBox.onmousedown = startDrag;
            cropBox.ontouchstart = startDrag;

            // Add resize handlers for each corner
            const handles = cropBox.querySelectorAll('.resize-handle');
            handles.forEach(handle => {
                handle.onmousedown = (e) => startResize(e, handle.classList[1]);
                handle.ontouchstart = (e) => startResize(e, handle.classList[1]);
            });

            // Global move and release handlers
            document.onmousemove = handleMove;
            document.onmouseup = stopDragOrResize;
            document.ontouchmove = handleMove;
            document.ontouchend = stopDragOrResize;

            modal.classList.add('active');
            document.body.classList.add('modal-open');

            console.log('Modal opened:', modal.classList.contains('active'));
        }

        function updateCropBox() {
            const cropBox = document.getElementById('cropBox');
            cropBox.style.left = cropState.x + 'px';
            cropBox.style.top = cropState.y + 'px';
            cropBox.style.width = cropState.size + 'px';
            cropBox.style.height = cropState.size + 'px';
        }

        function startDrag(e) {
            // Don't start dragging if clicking on a resize handle
            if (e.target.classList.contains('resize-handle')) return;

            e.preventDefault();
            e.stopPropagation();
            cropState.isDragging = true;

            const cropBox = document.getElementById('cropBox');
            const rect = cropBox.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            // Store offset from top-left corner of crop box
            cropState.startX = clientX - rect.left;
            cropState.startY = clientY - rect.top;
        }

        function startResize(e, handle) {
            e.preventDefault();
            e.stopPropagation();
            cropState.isResizing = true;
            cropState.resizeHandle = handle;

            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            cropState.startX = clientX;
            cropState.startY = clientY;
            cropState.startSize = cropState.size;
            cropState.startCropX = cropState.x;
            cropState.startCropY = cropState.y;
        }

        function handleMove(e) {
            if (cropState.isDragging) {
                dragCropBox(e);
            } else if (cropState.isResizing) {
                resizeCropBox(e);
            }
        }

        function dragCropBox(e) {
            e.preventDefault();

            const canvas = document.getElementById('cropCanvas');
            const canvasRect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            // Calculate new position relative to canvas
            let newX = clientX - canvasRect.left - cropState.startX;
            let newY = clientY - canvasRect.top - cropState.startY;

            // Keep within canvas bounds
            newX = Math.max(0, Math.min(newX, canvas.width - cropState.size));
            newY = Math.max(0, Math.min(newY, canvas.height - cropState.size));

            cropState.x = newX;
            cropState.y = newY;
            updateCropBox();
        }

        function resizeCropBox(e) {
            e.preventDefault();

            const canvas = document.getElementById('cropCanvas');
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            const deltaX = clientX - cropState.startX;
            const deltaY = clientY - cropState.startY;

            let newSize = cropState.startSize;
            let newX = cropState.startCropX;
            let newY = cropState.startCropY;

            // Handle different resize corners
            switch(cropState.resizeHandle) {
                case 'resize-se': // Bottom-right
                    newSize = Math.max(cropState.minSize, cropState.startSize + Math.max(deltaX, deltaY));
                    break;
                case 'resize-sw': // Bottom-left
                    newSize = Math.max(cropState.minSize, cropState.startSize + Math.max(-deltaX, deltaY));
                    newX = cropState.startCropX - (newSize - cropState.startSize);
                    break;
                case 'resize-ne': // Top-right
                    newSize = Math.max(cropState.minSize, cropState.startSize + Math.max(deltaX, -deltaY));
                    newY = cropState.startCropY - (newSize - cropState.startSize);
                    break;
                case 'resize-nw': // Top-left
                    newSize = Math.max(cropState.minSize, cropState.startSize + Math.max(-deltaX, -deltaY));
                    newX = cropState.startCropX - (newSize - cropState.startSize);
                    newY = cropState.startCropY - (newSize - cropState.startSize);
                    break;
            }

            // Keep within canvas bounds
            newX = Math.max(0, Math.min(newX, canvas.width - newSize));
            newY = Math.max(0, Math.min(newY, canvas.height - newSize));
            newSize = Math.min(newSize, canvas.width - newX, canvas.height - newY);

            cropState.size = newSize;
            cropState.x = newX;
            cropState.y = newY;
            updateCropBox();
        }

        function stopDragOrResize() {
            cropState.isDragging = false;
            cropState.isResizing = false;
            cropState.resizeHandle = null;
        }

        function applyCrop() {
            const canvas = document.getElementById('cropCanvas');
            const ctx = canvas.getContext('2d');

            // Use the appropriate image (coin or kid)
            const imageToUse = isCoinCrop ? currentCoinImage : currentImage;

            // Calculate scale factor
            const scaleX = imageToUse.width / canvas.width;
            const scaleY = imageToUse.height / canvas.height;

            // Create temporary canvas for cropped image
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');

            // Set final size to 200x200
            const finalSize = 200;
            tempCanvas.width = finalSize;
            tempCanvas.height = finalSize;

            // Draw cropped and resized image
            tempCtx.drawImage(
                imageToUse,
                cropState.x * scaleX,
                cropState.y * scaleY,
                cropState.size * scaleX,
                cropState.size * scaleY,
                0,
                0,
                finalSize,
                finalSize
            );

            // Convert to data URL - use PNG if image has transparency, otherwise JPEG
            let dataUrl;
            const imageData = tempCtx.getImageData(0, 0, finalSize, finalSize);
            let hasTransparency = false;

            // Check for any transparent pixels
            for (let i = 3; i < imageData.data.length; i += 4) {
                if (imageData.data[i] < 255) {
                    hasTransparency = true;
                    break;
                }
            }

            if (hasTransparency) {
                // Use PNG to preserve transparency
                dataUrl = tempCanvas.toDataURL('image/png');
            } else {
                // Use JPEG for smaller file size
                dataUrl = tempCanvas.toDataURL('image/jpeg', 0.85);
            }

            if (isCoinCrop) {
                // Update coin image preview and hidden field
                document.getElementById('coinImageData').value = dataUrl;
                document.getElementById('coinPreviewImg').src = dataUrl;
                document.getElementById('coinImagePreview').style.display = 'block';
                document.getElementById('coinImageName').value = ''; // Clear filename since we have uploaded image
                isCoinCrop = false; // Reset flag
            } else {
                // Update kid image preview and hidden field
                document.getElementById('kidImageData').value = dataUrl;
                document.getElementById('previewImg').src = dataUrl;
                document.getElementById('imagePreview').style.display = 'block';
                document.getElementById('kidImageName').value = ''; // Clear filename since we have uploaded image
            }

            closeCropModal();
        }

        function closeCropModal() {
            const modal = document.getElementById('cropModal');
            modal.classList.remove('active');
            document.body.classList.remove('modal-open');
            document.getElementById('kidImageUpload').value = ''; // Reset kid image file input
            document.getElementById('coinImageUpload').value = ''; // Reset coin image file input
            isCoinCrop = false; // Reset flag
        }

        function removeImage() {
            document.getElementById('kidImageData').value = '';
            document.getElementById('previewImg').src = '';
            document.getElementById('imagePreview').style.display = 'none';
        }

        // Coin image upload functionality
        let currentCoinImage = null;
        let isCoinCrop = false; // Track if we're cropping coin or kid image

        function handleCoinImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                alert('× × ×œ×‘×—×•×¨ ×§×•×‘×¥ ×ª××•× ×”');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    currentCoinImage = img;
                    isCoinCrop = true;
                    showCropModal();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function removeCoinImage() {
            document.getElementById('coinImageData').value = '';
            document.getElementById('coinPreviewImg').src = '';
            document.getElementById('coinImagePreview').style.display = 'none';
        }

        function toggleCoinImageInput() {
            const coinStyle = document.getElementById('coinStyle').value;
            const coinImageGroup = document.getElementById('coinImageGroup');

            if (coinStyle === 'custom') {
                coinImageGroup.style.display = 'block';
            } else {
                coinImageGroup.style.display = 'none';
            }
        }

        function removeTaskRow(taskId) {
            document.getElementById(taskId).remove();
        }

        // Emoji picker
        function openEmojiPicker(taskId) {
            currentTaskRow = taskId;
            document.getElementById('emojiModal').classList.add('active');
        }

        function closeEmojiPicker() {
            document.getElementById('emojiModal').classList.remove('active');
            currentTaskRow = null;
        }

        function selectEmoji(emoji) {
            if (currentTaskRow) {
                const taskRow = document.getElementById(currentTaskRow);
                const emojiDisplay = taskRow.querySelector('.emoji-display');

                // Check if it's an image icon
                if (emoji.startsWith('IMG:')) {
                    const imageName = emoji.substring(4);
                    emojiDisplay.innerHTML = `<img src="emojis/${imageName}" style="width: 40px; height: 40px; object-fit: contain;" />`;
                    emojiDisplay.dataset.icon = emoji; // Store the full IMG: reference
                } else {
                    emojiDisplay.textContent = emoji;
                    emojiDisplay.dataset.icon = emoji;
                }
            }
            closeEmojiPicker();
        }

        // Close modal when clicking outside
        document.getElementById('emojiModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEmojiPicker();
            }
        });

        // Edit existing kid
        async function editKid(kidId) {
            try {
                const doc = await db.collection('kids').doc(kidId).get();
                if (!doc.exists) {
                    alert('×™×œ×“ ×œ× × ××¦×');
                    return;
                }

                const kidData = doc.data();
                editingKidId = kidId;

                // Update form title and button
                document.getElementById('formTitle').textContent = `×¢×¨×•×š ×™×œ×“: ${kidData.name}`;
                document.getElementById('saveButton').textContent = '×©××•×¨ ×©×™× ×•×™×™×';
                document.getElementById('cancelButton').style.display = 'block';

                // Fill form with existing data
                document.getElementById('newKidName').value = kidData.name;

                // Handle image - check if it's a data URL or filename
                const imageName = kidData.imageName || '';
                if (imageName.startsWith('data:')) {
                    // It's an uploaded image (data URL)
                    document.getElementById('kidImageData').value = imageName;
                    document.getElementById('previewImg').src = imageName;
                    document.getElementById('imagePreview').style.display = 'block';
                    document.getElementById('kidImageName').value = '';
                } else {
                    // It's a filename
                    document.getElementById('kidImageName').value = imageName;
                    document.getElementById('kidImageData').value = '';
                    document.getElementById('imagePreview').style.display = 'none';
                }

                document.getElementById('kidMoney').value = kidData.totalMoney || 0;
                document.getElementById('kidDailyReward').value = kidData.dailyReward || 0.5;

                // Set coin style (default to dollar for backward compatibility)
                const coinStyle = kidData.coinStyle || 'dollar';
                document.getElementById('coinStyle').value = coinStyle;
                if (coinStyle === 'custom') {
                    const coinImageName = kidData.coinImageName || '';
                    // Check if it's a data URL or filename
                    if (coinImageName.startsWith('data:')) {
                        // It's an uploaded image (data URL)
                        document.getElementById('coinImageData').value = coinImageName;
                        document.getElementById('coinPreviewImg').src = coinImageName;
                        document.getElementById('coinImagePreview').style.display = 'block';
                        document.getElementById('coinImageName').value = '';
                    } else {
                        // It's a filename
                        document.getElementById('coinImageName').value = coinImageName;
                        document.getElementById('coinImageData').value = '';
                        document.getElementById('coinImagePreview').style.display = 'none';
                    }
                    toggleCoinImageInput();
                }

                // Set color schema (default to purple for backward compatibility)
                const colorSchema = kidData.colorSchema || 'purple';
                const colorSchemaInput = document.querySelector(`input[name="colorSchema"][value="${colorSchema}"]`);
                if (colorSchemaInput) {
                    colorSchemaInput.checked = true;
                }

                // Set header and savings labels
                document.getElementById('headerLabel').value = kidData.headerLabel || '';
                document.getElementById('savingsLabel').value = kidData.savingsLabel || '';
                document.getElementById('regularTasksHeader').value = kidData.regularTasksHeader !== undefined ? kidData.regularTasksHeader : '××©×™××•×ª ×¨×’×™×œ×•×ª';
                document.getElementById('bonusTasksHeader').value = kidData.bonusTasksHeader !== undefined ? kidData.bonusTasksHeader : 'ğŸ’° ××©×™××•×ª ×‘×•× ×•×¡ ğŸ’°';
                document.getElementById('calmDownHeader').value = kidData.calmDownHeader !== undefined ? kidData.calmDownHeader : 'ğŸ§˜ ×¤×™× ×ª ×”×”×¨×’×¢×” ğŸ§˜';

                // Clear and populate tasks
                document.getElementById('tasksList').innerHTML = '';
                taskCounter = 0;

                if (kidData.tasks && kidData.tasks.length > 0) {
                    kidData.tasks.forEach(task => {
                        addTaskRow();
                        const lastRow = document.getElementById(`task-${taskCounter - 1}`);
                        const emojiDisplay = lastRow.querySelector('.emoji-display');

                        // Check if it's an image icon
                        if (task.icon.startsWith('IMG:')) {
                            const imageName = task.icon.substring(4);
                            emojiDisplay.innerHTML = `<img src="emojis/${imageName}" style="width: 40px; height: 40px; object-fit: contain;" />`;
                            emojiDisplay.dataset.icon = task.icon;
                        } else {
                            emojiDisplay.textContent = task.icon;
                            emojiDisplay.dataset.icon = task.icon;
                        }

                        lastRow.querySelector('[data-type="title"]').value = task.title;

                        // Handle task type (default to regular for backward compatibility)
                        const taskType = task.type || 'regular';
                        lastRow.querySelector('[data-type="taskType"]').value = taskType;

                        // If bonus task, populate reward fields
                        if (taskType === 'bonus' && task.minReward !== undefined && task.maxReward !== undefined) {
                            toggleTaskTypeInputs(`task-${taskCounter - 1}`);
                            lastRow.querySelector('[data-type="minReward"]').value = task.minReward;
                            lastRow.querySelector('[data-type="maxReward"]').value = task.maxReward;
                        }

                        // If calm-down task, populate activity fields
                        if (taskType === 'calm-down') {
                            toggleTaskTypeInputs(`task-${taskCounter - 1}`);
                            if (task.activityType) {
                                lastRow.querySelector('[data-type="activityType"]').value = task.activityType;
                            }
                            if (task.activityUrl) {
                                lastRow.querySelector('[data-type="activityUrl"]').value = task.activityUrl;
                            }
                        }

                        // Set testimony checkbox
                        if (task.requiresTestimony) {
                            lastRow.querySelector('[data-type="requiresTestimony"]').checked = true;
                        }

                        // Set track time checkbox
                        if (task.trackTime) {
                            lastRow.querySelector('[data-type="trackTime"]').checked = true;
                        }

                        // Set active days (default to all 7 days for backward compatibility)
                        const activeDays = task.activeDays || [0, 1, 2, 3, 4, 5, 6];
                        const dayCheckboxes = lastRow.querySelectorAll('[data-day]');
                        dayCheckboxes.forEach(checkbox => {
                            const day = parseInt(checkbox.dataset.day);
                            checkbox.checked = activeDays.includes(day);
                        });
                    });
                } else {
                    addTaskRow();
                }

                // Scroll to form
                document.querySelector('.add-kid-form').scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                console.error('Error loading kid for edit:', error);
                alert('×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™ ×”×™×œ×“');
            }
        }

        // Copy kid board
        async function copyKid(kidId) {
            try {
                const doc = await db.collection('kids').doc(kidId).get();
                if (!doc.exists) {
                    alert('×™×œ×“ ×œ× × ××¦×');
                    return;
                }

                const kidData = doc.data();

                // Prompt for new kid name
                const newName = prompt(`×”×¢×ª×§ ×œ×•×— ×©×œ ${kidData.name}\n×”×›× ×¡ ×©× ×œ×™×œ×“ ×”×—×“×©:`, `${kidData.name} - ×¢×•×ª×§`);

                if (!newName || newName.trim() === '') {
                    return; // User cancelled
                }

                const newKidId = newName.toLowerCase().replace(/\s+/g, '-');

                // Check if kid with this name already exists
                const existingDoc = await db.collection('kids').doc(newKidId).get();
                if (existingDoc.exists) {
                    alert('×§×™×™× ×›×‘×¨ ×™×œ×“ ×¢× ×©× ×–×”. ×× × ×‘×—×¨ ×©× ××—×¨.');
                    return;
                }

                // Create new kid with copied data
                await db.collection('kids').doc(newKidId).set({
                    name: newName.trim(),
                    imageName: kidData.imageName || '',
                    tasks: kidData.tasks || [],
                    completedTasks: [],
                    completedBonusTasks: [],
                    bonusRewardsEarned: {},
                    totalMoney: 0, // Start with 0 money
                    dailyReward: kidData.dailyReward || 0.5,
                    coinStyle: kidData.coinStyle || 'dollar',
                    coinImageName: kidData.coinImageName || '',
                    colorSchema: kidData.colorSchema || 'purple',
                    headerLabel: kidData.headerLabel || '',
                    savingsLabel: kidData.savingsLabel || '',
                    regularTasksHeader: kidData.regularTasksHeader !== undefined ? kidData.regularTasksHeader : '××©×™××•×ª ×¨×’×™×œ×•×ª',
                    bonusTasksHeader: kidData.bonusTasksHeader !== undefined ? kidData.bonusTasksHeader : 'ğŸ’° ××©×™××•×ª ×‘×•× ×•×¡ ğŸ’°',
                    calmDownHeader: kidData.calmDownHeader !== undefined ? kidData.calmDownHeader : 'ğŸ§˜ ×¤×™× ×ª ×”×”×¨×’×¢×” ğŸ§˜',
                    todayRewardGiven: false,
                    lastResetDate: new Date().toDateString(),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                alert(`×”×œ×•×— ×”×•×¢×ª×§ ×‘×”×¦×œ×—×”!\n× ×•×¦×¨ ×œ×•×— ×—×“×© ×¢×‘×•×¨ ${newName}`);
                await loadKidsList();
            } catch (error) {
                console.error('Error copying kid:', error);
                alert('×©×’×™××” ×‘×”×¢×ª×§×ª ×”×œ×•×—: ' + error.message);
            }
        }

        // Cancel edit
        function cancelEdit() {
            editingKidId = null;
            document.getElementById('formTitle').textContent = '×”×•×¡×£ ×™×œ×“ ×—×“×©';
            document.getElementById('saveButton').textContent = '×©××•×¨ ×™×œ×“';
            document.getElementById('cancelButton').style.display = 'none';
            document.getElementById('newKidName').value = '';
            document.getElementById('kidImageName').value = '';
            document.getElementById('kidImageData').value = '';
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('coinImageName').value = '';
            document.getElementById('coinImageData').value = '';
            document.getElementById('coinImagePreview').style.display = 'none';
            document.getElementById('kidMoney').value = '';
            document.getElementById('kidDailyReward').value = '0.50';
            document.getElementById('coinStyle').value = 'dollar';
            toggleCoinImageInput();
            // Reset color schema to default
            document.querySelector('input[name="colorSchema"][value="purple"]').checked = true;
            document.getElementById('tasksList').innerHTML = '';
            addTaskRow();
        }

        // Save kid (create or update)
        async function saveKid() {
            const name = document.getElementById('newKidName').value.trim();
            let imageName = document.getElementById('kidImageName').value.trim();
            const imageData = document.getElementById('kidImageData').value;
            const money = parseFloat(document.getElementById('kidMoney').value) || 0;
            const dailyReward = parseFloat(document.getElementById('kidDailyReward').value) || 0.5;
            const coinStyle = document.getElementById('coinStyle').value;
            let coinImageName = document.getElementById('coinImageName').value.trim();
            const coinImageData = document.getElementById('coinImageData').value;
            const colorSchema = document.querySelector('input[name="colorSchema"]:checked').value;
            const headerLabel = document.getElementById('headerLabel').value.trim();
            const savingsLabel = document.getElementById('savingsLabel').value.trim();
            const regularTasksHeader = document.getElementById('regularTasksHeader').value.trim();
            const bonusTasksHeader = document.getElementById('bonusTasksHeader').value.trim();
            const calmDownHeader = document.getElementById('calmDownHeader').value.trim();

            if (!name) {
                alert('× × ×œ×”×›× ×™×¡ ×©× ×™×œ×“');
                return;
            }

            const taskRows = document.querySelectorAll('#tasksList .task-input-row');
            const tasks = [];
            let taskId = 1;

            taskRows.forEach(row => {
                const emojiDisplay = row.querySelector('.emoji-display');
                const icon = emojiDisplay.dataset.icon || emojiDisplay.textContent.trim();
                const title = row.querySelector('[data-type="title"]').value.trim();
                const taskType = row.querySelector('[data-type="taskType"]').value;
                const quantity = parseInt(row.querySelector('[data-type="quantity"]').value) || 1;
                const requiresTestimony = row.querySelector('[data-type="requiresTestimony"]').checked;
                const trackTime = row.querySelector('[data-type="trackTime"]').checked;

                // Get active days from checkboxes
                const activeDays = [];
                const dayCheckboxes = row.querySelectorAll('[data-day]');
                dayCheckboxes.forEach(checkbox => {
                    if (checkbox.checked) {
                        activeDays.push(parseInt(checkbox.dataset.day));
                    }
                });

                if (icon && title) {
                    // Create base task object with activeDays (default to all 7 days if none selected)
                    const baseTask = {
                        icon,
                        title,
                        type: taskType,
                        requiresTestimony: requiresTestimony,
                        trackTime: trackTime,
                        activeDays: activeDays.length > 0 ? activeDays : [0, 1, 2, 3, 4, 5, 6]
                    };

                    if (taskType === 'bonus') {
                        const minReward = parseFloat(row.querySelector('[data-type="minReward"]').value) || 0;
                        const maxReward = parseFloat(row.querySelector('[data-type="maxReward"]').value) || 0;

                        if (minReward <= 0 || maxReward <= 0 || minReward > maxReward) {
                            alert('× × ×œ×”×›× ×™×¡ ×¢×¨×›×™ ×¤×¨×¡ ×ª×§×™× ×™× (××™× ×™××•× ×•××§×¡×™××•× ×—×™×•×‘×™×™×, ××™× ×™××•× <= ××§×¡×™××•×)');
                            return;
                        }

                        baseTask.minReward = minReward;
                        baseTask.maxReward = maxReward;
                    }

                    if (taskType === 'calm-down') {
                        const activityType = row.querySelector('[data-type="activityType"]').value;
                        const activityUrl = row.querySelector('[data-type="activityUrl"]').value.trim();

                        baseTask.activityType = activityType;
                        if (activityType === 'link') {
                            if (!activityUrl) {
                                alert('× × ×œ×”×›× ×™×¡ URL ×œ×¤×¢×™×œ×•×ª ×”×¨×’×¢×” ××¡×•×’ ×§×™×©×•×¨');
                                return;
                            }
                            baseTask.activityUrl = activityUrl;
                        }
                    }

                    // Add multiple instances based on quantity
                    for (let i = 0; i < quantity; i++) {
                        tasks.push({ ...baseTask, id: taskId++ });
                    }
                }
            });

            if (tasks.length === 0) {
                alert('× × ×œ×”×•×¡×™×£ ×œ×¤×—×•×ª ××©×™××” ××—×ª');
                return;
            }

            try {
                const kidId = editingKidId || name.toLowerCase().replace(/\s+/g, '-');

                // Use uploaded image data or filename
                if (imageData) {
                    // Store image as data URL (will be shown directly in index.html)
                    imageName = imageData;
                }

                // Use uploaded coin image data or filename
                if (coinImageData) {
                    // Store coin image as data URL
                    coinImageName = coinImageData;
                }

                // Prepare kid data
                const kidDataToSave = {
                    name: name,
                    imageName: imageName || '',
                    tasks: tasks,
                    totalMoney: money,
                    dailyReward: dailyReward,
                    coinStyle: coinStyle,
                    coinImageName: coinImageName || '',
                    colorSchema: colorSchema || 'purple',
                    headerLabel: headerLabel || '',
                    savingsLabel: savingsLabel || '',
                    regularTasksHeader: regularTasksHeader,
                    bonusTasksHeader: bonusTasksHeader,
                    calmDownHeader: calmDownHeader
                };

                if (editingKidId) {
                    // Update existing kid
                    await db.collection('kids').doc(kidId).update(kidDataToSave);
                    alert('×”×©×™× ×•×™×™× × ×©××¨×• ×‘×”×¦×œ×—×”!');
                } else {
                    // Create new kid
                    kidDataToSave.completedTasks = [];
                    kidDataToSave.todayRewardGiven = false;
                    kidDataToSave.lastResetDate = new Date().toDateString();
                    kidDataToSave.createdAt = firebase.firestore.FieldValue.serverTimestamp();

                    await db.collection('kids').doc(kidId).set(kidDataToSave);
                    alert('×”×™×œ×“ × ×•×¡×£ ×‘×”×¦×œ×—×”!');
                }

                cancelEdit();
                await loadKidsList();
            } catch (error) {
                console.error('Error saving kid:', error);
                alert('×©×’×™××” ×‘×©××™×¨×”: ' + error.message);
            }
        }
    </script>
</body>
</html>
