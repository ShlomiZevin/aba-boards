<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>× ×™×”×•×œ ×™×œ×“×™× - ABA</title>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- Doing Theme -->
    <link rel="stylesheet" href="doing-theme-light.css">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            direction: rtl;
        }

        .admin-container {
            max-width: 900px;
            margin: 0 auto;
        }

        .admin-header {
            background: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .admin-header h1 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .back-link {
            display: inline-block;
            margin-top: 10px;
            color: #667eea;
            text-decoration: none;
            font-weight: bold;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        .kids-list {
            background: white;
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .kids-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .kids-list-header h2 {
            color: #667eea;
            margin: 0;
        }

        .kid-item {
            padding: 20px;
            border: 2px solid #f0f0f0;
            border-radius: 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
        }

        .kid-item:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .kid-item:last-child {
            margin-bottom: 0;
        }

        .kid-info h3 {
            color: #667eea;
            margin-bottom: 8px;
            font-size: 1.2em;
        }

        .kid-stats {
            font-size: 0.9em;
            color: #666;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .kid-stat {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .kid-links {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-success {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(67, 233, 123, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a5a 100%);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
        }

        .btn-add {
            padding: 12px 25px;
            font-size: 16px;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.5em;
            color: white;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-state .icon {
            font-size: 4em;
            margin-bottom: 15px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow-y: auto;
        }

        .modal.active {
            display: flex !important;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #667eea;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #666;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #eee;
            border-radius: 10px;
            font-size: 1em;
            direction: rtl;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        @media (max-width: 600px) {
            .kid-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }

            .kid-links {
                width: 100%;
            }

            .kid-links .btn {
                flex: 1;
                text-align: center;
            }

            .kids-list-header {
                flex-direction: column;
                align-items: stretch;
            }

            .kids-list-header h2 {
                text-align: center;
            }
        }
    </style>
</head>
<body class="doing-theme">
    <div id="loadingState" class="loading">×˜×•×¢×Ÿ...</div>

    <div id="adminContainer" class="admin-container" style="display: none;">
        <div class="admin-header">
            <div class="logo-container">
                <img src="doing-logo-transparent2.png" alt="Doing - Being. Doing. Playing." class="app-logo">
            </div>
            <h1>× ×™×”×•×œ ×™×œ×“×™×</h1>
            <a href="index.html" class="back-link">â† ×—×–×¨×” ×œ×œ×•×— ×¨××©×™</a>
        </div>

        <div class="kids-list">
            <div class="kids-list-header">
                <h2>×¨×©×™××ª ×™×œ×“×™×</h2>
                <button class="btn btn-success btn-add" onclick="showAddKidModal()">+ ×”×•×¡×£ ×™×œ×“ ×—×“×©</button>
            </div>
            <div id="kidsList"></div>
        </div>
    </div>

    <!-- Add Kid Modal -->
    <div id="addKidModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>×”×•×¡×£ ×™×œ×“ ×—×“×©</h3>
                <button class="close-btn" onclick="closeAddKidModal()">Ã—</button>
            </div>
            <div class="form-group">
                <label>×©× ×”×™×œ×“:</label>
                <input type="text" id="newKidName" placeholder="×”×›× ×¡ ×©×">
            </div>
            <button class="btn btn-primary" onclick="addNewKid()" style="width: 100%;">×¦×•×¨ ×™×œ×“ ×¢× ×œ×•×— ×‘×¨×™×¨×ª ××—×“×œ</button>
            <p style="text-align: center; margin-top: 15px; color: #666; font-size: 0.9em;">
                ×œ××—×¨ ×™×¦×™×¨×ª ×”×™×œ×“, ×”×©×ª××© ×‘"×‘× ×” ×œ×•×—" ×›×“×™ ×œ×¢×¨×•×š ××ª ×”×œ×•×—
            </p>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>××—×™×§×ª ×™×œ×“</h3>
                <button class="close-btn" onclick="closeDeleteModal()">Ã—</button>
            </div>
            <p style="text-align: center; margin-bottom: 20px; font-size: 1.1em;">
                ×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª <strong id="deleteKidName"></strong>?
            </p>
            <p style="text-align: center; margin-bottom: 20px; color: #ff6b6b;">
                ×¤×¢×•×œ×” ×–×• ×œ× × ×™×ª× ×ª ×œ×‘×™×˜×•×œ!
            </p>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-danger" onclick="confirmDeleteKid()" style="flex: 1;">××—×§</button>
                <button class="btn btn-secondary" onclick="closeDeleteModal()" style="flex: 1;">×‘×™×˜×•×œ</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDHE7FKHJ92rXXfz_3hLX8e9s8lC9g9g9o",
            authDomain: "aba-ai-d74f5.firebaseapp.com",
            projectId: "aba-ai-d74f5",
            storageBucket: "aba-ai-d74f5.firebasestorage.app",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef123456"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let kidToDelete = null;

        // Initialize
        window.onload = async function() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('adminContainer').style.display = 'block';
            await loadKidsList();
        };

        // Load kids list
        async function loadKidsList() {
            const snapshot = await db.collection('kids').get();
            const kidsList = document.getElementById('kidsList');
            kidsList.innerHTML = '';

            if (snapshot.empty) {
                kidsList.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">ğŸ‘¶</div>
                        <p>××™×Ÿ ×™×œ×“×™× ×‘××¢×¨×›×ª</p>
                        <p style="margin-top: 10px;">×œ×—×¥ ×¢×œ "×”×•×¡×£ ×™×œ×“ ×—×“×©" ×›×“×™ ×œ×”×ª×—×™×œ</p>
                    </div>
                `;
                return;
            }

            snapshot.forEach(doc => {
                const kid = doc.data();
                const kidDiv = document.createElement('div');
                kidDiv.className = 'kid-item';

                const taskCount = kid.tasks ? kid.tasks.length : 0;
                const money = (kid.totalMoney || 0).toFixed(2);
                const coinSymbol = kid.coinStyle === 'shekel' ? 'â‚ª' : '$';

                kidDiv.innerHTML = `
                    <div class="kid-info">
                        <h3>${kid.name}</h3>
                        <div class="kid-stats">
                            <span class="kid-stat">ğŸ“‹ ${taskCount} ××©×™××•×ª</span>
                            <span class="kid-stat">ğŸ’° ${coinSymbol}${money}</span>
                        </div>
                    </div>
                    <div class="kid-links">
                        <a href="board.html?kid=${doc.id}" class="btn btn-primary">ğŸ“± ×œ×•×—</a>
                        <a href="board-builder.html?kid=${doc.id}" class="btn btn-success">ğŸ¨ ×‘× ×” ×œ×•×—</a>
                        <button class="btn btn-secondary" onclick="copyKid('${doc.id}')">ğŸ“‹ ×”×¢×ª×§</button>
                        <button class="btn btn-danger" onclick="showDeleteModal('${doc.id}', '${kid.name}')">ğŸ—‘ï¸</button>
                    </div>
                `;
                kidsList.appendChild(kidDiv);
            });
        }

        // Show add kid modal
        function showAddKidModal() {
            document.getElementById('newKidName').value = '';
            document.getElementById('addKidModal').classList.add('active');
            document.getElementById('newKidName').focus();
        }

        // Close add kid modal
        function closeAddKidModal() {
            document.getElementById('addKidModal').classList.remove('active');
        }

        // Add new kid with default board layout
        async function addNewKid() {
            const name = document.getElementById('newKidName').value.trim();

            if (!name) {
                alert('× × ×œ×”×›× ×™×¡ ×©× ×™×œ×“');
                return;
            }

            const kidId = name.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9\u0590-\u05FF-]/g, '');

            // Check if kid already exists
            const existingDoc = await db.collection('kids').doc(kidId).get();
            if (existingDoc.exists) {
                alert('×§×™×™× ×›×‘×¨ ×™×œ×“ ×¢× ×©× ×–×”. ×× × ×‘×—×¨ ×©× ××—×¨.');
                return;
            }

            // Create default board layout
            const defaultBoardLayout = {
                items: [
                    {
                        id: 1,
                        type: 'bank',
                        label: `×§×•×¤×ª ×”×—×™×¡×›×•×Ÿ ×©×œ ${name}`
                    },
                    {
                        id: 2,
                        type: 'progress',
                        title: '×”×”×ª×§×“××•×ª ×©×œ×™ ×”×™×•×'
                    },
                    {
                        id: 3,
                        type: 'header',
                        size: 'medium',
                        text: '×”××©×™××•×ª ×©×œ×™'
                    },
                    {
                        id: 4,
                        type: 'task',
                        taskType: 'regular',
                        taskData: {
                            id: 1,
                            icon: 'âœ…',
                            title: '××©×™××” ×œ×“×•×’××”',
                            type: 'regular',
                            requiresTestimony: false,
                            trackTime: false,
                            activeDays: [0, 1, 2, 3, 4, 5, 6]
                        }
                    },
                    {
                        id: 5,
                        type: 'header',
                        size: 'medium',
                        text: 'ğŸ’° ××©×™××•×ª ×‘×•× ×•×¡ ğŸ’°'
                    },
                    {
                        id: 6,
                        type: 'task',
                        taskType: 'bonus',
                        taskData: {
                            id: 2,
                            icon: 'ğŸŒŸ',
                            title: '××©×™××ª ×‘×•× ×•×¡ ×œ×“×•×’××”',
                            type: 'bonus',
                            minReward: 1,
                            maxReward: 5,
                            requiresTestimony: false,
                            trackTime: false,
                            activeDays: [0, 1, 2, 3, 4, 5, 6]
                        }
                    },
                    {
                        id: 7,
                        type: 'header',
                        size: 'medium',
                        text: 'ğŸ§˜ ×¤×™× ×ª ×”×”×¨×’×¢×” ğŸ§˜'
                    },
                    {
                        id: 8,
                        type: 'task',
                        taskType: 'calm-down',
                        taskData: {
                            id: 3,
                            icon: 'ğŸ¨',
                            title: '×œ×•×— ×¦×™×•×¨',
                            type: 'calm-down',
                            activityType: 'paint',
                            activeDays: [0, 1, 2, 3, 4, 5, 6]
                        }
                    }
                ]
            };

            // Create tasks array from board layout for backward compatibility
            const tasks = defaultBoardLayout.items
                .filter(item => item.type === 'task')
                .map(item => item.taskData);

            try {
                await db.collection('kids').doc(kidId).set({
                    name: name,
                    imageName: '',
                    tasks: tasks,
                    boardLayout: defaultBoardLayout,
                    completedTasks: [],
                    completedBonusTasks: [],
                    bonusRewardsEarned: {},
                    totalMoney: 0,
                    dailyReward: 0.5,
                    coinStyle: 'dollar',
                    coinImageName: '',
                    colorSchema: 'purple',
                    headerLabel: '',
                    savingsLabel: '',
                    regularTasksHeader: '×”××©×™××•×ª ×©×œ×™',
                    bonusTasksHeader: 'ğŸ’° ××©×™××•×ª ×‘×•× ×•×¡ ğŸ’°',
                    calmDownHeader: 'ğŸ§˜ ×¤×™× ×ª ×”×”×¨×’×¢×” ğŸ§˜',
                    todayRewardGiven: false,
                    lastResetDate: new Date().toDateString(),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                closeAddKidModal();
                await loadKidsList();

                // Open board builder for the new kid
                if (confirm(`${name} × ×•×¦×¨ ×‘×”×¦×œ×—×”!\n\n×”×× ×œ×¤×ª×•×— ××ª ×‘×•× ×” ×”×œ×•×—×•×ª ×›×“×™ ×œ×¢×¨×•×š ××ª ×”×œ×•×—?`)) {
                    window.location.href = `board-builder.html?kid=${kidId}`;
                }
            } catch (error) {
                console.error('Error adding kid:', error);
                alert('×©×’×™××” ×‘×™×¦×™×¨×ª ×”×™×œ×“: ' + error.message);
            }
        }

        // Copy kid
        async function copyKid(kidId) {
            try {
                const doc = await db.collection('kids').doc(kidId).get();
                if (!doc.exists) {
                    alert('×™×œ×“ ×œ× × ××¦×');
                    return;
                }

                const kidData = doc.data();
                const newName = prompt(`×”×¢×ª×§ ×œ×•×— ×©×œ ${kidData.name}\n×”×›× ×¡ ×©× ×œ×™×œ×“ ×”×—×“×©:`, `${kidData.name} - ×¢×•×ª×§`);

                if (!newName || newName.trim() === '') {
                    return;
                }

                const newKidId = newName.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9\u0590-\u05FF-]/g, '');

                const existingDoc = await db.collection('kids').doc(newKidId).get();
                if (existingDoc.exists) {
                    alert('×§×™×™× ×›×‘×¨ ×™×œ×“ ×¢× ×©× ×–×”. ×× × ×‘×—×¨ ×©× ××—×¨.');
                    return;
                }

                await db.collection('kids').doc(newKidId).set({
                    name: newName.trim(),
                    imageName: kidData.imageName || '',
                    tasks: kidData.tasks || [],
                    boardLayout: kidData.boardLayout || null,
                    completedTasks: [],
                    completedBonusTasks: [],
                    bonusRewardsEarned: {},
                    totalMoney: 0,
                    dailyReward: kidData.dailyReward || 0.5,
                    coinStyle: kidData.coinStyle || 'dollar',
                    coinImageName: kidData.coinImageName || '',
                    colorSchema: kidData.colorSchema || 'purple',
                    headerLabel: kidData.headerLabel || '',
                    savingsLabel: kidData.savingsLabel || '',
                    regularTasksHeader: kidData.regularTasksHeader || '',
                    bonusTasksHeader: kidData.bonusTasksHeader || '',
                    calmDownHeader: kidData.calmDownHeader || '',
                    showDino: kidData.showDino || false,
                    todayRewardGiven: false,
                    lastResetDate: new Date().toDateString(),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                alert(`×”×œ×•×— ×”×•×¢×ª×§ ×‘×”×¦×œ×—×”!\n× ×•×¦×¨ ×œ×•×— ×—×“×© ×¢×‘×•×¨ ${newName}`);
                await loadKidsList();
            } catch (error) {
                console.error('Error copying kid:', error);
                alert('×©×’×™××” ×‘×”×¢×ª×§×ª ×”×œ×•×—: ' + error.message);
            }
        }

        // Show delete modal
        function showDeleteModal(kidId, kidName) {
            kidToDelete = kidId;
            document.getElementById('deleteKidName').textContent = kidName;
            document.getElementById('deleteModal').classList.add('active');
        }

        // Close delete modal
        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('active');
            kidToDelete = null;
        }

        // Confirm delete kid
        async function confirmDeleteKid() {
            if (!kidToDelete) return;

            try {
                await db.collection('kids').doc(kidToDelete).delete();
                closeDeleteModal();
                await loadKidsList();
                alert('×”×™×œ×“ × ××—×§ ×‘×”×¦×œ×—×”');
            } catch (error) {
                console.error('Error deleting kid:', error);
                alert('×©×’×™××” ×‘××—×™×§×”: ' + error.message);
            }
        }

        // Close modals when clicking outside
        document.getElementById('addKidModal').addEventListener('click', function(e) {
            if (e.target === this) closeAddKidModal();
        });

        document.getElementById('deleteModal').addEventListener('click', function(e) {
            if (e.target === this) closeDeleteModal();
        });

        // Handle Enter key in name input
        document.getElementById('newKidName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') addNewKid();
        });
    </script>
</body>
</html>
