<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×‘×•× ×” ×œ×•×—×•×ª - ABA</title>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- Doing Theme -->
    <link rel="stylesheet" href="doing-theme-light.css">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            direction: rtl;
        }

        /* Top Bar */
        .top-bar {
            background: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .top-bar h1 {
            color: #667eea;
            font-size: 1.5em;
        }

        .top-bar-buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-success {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
        }

        /* Main Layout */
        .builder-container {
            display: flex;
            height: calc(100vh - 70px);
        }

        /* Component Palette (Left Sidebar) */
        .palette {
            width: 280px;
            background: white;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }

        .palette h3 {
            color: #667eea;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }

        .palette-section {
            margin-bottom: 25px;
        }

        .palette-section h4 {
            color: #333;
            margin-bottom: 10px;
            font-size: 0.9em;
        }

        .palette-item {
            background: #f8f9fa;
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: grab;
            transition: all 0.3s ease;
            text-align: center;
        }

        .palette-item:hover {
            border-color: #667eea;
            background: #f0f0ff;
            transform: scale(1.02);
        }

        .palette-item.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .palette-item .icon {
            font-size: 2em;
            margin-bottom: 5px;
        }

        .palette-item .label {
            font-size: 0.85em;
            color: #666;
        }

        /* Canvas Area */
        .canvas-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .canvas {
            background: white;
            border-radius: 20px;
            min-height: 600px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .canvas-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 400px;
            color: #999;
            border: 3px dashed #ddd;
            border-radius: 15px;
            margin: 20px;
        }

        .canvas-empty .icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        /* Drop Zone */
        .drop-zone {
            min-height: 100px;
            border: 2px dashed transparent;
            border-radius: 10px;
            transition: all 0.3s ease;
            padding: 10px;
        }

        .drop-zone.drag-over {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        /* Board Items */
        .board-item {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: move;
            position: relative;
            transition: all 0.3s ease;
        }

        .board-item:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .board-item.dragging {
            opacity: 0.5;
        }

        .board-item.drag-over {
            border-color: #667eea;
            border-style: dashed;
        }

        .board-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .board-item-type {
            background: #667eea;
            color: white;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.75em;
            font-weight: bold;
        }

        .board-item-actions {
            display: flex;
            gap: 5px;
        }

        .board-item-actions button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2em;
            opacity: 0.6;
            transition: opacity 0.3s;
        }

        .board-item-actions button:hover {
            opacity: 1;
        }

        .board-item-content {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .board-item-icon {
            font-size: 2em;
            width: 50px;
            text-align: center;
        }

        .board-item-icon img {
            width: 50px;
            height: 50px;
            object-fit: contain;
        }

        .board-item-details {
            flex: 1;
        }

        .board-item-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .board-item-subtitle {
            font-size: 0.85em;
            color: #666;
        }

        /* Header Item Styles */
        .board-item.header-small .board-item-title { font-size: 1em; }
        .board-item.header-medium .board-item-title { font-size: 1.3em; }
        .board-item.header-large .board-item-title { font-size: 1.6em; }

        .board-item.header-item {
            background: linear-gradient(135deg, #667eea20 0%, #764ba220 100%);
            border-color: #667eea;
        }

        /* Bank Item Style */
        .board-item.bank-item {
            background: linear-gradient(135deg, #ffd70020 0%, #ffed4e20 100%);
            border-color: #ffd700;
        }

        .board-item.bank-item .board-item-type {
            background: #ffd700;
            color: #333;
        }

        /* Progress Bar Item Style */
        .board-item.progress-item {
            background: linear-gradient(135deg, #4CAF5020 0%, #8BC34A20 100%);
            border-color: #4CAF50;
        }

        .board-item.progress-item .board-item-type {
            background: #4CAF50;
            color: white;
        }

        /* Task Item Styles */
        .board-item.task-regular {
            background: white;
        }

        .board-item.task-bonus {
            background: linear-gradient(135deg, #ffd70010 0%, #ffed4e10 100%);
            border-color: #ffd700;
        }

        .board-item.task-bonus .board-item-type {
            background: #ffd700;
            color: #333;
        }

        .board-item.task-calm-down {
            background: linear-gradient(135deg, #a8edea20 0%, #fed6e320 100%);
            border-color: #89CFF0;
        }

        .board-item.task-calm-down .board-item-type {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #333;
        }

        /* Configuration Panel (Right Sidebar) */
        .config-panel {
            width: 350px;
            background: white;
            padding: 20px;
            overflow-y: auto;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            display: none;
        }

        .config-panel.active {
            display: block;
        }

        .config-panel h3 {
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }

        .config-group {
            margin-bottom: 20px;
        }

        .config-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
            font-size: 0.9em;
        }

        .config-group input,
        .config-group select,
        .config-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #eee;
            border-radius: 8px;
            font-size: 14px;
            direction: rtl;
        }

        .config-group input:focus,
        .config-group select:focus,
        .config-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .config-group small {
            color: #666;
            font-size: 0.8em;
            display: block;
            margin-top: 5px;
        }

        .config-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .config-checkbox input {
            width: 18px;
            height: 18px;
        }

        .config-checkbox label {
            margin: 0;
            font-weight: normal;
        }

        /* Days Selector */
        .days-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .day-checkbox {
            display: flex;
            align-items: center;
            gap: 4px;
            background: #f8f9fa;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.85em;
        }

        .day-checkbox input {
            width: 16px;
            height: 16px;
        }

        /* Emoji Picker */
        .emoji-picker-trigger {
            width: 60px;
            height: 60px;
            border: 2px solid #eee;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .emoji-picker-trigger:hover {
            border-color: #667eea;
            transform: scale(1.05);
        }

        .emoji-picker-trigger img {
            width: 50px;
            height: 50px;
            object-fit: contain;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #667eea;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #666;
        }

        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }

        .emoji-item {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            cursor: pointer;
            border: 2px solid #eee;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .emoji-item:hover {
            transform: scale(1.2);
            border-color: #667eea;
            background: #f0f0ff;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.5em;
            color: white;
        }

        /* Color Schema Selection */
        .color-schema-option:has(input:checked) {
            border-color: #667eea !important;
            background: #f0f0ff;
        }

        /* Responsive */
        @media (max-width: 900px) {
            .builder-container {
                flex-direction: column;
            }

            .palette {
                width: 100%;
                max-height: 200px;
            }

            .config-panel {
                width: 100%;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                max-height: 50vh;
                border-radius: 20px 20px 0 0;
            }
        }
    </style>
</head>
<body class="doing-theme">
    <div id="loadingState" class="loading">×˜×•×¢×Ÿ...</div>

    <div id="builderApp" style="display: none;">
        <!-- Top Bar -->
        <div class="top-bar">
            <h1>ğŸ¨ ×‘×•× ×” ×œ×•×—×•×ª - <span id="kidNameDisplay">×˜×•×¢×Ÿ...</span></h1>
            <div class="top-bar-buttons">
                <a href="admin.html" class="btn btn-secondary">â† ×—×–×¨×” ×œ× ×™×”×•×œ</a>
                <button class="btn btn-primary" onclick="previewBoard()">ğŸ‘ï¸ ×ª×¦×•×’×” ××§×“×™××”</button>
                <button class="btn btn-success" onclick="saveBoard()">ğŸ’¾ ×©××•×¨ ×œ×•×—</button>
            </div>
        </div>

        <div class="builder-container">
            <!-- Component Palette -->
            <div class="palette">
                <!-- Kid Settings Section (at top) -->
                <div class="palette-section" style="padding-bottom: 15px; margin-bottom: 15px; border-bottom: 2px solid #eee;">
                    <h4>×”×’×“×¨×•×ª ×™×œ×“</h4>

                    <!-- Kid Image -->
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-size: 0.85em; color: #666;">×ª××•× ×ª ×¤×¨×•×¤×™×œ:</label>
                        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                            <input type="file" id="kidImageUpload" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                            <button type="button" class="btn btn-secondary" style="font-size: 12px; padding: 8px 12px;" onclick="document.getElementById('kidImageUpload').click()">ğŸ“¤ ×”×¢×œ×”</button>
                            <div id="imagePreview" style="display: none; position: relative;">
                                <img id="previewImg" style="width: 60px; height: 60px; object-fit: cover; border-radius: 50%; border: 2px solid #667eea;">
                                <button type="button" onclick="removeImage()" style="position: absolute; top: -5px; right: -5px; width: 20px; height: 20px; border-radius: 50%; background: #ff6b6b; color: white; border: none; cursor: pointer; font-size: 12px;">Ã—</button>
                            </div>
                        </div>
                        <input type="hidden" id="kidImageData">
                    </div>

                    <!-- Daily Reward -->
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-size: 0.85em; color: #666;">×¤×¨×¡ ×™×•××™:</label>
                        <input type="number" id="dailyReward" placeholder="0.50" step="0.01" min="0" value="0.50" style="width: 100%; padding: 8px; border: 2px solid #eee; border-radius: 8px;">
                    </div>

                    <!-- Coin Style -->
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-size: 0.85em; color: #666;">×¡×•×’ ××˜×‘×¢:</label>
                        <select id="coinStyle" onchange="toggleCoinImageInput()" style="width: 100%; padding: 8px; border: 2px solid #eee; border-radius: 8px;">
                            <option value="dollar">×“×•×œ×¨ ($)</option>
                            <option value="shekel">×©×§×œ (â‚ª)</option>
                            <option value="custom">×ª××•× ×” ××•×ª×××ª</option>
                        </select>
                    </div>

                    <!-- Coin Image (for custom) -->
                    <div id="coinImageGroup" style="display: none; margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-size: 0.85em; color: #666;">×ª××•× ×ª ××˜×‘×¢:</label>
                        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                            <input type="file" id="coinImageUpload" accept="image/*" style="display: none;" onchange="handleCoinImageUpload(event)">
                            <button type="button" class="btn btn-secondary" style="font-size: 12px; padding: 8px 12px;" onclick="document.getElementById('coinImageUpload').click()">ğŸ“¤ ×”×¢×œ×”</button>
                            <div id="coinImagePreview" style="display: none; position: relative;">
                                <img id="coinPreviewImg" style="width: 40px; height: 40px; object-fit: cover; border-radius: 50%; border: 2px solid #ffd700;">
                                <button type="button" onclick="removeCoinImage()" style="position: absolute; top: -5px; right: -5px; width: 20px; height: 20px; border-radius: 50%; background: #ff6b6b; color: white; border: none; cursor: pointer; font-size: 12px;">Ã—</button>
                            </div>
                        </div>
                        <input type="hidden" id="coinImageData">
                    </div>

                    <!-- Color Schema -->
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; font-size: 0.85em; color: #666;">×¢×¨×›×ª ×¦×‘×¢×™×:</label>
                        <div class="color-schema-options" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                            <label class="color-schema-option" style="display: flex; align-items: center; gap: 8px; padding: 8px; border: 2px solid #eee; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                                <input type="radio" name="colorSchema" value="purple" checked style="display: none;">
                                <div style="width: 28px; height: 28px; border-radius: 6px; background: linear-gradient(135deg, #A8D5E5 0%, #89C4B8 100%); flex-shrink: 0;"></div>
                                <span style="font-size: 0.8em; font-weight: bold; color: #333;">×˜×•×¨×§×™×–</span>
                            </label>
                            <label class="color-schema-option" style="display: flex; align-items: center; gap: 8px; padding: 8px; border: 2px solid #eee; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                                <input type="radio" name="colorSchema" value="pink" style="display: none;">
                                <div style="width: 28px; height: 28px; border-radius: 6px; background: linear-gradient(135deg, #F5C6AA 0%, #E8A07E 100%); flex-shrink: 0;"></div>
                                <span style="font-size: 0.8em; font-weight: bold; color: #333;">××¤×¨×¡×§</span>
                            </label>
                            <label class="color-schema-option" style="display: flex; align-items: center; gap: 8px; padding: 8px; border: 2px solid #eee; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                                <input type="radio" name="colorSchema" value="blue" style="display: none;">
                                <div style="width: 28px; height: 28px; border-radius: 6px; background: linear-gradient(135deg, #B8D4E8 0%, #C5B8E8 100%); flex-shrink: 0;"></div>
                                <span style="font-size: 0.8em; font-weight: bold; color: #333;">×œ×‘× ×“×¨</span>
                            </label>
                            <label class="color-schema-option" style="display: flex; align-items: center; gap: 8px; padding: 8px; border: 2px solid #eee; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                                <input type="radio" name="colorSchema" value="dark" style="display: none;">
                                <div style="width: 28px; height: 28px; border-radius: 6px; background: linear-gradient(135deg, #3D5A6C 0%, #2C4A52 100%); flex-shrink: 0;"></div>
                                <span style="font-size: 0.8em; font-weight: bold; color: #333;">×›×”×”</span>
                            </label>
                        </div>
                    </div>

                    <div style="margin-top: 15px;">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="showDino" style="width: 18px; height: 18px;">
                            <span style="font-weight: bold;">ğŸ¦• ×”×¦×’ ×“×™× ×• ×¢×œ ×”×œ×•×—</span>
                        </label>
                        <div style="font-size: 0.8em; color: #666; margin-top: 5px; margin-right: 28px;">×“×™× ×•×–××•×¨ ××“×‘×¨ ×©×¢×•×–×¨ ×œ×™×œ×“×™×</div>
                    </div>
                </div>

                <h3>ğŸ§© ×¨×›×™×‘×™×</h3>

                <div class="palette-section">
                    <h4>×›×•×ª×¨×•×ª</h4>
                    <div class="palette-item" draggable="true" data-type="header" data-size="large">
                        <div class="icon">ğŸ“Œ</div>
                        <div class="label">×›×•×ª×¨×ª ×’×“×•×œ×”</div>
                    </div>
                    <div class="palette-item" draggable="true" data-type="header" data-size="medium">
                        <div class="icon">ğŸ“‹</div>
                        <div class="label">×›×•×ª×¨×ª ×‘×™× ×•× ×™×ª</div>
                    </div>
                    <div class="palette-item" draggable="true" data-type="header" data-size="small">
                        <div class="icon">ğŸ“</div>
                        <div class="label">×›×•×ª×¨×ª ×§×˜× ×”</div>
                    </div>
                </div>

                <div class="palette-section">
                    <h4>×”×ª×§×“××•×ª</h4>
                    <div class="palette-item" draggable="true" data-type="progress">
                        <div class="icon">ğŸ“Š</div>
                        <div class="label">×¡×¨×’×œ ×”×ª×§×“××•×ª ××©×™××•×ª</div>
                    </div>
                </div>

                <div class="palette-section">
                    <h4>×§×•×¤×ª ×—×™×¡×›×•×Ÿ</h4>
                    <div class="palette-item" draggable="true" data-type="bank">
                        <div class="icon">ğŸ·</div>
                        <div class="label">×§×•×¤×ª ×—×™×¡×›×•×Ÿ</div>
                    </div>
                </div>

                <div class="palette-section">
                    <h4>××©×™××•×ª</h4>
                    <div class="palette-item" draggable="true" data-type="task" data-task-type="regular">
                        <div class="icon">âœ…</div>
                        <div class="label">××©×™××” ×¨×’×™×œ×”</div>
                    </div>
                    <div class="palette-item" draggable="true" data-type="task" data-task-type="bonus">
                        <div class="icon">ğŸ’°</div>
                        <div class="label">××©×™××ª ×‘×•× ×•×¡</div>
                    </div>
                    <div class="palette-item" draggable="true" data-type="task" data-task-type="calm-down">
                        <div class="icon">ğŸ§˜</div>
                        <div class="label">×¤×¢×™×œ×•×ª ×”×¨×’×¢×”</div>
                    </div>
                </div>
            </div>

            <!-- Canvas Area -->
            <div class="canvas-container">
                <div class="canvas">
                    <div id="boardItems" class="drop-zone">
                        <div id="emptyState" class="canvas-empty">
                            <div class="icon">ğŸ‘†</div>
                            <div>×’×¨×•×¨ ×¨×›×™×‘×™× ××”×¦×“ ×›×“×™ ×œ×‘× ×•×ª ××ª ×”×œ×•×—</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Configuration Panel -->
            <div id="configPanel" class="config-panel">
                <h3>âš™ï¸ ×”×’×“×¨×•×ª ×¨×›×™×‘</h3>
                <div id="configContent">
                    <!-- Dynamic content based on selected item -->
                </div>
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button class="btn btn-primary" onclick="applyConfig()" style="flex: 1;">âœ“ ×”×—×œ ×©×™× ×•×™×™×</button>
                    <button class="btn btn-secondary" onclick="closeConfig()">×‘×™×˜×•×œ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Crop Modal -->
    <div id="cropModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>×—×ª×•×š ×ª××•× ×”</h3>
                <button class="close-btn" onclick="closeCropModal()">Ã—</button>
            </div>
            <div style="text-align: center; padding: 20px;">
                <div style="position: relative; display: inline-block; max-width: 100%;">
                    <canvas id="cropCanvas" style="max-width: 100%; border: 2px solid #667eea; border-radius: 10px;"></canvas>
                    <div id="cropBox" style="position: absolute; border: 3px solid #ffd700; cursor: move; box-shadow: 0 0 0 9999px rgba(0,0,0,0.5);">
                        <div class="resize-handle resize-nw" style="position: absolute; top: -5px; left: -5px; width: 20px; height: 20px; background: #ffd700; border: 2px solid white; border-radius: 50%; cursor: nw-resize;"></div>
                        <div class="resize-handle resize-ne" style="position: absolute; top: -5px; right: -5px; width: 20px; height: 20px; background: #ffd700; border: 2px solid white; border-radius: 50%; cursor: ne-resize;"></div>
                        <div class="resize-handle resize-sw" style="position: absolute; bottom: -5px; left: -5px; width: 20px; height: 20px; background: #ffd700; border: 2px solid white; border-radius: 50%; cursor: sw-resize;"></div>
                        <div class="resize-handle resize-se" style="position: absolute; bottom: -5px; right: -5px; width: 20px; height: 20px; background: #ffd700; border: 2px solid white; border-radius: 50%; cursor: se-resize;"></div>
                    </div>
                </div>
                <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: center;">
                    <button class="btn btn-primary" onclick="applyCrop()">âœ‚ï¸ ×—×ª×•×š</button>
                    <button class="btn btn-secondary" onclick="closeCropModal()">×‘×™×˜×•×œ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Emoji Picker Modal -->
    <div id="emojiModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>×‘×—×¨ ××™×™×§×•×Ÿ</h3>
                <button class="close-btn" onclick="closeEmojiPicker()">Ã—</button>
            </div>
            <div class="emoji-grid" id="emojiGrid"></div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDHE7FKHJ92rXXfz_3hLX8e9s8lC9g9g9o",
            authDomain: "aba-ai-d74f5.firebaseapp.com",
            projectId: "aba-ai-d74f5",
            storageBucket: "aba-ai-d74f5.firebasestorage.app",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef123456"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Custom emoji images from emojis/ directory
        const emojiImages = [
            'irobot-icon.png',
            'friendship.png','hold.png','listen.png','solving.png','strength.png'
        ];

        // Emoji categories
        const emojis = [
            'ğŸ˜€', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜', 'ğŸ˜…', 'ğŸ˜‚', 'ğŸ¤£', 'ğŸ˜Š', 'ğŸ˜‡', 'ğŸ™‚', 'ğŸ™ƒ', 'ğŸ˜‰', 'ğŸ˜Œ', 'ğŸ˜', 'ğŸ¥°', 'ğŸ˜˜',
            'ğŸ˜—', 'ğŸ˜™', 'ğŸ˜š', 'ğŸ˜‹', 'ğŸ˜›', 'ğŸ˜', 'ğŸ˜œ', 'ğŸ¤ª', 'ğŸ¤¨', 'ğŸ§', 'ğŸ¤“', 'ğŸ˜', 'ğŸ¤©', 'ğŸ¥³', 'ğŸ˜', 'ğŸ˜’',
            'ğŸ™ˆ', 'ğŸ«£',
            'ğŸ¯', 'ğŸ®', 'ğŸ²', 'ğŸ­', 'ğŸ¨', 'ğŸ¬', 'ğŸª', 'ğŸ°', 'ğŸ¸', 'ğŸ¹', 'ğŸº', 'ğŸ»', 'ğŸ¥', 'ğŸ¤', 'ğŸ§', 'ğŸ¼',
            'âš½', 'ğŸ€', 'ğŸˆ', 'âš¾', 'ğŸ¥', 'ğŸ¾', 'ğŸ', 'ğŸ‰', 'ğŸ¥', 'ğŸ±', 'ğŸª€', 'ğŸ“', 'ğŸ¸', 'ğŸ’', 'ğŸ‘', 'ğŸ¥',
            'ğŸ§’', 'ğŸ‘§', 'ğŸ‘¦', 'ğŸ‘¶', 'ğŸ–ï¸', 'ğŸ›', 'ğŸ¤', 'ğŸ‘«', 'ğŸ‘¬', 'ğŸ‘­',
            'ğŸŒ¸', 'ğŸŒº', 'ğŸŒ»', 'ğŸŒ·', 'ğŸŒ¹', 'ğŸ¥€', 'ğŸŒ¼', 'ğŸŒ±', 'ğŸŒ²', 'ğŸŒ³', 'ğŸŒ´', 'ğŸŒµ', 'ğŸŒ¾', 'ğŸŒ¿', 'â˜˜ï¸', 'ğŸ€',
            'â­', 'ğŸŒŸ', 'âœ¨', 'ğŸ’«', 'âš¡', 'ğŸ”¥', 'ğŸ’¥', 'â˜€ï¸', 'ğŸŒ™', 'ğŸŒˆ', 'â˜ï¸', 'â›…', 'ğŸŒ¤ï¸', 'â›ˆï¸', 'ğŸŒ©ï¸',
            'ğŸ¶', 'ğŸ±', 'ğŸ­', 'ğŸ¹', 'ğŸ°', 'ğŸ¦Š', 'ğŸ»', 'ğŸ¼', 'ğŸ¨', 'ğŸ¯', 'ğŸ¦', 'ğŸ®', 'ğŸ·', 'ğŸ¸', 'ğŸµ', 'ğŸ”',
            'ğŸ§', 'ğŸ¦', 'ğŸ¤', 'ğŸ¦†', 'ğŸ¦…', 'ğŸ¦‰', 'ğŸ¦‡', 'ğŸº', 'ğŸ—', 'ğŸ´', 'ğŸ¦„', 'ğŸ', 'ğŸ›', 'ğŸ¦‹', 'ğŸŒ', 'ğŸ',
            'ğŸ', 'ğŸ', 'ğŸŠ', 'ğŸ‹', 'ğŸŒ', 'ğŸ‰', 'ğŸ‡', 'ğŸ“', 'ğŸˆ', 'ğŸ’', 'ğŸ‘', 'ğŸ¥­', 'ğŸ', 'ğŸ¥¥', 'ğŸ¥', 'ğŸ…',
            'ğŸ¥‘', 'ğŸ†', 'ğŸ¥”', 'ğŸ¥•', 'ğŸŒ½', 'ğŸŒ¶ï¸', 'ğŸ¥’', 'ğŸ¥¬', 'ğŸ¥¦', 'ğŸ§„', 'ğŸ§…', 'ğŸ„', 'ğŸ¥œ', 'ğŸŒ°', 'ğŸ', 'ğŸ¥',
            'ğŸª¥', 'ğŸ§¸', 'ğŸ‘•', 'ğŸ’§', 'ğŸ¥ª', 'ğŸ‘Ÿ', 'ğŸ§¼', 'ğŸš¿', 'ğŸš½', 'ğŸ¥¤', 'ğŸ›', 'ğŸ§´', 'ğŸ§»', 'ğŸ§¹', 'ğŸ§º', 'ğŸ§½',
            'â°', 'â±ï¸', 'âŒš', 'ğŸ“š', 'ğŸ“–', 'âœï¸', 'âœ’ï¸', 'ğŸ–Šï¸', 'ğŸ–ï¸', 'ğŸ“', 'ğŸ’', 'ğŸ“', 'ğŸ“', 'ğŸ“', 'ğŸ“Œ', 'ğŸ“',
            'ğŸ›ï¸', 'ğŸ›‹ï¸', 'ğŸª‘', 'ğŸšª', 'ğŸªŸ', 'ğŸ ', 'ğŸ¡', 'ğŸ¢',
            'ğŸ“±', 'ğŸ’»', 'ğŸ–¥ï¸', 'âŒ¨ï¸', 'ğŸ–±ï¸', 'ğŸ–¨ï¸', 'ğŸ“º', 'ğŸ“·', 'ğŸ“¹', 'ğŸ¥', 'ğŸ“', 'â˜ï¸', 'ğŸ“Ÿ', 'ğŸ“ ', 'ğŸ”‹', 'ğŸ”Œ',
            'ğŸ’°', 'ğŸ’µ', 'ğŸ’´', 'ğŸ’¶', 'ğŸ’·', 'ğŸª™', 'ğŸ’³', 'ğŸ†', 'ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰', 'ğŸ–ï¸', 'ğŸ…', 'ğŸ—ï¸', 'âœ…', 'â˜‘ï¸',
            'â¤ï¸', 'ğŸ§¡', 'ğŸ’›', 'ğŸ’š', 'ğŸ’™', 'ğŸ’œ', 'ğŸ–¤', 'ğŸ¤', 'ğŸ¤', 'ğŸ’–', 'ğŸ’', 'ğŸ’—', 'ğŸ’“', 'ğŸ’', 'ğŸ’•', 'ğŸ’Œ'
        ];

        // State
        let kidId = null;
        let kidData = null;
        let boardItems = [];
        let selectedItemIndex = null;
        let draggedItemIndex = null;
        let nextItemId = 1;

        // Image upload state
        let currentImage = null;
        let currentCoinImage = null;
        let isCoinCrop = false;
        let cropState = {
            x: 0,
            y: 0,
            size: 100,
            isDragging: false,
            isResizing: false,
            resizeHandle: null,
            startX: 0,
            startY: 0,
            startSize: 0,
            startCropX: 0,
            startCropY: 0,
            minSize: 50
        };

        // Get URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        kidId = urlParams.get('kid');

        if (!kidId) {
            alert('×œ× × ×‘×—×¨ ×™×œ×“');
            window.location.href = 'admin.html';
        }

        // Initialize
        window.onload = async function() {
            await loadKidData();
            initDragAndDrop();
            initEmojiGrid();
        };

        // Load kid data
        async function loadKidData() {
            try {
                const doc = await db.collection('kids').doc(kidId).get();
                if (!doc.exists) {
                    alert('×™×œ×“ ×œ× × ××¦×');
                    window.location.href = 'admin.html';
                    return;
                }

                kidData = doc.data();
                document.getElementById('kidNameDisplay').textContent = kidData.name;

                // Load existing board layout or convert from tasks
                if (kidData.boardLayout && kidData.boardLayout.items) {
                    boardItems = kidData.boardLayout.items;
                    nextItemId = Math.max(...boardItems.map(i => i.id || 0)) + 1;
                } else {
                    // Convert existing tasks to board items
                    convertExistingTasks();
                }

                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('builderApp').style.display = 'block';

                // Load kid settings
                loadKidSettings();

                renderBoard();
            } catch (error) {
                console.error('Error loading kid:', error);
                alert('×©×’×™××” ×‘×˜×¢×™× ×”');
            }
        }

        // Load kid settings into the palette
        function loadKidSettings() {
            // Daily reward
            document.getElementById('dailyReward').value = kidData.dailyReward || 0.5;

            // Kid image
            const imageName = kidData.imageName || '';
            if (imageName) {
                if (imageName.startsWith('data:')) {
                    document.getElementById('kidImageData').value = imageName;
                    document.getElementById('previewImg').src = imageName;
                    document.getElementById('imagePreview').style.display = 'block';
                } else {
                    // It's a filename - show as preview
                    document.getElementById('previewImg').src = imageName;
                    document.getElementById('imagePreview').style.display = 'block';
                }
            }

            // Coin style
            const coinStyle = kidData.coinStyle || 'dollar';
            document.getElementById('coinStyle').value = coinStyle;
            toggleCoinImageInput();

            // Coin image
            if (coinStyle === 'custom') {
                const coinImageName = kidData.coinImageName || '';
                if (coinImageName) {
                    if (coinImageName.startsWith('data:')) {
                        document.getElementById('coinImageData').value = coinImageName;
                        document.getElementById('coinPreviewImg').src = coinImageName;
                        document.getElementById('coinImagePreview').style.display = 'block';
                    } else {
                        document.getElementById('coinPreviewImg').src = coinImageName;
                        document.getElementById('coinImagePreview').style.display = 'block';
                    }
                }
            }

            // Color schema
            const colorSchema = kidData.colorSchema || 'purple';
            const colorSchemaInput = document.querySelector(`input[name="colorSchema"][value="${colorSchema}"]`);
            if (colorSchemaInput) {
                colorSchemaInput.checked = true;
            }

            // Show Dino setting
            document.getElementById('showDino').checked = kidData.showDino || false;
        }

        // Toggle coin image input visibility
        function toggleCoinImageInput() {
            const coinStyle = document.getElementById('coinStyle').value;
            const coinImageGroup = document.getElementById('coinImageGroup');
            coinImageGroup.style.display = coinStyle === 'custom' ? 'block' : 'none';
        }

        // Convert existing tasks to board items
        function convertExistingTasks() {
            boardItems = [];

            // Add header if exists
            if (kidData.headerLabel) {
                boardItems.push({
                    id: nextItemId++,
                    type: 'header',
                    size: 'large',
                    text: kidData.headerLabel
                });
            }

            // Add bank
            boardItems.push({
                id: nextItemId++,
                type: 'bank',
                label: kidData.savingsLabel || '×§×•×¤×ª ×”×—×™×¡×›×•×Ÿ ×©×œ [×©×]',
                showBonus: true
            });

            // Add regular tasks header and tasks
            const regularTasks = (kidData.tasks || []).filter(t => !t.type || t.type === 'regular');
            if (regularTasks.length > 0) {
                if (kidData.regularTasksHeader) {
                    boardItems.push({
                        id: nextItemId++,
                        type: 'header',
                        size: 'medium',
                        text: kidData.regularTasksHeader
                    });
                }
                regularTasks.forEach(task => {
                    boardItems.push({
                        id: nextItemId++,
                        type: 'task',
                        taskType: 'regular',
                        taskData: { ...task }
                    });
                });
            }

            // Add bonus tasks header and tasks
            const bonusTasks = (kidData.tasks || []).filter(t => t.type === 'bonus');
            if (bonusTasks.length > 0) {
                if (kidData.bonusTasksHeader) {
                    boardItems.push({
                        id: nextItemId++,
                        type: 'header',
                        size: 'medium',
                        text: kidData.bonusTasksHeader
                    });
                }
                bonusTasks.forEach(task => {
                    boardItems.push({
                        id: nextItemId++,
                        type: 'task',
                        taskType: 'bonus',
                        taskData: { ...task }
                    });
                });
            }

            // Add calm-down tasks header and tasks
            const calmDownTasks = (kidData.tasks || []).filter(t => t.type === 'calm-down');
            if (calmDownTasks.length > 0) {
                if (kidData.calmDownHeader) {
                    boardItems.push({
                        id: nextItemId++,
                        type: 'header',
                        size: 'medium',
                        text: kidData.calmDownHeader
                    });
                }
                calmDownTasks.forEach(task => {
                    boardItems.push({
                        id: nextItemId++,
                        type: 'task',
                        taskType: 'calm-down',
                        taskData: { ...task }
                    });
                });
            }
        }

        // Initialize drag and drop
        function initDragAndDrop() {
            // Palette items
            document.querySelectorAll('.palette-item').forEach(item => {
                item.addEventListener('dragstart', handlePaletteDragStart);
                item.addEventListener('dragend', handleDragEnd);
            });

            // Drop zone
            const dropZone = document.getElementById('boardItems');
            dropZone.addEventListener('dragover', handleDragOver);
            dropZone.addEventListener('drop', handleDrop);
            dropZone.addEventListener('dragleave', handleDragLeave);
        }

        function handlePaletteDragStart(e) {
            e.target.classList.add('dragging');
            e.dataTransfer.setData('text/plain', JSON.stringify({
                fromPalette: true,
                type: e.target.dataset.type,
                size: e.target.dataset.size,
                taskType: e.target.dataset.taskType
            }));
        }

        function handleBoardItemDragStart(e, index) {
            e.target.classList.add('dragging');
            draggedItemIndex = index;
            e.dataTransfer.setData('text/plain', JSON.stringify({
                fromPalette: false,
                index: index
            }));
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            draggedItemIndex = null;
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
        }

        function handleDragOver(e) {
            e.preventDefault();
            const dropZone = document.getElementById('boardItems');
            dropZone.classList.add('drag-over');

            // Find closest board item for reordering
            const boardItemEls = document.querySelectorAll('.board-item');
            boardItemEls.forEach(el => el.classList.remove('drag-over'));

            const closest = getClosestBoardItem(e.clientY);
            if (closest) {
                closest.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            if (!e.relatedTarget || !document.getElementById('boardItems').contains(e.relatedTarget)) {
                document.getElementById('boardItems').classList.remove('drag-over');
            }
        }

        function getClosestBoardItem(y) {
            const boardItemEls = [...document.querySelectorAll('.board-item')];
            return boardItemEls.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > (closest.offset || -Infinity)) {
                    return { offset: offset, element: child };
                }
                return closest;
            }, {}).element;
        }

        function handleDrop(e) {
            e.preventDefault();
            document.getElementById('boardItems').classList.remove('drag-over');
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));

            const data = JSON.parse(e.dataTransfer.getData('text/plain'));

            // Find drop position
            const closest = getClosestBoardItem(e.clientY);
            let dropIndex = boardItems.length;
            if (closest) {
                const closestIndex = parseInt(closest.dataset.index);
                dropIndex = closestIndex;
            }

            if (data.fromPalette) {
                // Create new item from palette
                const newItem = createNewItem(data.type, data.size, data.taskType);
                boardItems.splice(dropIndex, 0, newItem);
            } else {
                // Reorder existing item
                if (data.index !== undefined && data.index !== dropIndex) {
                    const [movedItem] = boardItems.splice(data.index, 1);
                    if (data.index < dropIndex) dropIndex--;
                    boardItems.splice(dropIndex, 0, movedItem);
                }
            }

            renderBoard();
        }

        // Create new item
        function createNewItem(type, size, taskType) {
            const item = {
                id: nextItemId++,
                type: type
            };

            if (type === 'header') {
                item.size = size || 'medium';
                item.text = '×›×•×ª×¨×ª ×—×“×©×”';
            } else if (type === 'progress') {
                item.title = '×”×”×ª×§×“××•×ª ×©×œ×™ ×”×™×•×';
            } else if (type === 'bank') {
                item.label = '×§×•×¤×ª ×”×—×™×¡×›×•×Ÿ ×©×œ [×©×]';
                item.showBonus = true;
            } else if (type === 'task') {
                item.taskType = taskType || 'regular';
                item.taskData = {
                    id: nextItemId,
                    icon: 'ğŸ¯',
                    title: '××©×™××” ×—×“×©×”',
                    type: taskType || 'regular',
                    requiresTestimony: false,
                    trackTime: false,
                    activeDays: [0, 1, 2, 3, 4, 5, 6]
                };

                if (taskType === 'bonus') {
                    item.taskData.minReward = 1;
                    item.taskData.maxReward = 5;
                } else if (taskType === 'calm-down') {
                    item.taskData.activityType = 'paint';
                    item.taskData.activityUrl = '';
                }
            }

            return item;
        }

        // Render board
        function renderBoard() {
            const container = document.getElementById('boardItems');
            const emptyState = document.getElementById('emptyState');

            // Clear existing items (except empty state)
            container.querySelectorAll('.board-item').forEach(el => el.remove());

            if (boardItems.length === 0) {
                emptyState.style.display = 'flex';
                return;
            }

            emptyState.style.display = 'none';

            boardItems.forEach((item, index) => {
                const itemEl = document.createElement('div');
                itemEl.className = 'board-item';
                itemEl.draggable = true;
                itemEl.dataset.index = index;

                // Add type-specific classes
                if (item.type === 'header') {
                    itemEl.classList.add('header-item', `header-${item.size}`);
                } else if (item.type === 'progress') {
                    itemEl.classList.add('progress-item');
                } else if (item.type === 'bank') {
                    itemEl.classList.add('bank-item');
                } else if (item.type === 'task') {
                    itemEl.classList.add(`task-${item.taskType}`);
                }

                itemEl.innerHTML = renderItemContent(item);

                // Drag events
                itemEl.addEventListener('dragstart', (e) => handleBoardItemDragStart(e, index));
                itemEl.addEventListener('dragend', handleDragEnd);

                // Click to configure
                itemEl.addEventListener('click', (e) => {
                    if (!e.target.closest('.board-item-actions')) {
                        selectItem(index);
                    }
                });

                container.appendChild(itemEl);
            });
        }

        // Render item content
        function renderItemContent(item) {
            let typeLabel = '';
            let icon = '';
            let title = '';
            let subtitle = '';

            if (item.type === 'header') {
                typeLabel = '×›×•×ª×¨×ª';
                icon = item.size === 'large' ? 'ğŸ“Œ' : (item.size === 'medium' ? 'ğŸ“‹' : 'ğŸ“');
                title = item.text || '×›×•×ª×¨×ª';
                subtitle = item.size === 'large' ? '×’×“×•×œ×”' : (item.size === 'medium' ? '×‘×™× ×•× ×™×ª' : '×§×˜× ×”');
            } else if (item.type === 'progress') {
                typeLabel = '×¡×¨×’×œ ×”×ª×§×“××•×ª';
                icon = 'ğŸ“Š';
                title = item.title || '×”×”×ª×§×“××•×ª ×©×œ×™ ×”×™×•×';
                subtitle = '××¦×™×’ ××ª ××—×•×– ×”×©×œ××ª ×”××©×™××•×ª ×”×™×•××™×•×ª';
            } else if (item.type === 'bank') {
                typeLabel = '×§×•×¤×ª ×—×™×¡×›×•×Ÿ';
                icon = 'ğŸ·';
                title = item.label || '×§×•×¤×ª ×”×—×™×¡×›×•×Ÿ';
                subtitle = item.showBonus ? '×›×•×œ×œ ×‘×•× ×•×¡' : '';
            } else if (item.type === 'task') {
                typeLabel = item.taskType === 'regular' ? '××©×™××”' : (item.taskType === 'bonus' ? '×‘×•× ×•×¡' : '×”×¨×’×¢×”');
                const taskData = item.taskData || {};

                // Handle icon display
                if (taskData.icon && taskData.icon.startsWith('IMG:')) {
                    const imageName = taskData.icon.substring(4);
                    icon = `<img src="emojis/${imageName}" />`;
                } else {
                    icon = taskData.icon || 'ğŸ¯';
                }

                title = taskData.title || '××©×™××”';

                // Build subtitle
                const subtitleParts = [];
                if (taskData.requiresTestimony) subtitleParts.push('ğŸ“ ×¢×“×•×ª');
                if (taskData.trackTime) subtitleParts.push('â±ï¸ ××¢×§×‘ ×–××Ÿ');
                if (item.taskType === 'bonus') {
                    subtitleParts.push(`ğŸ’° $${taskData.minReward || 0}-$${taskData.maxReward || 0}`);
                }
                if (item.taskType === 'calm-down') {
                    const activityTypes = {
                        'paint': 'ğŸ¨ ×¦×™×•×¨',
                        'bubbles': 'ğŸ«§ ×‘×•×¢×•×ª',
                        'xylophone': 'ğŸ¹ ×§×¡×™×œ×•×¤×•×Ÿ',
                        'breathing': 'ğŸ§˜ × ×©×™××•×ª',
                        'scooter': 'ğŸ›´ ×§×•×¨×§×™× ×˜',
                        'link': 'ğŸ”— ×§×™×©×•×¨'
                    };
                    subtitleParts.push(activityTypes[taskData.activityType] || '');
                }
                subtitle = subtitleParts.join(' | ');
            }

            return `
                <div class="board-item-header">
                    <span class="board-item-type">${typeLabel}</span>
                    <div class="board-item-actions">
                        <button onclick="duplicateItem(${boardItems.indexOf(item)})" title="×©×›×¤×œ">ğŸ“‹</button>
                        <button onclick="deleteItem(${boardItems.indexOf(item)})" title="××—×§">ğŸ—‘ï¸</button>
                    </div>
                </div>
                <div class="board-item-content">
                    <div class="board-item-icon">${icon}</div>
                    <div class="board-item-details">
                        <div class="board-item-title">${title}</div>
                        <div class="board-item-subtitle">${subtitle}</div>
                    </div>
                </div>
            `;
        }

        // Select item for configuration
        function selectItem(index) {
            selectedItemIndex = index;
            const item = boardItems[index];

            const configPanel = document.getElementById('configPanel');
            const configContent = document.getElementById('configContent');

            configContent.innerHTML = renderConfigForm(item);
            configPanel.classList.add('active');

            // Highlight selected item
            document.querySelectorAll('.board-item').forEach((el, i) => {
                el.style.outline = i === index ? '3px solid #667eea' : 'none';
            });
        }

        // Render configuration form
        function renderConfigForm(item) {
            if (item.type === 'progress') {
                return `
                    <div class="config-group">
                        <label>×›×•×ª×¨×ª:</label>
                        <input type="text" id="configProgressTitle" value="${item.title || '×”×”×ª×§×“××•×ª ×©×œ×™ ×”×™×•×'}" placeholder="×”×›× ×¡ ×›×•×ª×¨×ª">
                        <small>×”×©×ª××© ×‘-[×©×] ×œ×”×›×œ×œ×ª ×©× ×”×™×œ×“</small>
                    </div>
                `;
            }

            if (item.type === 'header') {
                return `
                    <div class="config-group">
                        <label>×˜×§×¡×˜ ×”×›×•×ª×¨×ª:</label>
                        <input type="text" id="configText" value="${item.text || ''}" placeholder="×”×›× ×¡ ×˜×§×¡×˜">
                        <small>×”×©×ª××© ×‘-[×©×] ×œ×”×›×œ×œ×ª ×©× ×”×™×œ×“</small>
                    </div>
                    <div class="config-group">
                        <label>×’×•×“×œ:</label>
                        <select id="configSize">
                            <option value="large" ${item.size === 'large' ? 'selected' : ''}>×’×“×•×œ</option>
                            <option value="medium" ${item.size === 'medium' ? 'selected' : ''}>×‘×™× ×•× ×™</option>
                            <option value="small" ${item.size === 'small' ? 'selected' : ''}>×§×˜×Ÿ</option>
                        </select>
                    </div>
                `;
            } else if (item.type === 'bank') {
                return `
                    <div class="config-group">
                        <label>×›×•×ª×¨×ª ×”×§×•×¤×”:</label>
                        <input type="text" id="configLabel" value="${item.label || ''}" placeholder="×§×•×¤×ª ×”×—×™×¡×›×•×Ÿ">
                        <small>×”×©×ª××© ×‘-[×©×] ×œ×”×›×œ×œ×ª ×©× ×”×™×œ×“</small>
                    </div>
                    <div class="config-checkbox">
                        <input type="checkbox" id="configShowBonus" ${item.showBonus ? 'checked' : ''}>
                        <label for="configShowBonus">×”×¦×’ ×‘×•× ×•×¡ ×™×•××™</label>
                    </div>
                `;
            } else if (item.type === 'task') {
                const taskData = item.taskData || {};
                let iconDisplay = taskData.icon || 'ğŸ¯';
                if (iconDisplay.startsWith('IMG:')) {
                    const imageName = iconDisplay.substring(4);
                    iconDisplay = `<img src="emojis/${imageName}" />`;
                }

                let html = `
                    <div class="config-group">
                        <label>××™×™×§×•×Ÿ:</label>
                        <div class="emoji-picker-trigger" onclick="openEmojiPicker()" id="configIcon" data-icon="${taskData.icon || 'ğŸ¯'}">
                            ${iconDisplay}
                        </div>
                    </div>
                    <div class="config-group">
                        <label>×©× ×”××©×™××”:</label>
                        <input type="text" id="configTitle" value="${taskData.title || ''}" placeholder="×”×›× ×¡ ×©× ××©×™××”">
                    </div>
                    <div class="config-group">
                        <label>×›××•×ª:</label>
                        <input type="number" id="configQuantity" value="${taskData.quantity || 1}" min="1" placeholder="1">
                        <small>××¡×¤×¨ ×¤×¢××™× ×©×”××©×™××” ×ª×•×¤×™×¢</small>
                    </div>
                `;

                // Bonus-specific fields
                if (item.taskType === 'bonus') {
                    html += `
                        <div class="config-group">
                            <label>×¤×¨×¡ ××™× ×™××•× ($):</label>
                            <input type="number" id="configMinReward" value="${taskData.minReward || 0}" min="0" step="0.1">
                        </div>
                        <div class="config-group">
                            <label>×¤×¨×¡ ××§×¡×™××•× ($):</label>
                            <input type="number" id="configMaxReward" value="${taskData.maxReward || 0}" min="0" step="0.1">
                        </div>
                    `;
                }

                // Calm-down specific fields
                if (item.taskType === 'calm-down') {
                    html += `
                        <div class="config-group">
                            <label>×¡×•×’ ×¤×¢×™×œ×•×ª:</label>
                            <select id="configActivityType">
                                <option value="paint" ${taskData.activityType === 'paint' ? 'selected' : ''}>×œ×•×— ×¦×™×•×¨</option>
                                <option value="bubbles" ${taskData.activityType === 'bubbles' ? 'selected' : ''}>××©×—×§ ×‘×•×¢×•×ª</option>
                                <option value="xylophone" ${taskData.activityType === 'xylophone' ? 'selected' : ''}>×§×¡×™×œ×•×¤×•×Ÿ</option>
                                <option value="breathing" ${taskData.activityType === 'breathing' ? 'selected' : ''}>×ª×¨×’×™×œ × ×©×™××•×ª</option>
                                <option value="scooter" ${taskData.activityType === 'scooter' ? 'selected' : ''}>×§×¤×™×¦×” ×¢×œ ×§×•×¨×§×™× ×˜</option>
                                <option value="link" ${taskData.activityType === 'link' ? 'selected' : ''}>×§×™×©×•×¨ ×—×™×¦×•× ×™</option>
                            </select>
                        </div>
                        <div class="config-group" id="activityUrlGroup" style="${taskData.activityType === 'link' ? '' : 'display:none'}">
                            <label>×›×ª×•×‘×ª URL:</label>
                            <input type="text" id="configActivityUrl" value="${taskData.activityUrl || ''}" placeholder="https://...">
                        </div>
                    `;
                }

                // Common task options (not for calm-down)
                if (item.taskType !== 'calm-down') {
                    html += `
                        <div class="config-checkbox">
                            <input type="checkbox" id="configTestimony" ${taskData.requiresTestimony ? 'checked' : ''}>
                            <label for="configTestimony">×“×•×¨×© ×¢×“×•×ª (×ª×™××•×¨)</label>
                        </div>
                        <div class="config-checkbox">
                            <input type="checkbox" id="configTrackTime" ${taskData.trackTime ? 'checked' : ''}>
                            <label for="configTrackTime">××¢×§×‘ ×–××Ÿ</label>
                        </div>
                    `;
                }

                // Days selector
                const activeDays = taskData.activeDays || [0, 1, 2, 3, 4, 5, 6];
                const dayNames = ['××³', '×‘×³', '×’×³', '×“×³', '×”×³', '×•×³', '×©×‘×ª'];
                html += `
                    <div class="config-group">
                        <label>×™××™× ×¤×¢×™×œ×™×:</label>
                        <div class="days-selector">
                            ${dayNames.map((name, i) => `
                                <div class="day-checkbox">
                                    <input type="checkbox" id="configDay${i}" data-day="${i}" ${activeDays.includes(i) ? 'checked' : ''}>
                                    <label for="configDay${i}">${name}</label>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;

                return html;
            }

            return '';
        }

        // Apply configuration
        function applyConfig() {
            if (selectedItemIndex === null) return;

            const item = boardItems[selectedItemIndex];

            if (item.type === 'header') {
                item.text = document.getElementById('configText').value;
                item.size = document.getElementById('configSize').value;
            } else if (item.type === 'progress') {
                item.title = document.getElementById('configProgressTitle').value;
            } else if (item.type === 'bank') {
                item.label = document.getElementById('configLabel').value;
                item.showBonus = document.getElementById('configShowBonus').checked;
            } else if (item.type === 'task') {
                const taskData = item.taskData;
                taskData.icon = document.getElementById('configIcon').dataset.icon;
                taskData.title = document.getElementById('configTitle').value;
                taskData.quantity = parseInt(document.getElementById('configQuantity').value) || 1;

                if (item.taskType === 'bonus') {
                    taskData.minReward = parseFloat(document.getElementById('configMinReward').value) || 0;
                    taskData.maxReward = parseFloat(document.getElementById('configMaxReward').value) || 0;
                }

                if (item.taskType === 'calm-down') {
                    taskData.activityType = document.getElementById('configActivityType').value;
                    taskData.activityUrl = document.getElementById('configActivityUrl')?.value || '';
                }

                if (item.taskType !== 'calm-down') {
                    taskData.requiresTestimony = document.getElementById('configTestimony').checked;
                    taskData.trackTime = document.getElementById('configTrackTime').checked;
                }

                // Days
                const activeDays = [];
                for (let i = 0; i <= 6; i++) {
                    if (document.getElementById(`configDay${i}`).checked) {
                        activeDays.push(i);
                    }
                }
                taskData.activeDays = activeDays;
            }

            renderBoard();
            closeConfig();
        }

        // Close configuration panel
        function closeConfig() {
            document.getElementById('configPanel').classList.remove('active');
            document.querySelectorAll('.board-item').forEach(el => {
                el.style.outline = 'none';
            });
            selectedItemIndex = null;
        }

        // Delete item
        function deleteItem(index) {
            if (confirm('×œ××—×•×§ ××ª ×”×¨×›×™×‘?')) {
                boardItems.splice(index, 1);
                renderBoard();
                closeConfig();
            }
        }

        // Duplicate item
        function duplicateItem(index) {
            const item = JSON.parse(JSON.stringify(boardItems[index]));
            item.id = nextItemId++;
            if (item.taskData) {
                item.taskData.id = nextItemId;
            }
            boardItems.splice(index + 1, 0, item);
            renderBoard();
        }

        // Emoji picker
        function initEmojiGrid() {
            const emojiGrid = document.getElementById('emojiGrid');

            emojis.forEach(emoji => {
                const emojiItem = document.createElement('div');
                emojiItem.className = 'emoji-item';
                emojiItem.textContent = emoji;
                emojiItem.onclick = () => selectEmoji(emoji);
                emojiGrid.appendChild(emojiItem);
            });

            emojiImages.forEach(imageName => {
                const emojiItem = document.createElement('div');
                emojiItem.className = 'emoji-item';
                emojiItem.innerHTML = `<img src="emojis/${imageName}" style="width: 40px; height: 40px; object-fit: contain;" />`;
                emojiItem.onclick = () => selectEmoji(`IMG:${imageName}`);
                emojiGrid.appendChild(emojiItem);
            });
        }

        function openEmojiPicker() {
            document.getElementById('emojiModal').classList.add('active');
        }

        function closeEmojiPicker() {
            document.getElementById('emojiModal').classList.remove('active');
        }

        function selectEmoji(emoji) {
            const configIcon = document.getElementById('configIcon');
            if (configIcon) {
                configIcon.dataset.icon = emoji;
                if (emoji.startsWith('IMG:')) {
                    const imageName = emoji.substring(4);
                    configIcon.innerHTML = `<img src="emojis/${imageName}" />`;
                } else {
                    configIcon.textContent = emoji;
                }
            }
            closeEmojiPicker();
        }

        document.getElementById('emojiModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEmojiPicker();
            }
        });

        // Activity type change handler
        document.addEventListener('change', function(e) {
            if (e.target.id === 'configActivityType') {
                const urlGroup = document.getElementById('activityUrlGroup');
                if (urlGroup) {
                    urlGroup.style.display = e.target.value === 'link' ? '' : 'none';
                }
            }
        });

        // ==================== Image Upload Functions ====================

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                alert('× × ×œ×‘×—×•×¨ ×§×•×‘×¥ ×ª××•× ×”');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    currentImage = img;
                    isCoinCrop = false;
                    showCropModal();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function handleCoinImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                alert('× × ×œ×‘×—×•×¨ ×§×•×‘×¥ ×ª××•× ×”');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    currentCoinImage = img;
                    isCoinCrop = true;
                    showCropModal();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function showCropModal() {
            const modal = document.getElementById('cropModal');
            const canvas = document.getElementById('cropCanvas');
            const ctx = canvas.getContext('2d');
            const cropBox = document.getElementById('cropBox');

            const imageToUse = isCoinCrop ? currentCoinImage : currentImage;

            const isMobile = window.innerWidth <= 600;
            const maxSize = isMobile ? Math.min(window.innerWidth - 60, 400) : 500;
            let width = imageToUse.width;
            let height = imageToUse.height;

            if (width > maxSize || height > maxSize) {
                if (width > height) {
                    height = (height / width) * maxSize;
                    width = maxSize;
                } else {
                    width = (width / height) * maxSize;
                    height = maxSize;
                }
            }

            canvas.width = width;
            canvas.height = height;
            ctx.drawImage(imageToUse, 0, 0, width, height);

            const cropSize = Math.min(width, height) * 0.7;
            cropState.size = cropSize;
            cropState.x = (width - cropSize) / 2;
            cropState.y = (height - cropSize) / 2;

            updateCropBox();

            cropBox.onmousedown = startDrag;
            cropBox.ontouchstart = startDrag;

            const handles = cropBox.querySelectorAll('.resize-handle');
            handles.forEach(handle => {
                handle.onmousedown = (e) => startResize(e, handle.classList[1]);
                handle.ontouchstart = (e) => startResize(e, handle.classList[1]);
            });

            document.onmousemove = handleMove;
            document.onmouseup = stopDragOrResize;
            document.ontouchmove = handleMove;
            document.ontouchend = stopDragOrResize;

            modal.classList.add('active');
        }

        function updateCropBox() {
            const cropBox = document.getElementById('cropBox');
            cropBox.style.left = cropState.x + 'px';
            cropBox.style.top = cropState.y + 'px';
            cropBox.style.width = cropState.size + 'px';
            cropBox.style.height = cropState.size + 'px';
        }

        function startDrag(e) {
            if (e.target.classList.contains('resize-handle')) return;
            e.preventDefault();
            e.stopPropagation();
            cropState.isDragging = true;

            const cropBox = document.getElementById('cropBox');
            const rect = cropBox.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            cropState.startX = clientX - rect.left;
            cropState.startY = clientY - rect.top;
        }

        function startResize(e, handle) {
            e.preventDefault();
            e.stopPropagation();
            cropState.isResizing = true;
            cropState.resizeHandle = handle;

            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            cropState.startX = clientX;
            cropState.startY = clientY;
            cropState.startSize = cropState.size;
            cropState.startCropX = cropState.x;
            cropState.startCropY = cropState.y;
        }

        function handleMove(e) {
            if (cropState.isDragging) {
                dragCropBox(e);
            } else if (cropState.isResizing) {
                resizeCropBox(e);
            }
        }

        function dragCropBox(e) {
            e.preventDefault();

            const canvas = document.getElementById('cropCanvas');
            const canvasRect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            let newX = clientX - canvasRect.left - cropState.startX;
            let newY = clientY - canvasRect.top - cropState.startY;

            newX = Math.max(0, Math.min(newX, canvas.width - cropState.size));
            newY = Math.max(0, Math.min(newY, canvas.height - cropState.size));

            cropState.x = newX;
            cropState.y = newY;
            updateCropBox();
        }

        function resizeCropBox(e) {
            e.preventDefault();

            const canvas = document.getElementById('cropCanvas');
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            const deltaX = clientX - cropState.startX;
            const deltaY = clientY - cropState.startY;

            let newSize = cropState.startSize;
            let newX = cropState.startCropX;
            let newY = cropState.startCropY;

            switch(cropState.resizeHandle) {
                case 'resize-se':
                    newSize = Math.max(cropState.minSize, cropState.startSize + Math.max(deltaX, deltaY));
                    break;
                case 'resize-sw':
                    newSize = Math.max(cropState.minSize, cropState.startSize + Math.max(-deltaX, deltaY));
                    newX = cropState.startCropX - (newSize - cropState.startSize);
                    break;
                case 'resize-ne':
                    newSize = Math.max(cropState.minSize, cropState.startSize + Math.max(deltaX, -deltaY));
                    newY = cropState.startCropY - (newSize - cropState.startSize);
                    break;
                case 'resize-nw':
                    newSize = Math.max(cropState.minSize, cropState.startSize + Math.max(-deltaX, -deltaY));
                    newX = cropState.startCropX - (newSize - cropState.startSize);
                    newY = cropState.startCropY - (newSize - cropState.startSize);
                    break;
            }

            newX = Math.max(0, Math.min(newX, canvas.width - newSize));
            newY = Math.max(0, Math.min(newY, canvas.height - newSize));
            newSize = Math.min(newSize, canvas.width - newX, canvas.height - newY);

            cropState.size = newSize;
            cropState.x = newX;
            cropState.y = newY;
            updateCropBox();
        }

        function stopDragOrResize() {
            cropState.isDragging = false;
            cropState.isResizing = false;
            cropState.resizeHandle = null;
        }

        function applyCrop() {
            const canvas = document.getElementById('cropCanvas');
            const imageToUse = isCoinCrop ? currentCoinImage : currentImage;

            const scaleX = imageToUse.width / canvas.width;
            const scaleY = imageToUse.height / canvas.height;

            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');

            const finalSize = 200;
            tempCanvas.width = finalSize;
            tempCanvas.height = finalSize;

            tempCtx.drawImage(
                imageToUse,
                cropState.x * scaleX,
                cropState.y * scaleY,
                cropState.size * scaleX,
                cropState.size * scaleY,
                0,
                0,
                finalSize,
                finalSize
            );

            // Check for transparency
            let dataUrl;
            const imageData = tempCtx.getImageData(0, 0, finalSize, finalSize);
            let hasTransparency = false;

            for (let i = 3; i < imageData.data.length; i += 4) {
                if (imageData.data[i] < 255) {
                    hasTransparency = true;
                    break;
                }
            }

            if (hasTransparency) {
                dataUrl = tempCanvas.toDataURL('image/png');
            } else {
                dataUrl = tempCanvas.toDataURL('image/jpeg', 0.85);
            }

            if (isCoinCrop) {
                document.getElementById('coinImageData').value = dataUrl;
                document.getElementById('coinPreviewImg').src = dataUrl;
                document.getElementById('coinImagePreview').style.display = 'block';
                isCoinCrop = false;
            } else {
                document.getElementById('kidImageData').value = dataUrl;
                document.getElementById('previewImg').src = dataUrl;
                document.getElementById('imagePreview').style.display = 'block';
            }

            closeCropModal();
        }

        function closeCropModal() {
            const modal = document.getElementById('cropModal');
            modal.classList.remove('active');
            document.getElementById('kidImageUpload').value = '';
            document.getElementById('coinImageUpload').value = '';
            isCoinCrop = false;
        }

        function removeImage() {
            document.getElementById('kidImageData').value = '';
            document.getElementById('previewImg').src = '';
            document.getElementById('imagePreview').style.display = 'none';
        }

        function removeCoinImage() {
            document.getElementById('coinImageData').value = '';
            document.getElementById('coinPreviewImg').src = '';
            document.getElementById('coinImagePreview').style.display = 'none';
        }

        // Click outside crop modal to close
        document.getElementById('cropModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeCropModal();
            }
        });

        // ==================== End Image Upload Functions ====================

        // Save board
        async function saveBoard() {
            try {
                // Convert board items to tasks array for backward compatibility
                const tasks = [];
                let taskId = 1;

                boardItems.forEach(item => {
                    if (item.type === 'task' && item.taskData) {
                        const taskData = { ...item.taskData };
                        const quantity = taskData.quantity || 1;
                        delete taskData.quantity; // Don't store quantity in individual tasks

                        // Create multiple task instances based on quantity
                        for (let i = 0; i < quantity; i++) {
                            tasks.push({
                                ...taskData,
                                id: taskId++,
                                type: item.taskType
                            });
                        }
                    }
                });

                // Extract headers for backward compatibility
                const headers = boardItems.filter(i => i.type === 'header');
                const bankItem = boardItems.find(i => i.type === 'bank');

                // Find section headers (headers before tasks of each type)
                let regularTasksHeader = '';
                let bonusTasksHeader = '';
                let calmDownHeader = '';
                let headerLabel = '';

                // First large header becomes page header
                const largeHeader = headers.find(h => h.size === 'large');
                if (largeHeader) {
                    headerLabel = largeHeader.text;
                }

                // Find headers for each section by looking at what comes after them
                for (let i = 0; i < boardItems.length; i++) {
                    const item = boardItems[i];
                    if (item.type === 'header' && item !== largeHeader) {
                        // Look for next task to determine section
                        for (let j = i + 1; j < boardItems.length; j++) {
                            const nextItem = boardItems[j];
                            if (nextItem.type === 'task') {
                                if (nextItem.taskType === 'regular' && !regularTasksHeader) {
                                    regularTasksHeader = item.text;
                                } else if (nextItem.taskType === 'bonus' && !bonusTasksHeader) {
                                    bonusTasksHeader = item.text;
                                } else if (nextItem.taskType === 'calm-down' && !calmDownHeader) {
                                    calmDownHeader = item.text;
                                }
                                break;
                            }
                            if (nextItem.type === 'header') break;
                        }
                    }
                }

                // Get kid settings from palette
                const dailyReward = parseFloat(document.getElementById('dailyReward').value) || 0.5;
                const coinStyle = document.getElementById('coinStyle').value;
                const colorSchema = document.querySelector('input[name="colorSchema"]:checked').value;
                const showDino = document.getElementById('showDino').checked;

                // Get kid image - prefer uploaded data, fall back to existing
                let imageName = document.getElementById('kidImageData').value || kidData.imageName || '';

                // Get coin image - prefer uploaded data, fall back to existing
                let coinImageName = '';
                if (coinStyle === 'custom') {
                    coinImageName = document.getElementById('coinImageData').value || kidData.coinImageName || '';
                }

                // Save to Firestore
                await db.collection('kids').doc(kidId).update({
                    tasks: tasks,
                    boardLayout: { items: boardItems },
                    headerLabel: headerLabel,
                    savingsLabel: bankItem?.label || '',
                    regularTasksHeader: regularTasksHeader,
                    bonusTasksHeader: bonusTasksHeader,
                    calmDownHeader: calmDownHeader,
                    // Kid settings
                    dailyReward: dailyReward,
                    imageName: imageName,
                    coinStyle: coinStyle,
                    coinImageName: coinImageName,
                    colorSchema: colorSchema,
                    showDino: showDino
                });

                // Update local kidData
                kidData.dailyReward = dailyReward;
                kidData.imageName = imageName;
                kidData.coinStyle = coinStyle;
                kidData.coinImageName = coinImageName;
                kidData.colorSchema = colorSchema;
                kidData.showDino = showDino;

                alert('×”×œ×•×— × ×©××¨ ×‘×”×¦×œ×—×”!');
            } catch (error) {
                console.error('Error saving board:', error);
                alert('×©×’×™××” ×‘×©××™×¨×”: ' + error.message);
            }
        }

        // Preview board
        function previewBoard() {
            window.open(`board.html?kid=${kidId}`, '_blank');
        }
    </script>
</body>
</html>
