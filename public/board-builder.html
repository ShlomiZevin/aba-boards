<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×‘×•× ×” ×œ×•×—×•×ª - ABA</title>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- Doing Theme -->
    <link rel="stylesheet" href="doing-theme-light.css">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            direction: rtl;
        }

        /* Top Bar */
        .top-bar {
            background: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .top-bar h1 {
            color: #667eea;
            font-size: 1.5em;
        }

        .top-bar-buttons {
            display: flex;
            gap: 10px;
        }

        /* Override theme button styles for board-builder page */
        .btn {
            padding: 10px 20px !important;
            border: none !important;
            border-radius: 12px !important;
            cursor: pointer;
            font-weight: bold !important;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            font-size: 14px !important;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2) !important;
        }

        .btn-secondary {
            background: #f0f0f0 !important;
            color: #333 !important;
        }

        .btn-success {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%) !important;
            color: white !important;
        }

        /* Main Layout */
        .builder-container {
            display: flex;
            height: calc(100vh - 70px);
        }

        /* Component Palette (Left Sidebar) */
        .palette {
            width: 280px;
            background: white;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }

        .palette h3 {
            color: #667eea;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }

        .palette-section {
            margin-bottom: 25px;
        }

        .palette-section h4 {
            color: #333;
            margin-bottom: 10px;
            font-size: 0.9em;
        }

        .palette-item {
            background: #f8f9fa;
            border: 2px dashed #ddd;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: grab;
            transition: all 0.3s ease;
            text-align: center;
        }

        .palette-item:hover {
            border-color: #667eea;
            background: #f0f0ff;
            transform: scale(1.02);
        }

        .palette-item.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .palette-item .icon {
            font-size: 2em;
            margin-bottom: 5px;
        }

        .palette-item .label {
            font-size: 0.85em;
            color: #666;
        }

        /* Canvas Area */
        .canvas-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .canvas {
            background: white;
            border-radius: 20px;
            min-height: 600px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .canvas-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 400px;
            color: #999;
            border: 3px dashed #ddd;
            border-radius: 12px;
            margin: 20px;
        }

        .canvas-empty .icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        /* Drop Zone */
        .drop-zone {
            min-height: 100px;
            border: 2px dashed transparent;
            border-radius: 12px;
            transition: all 0.3s ease;
            padding: 10px;
        }

        .drop-zone.drag-over {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        /* Board Items */
        .board-item {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            cursor: move;
            position: relative;
            transition: all 0.3s ease;
        }

        .board-item:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .board-item.dragging {
            opacity: 0.5;
        }

        .board-item.drag-over {
            border-color: #667eea;
            border-style: dashed;
        }

        .board-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .board-item-type {
            background: #667eea;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: bold;
        }

        .board-item-actions {
            display: flex;
            gap: 5px;
        }

        .board-item-actions button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2em;
            opacity: 0.6;
            transition: opacity 0.3s;
        }

        .board-item-actions button:hover {
            opacity: 1;
        }

        .board-item-content {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .board-item-icon {
            font-size: 2em;
            width: 50px;
            text-align: center;
        }

        .board-item-icon img {
            width: 50px;
            height: 50px;
            object-fit: contain;
        }

        .board-item-details {
            flex: 1;
        }

        .board-item-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .board-item-subtitle {
            font-size: 0.85em;
            color: #666;
        }

        /* Header Item Styles */
        .board-item.header-small .board-item-title { font-size: 1em; }
        .board-item.header-medium .board-item-title { font-size: 1.3em; }
        .board-item.header-large .board-item-title { font-size: 1.6em; }

        .board-item.header-item {
            background: linear-gradient(135deg, #667eea20 0%, #764ba220 100%);
            border-color: #667eea;
        }

        /* Bank Item Style */
        .board-item.bank-item {
            background: linear-gradient(135deg, #ffd70020 0%, #ffed4e20 100%);
            border-color: #ffd700;
        }

        .board-item.bank-item .board-item-type {
            background: #ffd700;
            color: #333;
        }

        /* Progress Bar Item Style */
        .board-item.progress-item {
            background: linear-gradient(135deg, #4CAF5020 0%, #8BC34A20 100%);
            border-color: #4CAF50;
        }

        .board-item.progress-item .board-item-type {
            background: #4CAF50;
            color: white;
        }

        /* Task Item Styles */
        .board-item.task-regular {
            background: white;
        }

        .board-item.task-bonus {
            background: linear-gradient(135deg, #ffd70010 0%, #ffed4e10 100%);
            border-color: #ffd700;
        }

        .board-item.task-bonus .board-item-type {
            background: #ffd700;
            color: #333;
        }

        .board-item.task-calm-down {
            background: linear-gradient(135deg, #a8edea20 0%, #fed6e320 100%);
            border-color: #89CFF0;
        }

        .board-item.task-calm-down .board-item-type {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #333;
        }

        /* Goal Item Style */
        .board-item.goal-item {
            background: linear-gradient(135deg, #ffecd220 0%, #fcb69f20 100%);
            border-color: #f093fb;
        }

        .board-item.goal-item .board-item-type {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        /* Configuration Panel (Right Sidebar) */
        .config-panel {
            width: 350px;
            background: white;
            padding: 20px;
            overflow-y: auto;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1);
            display: none;
        }

        .config-panel.active {
            display: block;
        }

        .config-panel h3 {
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }

        .config-group {
            margin-bottom: 20px;
        }

        .config-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
            font-size: 0.9em;
        }

        .config-group input,
        .config-group select,
        .config-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #eee;
            border-radius: 12px;
            font-size: 14px;
            direction: rtl;
        }

        .config-group input:focus,
        .config-group select:focus,
        .config-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .config-group small {
            color: #666;
            font-size: 0.8em;
            display: block;
            margin-top: 5px;
        }

        .config-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .config-checkbox input {
            width: 18px;
            height: 18px;
        }

        .config-checkbox label {
            margin: 0;
            font-weight: normal;
        }

        /* Days Selector */
        .days-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .day-checkbox {
            display: flex;
            align-items: center;
            gap: 4px;
            background: #f8f9fa;
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 0.85em;
        }

        .day-checkbox input {
            width: 16px;
            height: 16px;
        }

        /* Emoji Picker */
        .emoji-picker-trigger {
            width: 60px;
            height: 60px;
            border: 2px solid #eee;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .emoji-picker-trigger:hover {
            border-color: #667eea;
            transform: scale(1.05);
        }

        .emoji-picker-trigger img {
            width: 50px;
            height: 50px;
            object-fit: contain;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #667eea;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #666;
        }

        #emojiModal > .modal-content {
            align-self: flex-start;
            margin-top: 10vh;
        }

        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
            gap: 10px;
            margin-top: 20px;
            min-height: 300px;
            align-content: start;
        }

        .emoji-item {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            cursor: pointer;
            border: 2px solid #eee;
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .emoji-item:hover {
            transform: scale(1.2);
            border-color: #667eea;
            background: #f0f0ff;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.5em;
            color: white;
        }

        /* Color Schema Selection */
        .color-schema-option:has(input:checked) {
            border-color: #667eea !important;
            background: #f0f0ff;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.25);
        }

        .color-schema-option {
            transition: all 0.2s ease;
        }

        .color-schema-option:hover {
            border-color: #a0aec0;
        }

        /* Responsive - Tablet */
        @media (max-width: 1024px) {
            .palette {
                width: 240px;
            }

            .config-panel {
                width: 300px;
            }
        }

        /* Responsive - Mobile */
        @media (max-width: 768px) {
            .top-bar {
                padding: 12px 16px;
                flex-direction: column;
                gap: 12px;
                position: relative;
            }

            .top-bar h1 {
                font-size: 1.1em;
                text-align: center;
                order: 1;
            }

            .top-bar-buttons {
                order: 2;
                width: 100%;
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }

            .top-bar-buttons .btn {
                padding: 10px 8px;
                font-size: 12px;
                text-align: center;
                justify-content: center;
            }

            .builder-container {
                flex-direction: column;
                height: auto;
                min-height: calc(100vh - 120px);
            }

            /* Palette becomes horizontal scrollable strip on mobile */
            .palette {
                width: 100%;
                max-height: none;
                padding: 12px;
                overflow-x: auto;
                overflow-y: hidden;
                box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }

            .palette h3 {
                display: none;
            }

            .palette-section {
                margin-bottom: 0;
            }

            /* Kid settings section - collapsible on mobile */
            .palette-section:first-child {
                display: none;
            }

            .palette-section h4 {
                display: none;
            }

            /* Horizontal layout for palette items */
            .palette-section:not(:first-child) {
                display: inline-flex;
                gap: 10px;
                white-space: nowrap;
            }

            .palette-item {
                min-width: 80px;
                padding: 10px;
                margin-bottom: 0;
                flex-shrink: 0;
            }

            .palette-item .icon {
                font-size: 1.5em;
                margin-bottom: 4px;
            }

            .palette-item .label {
                font-size: 0.7em;
            }

            /* Canvas area */
            .canvas-container {
                padding: 12px;
                flex: 1;
            }

            .canvas {
                padding: 16px;
                border-radius: 20px;
                min-height: auto;
            }

            .canvas-empty {
                height: 250px;
                margin: 10px;
            }

            .canvas-empty .icon {
                font-size: 3em;
            }

            /* Board items */
            .board-item {
                padding: 12px;
                border-radius: 12px;
                margin-bottom: 10px;
            }

            .board-item-header {
                margin-bottom: 8px;
            }

            .board-item-type {
                font-size: 0.65em;
                padding: 2px 8px;
            }

            .board-item-content {
                gap: 10px;
            }

            .board-item-icon {
                font-size: 1.5em;
                width: 40px;
            }

            .board-item-icon img {
                width: 40px;
                height: 40px;
            }

            .board-item-title {
                font-size: 0.95em;
            }

            .board-item-subtitle {
                font-size: 0.75em;
            }

            /* Config panel - slide up from bottom */
            .config-panel {
                width: 100%;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                max-height: 70vh;
                border-radius: 20px 20px 0 0;
                box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
                z-index: 200;
                padding: 16px;
            }

            .config-panel h3 {
                font-size: 1.1em;
                margin-bottom: 16px;
                padding-bottom: 12px;
            }

            .config-group {
                margin-bottom: 16px;
            }

            .config-group label {
                font-size: 0.85em;
            }

            .config-group input,
            .config-group select,
            .config-group textarea {
                padding: 10px;
                font-size: 14px;
            }

            .days-selector {
                gap: 6px;
            }

            .day-checkbox {
                padding: 4px 8px;
                font-size: 0.8em;
            }

            .emoji-picker-trigger {
                width: 50px;
                height: 50px;
                font-size: 1.5em;
            }

            /* Modal adjustments */
            .modal-content {
                padding: 20px;
                border-radius: 20px;
                max-width: 95%;
            }

            .emoji-grid {
                grid-template-columns: repeat(auto-fill, minmax(45px, 1fr));
                gap: 8px;
            }

            .emoji-item {
                width: 45px;
                height: 45px;
                font-size: 1.5em;
            }

            /* Add mobile settings toggle button */
            .mobile-settings-toggle {
                display: block;
                width: 100%;
                padding: 12px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border: none;
                border-radius: 12px;
                font-weight: bold;
                font-size: 14px;
                cursor: pointer;
                margin-bottom: 12px;
            }

            /* Drop zone indicator on mobile */
            .drop-zone {
                min-height: 150px;
            }
        }

        /* Very small screens */
        @media (max-width: 400px) {
            .top-bar-buttons {
                grid-template-columns: 1fr 1fr;
            }

            .top-bar-buttons .btn:first-child {
                grid-column: span 2;
            }

            .board-item-actions button {
                font-size: 1em;
                padding: 4px;
            }

            .config-panel {
                max-height: 80vh;
            }
        }

        /* Desktop - hide mobile elements */
        @media (min-width: 769px) {
            .mobile-settings-toggle {
                display: none;
            }
        }
    </style>
</head>
<body class="doing-theme">
    <div id="loadingState" class="loading">×˜×•×¢×Ÿ...</div>

    <div id="builderApp" style="display: none;">
        <!-- Top Bar -->
        <div class="top-bar">
            <h1>ğŸ¨ ×‘×•× ×” ×œ×•×—×•×ª - <span id="kidNameDisplay">×˜×•×¢×Ÿ...</span></h1>
            <div class="top-bar-buttons">
                <a href="admin.html" class="btn btn-secondary">â† ×—×–×¨×” ×œ× ×™×”×•×œ</a>
                <button class="btn btn-primary" onclick="previewBoard()">ğŸ‘ï¸ ×ª×¦×•×’×” ××§×“×™××”</button>
                <button class="btn btn-success" onclick="saveBoard()">ğŸ’¾ ×©××•×¨ ×œ×•×—</button>
            </div>
        </div>

        <div class="builder-container">
            <!-- Component Palette -->
            <div class="palette">
                <!-- Kid Settings Section (at top) -->
                <div class="palette-section" style="padding-bottom: 15px; margin-bottom: 15px; border-bottom: 2px solid #eee;">
                    <h4>×”×’×“×¨×•×ª ×™×œ×“</h4>

                    <!-- Kid Image -->
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-size: 0.85em; color: #666;">×ª××•× ×ª ×¤×¨×•×¤×™×œ:</label>
                        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                            <input type="file" id="kidImageUpload" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                            <button type="button" class="btn btn-secondary" style="font-size: 12px; padding: 8px 12px;" onclick="document.getElementById('kidImageUpload').click()">ğŸ“¤ ×”×¢×œ×”</button>
                            <div id="imagePreview" style="display: none; position: relative;">
                                <img id="previewImg" style="width: 60px; height: 60px; object-fit: cover; border-radius: 50%; border: 2px solid #667eea;">
                                <button type="button" onclick="removeImage()" style="position: absolute; top: -5px; right: -5px; width: 20px; height: 20px; border-radius: 50%; background: #ff6b6b; color: white; border: none; cursor: pointer; font-size: 12px;">Ã—</button>
                            </div>
                        </div>
                        <input type="hidden" id="kidImageData">
                    </div>

                    <!-- Daily Reward -->
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-size: 0.85em; color: #666;">×¤×¨×¡ ×™×•××™:</label>
                        <input type="number" id="dailyReward" placeholder="0.50" step="0.01" min="0" value="0.50" style="width: 100%; padding: 8px; border: 2px solid #eee; border-radius: 12px;">
                    </div>

                    <!-- Total Money -->
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-size: 0.85em; color: #666;">×¡×”×´×› ×›×¡×£ × ×•×›×—×™:</label>
                        <input type="number" id="totalMoney" placeholder="0" step="0.01" min="0" value="0" style="width: 100%; padding: 8px; border: 2px solid #eee; border-radius: 12px;">
                    </div>

                    <!-- Age -->
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-size: 0.85em; color: #666;">×’×™×œ:</label>
                        <input type="number" id="kidAge" placeholder="×’×™×œ" min="1" max="18" step="1" style="width: 100%; padding: 8px; border: 2px solid #eee; border-radius: 12px;">
                    </div>

                    <!-- Gender -->
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-size: 0.85em; color: #666;">××™×Ÿ:</label>
                        <select id="kidGender" style="width: 100%; padding: 8px; border: 2px solid #eee; border-radius: 12px;">
                            <option value="">×œ× × ×‘×—×¨</option>
                            <option value="boy">×‘×Ÿ</option>
                            <option value="girl">×‘×ª</option>
                        </select>
                    </div>

                    <!-- Kid Description -->
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-size: 0.85em; color: #666;">×ª×™××•×¨ ×”×™×œ×“:</label>
                        <textarea id="kidDescription" placeholder="×ª×™××•×¨ ×›×œ×œ×™ ×¢×œ ×”×™×œ×“..." rows="2" style="width: 100%; padding: 8px; border: 2px solid #eee; border-radius: 12px; resize: vertical; font-family: inherit;"></textarea>
                    </div>

                    <!-- Behavior Goals -->
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-size: 0.85em; color: #666;">××˜×¨×•×ª ×•×”×ª× ×”×’×•×™×•×ª ×œ×—×™×–×•×§:</label>
                        <textarea id="behaviorGoals" placeholder="××˜×¨×•×ª, ×”×ª× ×”×’×•×™×•×ª ×œ×¢×‘×•×“ ×¢×œ×™×”×Ÿ..." rows="2" style="width: 100%; padding: 8px; border: 2px solid #eee; border-radius: 12px; resize: vertical; font-family: inherit;"></textarea>
                    </div>

                    <!-- Coin Style -->
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-size: 0.85em; color: #666;">×¡×•×’ ××˜×‘×¢:</label>
                        <select id="coinStyle" onchange="toggleCoinImageInput()" style="width: 100%; padding: 8px; border: 2px solid #eee; border-radius: 12px;">
                            <option value="dollar">×“×•×œ×¨ ($)</option>
                            <option value="shekel">×©×§×œ (â‚ª)</option>
                            <option value="points">× ×§×•×“×•×ª</option>
                            <option value="custom">×ª××•× ×” ××•×ª×××ª</option>
                        </select>
                    </div>

                    <!-- Coin Image (for custom) -->
                    <div id="coinImageGroup" style="display: none; margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-size: 0.85em; color: #666;">×ª××•× ×ª ××˜×‘×¢:</label>
                        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                            <input type="file" id="coinImageUpload" accept="image/*" style="display: none;" onchange="handleCoinImageUpload(event)">
                            <button type="button" class="btn btn-secondary" style="font-size: 12px; padding: 8px 12px;" onclick="document.getElementById('coinImageUpload').click()">ğŸ“¤ ×”×¢×œ×”</button>
                            <div id="coinImagePreview" style="display: none; position: relative;">
                                <img id="coinPreviewImg" style="width: 40px; height: 40px; object-fit: cover; border-radius: 50%; border: 2px solid #ffd700;">
                                <button type="button" onclick="removeCoinImage()" style="position: absolute; top: -5px; right: -5px; width: 20px; height: 20px; border-radius: 50%; background: #ff6b6b; color: white; border: none; cursor: pointer; font-size: 12px;">Ã—</button>
                            </div>
                        </div>
                        <input type="hidden" id="coinImageData">
                    </div>

                    <!-- Color Schema -->
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 8px; font-size: 0.85em; color: #666;">×¢×¨×›×ª ×¦×‘×¢×™×:</label>
                        <div class="color-schema-options" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px;">
                            <label class="color-schema-option" style="display: flex; align-items: center; gap: 8px; padding: 8px; border: 2px solid #eee; border-radius: 12px; cursor: pointer; transition: all 0.2s;">
                                <input type="radio" name="colorSchema" value="purple" checked style="display: none;">
                                <div style="width: 28px; height: 28px; border-radius: 6px; background: linear-gradient(135deg, #A8D5E5 0%, #89C4B8 100%); flex-shrink: 0;"></div>
                                <span style="font-size: 0.8em; font-weight: bold; color: #333;">×˜×•×¨×§×™×–</span>
                            </label>
                            <label class="color-schema-option" style="display: flex; align-items: center; gap: 8px; padding: 8px; border: 2px solid #eee; border-radius: 12px; cursor: pointer; transition: all 0.2s;">
                                <input type="radio" name="colorSchema" value="pink" style="display: none;">
                                <div style="width: 28px; height: 28px; border-radius: 6px; background: linear-gradient(135deg, #F5C6AA 0%, #E8A07E 100%); flex-shrink: 0;"></div>
                                <span style="font-size: 0.8em; font-weight: bold; color: #333;">××¤×¨×¡×§</span>
                            </label>
                            <label class="color-schema-option" style="display: flex; align-items: center; gap: 8px; padding: 8px; border: 2px solid #eee; border-radius: 12px; cursor: pointer; transition: all 0.2s;">
                                <input type="radio" name="colorSchema" value="blue" style="display: none;">
                                <div style="width: 28px; height: 28px; border-radius: 6px; background: linear-gradient(135deg, #B8D4E8 0%, #C5B8E8 100%); flex-shrink: 0;"></div>
                                <span style="font-size: 0.8em; font-weight: bold; color: #333;">×œ×‘× ×“×¨</span>
                            </label>
                            <label class="color-schema-option" style="display: flex; align-items: center; gap: 8px; padding: 8px; border: 2px solid #eee; border-radius: 12px; cursor: pointer; transition: all 0.2s;">
                                <input type="radio" name="colorSchema" value="dark" style="display: none;">
                                <div style="width: 28px; height: 28px; border-radius: 6px; background: linear-gradient(135deg, #3D5A6C 0%, #2C4A52 100%); flex-shrink: 0;"></div>
                                <span style="font-size: 0.8em; font-weight: bold; color: #333;">×›×”×”</span>
                            </label>
                        </div>
                    </div>

                    <div style="margin-top: 15px;">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="showDino" style="width: 18px; height: 18px;">
                            <span style="font-weight: bold;">ğŸ¦• ×”×¦×’ ×“×™× ×• ×¢×œ ×”×œ×•×—</span>
                        </label>
                        <div style="font-size: 0.8em; color: #666; margin-top: 5px; margin-right: 28px;">×“×™× ×•×–××•×¨ ××“×‘×¨ ×©×¢×•×–×¨ ×œ×™×œ×“×™×</div>
                    </div>
                </div>

                <h3>ğŸ§© ×¨×›×™×‘×™×</h3>

                <div class="palette-section">
                    <h4>×›×•×ª×¨×•×ª</h4>
                    <div class="palette-item" draggable="true" data-type="header" data-size="large">
                        <div class="icon">ğŸ“Œ</div>
                        <div class="label">×›×•×ª×¨×ª ×’×“×•×œ×”</div>
                    </div>
                    <div class="palette-item" draggable="true" data-type="header" data-size="medium">
                        <div class="icon">ğŸ“‹</div>
                        <div class="label">×›×•×ª×¨×ª ×‘×™× ×•× ×™×ª</div>
                    </div>
                    <div class="palette-item" draggable="true" data-type="header" data-size="small">
                        <div class="icon">ğŸ“</div>
                        <div class="label">×›×•×ª×¨×ª ×§×˜× ×”</div>
                    </div>
                </div>

                <div class="palette-section">
                    <h4>×”×ª×§×“××•×ª</h4>
                    <div class="palette-item" draggable="true" data-type="progress">
                        <div class="icon">ğŸ“Š</div>
                        <div class="label">×¡×¨×’×œ ×”×ª×§×“××•×ª ××©×™××•×ª</div>
                    </div>
                </div>

                <div class="palette-section">
                    <h4>×§×•×¤×ª ×—×™×¡×›×•×Ÿ</h4>
                    <div class="palette-item" draggable="true" data-type="bank">
                        <div class="icon">ğŸ·</div>
                        <div class="label">×§×•×¤×ª ×—×™×¡×›×•×Ÿ</div>
                    </div>
                </div>

                <div class="palette-section">
                    <h4>××©×™××•×ª</h4>
                    <div class="palette-item" draggable="true" data-type="task" data-task-type="regular">
                        <div class="icon">âœ…</div>
                        <div class="label">××©×™××” ×¨×’×™×œ×”</div>
                    </div>
                    <div class="palette-item" draggable="true" data-type="task" data-task-type="bonus">
                        <div class="icon">ğŸ’°</div>
                        <div class="label">××©×™××ª ×‘×•× ×•×¡</div>
                    </div>
                    <div class="palette-item" draggable="true" data-type="task" data-task-type="calm-down">
                        <div class="icon">ğŸ§˜</div>
                        <div class="label">×¤×¢×™×œ×•×ª ×”×¨×’×¢×”</div>
                    </div>
                    <div class="palette-item" draggable="true" data-type="task" data-task-type="composite">
                        <div class="icon">ğŸ“¦</div>
                        <div class="label">××©×™××” ×¢× ×ª×ª×™-××©×™××•×ª</div>
                    </div>
                </div>

                <div class="palette-section">
                    <h4>×™×¢×“×™× ×•×¤×¨×¡×™×</h4>
                    <div class="palette-item" draggable="true" data-type="goal">
                        <div class="icon">ğŸ†</div>
                        <div class="label">×™×¢×“ / ×¤×¨×¡</div>
                    </div>
                </div>
            </div>

            <!-- Canvas Area -->
            <div class="canvas-container">
                <!-- Mobile Settings Button -->
                <button class="mobile-settings-toggle" onclick="openMobileSettings()">
                    âš™ï¸ ×”×’×“×¨×•×ª ×™×œ×“ (×ª××•× ×”, ×¦×‘×¢×™×, ×•×¢×•×“)
                </button>
                <div class="canvas">
                    <div id="boardItems" class="drop-zone">
                        <div id="emptyState" class="canvas-empty">
                            <div class="icon">ğŸ‘†</div>
                            <div>×’×¨×•×¨ ×¨×›×™×‘×™× ××”×¦×“ ×›×“×™ ×œ×‘× ×•×ª ××ª ×”×œ×•×—</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Configuration Panel -->
            <div id="configPanel" class="config-panel">
                <h3>âš™ï¸ ×”×’×“×¨×•×ª ×¨×›×™×‘</h3>
                <div id="configContent">
                    <!-- Dynamic content based on selected item -->
                </div>
                <div style="margin-top: 20px; display: flex; gap: 10px;">
                    <button class="btn btn-primary" onclick="applyConfig()" style="flex: 1;">âœ“ ×”×—×œ ×©×™× ×•×™×™×</button>
                    <button class="btn btn-secondary" onclick="closeConfig()">×‘×™×˜×•×œ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Crop Modal -->
    <div id="cropModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>×—×ª×•×š ×ª××•× ×”</h3>
                <button class="close-btn" onclick="closeCropModal()">Ã—</button>
            </div>
            <div style="text-align: center; padding: 20px;">
                <div style="position: relative; display: inline-block; max-width: 100%;">
                    <canvas id="cropCanvas" style="max-width: 100%; border: 2px solid #667eea; border-radius: 10px;"></canvas>
                    <div id="cropBox" style="position: absolute; border: 3px solid #ffd700; cursor: move; box-shadow: 0 0 0 9999px rgba(0,0,0,0.5);">
                        <div class="resize-handle resize-nw" style="position: absolute; top: -5px; left: -5px; width: 20px; height: 20px; background: #ffd700; border: 2px solid white; border-radius: 50%; cursor: nw-resize;"></div>
                        <div class="resize-handle resize-ne" style="position: absolute; top: -5px; right: -5px; width: 20px; height: 20px; background: #ffd700; border: 2px solid white; border-radius: 50%; cursor: ne-resize;"></div>
                        <div class="resize-handle resize-sw" style="position: absolute; bottom: -5px; left: -5px; width: 20px; height: 20px; background: #ffd700; border: 2px solid white; border-radius: 50%; cursor: sw-resize;"></div>
                        <div class="resize-handle resize-se" style="position: absolute; bottom: -5px; right: -5px; width: 20px; height: 20px; background: #ffd700; border: 2px solid white; border-radius: 50%; cursor: se-resize;"></div>
                    </div>
                </div>
                <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: center;">
                    <button class="btn btn-primary" onclick="applyCrop()">âœ‚ï¸ ×—×ª×•×š</button>
                    <button class="btn btn-secondary" onclick="closeCropModal()">×‘×™×˜×•×œ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Emoji Picker Modal -->
    <div id="emojiModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>×‘×—×¨ ××™×™×§×•×Ÿ</h3>
                <button class="close-btn" onclick="closeEmojiPicker()">Ã—</button>
            </div>
            <input type="text" id="emojiSearch" placeholder="×—×™×¤×•×©..." oninput="filterEmojis(this.value)" style="width:100%;padding:10px 14px;border:2px solid #eee;border-radius:12px;font-size:1em;margin-bottom:12px;box-sizing:border-box;direction:rtl;">
            <div class="emoji-grid" id="emojiGrid"></div>
        </div>
    </div>

    <!-- Mobile Settings Modal -->
    <div id="mobileSettingsModal" class="modal">
        <div class="modal-content" style="max-width: 450px; max-height: 85vh; overflow-y: auto;">
            <div class="modal-header">
                <h3>âš™ï¸ ×”×’×“×¨×•×ª ×™×œ×“</h3>
                <button class="close-btn" onclick="closeMobileSettings()">Ã—</button>
            </div>
            <div id="mobileSettingsContent">
                <!-- Kid Image -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">×ª××•× ×ª ×¤×¨×•×¤×™×œ:</label>
                    <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                        <input type="file" id="kidImageUploadMobile" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('kidImageUploadMobile').click()">ğŸ“¤ ×”×¢×œ×” ×ª××•× ×”</button>
                        <div id="imagePreviewMobile" style="display: none; position: relative;">
                            <img id="previewImgMobile" style="width: 60px; height: 60px; object-fit: cover; border-radius: 50%; border: 2px solid #667eea;">
                            <button type="button" onclick="removeImage()" style="position: absolute; top: -5px; right: -5px; width: 20px; height: 20px; border-radius: 50%; background: #ff6b6b; color: white; border: none; cursor: pointer; font-size: 12px;">Ã—</button>
                        </div>
                    </div>
                </div>

                <!-- Daily Reward -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">×¤×¨×¡ ×™×•××™:</label>
                    <input type="number" id="dailyRewardMobile" placeholder="0.50" step="0.01" min="0" value="0.50" style="width: 100%; padding: 12px; border: 2px solid #eee; border-radius: 12px; font-size: 16px;">
                </div>

                <!-- Total Money -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">×¡×”×´×› ×›×¡×£ × ×•×›×—×™:</label>
                    <input type="number" id="totalMoneyMobile" placeholder="0" step="0.01" min="0" value="0" style="width: 100%; padding: 12px; border: 2px solid #eee; border-radius: 12px; font-size: 16px;">
                </div>

                <!-- Age -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">×’×™×œ:</label>
                    <input type="number" id="kidAgeMobile" placeholder="×’×™×œ" min="1" max="18" step="1" style="width: 100%; padding: 12px; border: 2px solid #eee; border-radius: 12px; font-size: 16px;">
                </div>

                <!-- Gender -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">××™×Ÿ:</label>
                    <select id="kidGenderMobile" style="width: 100%; padding: 12px; border: 2px solid #eee; border-radius: 12px; font-size: 16px;">
                        <option value="">×œ× × ×‘×—×¨</option>
                        <option value="boy">×‘×Ÿ</option>
                        <option value="girl">×‘×ª</option>
                    </select>
                </div>

                <!-- Kid Description -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">×ª×™××•×¨ ×”×™×œ×“:</label>
                    <textarea id="kidDescriptionMobile" placeholder="×ª×™××•×¨ ×›×œ×œ×™ ×¢×œ ×”×™×œ×“..." rows="3" style="width: 100%; padding: 12px; border: 2px solid #eee; border-radius: 12px; font-size: 16px; resize: vertical; font-family: inherit;"></textarea>
                </div>

                <!-- Behavior Goals -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">××˜×¨×•×ª ×•×”×ª× ×”×’×•×™×•×ª ×œ×—×™×–×•×§:</label>
                    <textarea id="behaviorGoalsMobile" placeholder="××˜×¨×•×ª, ×”×ª× ×”×’×•×™×•×ª ×œ×¢×‘×•×“ ×¢×œ×™×”×Ÿ..." rows="3" style="width: 100%; padding: 12px; border: 2px solid #eee; border-radius: 12px; font-size: 16px; resize: vertical; font-family: inherit;"></textarea>
                </div>

                <!-- Coin Style -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">×¡×•×’ ××˜×‘×¢:</label>
                    <select id="coinStyleMobile" onchange="toggleCoinImageInputMobile()" style="width: 100%; padding: 12px; border: 2px solid #eee; border-radius: 12px; font-size: 16px;">
                        <option value="dollar">×“×•×œ×¨ ($)</option>
                        <option value="shekel">×©×§×œ (â‚ª)</option>
                        <option value="points">× ×§×•×“×•×ª</option>
                        <option value="custom">×ª××•× ×” ××•×ª×××ª</option>
                    </select>
                </div>

                <!-- Coin Image (for custom) -->
                <div id="coinImageGroupMobile" style="display: none; margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">×ª××•× ×ª ××˜×‘×¢:</label>
                    <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                        <input type="file" id="coinImageUploadMobile" accept="image/*" style="display: none;" onchange="handleCoinImageUpload(event)">
                        <button type="button" class="btn btn-secondary" onclick="document.getElementById('coinImageUploadMobile').click()">ğŸ“¤ ×”×¢×œ×”</button>
                        <div id="coinImagePreviewMobile" style="display: none; position: relative;">
                            <img id="coinPreviewImgMobile" style="width: 40px; height: 40px; object-fit: cover; border-radius: 50%; border: 2px solid #ffd700;">
                            <button type="button" onclick="removeCoinImage()" style="position: absolute; top: -5px; right: -5px; width: 20px; height: 20px; border-radius: 50%; background: #ff6b6b; color: white; border: none; cursor: pointer; font-size: 12px;">Ã—</button>
                        </div>
                    </div>
                </div>

                <!-- Color Schema -->
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: bold; color: #333;">×¢×¨×›×ª ×¦×‘×¢×™×:</label>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                        <label class="color-schema-option" style="display: flex; align-items: center; gap: 10px; padding: 12px; border: 2px solid #eee; border-radius: 12px; cursor: pointer;">
                            <input type="radio" name="colorSchemaMobile" value="purple" checked style="display: none;">
                            <div style="width: 32px; height: 32px; border-radius: 8px; background: linear-gradient(135deg, #A8D5E5 0%, #89C4B8 100%); flex-shrink: 0;"></div>
                            <span style="font-size: 0.9em; font-weight: bold;">×˜×•×¨×§×™×–</span>
                        </label>
                        <label class="color-schema-option" style="display: flex; align-items: center; gap: 10px; padding: 12px; border: 2px solid #eee; border-radius: 12px; cursor: pointer;">
                            <input type="radio" name="colorSchemaMobile" value="pink" style="display: none;">
                            <div style="width: 32px; height: 32px; border-radius: 8px; background: linear-gradient(135deg, #F5C6AA 0%, #E8A07E 100%); flex-shrink: 0;"></div>
                            <span style="font-size: 0.9em; font-weight: bold;">××¤×¨×¡×§</span>
                        </label>
                        <label class="color-schema-option" style="display: flex; align-items: center; gap: 10px; padding: 12px; border: 2px solid #eee; border-radius: 12px; cursor: pointer;">
                            <input type="radio" name="colorSchemaMobile" value="blue" style="display: none;">
                            <div style="width: 32px; height: 32px; border-radius: 8px; background: linear-gradient(135deg, #B8D4E8 0%, #C5B8E8 100%); flex-shrink: 0;"></div>
                            <span style="font-size: 0.9em; font-weight: bold;">×œ×‘× ×“×¨</span>
                        </label>
                        <label class="color-schema-option" style="display: flex; align-items: center; gap: 10px; padding: 12px; border: 2px solid #eee; border-radius: 12px; cursor: pointer;">
                            <input type="radio" name="colorSchemaMobile" value="dark" style="display: none;">
                            <div style="width: 32px; height: 32px; border-radius: 8px; background: linear-gradient(135deg, #3D5A6C 0%, #2C4A52 100%); flex-shrink: 0;"></div>
                            <span style="font-size: 0.9em; font-weight: bold;">×›×”×”</span>
                        </label>
                    </div>
                </div>

                <!-- Show Dino -->
                <div style="margin-bottom: 20px;">
                    <label style="display: flex; align-items: center; gap: 12px; cursor: pointer; padding: 12px; background: #f8f9fa; border-radius: 12px;">
                        <input type="checkbox" id="showDinoMobile" style="width: 20px; height: 20px;">
                        <span style="font-weight: bold;">ğŸ¦• ×”×¦×’ ×“×™× ×• ×¢×œ ×”×œ×•×—</span>
                    </label>
                    <div style="font-size: 0.85em; color: #666; margin-top: 8px; padding-right: 10px;">×“×™× ×•×–××•×¨ ××“×‘×¨ ×©×¢×•×–×¨ ×œ×™×œ×“×™×</div>
                </div>

                <button class="btn btn-primary" onclick="applyMobileSettings()" style="width: 100%; padding: 14px; font-size: 16px;">
                    âœ“ ×©××•×¨ ×”×’×“×¨×•×ª
                </button>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDHE7FKHJ92rXXfz_3hLX8e9s8lC9g9g9o",
            authDomain: "aba-ai-d74f5.firebaseapp.com",
            projectId: "aba-ai-d74f5",
            storageBucket: "aba-ai-d74f5.firebasestorage.app",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef123456"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Custom emoji images from emojis/ directory
        const emojiImages = [
            'irobot-icon.png',
            'friendship.png','hold.png','listen.png','solving.png','strength.png'
        ];

        // Emoji data: e = emoji, t = search tags (English + Hebrew)
        const emojis = [
            // Smileys & faces
            {e:'ğŸ˜€',t:'smile happy grin face ×©××— ×—×™×•×š ×¤×¨×¦×•×£'},{e:'ğŸ˜ƒ',t:'smile happy open face ×©××— ×—×™×•×š'},{e:'ğŸ˜„',t:'smile happy eyes face ×©××— ×—×™×•×š'},{e:'ğŸ˜',t:'grin beam happy ×©××— ×—×™×•×š'},{e:'ğŸ˜…',t:'smile sweat nervous ×©××— ×–×™×¢×”'},{e:'ğŸ˜‚',t:'laugh cry tears funny ×¦×•×—×§ ×“××¢×•×ª ××¦×—×™×§'},{e:'ğŸ¤£',t:'rofl laugh rolling funny ×¦×•×—×§ ××¦×—×™×§'},{e:'ğŸ˜Š',t:'smile blush happy shy ×©××— ××¡××™×§'},{e:'ğŸ˜‡',t:'angel halo innocent ××œ××š ×ª××™×'},{e:'ğŸ™‚',t:'smile slight happy ×©××— ×—×™×•×š'},{e:'ğŸ™ƒ',t:'upside down silly ×”×¤×•×š ××©×•×’×¢'},{e:'ğŸ˜‰',t:'wink face ×§×¨×™×¦×”'},{e:'ğŸ˜Œ',t:'relieved calm peaceful ×¨×’×•×¢ ×©×œ×•'},{e:'ğŸ˜',t:'heart eyes love ××”×‘×” ×¢×™× ×™×™× ×œ×‘'},{e:'ğŸ¥°',t:'love hearts smile ××”×‘×” ×œ×‘×‘×•×ª'},{e:'ğŸ˜˜',t:'kiss blow love × ×©×™×§×” ××”×‘×”'},
            {e:'ğŸ˜—',t:'kiss face × ×©×™×§×”'},{e:'ğŸ˜™',t:'kiss smile eyes × ×©×™×§×” ×—×™×•×š'},{e:'ğŸ˜š',t:'kiss blush eyes × ×©×™×§×” ××¡××™×§'},{e:'ğŸ˜‹',t:'yummy delicious tongue ×˜×¢×™× ×œ×©×•×Ÿ'},{e:'ğŸ˜›',t:'tongue out playful ×œ×©×•×Ÿ ×©×•×‘×‘'},{e:'ğŸ˜',t:'tongue squint playful ×œ×©×•×Ÿ ×©×•×‘×‘'},{e:'ğŸ˜œ',t:'wink tongue crazy ×œ×©×•×Ÿ ×§×¨×™×¦×” ××©×•×’×¢'},{e:'ğŸ¤ª',t:'zany crazy wild ××©×•×’×¢ ×¤×¨×•×¢'},{e:'ğŸ¤¨',t:'raised eyebrow suspicious ×—×©×“×Ÿ ×’×‘×”'},{e:'ğŸ§',t:'monocle curious smart ×—×›× ×¡×§×¨×Ÿ'},{e:'ğŸ¤“',t:'nerd glasses smart ×—× ×•×Ÿ ××©×§×¤×™×™×'},{e:'ğŸ˜',t:'cool sunglasses awesome ××’× ×™×‘ ××©×§×¤×™ ×©××©'},{e:'ğŸ¤©',t:'star struck excited wow ××¨×’×© ×›×•×›×‘×™×'},{e:'ğŸ¥³',t:'party celebrate birthday ××¡×™×‘×” ×—×’×™×’×” ×™×•× ×”×•×œ×“×ª'},{e:'ğŸ˜',t:'smirk sly ×—×™×•×š ×¢×¨××•××™'},{e:'ğŸ˜’',t:'unamused bored annoyed ××©×•×¢×× ××¢×•×¦×‘×Ÿ'},
            {e:'ğŸ™ˆ',t:'monkey hide peek ×§×•×£ ××¡×ª×™×¨'},{e:'ğŸ«£',t:'peeking shy hide ××¦×™×¥ ×‘×™×™×©×Ÿ'},
            // More faces & emotions (new)
            {e:'ğŸ˜´',t:'sleep sleeping zzz tired ×™×©×Ÿ ×¢×™×™×£ ×©×™× ×”'},{e:'ğŸ¥±',t:'yawn tired sleepy ×¢×™×™×£ ×¤×™×”×•×§'},{e:'ğŸ˜¤',t:'angry frustrated huff ×›×•×¢×¡ ××ª×•×¡×›×œ'},{e:'ğŸ˜¡',t:'angry mad rage ×›×•×¢×¡ ×–×•×¢×'},{e:'ğŸ¤¯',t:'mind blown explode shocked ××•×¤×ª×¢ ××•×— ×”×ª×¤×•×¦×¥'},{e:'ğŸ¥¶',t:'cold freezing frozen ×§×¨ ×§×¤×•×'},{e:'ğŸ¥µ',t:'hot warm sweating ×—× ××–×™×¢'},{e:'ğŸ˜°',t:'anxious worried scared ×—×¨×“ ××•×“××’'},{e:'ğŸ˜±',t:'scream shock horror fear ×¦×•×¨×— ××–×•×¢×–×¢ ×¤×—×“'},{e:'ğŸ¤—',t:'hug warm embrace friendly ×—×™×‘×•×§ ×—× ×™×“×™×“×•×ª×™'},{e:'ğŸ¤”',t:'thinking wonder hmm ×—×•×©×‘ ×ª×•×”×”'},{e:'ğŸ«¡',t:'salute respect honor ×›×‘×•×“ ×”×¦×“×¢×”'},{e:'ğŸ« ',t:'melt relax happy × ××¡ ×¨×’×•×¢'},{e:'ğŸ¥¹',t:'emotional touched tears ××¨×’×© × ×¨×’×©'},{e:'ğŸ«¢',t:'surprised oops hand mouth ××•×¤×ª×¢ ××•×¤×¡'},{e:'ğŸ˜®',t:'surprised wow open mouth ××•×¤×ª×¢ ×•×•××•'},{e:'ğŸ¤­',t:'giggle tee hee oops ×¦×•×—×§ ××•×¤×¡'},{e:'ğŸ˜µâ€ğŸ’«',t:'dizzy confused spiral ×¡×—×¨×—×•×¨×ª ××‘×•×œ×‘×œ'},{e:'ğŸ¤',t:'quiet silent zipper mouth ×©×§×˜ ×¡×’×•×¨'},{e:'ğŸ«¥',t:'invisible hidden dotted × ×¢×œ×'},
            // Hand gestures (new)
            {e:'ğŸ‘',t:'thumbs up like good great approve ××”×‘×ª×™ ×œ×™×™×§ ×˜×•×‘ ××¢×•×œ×” ××™×©×•×¨'},{e:'ğŸ‘',t:'thumbs down dislike bad ×œ× ×˜×•×‘ ×œ× ××”×‘×ª×™'},{e:'ğŸ‘',t:'clap bravo applause ×›×¤×™×™× ××—×™××•×ª ×›×¤×™×™× ×‘×¨××‘×•'},{e:'ğŸ™Œ',t:'hands raised celebrate hooray ×™×“×™×™× ×—×’×™×’×”'},{e:'ğŸ¤²',t:'palms open receive give ×›×¤×•×ª ×™×“×™×™×'},{e:'ğŸ¤™',t:'call shaka hang loose ×©××§×” ×˜×œ×¤×•×Ÿ'},{e:'âœŒï¸',t:'peace victory two ×©×œ×•× × ×™×¦×—×•×Ÿ'},{e:'ğŸ¤',t:'fingers crossed luck hope ××–×œ ××¦×‘×¢×•×ª'},{e:'ğŸ¤Ÿ',t:'love you rock hand ××”×‘×” ×¨×•×§'},{e:'ğŸ¤˜',t:'rock metal horns ×¨×•×§ ××˜××œ'},{e:'ğŸ‘‹',t:'wave hello bye hi ×©×œ×•× ×œ×”×ª×¨××•×ª'},{e:'ğŸ–ï¸',t:'hand five stop ×™×“ ×—××© ×¢×¦×•×¨'},{e:'âœ‹',t:'hand stop high five ×™×“ ×¢×¦×•×¨'},{e:'ğŸ‘Œ',t:'ok perfect fine great ××•×§×™×™ ××•×©×œ×'},{e:'ğŸ¤Œ',t:'pinched fingers italian perfect ××•×©×œ×'},{e:'ğŸ«¶',t:'heart hands love care ××”×‘×” ×œ×‘ ×™×“×™×™×'},{e:'ğŸ’ª',t:'strong muscle power flex ×—×–×§ ×©×¨×™×¨ ×›×•×—'},
            // People & gestures (new)
            {e:'ğŸ§˜â€â™€ï¸',t:'yoga meditate relax calm woman ×™×•×’×” ××“×™×˜×¦×™×” ×¨×’×•×¢ ×¨×’×™×¢×”'},{e:'ğŸ§˜â€â™‚ï¸',t:'yoga meditate relax calm man ×™×•×’×” ××“×™×˜×¦×™×” ×¨×’×•×¢ ×¨×’×™×¢×”'},{e:'ğŸƒâ€â™‚ï¸',t:'run jog exercise sport man ×¨×™×¦×” ×¡×¤×•×¨×˜'},{e:'ğŸƒâ€â™€ï¸',t:'run jog exercise sport woman ×¨×™×¦×” ×¡×¤×•×¨×˜'},{e:'ğŸš¶â€â™‚ï¸',t:'walk man walking ×”×œ×™×›×”'},{e:'ğŸš¶â€â™€ï¸',t:'walk woman walking ×”×œ×™×›×”'},{e:'ğŸ¤¸â€â™‚ï¸',t:'cartwheel gymnastics sport ×’×œ×’×œ ×”×ª×¢××œ×•×ª'},{e:'ğŸ¤¸â€â™€ï¸',t:'cartwheel gymnastics sport ×’×œ×’×œ ×”×ª×¢××œ×•×ª'},{e:'ğŸ§—â€â™‚ï¸',t:'climb rock wall ×˜×™×¤×•×¡ ×§×™×¨'},{e:'ğŸ§—â€â™€ï¸',t:'climb rock wall ×˜×™×¤×•×¡ ×§×™×¨'},{e:'ğŸŠâ€â™‚ï¸',t:'swim pool water ×©×—×™×™×” ×‘×¨×™×›×” ××™×'},{e:'ğŸŠâ€â™€ï¸',t:'swim pool water ×©×—×™×™×” ×‘×¨×™×›×” ××™×'},{e:'ğŸš´â€â™‚ï¸',t:'bike bicycle ride cycle ××•×¤× ×™×™× ×¨×›×™×‘×”'},{e:'ğŸš´â€â™€ï¸',t:'bike bicycle ride cycle ××•×¤× ×™×™× ×¨×›×™×‘×”'},
            {e:'ğŸ’†â€â™€ï¸',t:'massage relax spa woman ×¢×™×¡×•×™ ×¨×’×™×¢×” ×¡×¤×'},{e:'ğŸ’†â€â™‚ï¸',t:'massage relax spa man ×¢×™×¡×•×™ ×¨×’×™×¢×” ×¡×¤×'},{e:'ğŸ’‡â€â™€ï¸',t:'haircut salon woman ×ª×¡×¤×•×¨×ª ××¡×¤×¨×”'},{e:'ğŸ’‡â€â™‚ï¸',t:'haircut salon man ×ª×¡×¤×•×¨×ª ××¡×¤×¨×”'},{e:'ğŸ™‹â€â™€ï¸',t:'raise hand question woman ×™×“ ×©××œ×”'},{e:'ğŸ™‹â€â™‚ï¸',t:'raise hand question man ×™×“ ×©××œ×”'},{e:'ğŸ™…â€â™€ï¸',t:'no stop cross woman ×œ× ×¢×¦×•×¨'},{e:'ğŸ™…â€â™‚ï¸',t:'no stop cross man ×œ× ×¢×¦×•×¨'},{e:'ğŸ™†â€â™€ï¸',t:'ok yes gesture woman ×›×Ÿ ××•×§×™×™'},{e:'ğŸ™†â€â™‚ï¸',t:'ok yes gesture man ×›×Ÿ ××•×§×™×™'},{e:'ğŸ¤¦â€â™€ï¸',t:'facepalm woman frustrated ××ª×•×¡×›×œ×ª'},{e:'ğŸ¤¦â€â™‚ï¸',t:'facepalm man frustrated ××ª×•×¡×›×œ'},{e:'ğŸ¤·â€â™€ï¸',t:'shrug whatever woman ××” ×œ×¢×©×•×ª'},{e:'ğŸ¤·â€â™‚ï¸',t:'shrug whatever man ××” ×œ×¢×©×•×ª'},
            // People & family
            {e:'ğŸ§’',t:'child kid ×™×œ×“ ×™×œ×“×”'},{e:'ğŸ‘§',t:'girl child ×™×œ×“×”'},{e:'ğŸ‘¦',t:'boy child ×™×œ×“'},{e:'ğŸ‘¶',t:'baby infant ×ª×™× ×•×§'},{e:'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦',t:'family parents kids ××©×¤×—×” ×”×•×¨×™× ×™×œ×“×™×'},{e:'ğŸ‘©â€ğŸ‘§',t:'mother daughter mom ××× ×‘×ª'},{e:'ğŸ‘¨â€ğŸ‘¦',t:'father son dad ××‘× ×‘×Ÿ'},{e:'ğŸ§‘â€ğŸ¤â€ğŸ§‘',t:'people together friends ×—×‘×¨×™× ×‘×™×—×“'},{e:'ğŸ–ï¸',t:'beach vacation relax ×—×•×£ ×—×•×¤×©×” ×¨×’×™×¢×”'},{e:'ğŸ›',t:'playground slide park ××’×œ×©×” ×’×Ÿ ××©×—×§×™×'},{e:'ğŸ¤',t:'handshake deal agree ×œ×—×™×¦×ª ×™×“ ×”×¡×›××”'},{e:'ğŸ‘«',t:'couple man woman holding hands ×–×•×’'},{e:'ğŸ‘¬',t:'men holding hands friends ×—×‘×¨×™×'},{e:'ğŸ‘­',t:'women holding hands friends ×—×‘×¨×•×ª'},
            // Activities & entertainment
            {e:'ğŸ¯',t:'target goal bullseye direct hit ××˜×¨×” ×™×¢×“'},{e:'ğŸ®',t:'game controller video gaming ××©×—×§ ×‘×§×¨'},{e:'ğŸ²',t:'dice game board game luck ×§×•×‘×™×” ××©×—×§ ××–×œ'},{e:'ğŸ­',t:'theater drama masks performing ×ª×™××˜×¨×•×Ÿ ××¡×›×•×ª'},{e:'ğŸ¨',t:'art paint palette creative ××× ×•×ª ×¦×™×•×¨ ×™×¦×™×¨×”'},{e:'ğŸ¬',t:'movie film clapper cinema ×¡×¨×˜ ×§×•×œ× ×•×¢'},{e:'ğŸª',t:'circus tent carnival ×§×¨×§×¡'},{e:'ğŸ°',t:'slot machine gamble casino ××›×•× ×”'},{e:'ğŸ¸',t:'guitar music rock ×’×™×˜×¨×” ××•×–×™×§×”'},{e:'ğŸ¹',t:'piano keyboard music ×¤×¡× ×ª×¨ ××•×–×™×§×”'},{e:'ğŸº',t:'trumpet music brass ×—×¦×•×¦×¨×” ××•×–×™×§×”'},{e:'ğŸ»',t:'violin music fiddle ×›×™× ×•×¨ ××•×–×™×§×”'},{e:'ğŸ¥',t:'drum music beat ×ª×•×£ ××•×–×™×§×”'},{e:'ğŸ¤',t:'microphone sing karaoke ××™×§×¨×•×¤×•×Ÿ ×©×™×¨×”'},{e:'ğŸ§',t:'headphones music listen ××•×–× ×™×•×ª ××•×–×™×§×”'},{e:'ğŸ¼',t:'music notes score ××•×–×™×§×” ×ª×•×•×™×'},
            // Sports
            {e:'âš½',t:'soccer football ball sport ×›×“×•×¨×’×œ'},{e:'ğŸ€',t:'basketball ball sport ×›×“×•×¨×¡×œ'},{e:'ğŸˆ',t:'football american sport ×¤×•×˜×‘×•×œ'},{e:'âš¾',t:'baseball ball sport ×‘×™×™×¡×‘×•×œ'},{e:'ğŸ¥',t:'softball ball sport ×¡×•×¤×˜×‘×•×œ'},{e:'ğŸ¾',t:'tennis ball sport ×˜× ×™×¡'},{e:'ğŸ',t:'volleyball ball sport ×›×“×•×¨×¢×£'},{e:'ğŸ‰',t:'rugby ball sport ×¨×•×’×‘×™'},{e:'ğŸ¥',t:'frisbee disc sport ×¤×¨×™×–×‘×™'},{e:'ğŸ±',t:'billiards pool sport ×‘×™×œ×™××¨×“'},{e:'ğŸª€',t:'yoyo toy ×™×•×™×•'},{e:'ğŸ“',t:'ping pong table tennis sport ×¤×™× ×’ ×¤×•× ×’'},{e:'ğŸ¸',t:'badminton sport ×‘×“××™× ×˜×•×Ÿ'},{e:'ğŸ’',t:'hockey ice sport ×”×•×§×™'},{e:'ğŸ‘',t:'field hockey sport ×”×•×§×™'},{e:'ğŸ¥',t:'lacrosse sport ×œ×§×¨×•×¡'},
            // Nature & flowers
            {e:'ğŸŒ¸',t:'blossom flower cherry sakura ×¤×¨×— ×“×•×‘×“×‘×Ÿ'},{e:'ğŸŒº',t:'hibiscus flower tropical ×¤×¨×— ×˜×¨×•×¤×™'},{e:'ğŸŒ»',t:'sunflower flower yellow ×—×× ×™×™×” ×¤×¨×—'},{e:'ğŸŒ·',t:'tulip flower spring ×¦×‘×¢×•× ×™ ×¤×¨×— ××‘×™×‘'},{e:'ğŸŒ¹',t:'rose flower red love ×•×¨×“ ×¤×¨×— ××”×‘×”'},{e:'ğŸ¥€',t:'wilted flower dead × ×‘×œ ×¤×¨×—'},{e:'ğŸŒ¼',t:'blossom flower yellow ×¤×¨×—'},{e:'ğŸŒ±',t:'seedling plant grow sprout × ×‘×˜ ×¦××—'},{e:'ğŸŒ²',t:'evergreen tree pine ×¢×¥ ××•×¨×Ÿ'},{e:'ğŸŒ³',t:'tree deciduous nature ×¢×¥ ×˜×‘×¢'},{e:'ğŸŒ´',t:'palm tree tropical ×“×§×œ'},{e:'ğŸŒµ',t:'cactus desert ×§×§×˜×•×¡ ××“×‘×¨'},{e:'ğŸŒ¾',t:'rice wheat grain ×—×™×˜×” ×©×™×‘×•×œ×ª'},{e:'ğŸŒ¿',t:'herb plant leaf ×¢×©×‘ ×¦××—'},{e:'â˜˜ï¸',t:'shamrock clover luck ×ª×œ×ª×Ÿ ××–×œ'},{e:'ğŸ€',t:'four leaf clover luck ×ª×œ×ª×Ÿ ××–×œ'},
            // Sky & weather
            {e:'â­',t:'star shine ×›×•×›×‘'},{e:'ğŸŒŸ',t:'star glow shine ×›×•×›×‘ ×–×•×”×¨'},{e:'âœ¨',t:'sparkle shine magic × ×™×¦×•×¥ ×§×¡×'},{e:'ğŸ’«',t:'dizzy star shooting ×›×•×›×‘'},{e:'âš¡',t:'lightning bolt electric ×‘×¨×§ ×—×©××œ'},{e:'ğŸ”¥',t:'fire hot flame ××© ×—× ×œ×”×‘×”'},{e:'ğŸ’¥',t:'boom explosion crash ×¤×™×¦×•×¥'},{e:'â˜€ï¸',t:'sun sunny bright warm ×©××© ×‘×”×™×¨ ×—×'},{e:'ğŸŒ™',t:'moon night crescent ×™×¨×— ×œ×™×œ×”'},{e:'ğŸŒˆ',t:'rainbow colors ×§×©×ª ×¦×‘×¢×™×'},{e:'â˜ï¸',t:'cloud sky ×¢× ×Ÿ ×©××™×™×'},{e:'â›…',t:'cloud sun partly cloudy ×¢× ×Ÿ ×©××©'},{e:'ğŸŒ¤ï¸',t:'sun cloud bright ×©××© ×¢× ×Ÿ'},{e:'â›ˆï¸',t:'storm thunder rain ×¡×¢×¨×” ×¨×¢× ×’×©×'},{e:'ğŸŒ©ï¸',t:'lightning storm cloud ×‘×¨×§ ×¡×¢×¨×”'},
            // Animals
            {e:'ğŸ¶',t:'dog puppy pet ×›×œ×‘ ×’×•×¨ ×—×™×™×ª ××—××“'},{e:'ğŸ±',t:'cat kitten pet ×—×ª×•×œ ×’×•×¨ ×—×™×™×ª ××—××“'},{e:'ğŸ­',t:'mouse face ×¢×›×‘×¨'},{e:'ğŸ¹',t:'hamster pet face ××•×’×¨'},{e:'ğŸ°',t:'rabbit bunny ××¨× ×‘'},{e:'ğŸ¦Š',t:'fox face ×©×•×¢×œ'},{e:'ğŸ»',t:'bear face ×“×•×‘'},{e:'ğŸ¼',t:'panda bear ×¤× ×“×”'},{e:'ğŸ¨',t:'koala bear face ×§×•××œ×”'},{e:'ğŸ¯',t:'tiger face cat × ××¨'},{e:'ğŸ¦',t:'lion king face ××¨×™×” ××œ×š'},{e:'ğŸ®',t:'cow face ×¤×¨×”'},{e:'ğŸ·',t:'pig face ×—×–×™×¨'},{e:'ğŸ¸',t:'frog face ×¦×¤×¨×“×¢'},{e:'ğŸµ',t:'monkey face ×§×•×£'},{e:'ğŸ”',t:'chicken hen rooster ×ª×¨× ×’×•×œ×ª'},
            {e:'ğŸ§',t:'penguin bird ×¤×™× ×’×•×•×™×Ÿ'},{e:'ğŸ¦',t:'bird ×¦×™×¤×•×¨'},{e:'ğŸ¤',t:'chick baby bird ××¤×¨×•×—'},{e:'ğŸ¦†',t:'duck bird ×‘×¨×•×•×–'},{e:'ğŸ¦…',t:'eagle bird × ×©×¨'},{e:'ğŸ¦‰',t:'owl bird night ×™× ×©×•×£'},{e:'ğŸ¦‡',t:'bat night ×¢×˜×œ×£'},{e:'ğŸº',t:'wolf face ×–××‘'},{e:'ğŸ—',t:'boar pig ×—×–×™×¨ ×‘×¨'},{e:'ğŸ´',t:'horse face ×¡×•×¡'},{e:'ğŸ¦„',t:'unicorn magic ×—×“ ×§×¨×Ÿ'},{e:'ğŸ',t:'bee honey ×“×‘×•×¨×” ×“×‘×©'},{e:'ğŸ›',t:'bug caterpillar ×–×—×œ'},{e:'ğŸ¦‹',t:'butterfly insect ×¤×¨×¤×¨'},{e:'ğŸŒ',t:'snail slow ×—×™×œ×–×•×Ÿ'},{e:'ğŸ',t:'ladybug insect ×—×™×¤×•×©×™×ª'},
            // Food & fruit
            {e:'ğŸ',t:'apple red fruit ×ª×¤×•×— ××“×•× ×¤×¨×™'},{e:'ğŸ',t:'apple green fruit ×ª×¤×•×— ×™×¨×•×§'},{e:'ğŸŠ',t:'orange tangerine fruit ×ª×¤×•×–'},{e:'ğŸ‹',t:'lemon yellow fruit ×œ×™××•×Ÿ'},{e:'ğŸŒ',t:'banana fruit ×‘× × ×”'},{e:'ğŸ‰',t:'watermelon fruit ××‘×˜×™×—'},{e:'ğŸ‡',t:'grapes fruit ×¢× ×‘×™×'},{e:'ğŸ“',t:'strawberry fruit ×ª×•×ª'},{e:'ğŸˆ',t:'melon fruit ××œ×•×Ÿ'},{e:'ğŸ’',t:'cherries fruit ×“×•×‘×“×‘×Ÿ'},{e:'ğŸ‘',t:'peach fruit ××¤×¨×¡×§'},{e:'ğŸ¥­',t:'mango fruit ×× ×’×•'},{e:'ğŸ',t:'pineapple fruit ×× × ×¡'},{e:'ğŸ¥¥',t:'coconut fruit ×§×•×§×•×¡'},{e:'ğŸ¥',t:'kiwi fruit ×§×™×•×•×™'},{e:'ğŸ…',t:'tomato vegetable ×¢×’×‘× ×™×™×”'},
            {e:'ğŸ¥‘',t:'avocado fruit ××‘×•×§×“×•'},{e:'ğŸ†',t:'eggplant aubergine ×—×¦×™×œ'},{e:'ğŸ¥”',t:'potato vegetable ×ª×¤×•×— ××“××”'},{e:'ğŸ¥•',t:'carrot vegetable ×’×–×¨'},{e:'ğŸŒ½',t:'corn maize vegetable ×ª×™×¨×¡'},{e:'ğŸŒ¶ï¸',t:'pepper hot chili ×¤×œ×¤×œ ×—×¨×™×£'},{e:'ğŸ¥’',t:'cucumber vegetable ××œ×¤×¤×•×Ÿ'},{e:'ğŸ¥¬',t:'leafy green lettuce vegetable ×—×¡×”'},{e:'ğŸ¥¦',t:'broccoli vegetable ×‘×¨×•×§×•×œ×™'},{e:'ğŸ§„',t:'garlic vegetable ×©×•×'},{e:'ğŸ§…',t:'onion vegetable ×‘×¦×œ'},{e:'ğŸ„',t:'mushroom fungus ×¤×˜×¨×™×”'},{e:'ğŸ¥œ',t:'peanut nut ×‘×•×˜×Ÿ'},{e:'ğŸŒ°',t:'chestnut nut ×¢×¨××•×Ÿ'},{e:'ğŸ',t:'bread food ×œ×—× ××•×›×œ'},{e:'ğŸ¥',t:'croissant pastry bread ×§×¨×•××¡×•×Ÿ'},
            // Daily routine objects
            {e:'ğŸª¥',t:'toothbrush teeth brush clean ××‘×¨×©×ª ×©×™× ×™×™× × ×™×§×•×™'},{e:'ğŸ§¸',t:'teddy bear toy doll ×“×•×‘×™ ×¦×¢×¦×•×¢'},{e:'ğŸ‘•',t:'shirt clothes tshirt ×—×•×œ×¦×” ×‘×’×“×™×'},{e:'ğŸ’§',t:'water drop droplet ××™× ×˜×™×¤×”'},{e:'ğŸ¥ª',t:'sandwich food lunch ×¡× ×“×•×•×™×¥ ××•×›×œ ××¨×•×—×”'},{e:'ğŸ‘Ÿ',t:'shoe sneaker running × ×¢×œ × ×¢×œ×™×™×'},{e:'ğŸ§¼',t:'soap clean wash ×¡×‘×•×Ÿ × ×™×§×•×™'},{e:'ğŸš¿',t:'shower bath clean water ××§×œ×—×ª'},{e:'ğŸš½',t:'toilet bathroom ×©×™×¨×•×ª×™×'},{e:'ğŸ¥¤',t:'drink cup straw juice ×©×ª×™×™×” ×›×•×¡'},{e:'ğŸ›',t:'bath tub clean water ×××‘×˜×™×”'},{e:'ğŸ§´',t:'lotion cream bottle ×§×¨× ×‘×§×‘×•×§'},{e:'ğŸ§»',t:'toilet paper roll × ×™×™×¨ ×˜×•××œ×˜'},{e:'ğŸ§¹',t:'broom sweep clean ××˜××˜× × ×™×§×•×™'},{e:'ğŸ§º',t:'basket laundry ×¡×œ ×›×‘×™×¡×”'},{e:'ğŸ§½',t:'sponge clean wash ×¡×¤×•×’ × ×™×§×•×™'},
            // School & time
            {e:'â°',t:'alarm clock time wake up ×©×¢×•×Ÿ ××¢×•×¨×¨ ×–××Ÿ'},{e:'â±ï¸',t:'stopwatch timer time ×©×¢×•×Ÿ ×¢×¦×¨ ×–××Ÿ'},{e:'âŒš',t:'watch time ×©×¢×•×Ÿ ×™×“'},{e:'ğŸ“š',t:'books study read school ×¡×¤×¨×™× ×œ×™××•×“ ×§×¨×™××” ×‘×™×ª ×¡×¤×¨'},{e:'ğŸ“–',t:'book read open ×¡×¤×¨ ×§×¨×™××”'},{e:'âœï¸',t:'pencil write draw ×¢×™×¤×¨×•×Ÿ ×›×ª×™×‘×” ×¦×™×•×¨'},{e:'âœ’ï¸',t:'pen ink write ×¢×˜ ×“×™×•'},{e:'ğŸ–Šï¸',t:'pen write ×¢×˜ ×›×ª×™×‘×”'},{e:'ğŸ–ï¸',t:'crayon draw color ×¦×‘×¢ ×¦×™×•×¨'},{e:'ğŸ“',t:'note write memo ×¤×ª×§ ×›×ª×™×‘×”'},{e:'ğŸ’',t:'backpack school bag ×ª×™×§ ×‘×™×ª ×¡×¤×¨'},{e:'ğŸ“',t:'graduation cap school ×ª×•××¨ ×›×•×‘×¢'},{e:'ğŸ“',t:'triangle ruler math ××“×™×“×” ××ª××˜×™×§×”'},{e:'ğŸ“',t:'ruler measure straight ×¡×¨×’×œ ××“×™×“×”'},{e:'ğŸ“Œ',t:'pin push × ×¢×¥ ×¡×™×›×”'},{e:'ğŸ“',t:'pin location ××™×§×•× ×¡×™×›×”'},
            // Home & furniture
            {e:'ğŸ›ï¸',t:'bed sleep rest room ××™×˜×” ×©×™× ×” ×—×“×¨'},{e:'ğŸ›‹ï¸',t:'couch sofa living room ×¡×¤×” ×¡×œ×•×Ÿ'},{e:'ğŸª‘',t:'chair seat sit ×›×™×¡× ×™×©×™×‘×”'},{e:'ğŸšª',t:'door entrance exit ×“×œ×ª ×›× ×™×¡×”'},{e:'ğŸªŸ',t:'window view ×—×œ×•×Ÿ'},{e:'ğŸ ',t:'house home ×‘×™×ª'},{e:'ğŸ¡',t:'house garden home ×‘×™×ª ×’×™× ×”'},{e:'ğŸ¢',t:'building office ×‘× ×™×™×Ÿ ××©×¨×“'},
            // Electronics
            {e:'ğŸ“±',t:'phone mobile smartphone ×˜×œ×¤×•×Ÿ × ×™×™×“'},{e:'ğŸ’»',t:'laptop computer ××—×©×‘ × ×™×™×“'},{e:'ğŸ–¥ï¸',t:'computer desktop screen ××—×©×‘ ××¡×š'},{e:'âŒ¨ï¸',t:'keyboard type ××§×œ×“×ª ×”×§×œ×“×”'},{e:'ğŸ–±ï¸',t:'mouse computer click ×¢×›×‘×¨ ××—×©×‘'},{e:'ğŸ–¨ï¸',t:'printer print ××“×¤×¡×ª'},{e:'ğŸ“º',t:'television tv screen ×˜×œ×•×•×™×–×™×” ××¡×š'},{e:'ğŸ“·',t:'camera photo picture ××¦×œ××” ×ª××•× ×”'},{e:'ğŸ“¹',t:'video camera record ×•×™×“××• ××¦×œ××”'},{e:'ğŸ¥',t:'movie camera film ×¡×¨×˜ ××¦×œ××”'},{e:'ğŸ“',t:'phone telephone call ×˜×œ×¤×•×Ÿ ×©×™×—×”'},{e:'â˜ï¸',t:'telephone phone call ×˜×œ×¤×•×Ÿ'},{e:'ğŸ“Ÿ',t:'pager beeper ××™×ª×•×¨×™×ª'},{e:'ğŸ“ ',t:'fax machine ×¤×§×¡'},{e:'ğŸ”‹',t:'battery power charge ×¡×•×œ×œ×”'},{e:'ğŸ”Œ',t:'plug electric power ×©×§×¢ ×—×©××œ'},
            // Money & awards
            {e:'ğŸ’°',t:'money bag rich ×›×¡×£ ×©×§ ×¢×©×™×¨'},{e:'ğŸ’µ',t:'dollar money bill ×›×¡×£ ×“×•×œ×¨ ×©×˜×¨'},{e:'ğŸ’´',t:'yen money bill ×›×¡×£ ×™×Ÿ'},{e:'ğŸ’¶',t:'euro money bill ×›×¡×£ ×™×•×¨×•'},{e:'ğŸ’·',t:'pound money bill ×›×¡×£ ×œ×™×¨×”'},{e:'ğŸª™',t:'coin money ××˜×‘×¢ ×›×¡×£'},{e:'ğŸ’³',t:'credit card payment ×›×¨×˜×™×¡ ××©×¨××™'},{e:'ğŸ†',t:'trophy winner champion cup ×’×‘×™×¢ ×× ×¦×— ××œ×•×£'},{e:'ğŸ¥‡',t:'gold medal first winner ××“×œ×™×” ×–×”×‘ ×¨××©×•×Ÿ'},{e:'ğŸ¥ˆ',t:'silver medal second ××“×œ×™×” ×›×¡×£ ×©× ×™'},{e:'ğŸ¥‰',t:'bronze medal third ××“×œ×™×” ××¨×“ ×©×œ×™×©×™'},{e:'ğŸ–ï¸',t:'medal military award ××“×œ×™×” ×¤×¨×¡'},{e:'ğŸ…',t:'medal sports award ××“×œ×™×” ×¡×¤×•×¨×˜'},{e:'ğŸ—ï¸',t:'ribbon awareness ×¡×¨×˜'},{e:'âœ…',t:'check mark done complete ×¡×™××•×Ÿ ×‘×•×¦×¢'},{e:'â˜‘ï¸',t:'check box done complete ×¡×™××•×Ÿ ×‘×•×¦×¢'},
            // Hearts
            {e:'â¤ï¸',t:'heart love red ×œ×‘ ××”×‘×” ××“×•×'},{e:'ğŸ§¡',t:'heart orange love ×œ×‘ ×›×ª×•×'},{e:'ğŸ’›',t:'heart yellow love ×œ×‘ ×¦×”×•×‘'},{e:'ğŸ’š',t:'heart green love ×œ×‘ ×™×¨×•×§'},{e:'ğŸ’™',t:'heart blue love ×œ×‘ ×›×—×•×œ'},{e:'ğŸ’œ',t:'heart purple love ×œ×‘ ×¡×’×•×œ'},{e:'ğŸ–¤',t:'heart black love ×œ×‘ ×©×—×•×¨'},{e:'ğŸ¤',t:'heart white love ×œ×‘ ×œ×‘×Ÿ'},{e:'ğŸ¤',t:'heart brown love ×œ×‘ ×—×•×'},{e:'ğŸ’–',t:'heart sparkle love ×œ×‘ × ×™×¦×•×¥'},{e:'ğŸ’',t:'heart ribbon gift ×œ×‘ ×¡×¨×˜ ××ª× ×”'},{e:'ğŸ’—',t:'heart growing love ×œ×‘ ×’×“×œ'},{e:'ğŸ’“',t:'heart beating love ×œ×‘ ×¤×•×¢×'},{e:'ğŸ’',t:'hearts revolving love ×œ×‘×‘×•×ª'},{e:'ğŸ’•',t:'hearts two love ×œ×‘×‘×•×ª'},{e:'ğŸ’Œ',t:'love letter envelope ××›×ª×‘ ××”×‘×”'},
            {e: 'ğŸ«§', t: 'bubbles ×‘×•×¢×•×ª'},
            {e: 'ğŸ›´', t: 'scooter ×§×•×¨×§×™× ×˜'}
        ];

        // State
        let kidId = null;
        let kidData = null;
        let boardItems = [];
        let selectedItemIndex = null;
        let draggedItemIndex = null;
        let nextItemId = 1;

        // Image upload state
        let currentImage = null;
        let currentCoinImage = null;
        let isCoinCrop = false;
        let cropState = {
            x: 0,
            y: 0,
            size: 100,
            isDragging: false,
            isResizing: false,
            resizeHandle: null,
            startX: 0,
            startY: 0,
            startSize: 0,
            startCropX: 0,
            startCropY: 0,
            minSize: 50
        };

        // Get URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        kidId = urlParams.get('kid');

        if (!kidId) {
            alert('×œ× × ×‘×—×¨ ×™×œ×“');
            window.location.href = 'admin.html';
        }

        // Initialize
        window.onload = async function() {
            await loadKidData();
            initDragAndDrop();
            initEmojiGrid();
        };

        // Load kid data
        async function loadKidData() {
            try {
                const doc = await db.collection('kids').doc(kidId).get();
                if (!doc.exists) {
                    alert('×™×œ×“ ×œ× × ××¦×');
                    window.location.href = 'admin.html';
                    return;
                }

                kidData = doc.data();
                document.getElementById('kidNameDisplay').textContent = kidData.name;

                // Load existing board layout or convert from tasks
                if (kidData.boardLayout && kidData.boardLayout.items) {
                    boardItems = kidData.boardLayout.items;
                    nextItemId = Math.max(...boardItems.map(i => i.id || 0)) + 1;
                } else {
                    // Convert existing tasks to board items
                    convertExistingTasks();
                }

                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('builderApp').style.display = 'block';

                // Load kid settings
                loadKidSettings();

                renderBoard();
            } catch (error) {
                console.error('Error loading kid:', error);
                alert('×©×’×™××” ×‘×˜×¢×™× ×”');
            }
        }

        // Load kid settings into the palette
        function loadKidSettings() {
            // Daily reward
            document.getElementById('dailyReward').value = kidData.dailyReward || 0.5;

            // Total money
            document.getElementById('totalMoney').value = kidData.totalMoney || 0;

            // Age
            document.getElementById('kidAge').value = kidData.age || '';

            // Gender
            document.getElementById('kidGender').value = kidData.gender || '';

            // Kid description
            document.getElementById('kidDescription').value = kidData.kidDescription || '';

            // Behavior goals
            document.getElementById('behaviorGoals').value = kidData.behaviorGoals || '';

            // Kid image
            const imageName = kidData.imageName || '';
            if (imageName) {
                if (imageName.startsWith('data:')) {
                    document.getElementById('kidImageData').value = imageName;
                    document.getElementById('previewImg').src = imageName;
                    document.getElementById('imagePreview').style.display = 'block';
                } else {
                    // It's a filename - show as preview
                    document.getElementById('previewImg').src = imageName;
                    document.getElementById('imagePreview').style.display = 'block';
                }
            }

            // Coin style
            const coinStyle = kidData.coinStyle || 'dollar';
            document.getElementById('coinStyle').value = coinStyle;
            toggleCoinImageInput();

            // Coin image
            if (coinStyle === 'custom') {
                const coinImageName = kidData.coinImageName || '';
                if (coinImageName) {
                    if (coinImageName.startsWith('data:')) {
                        document.getElementById('coinImageData').value = coinImageName;
                        document.getElementById('coinPreviewImg').src = coinImageName;
                        document.getElementById('coinImagePreview').style.display = 'block';
                    } else {
                        document.getElementById('coinPreviewImg').src = coinImageName;
                        document.getElementById('coinImagePreview').style.display = 'block';
                    }
                }
            }

            // Color schema
            const colorSchema = kidData.colorSchema || 'purple';
            const colorSchemaInput = document.querySelector(`input[name="colorSchema"][value="${colorSchema}"]`);
            if (colorSchemaInput) {
                colorSchemaInput.checked = true;
            }

            // Show Dino setting
            document.getElementById('showDino').checked = kidData.showDino || false;
        }

        // Toggle coin image input visibility
        function toggleCoinImageInput() {
            const coinStyle = document.getElementById('coinStyle').value;
            const coinImageGroup = document.getElementById('coinImageGroup');
            coinImageGroup.style.display = coinStyle === 'custom' ? 'block' : 'none';
        }

        // Convert existing tasks to board items
        function convertExistingTasks() {
            boardItems = [];

            // Add header if exists
            if (kidData.headerLabel) {
                boardItems.push({
                    id: nextItemId++,
                    type: 'header',
                    size: 'large',
                    text: kidData.headerLabel
                });
            }

            // Add bank
            boardItems.push({
                id: nextItemId++,
                type: 'bank',
                label: kidData.savingsLabel || '×§×•×¤×ª ×”×—×™×¡×›×•×Ÿ ×©×œ [×©×]',
                showBonus: true
            });

            // Add regular tasks header and tasks
            const regularTasks = (kidData.tasks || []).filter(t => !t.type || t.type === 'regular');
            if (regularTasks.length > 0) {
                if (kidData.regularTasksHeader) {
                    boardItems.push({
                        id: nextItemId++,
                        type: 'header',
                        size: 'medium',
                        text: kidData.regularTasksHeader
                    });
                }
                regularTasks.forEach(task => {
                    boardItems.push({
                        id: nextItemId++,
                        type: 'task',
                        taskType: 'regular',
                        taskData: { ...task }
                    });
                });
            }

            // Add bonus tasks header and tasks
            const bonusTasks = (kidData.tasks || []).filter(t => t.type === 'bonus');
            if (bonusTasks.length > 0) {
                if (kidData.bonusTasksHeader) {
                    boardItems.push({
                        id: nextItemId++,
                        type: 'header',
                        size: 'medium',
                        text: kidData.bonusTasksHeader
                    });
                }
                bonusTasks.forEach(task => {
                    boardItems.push({
                        id: nextItemId++,
                        type: 'task',
                        taskType: 'bonus',
                        taskData: { ...task }
                    });
                });
            }

            // Add calm-down tasks header and tasks
            const calmDownTasks = (kidData.tasks || []).filter(t => t.type === 'calm-down');
            if (calmDownTasks.length > 0) {
                if (kidData.calmDownHeader) {
                    boardItems.push({
                        id: nextItemId++,
                        type: 'header',
                        size: 'medium',
                        text: kidData.calmDownHeader
                    });
                }
                calmDownTasks.forEach(task => {
                    boardItems.push({
                        id: nextItemId++,
                        type: 'task',
                        taskType: 'calm-down',
                        taskData: { ...task }
                    });
                });
            }
        }

        // Initialize drag and drop
        function initDragAndDrop() {
            // Palette items
            document.querySelectorAll('.palette-item').forEach(item => {
                item.addEventListener('dragstart', handlePaletteDragStart);
                item.addEventListener('dragend', handleDragEnd);
            });

            // Drop zone
            const dropZone = document.getElementById('boardItems');
            dropZone.addEventListener('dragover', handleDragOver);
            dropZone.addEventListener('drop', handleDrop);
            dropZone.addEventListener('dragleave', handleDragLeave);
        }

        function handlePaletteDragStart(e) {
            e.target.classList.add('dragging');
            e.dataTransfer.setData('text/plain', JSON.stringify({
                fromPalette: true,
                type: e.target.dataset.type,
                size: e.target.dataset.size,
                taskType: e.target.dataset.taskType
            }));
        }

        function handleBoardItemDragStart(e, index) {
            e.target.classList.add('dragging');
            draggedItemIndex = index;
            e.dataTransfer.setData('text/plain', JSON.stringify({
                fromPalette: false,
                index: index
            }));
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            draggedItemIndex = null;
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
        }

        function handleDragOver(e) {
            e.preventDefault();
            const dropZone = document.getElementById('boardItems');
            dropZone.classList.add('drag-over');

            // Find closest board item for reordering
            const boardItemEls = document.querySelectorAll('.board-item');
            boardItemEls.forEach(el => el.classList.remove('drag-over'));

            const closest = getClosestBoardItem(e.clientY);
            if (closest) {
                closest.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            if (!e.relatedTarget || !document.getElementById('boardItems').contains(e.relatedTarget)) {
                document.getElementById('boardItems').classList.remove('drag-over');
            }
        }

        function getClosestBoardItem(y) {
            const boardItemEls = [...document.querySelectorAll('.board-item')];
            return boardItemEls.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > (closest.offset || -Infinity)) {
                    return { offset: offset, element: child };
                }
                return closest;
            }, {}).element;
        }

        function handleDrop(e) {
            e.preventDefault();
            document.getElementById('boardItems').classList.remove('drag-over');
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));

            const data = JSON.parse(e.dataTransfer.getData('text/plain'));

            // Find drop position
            const closest = getClosestBoardItem(e.clientY);
            let dropIndex = boardItems.length;
            if (closest) {
                const closestIndex = parseInt(closest.dataset.index);
                dropIndex = closestIndex;
            }

            if (data.fromPalette) {
                // Create new item from palette
                const newItem = createNewItem(data.type, data.size, data.taskType);
                boardItems.splice(dropIndex, 0, newItem);
            } else {
                // Reorder existing item
                if (data.index !== undefined && data.index !== dropIndex) {
                    const [movedItem] = boardItems.splice(data.index, 1);
                    if (data.index < dropIndex) dropIndex--;
                    boardItems.splice(dropIndex, 0, movedItem);
                }
            }

            renderBoard();
        }

        // Create new item
        function createNewItem(type, size, taskType) {
            const item = {
                id: nextItemId++,
                type: type
            };

            if (type === 'header') {
                item.size = size || 'medium';
                item.text = '×›×•×ª×¨×ª ×—×“×©×”';
            } else if (type === 'progress') {
                item.title = '×”×”×ª×§×“××•×ª ×©×œ×™ ×”×™×•×';
            } else if (type === 'bank') {
                item.label = '×§×•×¤×ª ×”×—×™×¡×›×•×Ÿ ×©×œ [×©×]';
                item.showBonus = true;
            } else if (type === 'task') {
                item.taskType = taskType || 'regular';
                item.taskData = {
                    id: nextItemId,
                    icon: 'ğŸ¯',
                    title: '××©×™××” ×—×“×©×”',
                    type: taskType || 'regular',
                    requiresTestimony: false,
                    trackTime: false,
                    activeDays: [0, 1, 2, 3, 4, 5, 6]
                };

                if (taskType === 'bonus') {
                    item.taskData.minReward = 1;
                    item.taskData.maxReward = 5;
                } else if (taskType === 'calm-down') {
                    item.taskData.activityType = 'paint';
                    item.taskData.activityUrl = '';
                } else if (taskType === 'composite') {
                    item.taskData.subtasks = [
                        { id: 1, title: '×ª×ª-××©×™××” 1' },
                        { id: 2, title: '×ª×ª-××©×™××” 2' }
                    ];
                }
            } else if (type === 'goal') {
                item.icon = 'ğŸ†';
                item.title = '×¤×¨×¡ ×—×“×©';
                item.pointsRequired = 100;
            }

            return item;
        }

        // Render board
        function renderBoard() {
            const container = document.getElementById('boardItems');
            const emptyState = document.getElementById('emptyState');

            // Clear existing items (except empty state)
            container.querySelectorAll('.board-item').forEach(el => el.remove());

            if (boardItems.length === 0) {
                emptyState.style.display = 'flex';
                return;
            }

            emptyState.style.display = 'none';

            boardItems.forEach((item, index) => {
                const itemEl = document.createElement('div');
                itemEl.className = 'board-item';
                itemEl.draggable = true;
                itemEl.dataset.index = index;

                // Add type-specific classes
                if (item.type === 'header') {
                    itemEl.classList.add('header-item', `header-${item.size}`);
                } else if (item.type === 'progress') {
                    itemEl.classList.add('progress-item');
                } else if (item.type === 'bank') {
                    itemEl.classList.add('bank-item');
                } else if (item.type === 'goal') {
                    itemEl.classList.add('goal-item');
                } else if (item.type === 'task') {
                    itemEl.classList.add(`task-${item.taskType}`);
                }

                itemEl.innerHTML = renderItemContent(item);

                // Drag events
                itemEl.addEventListener('dragstart', (e) => handleBoardItemDragStart(e, index));
                itemEl.addEventListener('dragend', handleDragEnd);

                // Click to configure
                itemEl.addEventListener('click', (e) => {
                    if (!e.target.closest('.board-item-actions')) {
                        selectItem(index);
                    }
                });

                container.appendChild(itemEl);
            });
        }

        // Render item content
        function renderItemContent(item) {
            let typeLabel = '';
            let icon = '';
            let title = '';
            let subtitle = '';

            if (item.type === 'header') {
                typeLabel = '×›×•×ª×¨×ª';
                icon = item.size === 'large' ? 'ğŸ“Œ' : (item.size === 'medium' ? 'ğŸ“‹' : 'ğŸ“');
                title = item.text || '×›×•×ª×¨×ª';
                subtitle = item.size === 'large' ? '×’×“×•×œ×”' : (item.size === 'medium' ? '×‘×™× ×•× ×™×ª' : '×§×˜× ×”');
            } else if (item.type === 'progress') {
                typeLabel = '×¡×¨×’×œ ×”×ª×§×“××•×ª';
                icon = 'ğŸ“Š';
                title = item.title || '×”×”×ª×§×“××•×ª ×©×œ×™ ×”×™×•×';
                subtitle = '××¦×™×’ ××ª ××—×•×– ×”×©×œ××ª ×”××©×™××•×ª ×”×™×•××™×•×ª';
            } else if (item.type === 'bank') {
                typeLabel = '×§×•×¤×ª ×—×™×¡×›×•×Ÿ';
                icon = 'ğŸ·';
                title = item.label || '×§×•×¤×ª ×”×—×™×¡×›×•×Ÿ';
                subtitle = item.showBonus ? '×›×•×œ×œ ×‘×•× ×•×¡' : '';
            } else if (item.type === 'goal') {
                typeLabel = '×™×¢×“ / ×¤×¨×¡';
                // Handle icon display
                if (item.icon && item.icon.startsWith('IMG:')) {
                    const imageName = item.icon.substring(4);
                    icon = `<img src="emojis/${imageName}" />`;
                } else {
                    icon = item.icon || 'ğŸ†';
                }
                title = item.title || '×¤×¨×¡';
                subtitle = `ğŸ¯ ${item.pointsRequired || 0} × ×§×•×“×•×ª`;
            } else if (item.type === 'task') {
                typeLabel = item.taskType === 'regular' ? '××©×™××”' : (item.taskType === 'bonus' ? '×‘×•× ×•×¡' : (item.taskType === 'composite' ? '××©×™××” ××•×¨×›×‘×ª' : '×”×¨×’×¢×”'));
                const taskData = item.taskData || {};

                // Handle icon display
                if (taskData.icon && taskData.icon.startsWith('IMG:')) {
                    const imageName = taskData.icon.substring(4);
                    icon = `<img src="emojis/${imageName}" />`;
                } else {
                    icon = taskData.icon || 'ğŸ¯';
                }

                title = taskData.title || '××©×™××”';

                // Build subtitle
                const subtitleParts = [];
                if (taskData.requiresTestimony) subtitleParts.push('ğŸ“ ×¢×“×•×ª');
                if (taskData.trackTime) subtitleParts.push('â±ï¸ ××¢×§×‘ ×–××Ÿ');
                if (item.taskType === 'bonus') {
                    subtitleParts.push(`ğŸ’° $${taskData.minReward || 0}-$${taskData.maxReward || 0}`);
                }
                if (item.taskType === 'calm-down') {
                    const activityTypes = {
                        'paint': 'ğŸ¨ ×¦×™×•×¨',
                        'bubbles': 'ğŸ«§ ×‘×•×¢×•×ª',
                        'xylophone': 'ğŸ¹ ×§×¡×™×œ×•×¤×•×Ÿ',
                        'breathing': 'ğŸ§˜ × ×©×™××•×ª',
                        'scooter': 'ğŸ›´ ×§×•×¨×§×™× ×˜',
                        'link': 'ğŸ”— ×§×™×©×•×¨'
                    };
                    subtitleParts.push(activityTypes[taskData.activityType] || '');
                }
                if (item.taskType === 'composite') {
                    const subtaskCount = taskData.subtasks?.length || 0;
                    subtitleParts.push(`ğŸ“¦ ${subtaskCount} ×ª×ª×™-××©×™××•×ª`);
                }
                subtitle = subtitleParts.join(' | ');
            }

            return `
                <div class="board-item-header">
                    <span class="board-item-type">${typeLabel}</span>
                    <div class="board-item-actions">
                        <button onclick="duplicateItem(${boardItems.indexOf(item)})" title="×©×›×¤×œ">ğŸ“‹</button>
                        <button onclick="deleteItem(${boardItems.indexOf(item)})" title="××—×§">ğŸ—‘ï¸</button>
                    </div>
                </div>
                <div class="board-item-content">
                    <div class="board-item-icon">${icon}</div>
                    <div class="board-item-details">
                        <div class="board-item-title">${title}</div>
                        <div class="board-item-subtitle">${subtitle}</div>
                    </div>
                </div>
            `;
        }

        // Select item for configuration
        function selectItem(index) {
            selectedItemIndex = index;
            const item = boardItems[index];

            const configPanel = document.getElementById('configPanel');
            const configContent = document.getElementById('configContent');

            configContent.innerHTML = renderConfigForm(item);
            configPanel.classList.add('active');

            // Highlight selected item
            document.querySelectorAll('.board-item').forEach((el, i) => {
                el.style.outline = i === index ? '3px solid #667eea' : 'none';
            });
        }

        // Render configuration form
        function renderConfigForm(item) {
            if (item.type === 'progress') {
                return `
                    <div class="config-group">
                        <label>×›×•×ª×¨×ª:</label>
                        <input type="text" id="configProgressTitle" value="${item.title || '×”×”×ª×§×“××•×ª ×©×œ×™ ×”×™×•×'}" placeholder="×”×›× ×¡ ×›×•×ª×¨×ª">
                        <small>×”×©×ª××© ×‘-[×©×] ×œ×”×›×œ×œ×ª ×©× ×”×™×œ×“</small>
                    </div>
                `;
            }

            if (item.type === 'header') {
                return `
                    <div class="config-group">
                        <label>×˜×§×¡×˜ ×”×›×•×ª×¨×ª:</label>
                        <div style="display:flex;gap:6px;align-items:center;">
                            <input type="text" id="configText" value="${item.text || ''}" placeholder="×”×›× ×¡ ×˜×§×¡×˜" style="flex:1;">
                            <button type="button" onclick="openEmojiPickerForInput('configText')" style="width:36px;height:36px;border:2px solid #eee;border-radius:10px;background:white;font-size:1.2em;cursor:pointer;flex-shrink:0;" title="×”×•×¡×£ ××™××•×’×³×™">ğŸ˜€</button>
                        </div>
                        <small>×”×©×ª××© ×‘-[×©×] ×œ×”×›×œ×œ×ª ×©× ×”×™×œ×“</small>
                    </div>
                    <div class="config-group">
                        <label>×’×•×“×œ:</label>
                        <select id="configSize">
                            <option value="large" ${item.size === 'large' ? 'selected' : ''}>×’×“×•×œ</option>
                            <option value="medium" ${item.size === 'medium' ? 'selected' : ''}>×‘×™× ×•× ×™</option>
                            <option value="small" ${item.size === 'small' ? 'selected' : ''}>×§×˜×Ÿ</option>
                        </select>
                    </div>
                `;
            } else if (item.type === 'bank') {
                return `
                    <div class="config-group">
                        <label>×›×•×ª×¨×ª ×”×§×•×¤×”:</label>
                        <input type="text" id="configLabel" value="${item.label || ''}" placeholder="×§×•×¤×ª ×”×—×™×¡×›×•×Ÿ">
                        <small>×”×©×ª××© ×‘-[×©×] ×œ×”×›×œ×œ×ª ×©× ×”×™×œ×“</small>
                    </div>
                    <div class="config-checkbox">
                        <input type="checkbox" id="configShowBonus" ${item.showBonus ? 'checked' : ''}>
                        <label for="configShowBonus">×”×¦×’ ×‘×•× ×•×¡ ×™×•××™</label>
                    </div>
                `;
            } else if (item.type === 'goal') {
                let iconDisplay = item.icon || 'ğŸ†';
                if (iconDisplay.startsWith('IMG:')) {
                    const imageName = iconDisplay.substring(4);
                    iconDisplay = `<img src="emojis/${imageName}" />`;
                }
                return `
                    <div class="config-group">
                        <label>××™×™×§×•×Ÿ:</label>
                        <div class="emoji-picker-trigger" onclick="openEmojiPicker()" id="configIcon" data-icon="${item.icon || 'ğŸ†'}">
                            ${iconDisplay}
                        </div>
                    </div>
                    <div class="config-group">
                        <label>×©× ×”×¤×¨×¡ / ×™×¢×“:</label>
                        <input type="text" id="configGoalTitle" value="${item.title || ''}" placeholder="×”×›× ×¡ ×©× ×¤×¨×¡">
                    </div>
                    <div class="config-group">
                        <label>× ×§×•×“×•×ª × ×“×¨×©×•×ª:</label>
                        <input type="number" id="configPointsRequired" value="${item.pointsRequired || 100}" min="1" step="1">
                        <small>×›××•×ª ×”× ×§×•×“×•×ª ×©×¦×¨×™×š ×›×“×™ ×œ×”×©×™×’ ××ª ×”×™×¢×“</small>
                    </div>
                `;
            } else if (item.type === 'task') {
                const taskData = item.taskData || {};
                let iconDisplay = taskData.icon || 'ğŸ¯';
                if (iconDisplay.startsWith('IMG:')) {
                    const imageName = iconDisplay.substring(4);
                    iconDisplay = `<img src="emojis/${imageName}" />`;
                }

                let html = `
                    <div class="config-group">
                        <label>××™×™×§×•×Ÿ:</label>
                        <div class="emoji-picker-trigger" onclick="openEmojiPicker()" id="configIcon" data-icon="${taskData.icon || 'ğŸ¯'}">
                            ${iconDisplay}
                        </div>
                    </div>
                    <div class="config-group">
                        <label>×©× ×”××©×™××”:</label>
                        <input type="text" id="configTitle" value="${taskData.title || ''}" placeholder="×”×›× ×¡ ×©× ××©×™××”">
                    </div>
                `;

                // Quantity field (not for composite tasks)
                if (item.taskType !== 'composite') {
                    html += `
                    <div class="config-group">
                        <label>×›××•×ª:</label>
                        <input type="number" id="configQuantity" value="${taskData.quantity || 1}" min="1" placeholder="1">
                        <small>××¡×¤×¨ ×¤×¢××™× ×©×”××©×™××” ×ª×•×¤×™×¢</small>
                    </div>
                    `;
                }

                // Composite task - subtasks editor
                if (item.taskType === 'composite') {
                    const subtasks = taskData.subtasks || [];
                    html += `
                    <div class="config-group">
                        <label>×ª×ª×™-××©×™××•×ª:</label>
                        <div id="subtasksConfigList">
                            ${subtasks.map((st, i) => `
                                <div class="subtask-config-row" style="display: flex; gap: 8px; margin-bottom: 8px; align-items: center;">
                                    <input type="text" value="${st.title || ''}" class="subtask-input" placeholder="×ª×ª-××©×™××” ${i + 1}" style="flex: 1; padding: 8px; border: 2px solid #eee; border-radius: 10px; font-size: 14px; direction: rtl;">
                                    <button type="button" onclick="removeSubtaskConfig(${i})" style="width: 30px; height: 30px; border-radius: 50%; border: none; background: #ff6b6b; color: white; cursor: pointer; font-size: 14px; flex-shrink: 0;">âœ•</button>
                                </div>
                            `).join('')}
                        </div>
                        <button type="button" onclick="addSubtaskConfig()" class="btn btn-secondary" style="font-size: 12px; padding: 8px 14px; margin-top: 4px;">+ ×”×•×¡×£ ×ª×ª-××©×™××”</button>
                    </div>
                    `;
                }

                // Bonus-specific fields
                if (item.taskType === 'bonus') {
                    html += `
                        <div class="config-group">
                            <label>×¤×¨×¡ ××™× ×™××•× ($):</label>
                            <input type="number" id="configMinReward" value="${taskData.minReward || 0}" min="0" step="0.1">
                        </div>
                        <div class="config-group">
                            <label>×¤×¨×¡ ××§×¡×™××•× ($):</label>
                            <input type="number" id="configMaxReward" value="${taskData.maxReward || 0}" min="0" step="0.1">
                        </div>
                        <div class="config-group">
                            <label>×¡×•×’ ×‘×•× ×•×¡:</label>
                            <select id="configBonusType">
                                <option value="instant" ${(!taskData.bonusType || taskData.bonusType === 'instant') ? 'selected' : ''}>××™×™×“×™ - ×”×¤×¨×¡ × ×™×ª×Ÿ ××™×“</option>
                                <option value="after-regular" ${taskData.bonusType === 'after-regular' ? 'selected' : ''}>×œ××—×¨ ×”×©×œ××ª ×›×œ ×”××©×™××•×ª</option>
                            </select>
                            <small>××™×™×“×™: ×”×™×œ×“ ××§×‘×œ ××ª ×”×›×¡×£ ××™×“. ×œ××—×¨ ×”×©×œ××”: ×”×›×¡×£ ×××ª×™×Ÿ ×¢×“ ×©×›×œ ×”××©×™××•×ª ×”×¨×’×™×œ×•×ª ×”×•×©×œ××•</small>
                        </div>
                    `;
                }

                // Calm-down specific fields
                if (item.taskType === 'calm-down') {
                    html += `
                        <div class="config-group">
                            <label>×¡×•×’ ×¤×¢×™×œ×•×ª:</label>
                            <select id="configActivityType">
                                <option value="paint" ${taskData.activityType === 'paint' ? 'selected' : ''}>×œ×•×— ×¦×™×•×¨</option>
                                <option value="bubbles" ${taskData.activityType === 'bubbles' ? 'selected' : ''}>××©×—×§ ×‘×•×¢×•×ª</option>
                                <option value="xylophone" ${taskData.activityType === 'xylophone' ? 'selected' : ''}>×§×¡×™×œ×•×¤×•×Ÿ</option>
                                <option value="breathing" ${taskData.activityType === 'breathing' ? 'selected' : ''}>×ª×¨×’×™×œ × ×©×™××•×ª</option>
                                <option value="scooter" ${taskData.activityType === 'scooter' ? 'selected' : ''}>×§×¤×™×¦×” ×¢×œ ×§×•×¨×§×™× ×˜</option>
                                <option value="link" ${taskData.activityType === 'link' ? 'selected' : ''}>×§×™×©×•×¨ ×—×™×¦×•× ×™</option>
                            </select>
                        </div>
                        <div class="config-group" id="activityUrlGroup" style="${taskData.activityType === 'link' ? '' : 'display:none'}">
                            <label>×›×ª×•×‘×ª URL:</label>
                            <input type="text" id="configActivityUrl" value="${taskData.activityUrl || ''}" placeholder="https://...">
                        </div>
                    `;
                }

                // Common task options (not for calm-down)
                if (item.taskType !== 'calm-down') {
                    html += `
                        <div class="config-checkbox">
                            <input type="checkbox" id="configTestimony" ${taskData.requiresTestimony ? 'checked' : ''}>
                            <label for="configTestimony">×“×•×¨×© ×¢×“×•×ª (×ª×™××•×¨)</label>
                        </div>
                        <div class="config-checkbox">
                            <input type="checkbox" id="configTrackTime" ${taskData.trackTime ? 'checked' : ''}>
                            <label for="configTrackTime">××¢×§×‘ ×–××Ÿ</label>
                        </div>
                    `;
                }

                // Days selector
                const activeDays = taskData.activeDays || [0, 1, 2, 3, 4, 5, 6];
                const dayNames = ['××³', '×‘×³', '×’×³', '×“×³', '×”×³', '×•×³', '×©×‘×ª'];
                html += `
                    <div class="config-group">
                        <label>×™××™× ×¤×¢×™×œ×™×:</label>
                        <div class="days-selector">
                            ${dayNames.map((name, i) => `
                                <div class="day-checkbox">
                                    <input type="checkbox" id="configDay${i}" data-day="${i}" ${activeDays.includes(i) ? 'checked' : ''}>
                                    <label for="configDay${i}">${name}</label>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;

                return html;
            }

            return '';
        }

        // Apply configuration
        function applyConfig() {
            if (selectedItemIndex === null) return;

            const item = boardItems[selectedItemIndex];

            if (item.type === 'header') {
                item.text = document.getElementById('configText').value;
                item.size = document.getElementById('configSize').value;
            } else if (item.type === 'progress') {
                item.title = document.getElementById('configProgressTitle').value;
            } else if (item.type === 'bank') {
                item.label = document.getElementById('configLabel').value;
                item.showBonus = document.getElementById('configShowBonus').checked;
            } else if (item.type === 'goal') {
                item.icon = document.getElementById('configIcon').dataset.icon;
                item.title = document.getElementById('configGoalTitle').value;
                item.pointsRequired = parseInt(document.getElementById('configPointsRequired').value) || 100;
            } else if (item.type === 'task') {
                const taskData = item.taskData;
                taskData.icon = document.getElementById('configIcon').dataset.icon;
                taskData.title = document.getElementById('configTitle').value;

                if (item.taskType !== 'composite') {
                    taskData.quantity = parseInt(document.getElementById('configQuantity').value) || 1;
                }

                if (item.taskType === 'composite') {
                    const subtaskInputs = document.querySelectorAll('#subtasksConfigList .subtask-input');
                    taskData.subtasks = Array.from(subtaskInputs).map((input, i) => ({
                        id: i + 1,
                        title: input.value.trim() || `×ª×ª-××©×™××” ${i + 1}`
                    }));
                }

                if (item.taskType === 'bonus') {
                    taskData.minReward = parseFloat(document.getElementById('configMinReward').value) || 0;
                    taskData.maxReward = parseFloat(document.getElementById('configMaxReward').value) || 0;
                    taskData.bonusType = document.getElementById('configBonusType').value;
                }

                if (item.taskType === 'calm-down') {
                    taskData.activityType = document.getElementById('configActivityType').value;
                    taskData.activityUrl = document.getElementById('configActivityUrl')?.value || '';
                }

                if (item.taskType !== 'calm-down') {
                    taskData.requiresTestimony = document.getElementById('configTestimony').checked;
                    taskData.trackTime = document.getElementById('configTrackTime').checked;
                }

                // Days
                const activeDays = [];
                for (let i = 0; i <= 6; i++) {
                    if (document.getElementById(`configDay${i}`).checked) {
                        activeDays.push(i);
                    }
                }
                taskData.activeDays = activeDays;
            }

            renderBoard();
            closeConfig();
        }

        // Close configuration panel
        function closeConfig() {
            document.getElementById('configPanel').classList.remove('active');
            document.querySelectorAll('.board-item').forEach(el => {
                el.style.outline = 'none';
            });
            selectedItemIndex = null;
        }

        // Subtask config helpers
        function addSubtaskConfig() {
            const list = document.getElementById('subtasksConfigList');
            if (!list) return;
            const count = list.querySelectorAll('.subtask-config-row').length;
            const row = document.createElement('div');
            row.className = 'subtask-config-row';
            row.style.cssText = 'display: flex; gap: 8px; margin-bottom: 8px; align-items: center;';
            row.innerHTML = `
                <input type="text" value="" class="subtask-input" placeholder="×ª×ª-××©×™××” ${count + 1}" style="flex: 1; padding: 8px; border: 2px solid #eee; border-radius: 10px; font-size: 14px; direction: rtl;">
                <button type="button" onclick="removeSubtaskConfig(${count})" style="width: 30px; height: 30px; border-radius: 50%; border: none; background: #ff6b6b; color: white; cursor: pointer; font-size: 14px; flex-shrink: 0;">âœ•</button>
            `;
            list.appendChild(row);
        }

        function removeSubtaskConfig(index) {
            const list = document.getElementById('subtasksConfigList');
            if (!list) return;
            const rows = list.querySelectorAll('.subtask-config-row');
            if (rows.length <= 1) {
                alert('×—×™×™×‘×ª ×œ×”×™×•×ª ×œ×¤×—×•×ª ×ª×ª-××©×™××” ××—×ª');
                return;
            }
            if (rows[index]) {
                rows[index].remove();
            }
            // Re-index remove buttons
            const remaining = list.querySelectorAll('.subtask-config-row');
            remaining.forEach((row, i) => {
                const btn = row.querySelector('button');
                if (btn) btn.setAttribute('onclick', `removeSubtaskConfig(${i})`);
                const input = row.querySelector('input');
                if (input && !input.value) input.placeholder = `×ª×ª-××©×™××” ${i + 1}`;
            });
        }

        // Delete item
        function deleteItem(index) {
            if (confirm('×œ××—×•×§ ××ª ×”×¨×›×™×‘?')) {
                boardItems.splice(index, 1);
                renderBoard();
                closeConfig();
            }
        }

        // Duplicate item
        function duplicateItem(index) {
            const item = JSON.parse(JSON.stringify(boardItems[index]));
            item.id = nextItemId++;
            if (item.taskData) {
                item.taskData.id = nextItemId;
            }
            boardItems.splice(index + 1, 0, item);
            renderBoard();
        }

        // Emoji picker
        function initEmojiGrid() {
            const emojiGrid = document.getElementById('emojiGrid');

            emojis.forEach(item => {
                const emojiEl = document.createElement('div');
                emojiEl.className = 'emoji-item';
                emojiEl.textContent = item.e;
                emojiEl.dataset.tags = item.t;
                emojiEl.dataset.emoji = item.e;
                emojiEl.onclick = () => selectEmoji(item.e);
                emojiGrid.appendChild(emojiEl);
            });

            emojiImages.forEach(imageName => {
                const emojiEl = document.createElement('div');
                emojiEl.className = 'emoji-item';
                emojiEl.dataset.tags = imageName.replace('.png', '').replace(/-/g, ' ');
                emojiEl.innerHTML = `<img src="emojis/${imageName}" style="width: 40px; height: 40px; object-fit: contain;" />`;
                emojiEl.onclick = () => selectEmoji(`IMG:${imageName}`);
                emojiGrid.appendChild(emojiEl);
            });
        }

        function filterEmojis(query) {
            const items = document.querySelectorAll('#emojiGrid .emoji-item');
            const q = query.trim().toLowerCase();
            items.forEach(item => {
                if (!q) {
                    item.style.display = '';
                    return;
                }
                const tags = (item.dataset.tags || '').toLowerCase();
                const emoji = item.dataset.emoji || '';
                item.style.display = (tags.includes(q) || emoji.includes(q)) ? '' : 'none';
            });
        }

        let emojiInsertTargetInput = null; // When set, emoji will be inserted into this input field

        function openEmojiPicker() {
            emojiInsertTargetInput = null;
            const searchInput = document.getElementById('emojiSearch');
            searchInput.value = '';
            filterEmojis('');
            document.getElementById('emojiModal').classList.add('active');
            searchInput.focus();
        }

        function openEmojiPickerForInput(inputId) {
            emojiInsertTargetInput = inputId;
            const searchInput = document.getElementById('emojiSearch');
            searchInput.value = '';
            filterEmojis('');
            document.getElementById('emojiModal').classList.add('active');
            searchInput.focus();
        }

        function closeEmojiPicker() {
            document.getElementById('emojiModal').classList.remove('active');
            emojiInsertTargetInput = null;
        }

        function selectEmoji(emoji) {
            if (emojiInsertTargetInput) {
                // Insert emoji into target text input
                const input = document.getElementById(emojiInsertTargetInput);
                if (input && !emoji.startsWith('IMG:')) {
                    const start = input.selectionStart || input.value.length;
                    const end = input.selectionEnd || input.value.length;
                    input.value = input.value.substring(0, start) + emoji + input.value.substring(end);
                    input.focus();
                    const newPos = start + emoji.length;
                    input.setSelectionRange(newPos, newPos);
                }
                closeEmojiPicker();
                return;
            }
            const configIcon = document.getElementById('configIcon');
            if (configIcon) {
                configIcon.dataset.icon = emoji;
                if (emoji.startsWith('IMG:')) {
                    const imageName = emoji.substring(4);
                    configIcon.innerHTML = `<img src="emojis/${imageName}" />`;
                } else {
                    configIcon.textContent = emoji;
                }
            }
            closeEmojiPicker();
        }

        document.getElementById('emojiModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEmojiPicker();
            }
        });

        // Activity type change handler
        document.addEventListener('change', function(e) {
            if (e.target.id === 'configActivityType') {
                const urlGroup = document.getElementById('activityUrlGroup');
                if (urlGroup) {
                    urlGroup.style.display = e.target.value === 'link' ? '' : 'none';
                }
            }
        });

        // ==================== Image Upload Functions ====================

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                alert('× × ×œ×‘×—×•×¨ ×§×•×‘×¥ ×ª××•× ×”');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    currentImage = img;
                    isCoinCrop = false;
                    showCropModal();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function handleCoinImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                alert('× × ×œ×‘×—×•×¨ ×§×•×‘×¥ ×ª××•× ×”');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    currentCoinImage = img;
                    isCoinCrop = true;
                    showCropModal();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function showCropModal() {
            const modal = document.getElementById('cropModal');
            const canvas = document.getElementById('cropCanvas');
            const ctx = canvas.getContext('2d');
            const cropBox = document.getElementById('cropBox');

            const imageToUse = isCoinCrop ? currentCoinImage : currentImage;

            const isMobile = window.innerWidth <= 600;
            const maxSize = isMobile ? Math.min(window.innerWidth - 60, 400) : 500;
            let width = imageToUse.width;
            let height = imageToUse.height;

            if (width > maxSize || height > maxSize) {
                if (width > height) {
                    height = (height / width) * maxSize;
                    width = maxSize;
                } else {
                    width = (width / height) * maxSize;
                    height = maxSize;
                }
            }

            canvas.width = width;
            canvas.height = height;
            ctx.drawImage(imageToUse, 0, 0, width, height);

            const cropSize = Math.min(width, height) * 0.7;
            cropState.size = cropSize;
            cropState.x = (width - cropSize) / 2;
            cropState.y = (height - cropSize) / 2;

            updateCropBox();

            cropBox.onmousedown = startDrag;
            cropBox.ontouchstart = startDrag;

            const handles = cropBox.querySelectorAll('.resize-handle');
            handles.forEach(handle => {
                handle.onmousedown = (e) => startResize(e, handle.classList[1]);
                handle.ontouchstart = (e) => startResize(e, handle.classList[1]);
            });

            document.onmousemove = handleMove;
            document.onmouseup = stopDragOrResize;
            document.ontouchmove = handleMove;
            document.ontouchend = stopDragOrResize;

            modal.classList.add('active');
        }

        function updateCropBox() {
            const cropBox = document.getElementById('cropBox');
            cropBox.style.left = cropState.x + 'px';
            cropBox.style.top = cropState.y + 'px';
            cropBox.style.width = cropState.size + 'px';
            cropBox.style.height = cropState.size + 'px';
        }

        function startDrag(e) {
            if (e.target.classList.contains('resize-handle')) return;
            e.preventDefault();
            e.stopPropagation();
            cropState.isDragging = true;

            const cropBox = document.getElementById('cropBox');
            const rect = cropBox.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            cropState.startX = clientX - rect.left;
            cropState.startY = clientY - rect.top;
        }

        function startResize(e, handle) {
            e.preventDefault();
            e.stopPropagation();
            cropState.isResizing = true;
            cropState.resizeHandle = handle;

            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            cropState.startX = clientX;
            cropState.startY = clientY;
            cropState.startSize = cropState.size;
            cropState.startCropX = cropState.x;
            cropState.startCropY = cropState.y;
        }

        function handleMove(e) {
            if (cropState.isDragging) {
                dragCropBox(e);
            } else if (cropState.isResizing) {
                resizeCropBox(e);
            }
        }

        function dragCropBox(e) {
            e.preventDefault();

            const canvas = document.getElementById('cropCanvas');
            const canvasRect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            let newX = clientX - canvasRect.left - cropState.startX;
            let newY = clientY - canvasRect.top - cropState.startY;

            newX = Math.max(0, Math.min(newX, canvas.width - cropState.size));
            newY = Math.max(0, Math.min(newY, canvas.height - cropState.size));

            cropState.x = newX;
            cropState.y = newY;
            updateCropBox();
        }

        function resizeCropBox(e) {
            e.preventDefault();

            const canvas = document.getElementById('cropCanvas');
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;

            const deltaX = clientX - cropState.startX;
            const deltaY = clientY - cropState.startY;

            let newSize = cropState.startSize;
            let newX = cropState.startCropX;
            let newY = cropState.startCropY;

            switch(cropState.resizeHandle) {
                case 'resize-se':
                    newSize = Math.max(cropState.minSize, cropState.startSize + Math.max(deltaX, deltaY));
                    break;
                case 'resize-sw':
                    newSize = Math.max(cropState.minSize, cropState.startSize + Math.max(-deltaX, deltaY));
                    newX = cropState.startCropX - (newSize - cropState.startSize);
                    break;
                case 'resize-ne':
                    newSize = Math.max(cropState.minSize, cropState.startSize + Math.max(deltaX, -deltaY));
                    newY = cropState.startCropY - (newSize - cropState.startSize);
                    break;
                case 'resize-nw':
                    newSize = Math.max(cropState.minSize, cropState.startSize + Math.max(-deltaX, -deltaY));
                    newX = cropState.startCropX - (newSize - cropState.startSize);
                    newY = cropState.startCropY - (newSize - cropState.startSize);
                    break;
            }

            newX = Math.max(0, Math.min(newX, canvas.width - newSize));
            newY = Math.max(0, Math.min(newY, canvas.height - newSize));
            newSize = Math.min(newSize, canvas.width - newX, canvas.height - newY);

            cropState.size = newSize;
            cropState.x = newX;
            cropState.y = newY;
            updateCropBox();
        }

        function stopDragOrResize() {
            cropState.isDragging = false;
            cropState.isResizing = false;
            cropState.resizeHandle = null;
        }

        function applyCrop() {
            const canvas = document.getElementById('cropCanvas');
            const imageToUse = isCoinCrop ? currentCoinImage : currentImage;

            const scaleX = imageToUse.width / canvas.width;
            const scaleY = imageToUse.height / canvas.height;

            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');

            const finalSize = 200;
            tempCanvas.width = finalSize;
            tempCanvas.height = finalSize;

            tempCtx.drawImage(
                imageToUse,
                cropState.x * scaleX,
                cropState.y * scaleY,
                cropState.size * scaleX,
                cropState.size * scaleY,
                0,
                0,
                finalSize,
                finalSize
            );

            // Check for transparency
            let dataUrl;
            const imageData = tempCtx.getImageData(0, 0, finalSize, finalSize);
            let hasTransparency = false;

            for (let i = 3; i < imageData.data.length; i += 4) {
                if (imageData.data[i] < 255) {
                    hasTransparency = true;
                    break;
                }
            }

            if (hasTransparency) {
                dataUrl = tempCanvas.toDataURL('image/png');
            } else {
                dataUrl = tempCanvas.toDataURL('image/jpeg', 0.85);
            }

            if (isCoinCrop) {
                document.getElementById('coinImageData').value = dataUrl;
                document.getElementById('coinPreviewImg').src = dataUrl;
                document.getElementById('coinImagePreview').style.display = 'block';
                isCoinCrop = false;
            } else {
                document.getElementById('kidImageData').value = dataUrl;
                document.getElementById('previewImg').src = dataUrl;
                document.getElementById('imagePreview').style.display = 'block';
            }

            closeCropModal();
        }

        function closeCropModal() {
            const modal = document.getElementById('cropModal');
            modal.classList.remove('active');
            document.getElementById('kidImageUpload').value = '';
            document.getElementById('coinImageUpload').value = '';
            isCoinCrop = false;
        }

        function removeImage() {
            document.getElementById('kidImageData').value = '';
            document.getElementById('previewImg').src = '';
            document.getElementById('imagePreview').style.display = 'none';
            // Also clear mobile preview
            if (document.getElementById('previewImgMobile')) {
                document.getElementById('previewImgMobile').src = '';
                document.getElementById('imagePreviewMobile').style.display = 'none';
            }
        }

        function removeCoinImage() {
            document.getElementById('coinImageData').value = '';
            document.getElementById('coinPreviewImg').src = '';
            document.getElementById('coinImagePreview').style.display = 'none';
            // Also clear mobile preview
            if (document.getElementById('coinPreviewImgMobile')) {
                document.getElementById('coinPreviewImgMobile').src = '';
                document.getElementById('coinImagePreviewMobile').style.display = 'none';
            }
        }

        // Click outside crop modal to close
        document.getElementById('cropModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeCropModal();
            }
        });

        // ==================== End Image Upload Functions ====================

        // Save board
        async function saveBoard() {
            try {
                // Convert board items to tasks array for backward compatibility
                const tasks = [];
                let taskId = 1;

                boardItems.forEach(item => {
                    if (item.type === 'task' && item.taskData) {
                        const taskData = { ...item.taskData };
                        const quantity = taskData.quantity || 1;
                        delete taskData.quantity; // Don't store quantity in individual tasks

                        // Create multiple task instances based on quantity
                        for (let i = 0; i < quantity; i++) {
                            tasks.push({
                                ...taskData,
                                id: taskId++,
                                type: item.taskType
                            });
                        }
                    }
                });

                // Extract headers for backward compatibility
                const headers = boardItems.filter(i => i.type === 'header');
                const bankItem = boardItems.find(i => i.type === 'bank');

                // Find section headers (headers before tasks of each type)
                let regularTasksHeader = '';
                let bonusTasksHeader = '';
                let calmDownHeader = '';
                let headerLabel = '';

                // First large header becomes page header
                const largeHeader = headers.find(h => h.size === 'large');
                if (largeHeader) {
                    headerLabel = largeHeader.text;
                }

                // Find headers for each section by looking at what comes after them
                for (let i = 0; i < boardItems.length; i++) {
                    const item = boardItems[i];
                    if (item.type === 'header' && item !== largeHeader) {
                        // Look for next task to determine section
                        for (let j = i + 1; j < boardItems.length; j++) {
                            const nextItem = boardItems[j];
                            if (nextItem.type === 'task') {
                                if (nextItem.taskType === 'regular' && !regularTasksHeader) {
                                    regularTasksHeader = item.text;
                                } else if (nextItem.taskType === 'bonus' && !bonusTasksHeader) {
                                    bonusTasksHeader = item.text;
                                } else if (nextItem.taskType === 'calm-down' && !calmDownHeader) {
                                    calmDownHeader = item.text;
                                }
                                break;
                            }
                            if (nextItem.type === 'header') break;
                        }
                    }
                }

                // Get kid settings from palette
                const dailyReward = parseFloat(document.getElementById('dailyReward').value) || 0.5;
                const totalMoney = parseFloat(document.getElementById('totalMoney').value) || 0;
                const kidDescription = document.getElementById('kidDescription').value || '';
                const behaviorGoals = document.getElementById('behaviorGoals').value || '';
                const kidAge = document.getElementById('kidAge').value ? parseInt(document.getElementById('kidAge').value) : '';
                const kidGender = document.getElementById('kidGender').value || '';
                const coinStyle = document.getElementById('coinStyle').value;
                const colorSchema = document.querySelector('input[name="colorSchema"]:checked').value;
                const showDino = document.getElementById('showDino').checked;

                // Get kid image - prefer uploaded data, fall back to existing
                let imageName = document.getElementById('kidImageData').value || kidData.imageName || '';

                // Get coin image - prefer uploaded data, fall back to existing
                let coinImageName = '';
                if (coinStyle === 'custom') {
                    coinImageName = document.getElementById('coinImageData').value || kidData.coinImageName || '';
                }

                // Save to Firestore
                await db.collection('kids').doc(kidId).update({
                    tasks: tasks,
                    boardLayout: { items: boardItems },
                    headerLabel: headerLabel,
                    savingsLabel: bankItem?.label || '',
                    regularTasksHeader: regularTasksHeader,
                    bonusTasksHeader: bonusTasksHeader,
                    calmDownHeader: calmDownHeader,
                    // Kid settings
                    totalMoney: totalMoney,
                    kidDescription: kidDescription,
                    behaviorGoals: behaviorGoals,
                    age: kidAge,
                    gender: kidGender,
                    dailyReward: dailyReward,
                    imageName: imageName,
                    coinStyle: coinStyle,
                    coinImageName: coinImageName,
                    colorSchema: colorSchema,
                    showDino: showDino
                });

                // Update local kidData
                kidData.dailyReward = dailyReward;
                kidData.totalMoney = totalMoney;
                kidData.kidDescription = kidDescription;
                kidData.behaviorGoals = behaviorGoals;
                kidData.age = kidAge;
                kidData.gender = kidGender;
                kidData.imageName = imageName;
                kidData.coinStyle = coinStyle;
                kidData.coinImageName = coinImageName;
                kidData.colorSchema = colorSchema;
                kidData.showDino = showDino;

                alert('×”×œ×•×— × ×©××¨ ×‘×”×¦×œ×—×”!');
            } catch (error) {
                console.error('Error saving board:', error);
                alert('×©×’×™××” ×‘×©××™×¨×”: ' + error.message);
            }
        }

        // Preview board
        function previewBoard() {
            window.open(`board.html?kid=${kidId}`, '_blank');
        }

        // ==================== Mobile Settings Functions ====================

        function openMobileSettings() {
            // Sync values from desktop controls to mobile controls
            document.getElementById('dailyRewardMobile').value = document.getElementById('dailyReward').value;
            document.getElementById('totalMoneyMobile').value = document.getElementById('totalMoney').value;
            document.getElementById('kidAgeMobile').value = document.getElementById('kidAge').value;
            document.getElementById('kidGenderMobile').value = document.getElementById('kidGender').value;
            document.getElementById('kidDescriptionMobile').value = document.getElementById('kidDescription').value;
            document.getElementById('behaviorGoalsMobile').value = document.getElementById('behaviorGoals').value;
            document.getElementById('coinStyleMobile').value = document.getElementById('coinStyle').value;
            toggleCoinImageInputMobile();

            // Sync image previews
            const kidImageData = document.getElementById('kidImageData').value;
            if (kidImageData) {
                document.getElementById('previewImgMobile').src = kidImageData;
                document.getElementById('imagePreviewMobile').style.display = 'block';
            } else {
                document.getElementById('imagePreviewMobile').style.display = 'none';
            }

            const coinImageData = document.getElementById('coinImageData').value;
            if (coinImageData) {
                document.getElementById('coinPreviewImgMobile').src = coinImageData;
                document.getElementById('coinImagePreviewMobile').style.display = 'block';
            } else {
                document.getElementById('coinImagePreviewMobile').style.display = 'none';
            }

            // Sync color schema
            const colorSchema = document.querySelector('input[name="colorSchema"]:checked').value;
            const mobileColorSchemaInput = document.querySelector(`input[name="colorSchemaMobile"][value="${colorSchema}"]`);
            if (mobileColorSchemaInput) {
                mobileColorSchemaInput.checked = true;
            }

            // Sync show dino
            document.getElementById('showDinoMobile').checked = document.getElementById('showDino').checked;

            document.getElementById('mobileSettingsModal').classList.add('active');
        }

        function closeMobileSettings() {
            document.getElementById('mobileSettingsModal').classList.remove('active');
        }

        function toggleCoinImageInputMobile() {
            const coinStyle = document.getElementById('coinStyleMobile').value;
            const coinImageGroup = document.getElementById('coinImageGroupMobile');
            coinImageGroup.style.display = coinStyle === 'custom' ? 'block' : 'none';
        }

        function applyMobileSettings() {
            // Sync values from mobile controls to desktop controls
            document.getElementById('dailyReward').value = document.getElementById('dailyRewardMobile').value;
            document.getElementById('totalMoney').value = document.getElementById('totalMoneyMobile').value;
            document.getElementById('kidAge').value = document.getElementById('kidAgeMobile').value;
            document.getElementById('kidGender').value = document.getElementById('kidGenderMobile').value;
            document.getElementById('kidDescription').value = document.getElementById('kidDescriptionMobile').value;
            document.getElementById('behaviorGoals').value = document.getElementById('behaviorGoalsMobile').value;
            document.getElementById('coinStyle').value = document.getElementById('coinStyleMobile').value;
            toggleCoinImageInput();

            // Sync color schema
            const colorSchema = document.querySelector('input[name="colorSchemaMobile"]:checked').value;
            const desktopColorSchemaInput = document.querySelector(`input[name="colorSchema"][value="${colorSchema}"]`);
            if (desktopColorSchemaInput) {
                desktopColorSchemaInput.checked = true;
            }

            // Sync show dino
            document.getElementById('showDino').checked = document.getElementById('showDinoMobile').checked;

            closeMobileSettings();
        }

        // Handle image uploads from mobile inputs
        document.getElementById('kidImageUploadMobile')?.addEventListener('change', function(event) {
            // Trigger the same handler as desktop
            handleImageUpload(event);
        });

        document.getElementById('coinImageUploadMobile')?.addEventListener('change', function(event) {
            handleCoinImageUpload(event);
        });

        // Close mobile settings modal when clicking outside
        document.getElementById('mobileSettingsModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeMobileSettings();
            }
        });

        // Sync image previews when crop is applied (override for mobile support)
        const originalApplyCrop = applyCrop;
        applyCrop = function() {
            const canvas = document.getElementById('cropCanvas');
            const imageToUse = isCoinCrop ? currentCoinImage : currentImage;

            const scaleX = imageToUse.width / canvas.width;
            const scaleY = imageToUse.height / canvas.height;

            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');

            const finalSize = 200;
            tempCanvas.width = finalSize;
            tempCanvas.height = finalSize;

            tempCtx.drawImage(
                imageToUse,
                cropState.x * scaleX,
                cropState.y * scaleY,
                cropState.size * scaleX,
                cropState.size * scaleY,
                0,
                0,
                finalSize,
                finalSize
            );

            // Check for transparency
            let dataUrl;
            const imageData = tempCtx.getImageData(0, 0, finalSize, finalSize);
            let hasTransparency = false;

            for (let i = 3; i < imageData.data.length; i += 4) {
                if (imageData.data[i] < 255) {
                    hasTransparency = true;
                    break;
                }
            }

            if (hasTransparency) {
                dataUrl = tempCanvas.toDataURL('image/png');
            } else {
                dataUrl = tempCanvas.toDataURL('image/jpeg', 0.85);
            }

            if (isCoinCrop) {
                document.getElementById('coinImageData').value = dataUrl;
                document.getElementById('coinPreviewImg').src = dataUrl;
                document.getElementById('coinImagePreview').style.display = 'block';
                // Also update mobile preview
                document.getElementById('coinPreviewImgMobile').src = dataUrl;
                document.getElementById('coinImagePreviewMobile').style.display = 'block';
                isCoinCrop = false;
            } else {
                document.getElementById('kidImageData').value = dataUrl;
                document.getElementById('previewImg').src = dataUrl;
                document.getElementById('imagePreview').style.display = 'block';
                // Also update mobile preview
                document.getElementById('previewImgMobile').src = dataUrl;
                document.getElementById('imagePreviewMobile').style.display = 'block';
            }

            closeCropModal();
        };
    </script>
</body>
</html>
