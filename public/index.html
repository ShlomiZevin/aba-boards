<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×œ×•×— ××©×™××•×ª ABA</title>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            direction: rtl;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .piggy-bank-section {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3);
        }

        .piggy-bank-icon {
            width: 120px;
            height: 120px;
            margin: 0 auto 10px;
            animation: wiggle 2s ease-in-out infinite;
            border-radius: 50%;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
        }

        .piggy-bank-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        @keyframes wiggle {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-5deg); }
            75% { transform: rotate(5deg); }
        }

        .money-counter {
            font-size: 2.5em;
            font-weight: bold;
            color: #ff6b6b;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            margin: 10px 0;
        }

        .money-label {
            font-size: 1.2em;
            color: #333;
            font-weight: bold;
        }

        .coins-animation {
            position: fixed;
            font-size: 3em;
            animation: coinFall 2s ease-out;
            pointer-events: none;
            z-index: 1001;
        }

        @keyframes coinFall {
            0% {
                transform: translateY(-100px) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(80vh) rotate(720deg);
                opacity: 0;
            }
        }

        h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .progress-container {
            margin-top: 20px;
            background: #f0f0f0;
            border-radius: 15px;
            height: 30px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .tasks-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .task-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .task-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .task-card.completed {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .task-icon {
            font-size: 3em;
            margin-bottom: 15px;
            text-align: center;
        }

        .task-title {
            font-size: 1.3em;
            font-weight: bold;
            text-align: center;
            margin-bottom: 10px;
        }

        .checkmark {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 40px;
            height: 40px;
            background: #4CAF50;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5em;
            animation: checkPop 0.5s ease;
        }

        .task-card.completed .checkmark {
            display: flex;
        }

        @keyframes checkPop {
            0% { transform: scale(0) rotate(0deg); }
            50% { transform: scale(1.2) rotate(180deg); }
            100% { transform: scale(1) rotate(360deg); }
        }

        /* Celebration animation */
        .celebration {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #f0f;
            animation: confettiFall 3s linear;
        }

        @keyframes confettiFall {
            to {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        .star {
            position: absolute;
            font-size: 2em;
            animation: starBurst 1s ease-out;
            pointer-events: none;
        }

        @keyframes starBurst {
            0% {
                transform: scale(0) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: scale(3) rotate(360deg);
                opacity: 0;
            }
        }

        .encouragement {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            text-align: center;
            animation: encouragePop 2s ease;
            pointer-events: none;
            z-index: 999;
            display: none;
        }

        @keyframes encouragePop {
            0%, 100% { opacity: 0; transform: translate(-50%, -50%) scale(0); }
            10%, 90% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }

        .reset-info {
            text-align: center;
            color: white;
            font-size: 0.9em;
            margin-top: 20px;
        }

        @media (max-width: 600px) {
            .tasks-grid {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 1.8em;
            }
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.5em;
            color: white;
        }
    </style>
</head>
<body>
    <!-- Loading State -->
    <div id="loadingState" class="loading">×˜×•×¢×Ÿ...</div>

    <!-- Kid/Parent Page -->
    <div id="kidPage" class="container hidden">
        <div class="header">
            <h1 id="kidTitle">ğŸŒŸ ×”××©×™××•×ª ğŸŒŸ</h1>
            <div class="progress-container">
                <div class="progress-bar" id="progressBar">0%</div>
            </div>

            <div class="piggy-bank-section">
                <div class="piggy-bank-icon">
                    <img id="kidImage" src="lenny-small.png" alt="Kid">
                </div>
                <div class="money-counter" id="moneyCounter">$0</div>
                <div class="money-label" id="moneyLabel">×§×•×¤×ª ×”×—×™×¡×›×•×Ÿ</div>
            </div>
        </div>

        <div class="tasks-grid" id="tasksGrid"></div>

        <div class="reset-info">
            ×”×œ×•×— ××ª××¤×¡ ×›×œ ×™×•× ×‘×—×¦×•×ª ğŸŒ™
        </div>
    </div>

    <div class="celebration" id="celebration"></div>
    <div class="encouragement" id="encouragement"></div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDHE7FKHJ92rXXfz_3hLX8e9s8lC9g9g9o",
            authDomain: "aba-ai-d74f5.firebaseapp.com",
            projectId: "aba-ai-d74f5",
            storageBucket: "aba-ai-d74f5.firebasestorage.app",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef123456"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const DAILY_REWARD = 0.5;
        const encouragementMessages = [
            '!×›×œ ×”×›×‘×•×“ ğŸ‰',
            '!×™×•×¤×™ ×©×œ ×™×•×¤×™ ğŸŒŸ',
            '!××œ×•×£ ××œ×•×¤×™× ğŸ†',
            '!××¦×•×™×Ÿ ×××•×“ ğŸ’ª',
            '!×¢×‘×•×“×” ××¢×•×œ×” â­',
            '!×’××” ×‘×š ğŸŠ',
            '!×”××©×š ×›×š ğŸš€',
            '!×¤×©×•×˜ ××“×”×™× ğŸŒˆ'
        ];

        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const kidId = urlParams.get('kid');
        const isParent = urlParams.get('mode') === 'parent';

        // Route to kid/parent page
        if (kidId) {
            showKidPage(kidId, isParent);
        } else {
            // Default to ×œ× ×™
            window.location.search = '?kid=leni';
        }

        // Kid/Parent Page Logic
        class TaskBoard {
            constructor(kidId, kidData, isParentMode) {
                this.kidId = kidId;
                this.kidData = kidData;
                this.isParentMode = isParentMode;
                this.tasks = kidData.tasks || [];
                this.completedTasks = new Set();
                this.todayRewardGiven = false;
                this.init();
            }

            async init() {
                await this.checkDailyReset();
                await this.loadState();
                this.render();
                this.updateProgress();
                this.updateMoneyDisplay();
            }

            async checkDailyReset() {
                const today = new Date().toDateString();

                if (this.kidData.lastResetDate !== today) {
                    // New day - reset tasks
                    await db.collection('kids').doc(this.kidId).update({
                        completedTasks: [],
                        todayRewardGiven: false,
                        lastResetDate: today
                    });
                    this.completedTasks.clear();
                    this.todayRewardGiven = false;
                }
            }

            async loadState() {
                const doc = await db.collection('kids').doc(this.kidId).get();
                const data = doc.data();
                this.completedTasks = new Set(data.completedTasks || []);
                this.todayRewardGiven = data.todayRewardGiven || false;
                this.kidData.totalMoney = data.totalMoney || 0;
            }

            async saveState() {
                await db.collection('kids').doc(this.kidId).update({
                    completedTasks: Array.from(this.completedTasks),
                    todayRewardGiven: this.todayRewardGiven
                });
            }

            async addMoney(amount) {
                this.kidData.totalMoney += amount;
                await db.collection('kids').doc(this.kidId).update({
                    totalMoney: this.kidData.totalMoney
                });
                this.updateMoneyDisplay();
            }

            updateMoneyDisplay() {
                const counter = document.getElementById('moneyCounter');
                counter.textContent = `$${this.kidData.totalMoney.toFixed(2)}`;
            }

            async toggleTask(taskId) {
                if (this.isParentMode) {
                    // Parents can't toggle tasks
                    return;
                }

                if (this.completedTasks.has(taskId)) {
                    this.completedTasks.delete(taskId);
                } else {
                    this.completedTasks.add(taskId);
                    this.celebrate();
                }
                await this.saveState();
                this.render();
                this.updateProgress();
            }

            render() {
                const grid = document.getElementById('tasksGrid');
                grid.innerHTML = '';

                this.tasks.forEach(task => {
                    const card = document.createElement('div');
                    card.className = 'task-card';
                    if (this.completedTasks.has(task.id)) {
                        card.classList.add('completed');
                    }

                    card.innerHTML = `
                        <div class="checkmark">âœ“</div>
                        <div class="task-icon">${task.icon}</div>
                        <div class="task-title">${task.title}</div>
                    `;

                    if (!this.isParentMode) {
                        card.style.cursor = 'pointer';
                        card.addEventListener('click', () => this.toggleTask(task.id));
                    } else {
                        card.style.cursor = 'default';
                        card.style.opacity = '0.8';
                    }

                    grid.appendChild(card);
                });
            }

            updateProgress() {
                const progress = (this.completedTasks.size / this.tasks.length) * 100;
                const progressBar = document.getElementById('progressBar');
                progressBar.style.width = progress + '%';
                progressBar.textContent = Math.round(progress) + '%';

                if (progress === 100 && !this.isParentMode) {
                    this.showMegaCelebration();
                }
            }

            celebrate() {
                const msg = encouragementMessages[Math.floor(Math.random() * encouragementMessages.length)];
                const encouragement = document.getElementById('encouragement');
                encouragement.textContent = msg;
                encouragement.style.display = 'block';
                setTimeout(() => {
                    encouragement.style.display = 'none';
                }, 2000);

                this.createConfetti(15);
                this.createStars();
            }

            createConfetti(count) {
                const celebration = document.getElementById('celebration');
                const colors = ['#667eea', '#764ba2', '#f093fb', '#4facfe', '#43e97b', '#fa709a'];

                for (let i = 0; i < count; i++) {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDelay = Math.random() * 0.5 + 's';
                    celebration.appendChild(confetti);
                    setTimeout(() => confetti.remove(), 3000);
                }
            }

            createStars() {
                const celebration = document.getElementById('celebration');
                const starEmojis = ['â­', 'ğŸŒŸ', 'âœ¨', 'ğŸ’«'];

                for (let i = 0; i < 5; i++) {
                    const star = document.createElement('div');
                    star.className = 'star';
                    star.textContent = starEmojis[Math.floor(Math.random() * starEmojis.length)];
                    star.style.left = Math.random() * 100 + '%';
                    star.style.top = Math.random() * 100 + '%';
                    celebration.appendChild(star);
                    setTimeout(() => star.remove(), 1000);
                }
            }

            async showMegaCelebration() {
                if (this.todayRewardGiven) {
                    const encouragement = document.getElementById('encouragement');
                    encouragement.textContent = '!ğŸ‰ ×¡×™×™××ª ××ª ×›×œ ×”××©×™××•×ª! ××ª×” ××œ×•×£ ğŸ†';
                    encouragement.style.display = 'block';
                    this.createConfetti(50);
                    this.createStars();
                    setTimeout(() => {
                        encouragement.style.display = 'none';
                    }, 3000);
                    return;
                }

                this.todayRewardGiven = true;
                await this.saveState();

                const encouragement = document.getElementById('encouragement');
                encouragement.innerHTML = `
                    <div>!ğŸ‰ ×¡×™×™××ª ××ª ×›×œ ×”××©×™××•×ª! ××ª×” ××œ×•×£ ğŸ†</div>
                    <div style="font-size: 1.5em; margin-top: 20px; color: #ffd700;">
                        !ğŸ’° ×§×™×‘×œ×ª $${DAILY_REWARD} ×œ×§×•×¤×ª ×”×—×™×¡×›×•×Ÿ ğŸ’°
                    </div>
                `;
                encouragement.style.display = 'block';

                this.createConfetti(100);
                this.createStars();
                this.createFallingCoins();

                setTimeout(() => {
                    this.animateMoneyIncrease(DAILY_REWARD);
                }, 1000);

                setTimeout(() => {
                    encouragement.style.display = 'none';
                }, 4000);
            }

            createFallingCoins() {
                const celebration = document.getElementById('celebration');
                const coinEmojis = ['ğŸª™', 'ğŸ’°', 'ğŸ’µ', 'ğŸ’´', 'ğŸ’¶', 'ğŸ’·'];

                for (let i = 0; i < 30; i++) {
                    const coin = document.createElement('div');
                    coin.className = 'coins-animation';
                    coin.textContent = coinEmojis[Math.floor(Math.random() * coinEmojis.length)];
                    coin.style.left = Math.random() * 100 + '%';
                    coin.style.animationDelay = Math.random() * 1 + 's';
                    celebration.appendChild(coin);
                    setTimeout(() => coin.remove(), 3000);
                }
            }

            animateMoneyIncrease(amount) {
                const counter = document.getElementById('moneyCounter');
                const startMoney = this.kidData.totalMoney;
                const duration = 1500;
                const startTime = Date.now();

                const animate = () => {
                    const elapsed = Date.now() - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    const easeProgress = 1 - Math.pow(1 - progress, 3);
                    const currentMoney = startMoney + (amount * easeProgress);

                    counter.textContent = `$${currentMoney.toFixed(2)}`;
                    counter.style.transform = `scale(${1 + Math.sin(progress * Math.PI) * 0.3})`;

                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    } else {
                        this.addMoney(amount);
                        counter.style.transform = 'scale(1)';
                    }
                };

                animate();
            }
        }

        // Show Kid/Parent Page
        async function showKidPage(kidId, isParentMode) {
            try {
                const doc = await db.collection('kids').doc(kidId).get();
                if (!doc.exists) {
                    document.getElementById('loadingState').textContent = '×™×œ×“ ×œ× × ××¦×';
                    return;
                }

                const kidData = doc.data();
                document.getElementById('kidTitle').textContent = `ğŸŒŸ ×”××©×™××•×ª ×©×œ ${kidData.name} ğŸŒŸ`;
                document.getElementById('moneyLabel').textContent = `×§×•×¤×ª ×”×—×™×¡×›×•×Ÿ ×©×œ ${kidData.name}`;

                // Set kid image
                const kidImage = document.getElementById('kidImage');
                kidImage.src = kidData.imageName || 'lenny-small.png';
                kidImage.alt = kidData.name;

                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('kidPage').classList.remove('hidden');

                new TaskBoard(kidId, kidData, isParentMode);
            } catch (error) {
                console.error('Error loading kid page:', error);
                document.getElementById('loadingState').textContent = '×©×’×™××” ×‘×˜×¢×™× ×”';
            }
        }
    </script>
</body>
</html>
