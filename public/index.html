<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×œ×•×— ××©×™××•×ª</title>

    <!-- Prevent caching -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- Doing Theme -->
    <link rel="stylesheet" href="doing-theme-light.css">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            direction: rtl;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .piggy-bank-section {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3);
        }

        .piggy-bank-icon {
            width: 120px;
            height: 120px;
            margin: 0 auto 10px;
            animation: wiggle 2s ease-in-out infinite;
            border-radius: 50%;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
        }

        .piggy-bank-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        @keyframes wiggle {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-5deg); }
            75% { transform: rotate(5deg); }
        }

        .money-counter {
            font-size: 2.5em;
            font-weight: bold;
            color: #ff6b6b;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            margin: 10px 0;
        }

        .money-label {
            font-size: 1.2em;
            color: #333;
            font-weight: bold;
        }

        .coins-animation {
            position: fixed;
            font-size: 3em;
            animation: coinFall 2s ease-out;
            pointer-events: none;
            z-index: 1001;
        }

        @keyframes coinFall {
            0% {
                transform: translateY(-100px) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(80vh) rotate(720deg);
                opacity: 0;
            }
        }

        h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .progress-container {
            margin-top: 20px;
            background: #f0f0f0;
            border-radius: 15px;
            height: 30px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .tasks-grid, .bonus-tasks-grid, .calm-down-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .task-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .task-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .task-card.completed {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        /* Bonus task styles */
        .bonus-task-card {
            background: white;
            border: 3px solid #ffd700;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(255, 215, 0, 0.4);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .bonus-task-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.6);
        }

        .bonus-task-card.completed {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #333;
            border-color: #ffaa00;
        }

        .bonus-reward-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #ffd700;
            color: #333;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(255, 215, 0, 0.5);
        }

        .bonus-task-card.completed .bonus-reward-badge {
            background: #ffaa00;
        }

        /* Calm down task styles */
        .calm-down-card {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            border: 3px solid #89CFF0;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(168, 237, 234, 0.5);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .calm-down-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 30px rgba(168, 237, 234, 0.7);
        }

        .task-icon {
            font-size: 3em;
            margin-bottom: 15px;
            text-align: center;
        }

        .task-title {
            font-size: 1.3em;
            font-weight: bold;
            text-align: center;
            margin-bottom: 10px;
        }

        .checkmark {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 40px;
            height: 40px;
            background: #4CAF50;
            border-radius: 50%;
            display: none;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5em;
            animation: checkPop 0.5s ease;
        }

        .task-card.completed .checkmark {
            display: flex;
        }

        .bonus-task-card.completed .checkmark {
            display: flex;
        }

        @keyframes checkPop {
            0% { transform: scale(0) rotate(0deg); }
            50% { transform: scale(1.2) rotate(180deg); }
            100% { transform: scale(1) rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(1.05); }
        }

        .task-card.started {
            border: 3px solid #FF9800;
            box-shadow: 0 0 20px rgba(255, 152, 0, 0.5);
        }

        .bonus-task-card.started {
            border: 3px solid #FF9800;
            box-shadow: 0 0 20px rgba(255, 152, 0, 0.5);
        }

        /* Testimony indicators */
        .testimony-badge {
            position: absolute;
            top: 10px;
            left: 60px;
            font-size: 1.2em;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .testimony-indicator {
            position: absolute;
            bottom: 10px;
            right: 10px;
            font-size: 1.5em;
            background: rgba(102, 126, 234, 0.2);
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            animation: pulse 2s ease-in-out infinite;
        }

        .testimony-indicator:hover {
            background: rgba(102, 126, 234, 0.4);
            transform: scale(1.1);
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Celebration animation */
        .celebration {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #f0f;
            animation: confettiFall 3s linear;
        }

        @keyframes confettiFall {
            to {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        .star {
            position: absolute;
            font-size: 2em;
            animation: starBurst 1s ease-out;
            pointer-events: none;
        }

        @keyframes starBurst {
            0% {
                transform: scale(0) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: scale(3) rotate(360deg);
                opacity: 0;
            }
        }

        .encouragement {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            text-align: center;
            animation: encouragePop 2s ease;
            pointer-events: none;
            z-index: 999;
            display: none;
        }

        @keyframes encouragePop {
            0%, 100% { opacity: 0; transform: translate(-50%, -50%) scale(0); }
            10%, 90% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }

        .reset-info {
            text-align: center;
            color: white;
            font-size: 0.9em;
            margin-top: 20px;
        }

        .testimony-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .testimony-modal.active {
            display: flex;
        }

        .testimony-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            max-width: 500px;
            width: 90%;
            text-align: center;
        }

        .testimony-content h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .testimony-content textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
            margin-bottom: 20px;
            direction: rtl;
            text-align: right;
        }

        .testimony-content textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .testimony-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .testimony-buttons button {
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .testimony-buttons button:hover {
            transform: scale(1.05);
        }

        .testimony-buttons .submit-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .testimony-buttons .cancel-btn {
            background: #e0e0e0;
            color: #333;
        }

        @media (max-width: 600px) {
            .tasks-grid {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 1.8em;
            }
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.5em;
            color: white;
        }
    </style>
</head>
<body class="doing-theme">
    <!-- Loading State -->
    <div id="loadingState" class="loading">×˜×•×¢×Ÿ...</div>

    <!-- Kid/Parent Page -->
    <div id="kidPage" class="container hidden">
        <div class="header">
            <div class="logo-container">
                <img id="appLogo" src="doing-logo-transparent2.png" alt="Doing - Being. Doing. Playing." class="app-logo">
            </div>
            <h1 id="kidTitle">ğŸŒŸ ×”××©×™××•×ª ğŸŒŸ</h1>
            <div class="progress-container">
                <div class="progress-bar" id="progressBar">0%</div>
            </div>

            <div class="piggy-bank-section">
                <div class="piggy-bank-icon">
                    <img id="kidImage" src="lenny-small.png" alt="Kid">
                </div>
                <div class="money-counter" id="moneyCounter">$0</div>
                <div class="money-label" id="moneyLabel">×§×•×¤×ª ×”×—×™×¡×›×•×Ÿ</div>
            </div>
        </div>

        <div class="tasks-section">
            <h2 id="regularTasksHeader" style="text-align: center; color: white; margin-bottom: 20px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); font-size: 1.8em;">××©×™××•×ª ×¨×’×™×œ×•×ª</h2>
            <div class="tasks-grid" id="tasksGrid"></div>
        </div>

        <div class="bonus-tasks-section" id="bonusTasksSection" style="display: none; margin-top: 40px;">
            <h2 id="bonusTasksHeader" style="text-align: center; color: #ffd700; margin-bottom: 20px; text-shadow: 2px 2px 4px rgba(0,0,0,0.1);">ğŸ’° ××©×™××•×ª ×‘×•× ×•×¡ ğŸ’°</h2>
            <div class="bonus-tasks-grid" id="bonusTasksGrid"></div>
        </div>

        <div class="calm-down-section" id="calmDownSection" style="display: none; margin-top: 40px;">
            <h2 id="calmDownHeader" style="text-align: center; color: #a8edea; margin-bottom: 20px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); font-size: 1.8em;">ğŸ§˜ ×¤×™× ×ª ×”×”×¨×’×¢×” ğŸ§˜</h2>
            <div class="calm-down-grid" id="calmDownGrid"></div>
        </div>

        <div class="reset-info">
            ×”×œ×•×— ××ª××¤×¡ ×›×œ ×™×•× ×‘×—×¦×•×ª ğŸŒ™
        </div>
    </div>

    <div class="celebration" id="celebration"></div>
    <div class="encouragement" id="encouragement"></div>

    <!-- Calm Down Activity Modal -->
    <div class="testimony-modal" id="calmDownModal">
        <div class="testimony-content" style="max-width: 90vw; max-height: 90vh; width: 100%; height: 80vh; padding: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h2 id="calmDownTitle" style="color: #667eea;">×¤×¢×™×œ×•×ª ×”×¨×’×¢×”</h2>
                <button class="submit-btn" onclick="taskBoard.closeCalmDownActivity()" style="padding: 8px 20px;">×¡×’×•×¨</button>
            </div>
            <iframe id="calmDownFrame" style="width: 100%; height: calc(100% - 100px); border: 2px solid #667eea; border-radius: 15px;"></iframe>
            <div id="calmDownFallback" style="display: none; text-align: center; padding: 10px; margin-top: 10px;">
                <a id="calmDownFallbackLink" href="#" target="_blank" style="color: #667eea; text-decoration: none; font-size: 1.1em; display: inline-flex; align-items: center; gap: 8px;">
                    ×× ×”×¡×¨×˜×•×Ÿ ×œ× × ×¤×ª×—, ×œ×—×¥ ×›××Ÿ ×œ×¤×ª×™×—×” ×‘×™×•×˜×™×•×‘ ğŸš€
                </a>
            </div>
        </div>
    </div>

    <!-- Testimony Modal -->
    <div class="testimony-modal" id="testimonyModal">
        <div class="testimony-content">
            <h2 id="testimonyTitle">×¡×¤×¨ ×œ× ×• ××” ×§×¨×”</h2>
            <textarea id="testimonyInput" placeholder="××™×š ×”×©×œ××ª ××ª ×”××©×™××”?"></textarea>
            <div class="testimony-buttons">
                <button class="submit-btn" onclick="taskBoard.submitTestimony()">×©×œ×—</button>
                <button class="cancel-btn" onclick="taskBoard.cancelTestimony()">×‘×™×˜×•×œ</button>
            </div>
        </div>
    </div>

    <!-- Testimony Reader Modal -->
    <div class="testimony-modal" id="testimonyReaderModal">
        <div class="testimony-content">
            <h2 id="testimonyReaderTitle">×”×¢×“×•×ª ×©×œ×š</h2>
            <div id="testimonyReaderText" style="padding: 20px; background: #f5f5f5; border-radius: 10px; font-size: 1.1em; line-height: 1.6; min-height: 80px; text-align: right; white-space: pre-wrap;"></div>
            <div class="testimony-buttons" style="margin-top: 20px;">
                <button class="submit-btn" onclick="taskBoard.closeTestimonyReader()">×¡×’×•×¨</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDHE7FKHJ92rXXfz_3hLX8e9s8lC9g9g9o",
            authDomain: "aba-ai-d74f5.firebaseapp.com",
            projectId: "aba-ai-d74f5",
            storageBucket: "aba-ai-d74f5.firebasestorage.app",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef123456"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const encouragementMessages = [
            '×›×œ ×”×›×‘×•×“! ğŸ‰',
            '××œ×•×£ ××œ×•×¤×™×! ğŸ†',
            '××¦×•×™×Ÿ ×××•×“! ğŸ’ª',
            '×¢×‘×•×“×” ××¢×•×œ×”! â­',
            '×’××” ×‘×š! ğŸŠ',
            '×”××©×š ×›×š! ğŸš€',
            '×¤×©×•×˜ ××“×”×™×! ğŸŒˆ'
        ];

        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const kidId = urlParams.get('kid');
        const isParent = urlParams.get('mode') === 'parent';

        // Route to kid/parent page
        if (kidId) {
            showKidPage(kidId, isParent);
        } else {
            // Default to ×œ× ×™
            window.location.search = '?kid=leni';
        }

        // Kid/Parent Page Logic
        class TaskBoard {
            constructor(kidId, kidData, isParentMode) {
                this.kidId = kidId;
                this.kidData = kidData;
                this.isParentMode = isParentMode;
                this.tasks = kidData.tasks || [];

                // Get current day of week (0 = Sunday, 6 = Saturday)
                this.currentDay = new Date().getDay();

                // Filter tasks by active days, then separate regular and bonus tasks
                const activeTasks = this.tasks.filter(task => {
                    // Default to all days active if activeDays not set (backward compatibility)
                    const activeDays = task.activeDays || [0, 1, 2, 3, 4, 5, 6];
                    return activeDays.includes(this.currentDay);
                });

                this.regularTasks = activeTasks.filter(t => !t.type || t.type === 'regular');
                this.bonusTasks = activeTasks.filter(t => t.type === 'bonus');
                this.calmDownTasks = activeTasks.filter(t => t.type === 'calm-down');

                this.completedTasks = new Set();
                this.completedBonusTasks = new Set();
                this.bonusRewardsEarned = {}; // Track reward amounts for each bonus task
                this.todayRewardGiven = false;
                this.isCelebrating = false; // Prevent multiple simultaneous celebrations

                // Testimony tracking
                this.testimonies = {}; // Track testimonies for each task
                this.pendingTestimonyTaskId = null;
                this.pendingTestimonyIsBonus = false;

                // Time tracking
                this.startedTasks = new Set(); // Track which tasks have been started
                this.taskStartTimes = {}; // Track start timestamp for each task
                this.taskDurations = {}; // Track completed durations in seconds

                // Coin style configuration (default to dollar)
                this.coinStyle = kidData.coinStyle || 'dollar';
                this.coinImageName = kidData.coinImageName || '';

                this.init();
            }

            getCoinSymbol() {
                switch (this.coinStyle) {
                    case 'shekel':
                        return 'â‚ª';
                    case 'custom':
                        return ''; // Will use image instead
                    case 'dollar':
                    default:
                        return '$';
                }
            }

            getCoinImageSrc() {
                // Don't add timestamp to data URLs (breaks them), only to file paths
                if (this.coinImageName.startsWith('data:')) {
                    return this.coinImageName;
                } else {
                    const timestamp = new Date().getTime();
                    return `${this.coinImageName}?t=${timestamp}`;
                }
            }

            formatMoney(amount) {
                const symbol = this.getCoinSymbol();
                if (this.coinStyle === 'custom') {
                    const coinSrc = this.getCoinImageSrc();
                    return `<img src="${coinSrc}" style="width: 20px; height: 20px; vertical-align: middle; margin: 0 3px;" /> ${amount.toFixed(2)}`;
                }
                return `${symbol}${amount.toFixed(2)}`;
            }

            formatMoneySimple(amount) {
                const symbol = this.getCoinSymbol();
                if (this.coinStyle === 'custom') {
                    return amount.toFixed(2);
                }
                return `${symbol}${amount.toFixed(2)}`;
            }

            formatDuration(seconds) {
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const secs = seconds % 60;

                if (hours > 0) {
                    return `${hours}:${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
                } else if (minutes > 0) {
                    return `${minutes}:${String(secs).padStart(2, '0')}`;
                } else {
                    return `${secs}s`;
                }
            }

            getElapsedTime(taskId) {
                if (!this.taskStartTimes[taskId]) return 0;
                return Math.floor((Date.now() - this.taskStartTimes[taskId]) / 1000);
            }

            async init() {
                await this.checkDailyReset();
                await this.loadState();
                this.render();
                this.updateProgress();
                this.updateMoneyDisplay();
            }

            async checkDailyReset() {
                const today = new Date().toDateString();

                if (this.kidData.lastResetDate !== today) {
                    // New day - reset tasks
                    await db.collection('kids').doc(this.kidId).update({
                        completedTasks: [],
                        completedBonusTasks: [],
                        bonusRewardsEarned: {},
                        todayRewardGiven: false,
                        testimonies: {},
                        startedTasks: [],
                        taskStartTimes: {},
                        taskDurations: {},
                        lastResetDate: today
                    });
                    this.completedTasks.clear();
                    this.completedBonusTasks.clear();
                    this.bonusRewardsEarned = {};
                    this.todayRewardGiven = false;
                    this.testimonies = {};
                    this.startedTasks.clear();
                    this.taskStartTimes = {};
                    this.taskDurations = {};
                }
            }

            async loadState() {
                const doc = await db.collection('kids').doc(this.kidId).get();
                const data = doc.data();
                this.completedTasks = new Set(data.completedTasks || []);
                this.completedBonusTasks = new Set(data.completedBonusTasks || []);
                this.bonusRewardsEarned = data.bonusRewardsEarned || {};
                this.todayRewardGiven = data.todayRewardGiven || false;
                this.testimonies = data.testimonies || {};
                this.startedTasks = new Set(data.startedTasks || []);
                this.taskStartTimes = data.taskStartTimes || {};
                this.taskDurations = data.taskDurations || {};
                this.kidData.totalMoney = data.totalMoney || 0;
            }

            async saveState() {
                await db.collection('kids').doc(this.kidId).update({
                    completedTasks: Array.from(this.completedTasks),
                    completedBonusTasks: Array.from(this.completedBonusTasks),
                    bonusRewardsEarned: this.bonusRewardsEarned,
                    todayRewardGiven: this.todayRewardGiven,
                    testimonies: this.testimonies,
                    startedTasks: Array.from(this.startedTasks),
                    taskStartTimes: this.taskStartTimes,
                    taskDurations: this.taskDurations
                });
            }

            async addMoney(amount) {
                this.kidData.totalMoney += amount;
                await db.collection('kids').doc(this.kidId).update({
                    totalMoney: this.kidData.totalMoney
                });
                this.updateMoneyDisplay();
            }

            updateMoneyDisplay() {
                const counter = document.getElementById('moneyCounter');
                if (this.coinStyle === 'custom' && this.coinImageName) {
                    const coinSrc = this.getCoinImageSrc();
                    counter.innerHTML = `<img src="${coinSrc}" style="width: 50px; height: 50px; vertical-align: middle; margin: 0 5px;" /> ${this.kidData.totalMoney.toFixed(2)}`;
                } else {
                    counter.textContent = this.formatMoneySimple(this.kidData.totalMoney);
                }
            }

            async toggleTask(taskId) {
                if (this.isParentMode) {
                    // Parents can't toggle tasks
                    return;
                }

                const task = this.regularTasks.find(t => t.id === taskId);
                if (!task) return;

                if (this.completedTasks.has(taskId)) {
                    // Unchecking - remove task, testimony, and time tracking data
                    this.completedTasks.delete(taskId);
                    delete this.testimonies[taskId];
                    this.startedTasks.delete(taskId);
                    delete this.taskStartTimes[taskId];
                    delete this.taskDurations[taskId];
                    await this.saveState();
                    this.render();
                    this.updateProgress();
                } else if (task.trackTime && !this.startedTasks.has(taskId)) {
                    // Time tracking task - first click starts the timer
                    this.startedTasks.add(taskId);
                    this.taskStartTimes[taskId] = Date.now();
                    await this.saveState();
                    this.render();
                } else if (task.trackTime && this.startedTasks.has(taskId)) {
                    // Time tracking task - second click completes it
                    const duration = Math.floor((Date.now() - this.taskStartTimes[taskId]) / 1000);
                    this.taskDurations[taskId] = duration;

                    // Check if testimony required
                    if (task.requiresTestimony) {
                        this.showTestimonyModal(taskId, false);
                    } else {
                        this.completedTasks.add(taskId);
                        this.celebrate();
                        await this.saveState();
                        this.render();
                        this.updateProgress();
                    }
                } else {
                    // Regular task without time tracking - check if testimony required
                    if (task.requiresTestimony) {
                        this.showTestimonyModal(taskId, false);
                    } else {
                        this.completedTasks.add(taskId);
                        this.celebrate();
                        await this.saveState();
                        this.render();
                        this.updateProgress();
                    }
                }
            }

            async toggleBonusTask(taskId) {
                if (this.isParentMode) {
                    // Parents can't toggle tasks
                    return;
                }

                const task = this.bonusTasks.find(t => t.id === taskId);
                if (!task) return;

                if (this.completedBonusTasks.has(taskId)) {
                    // Unchecking - remove the reward, testimony, and time tracking data
                    const rewardAmount = this.bonusRewardsEarned[taskId] || 0;
                    this.completedBonusTasks.delete(taskId);
                    delete this.bonusRewardsEarned[taskId];
                    delete this.testimonies[taskId];
                    this.startedTasks.delete(taskId);
                    delete this.taskStartTimes[taskId];
                    delete this.taskDurations[taskId];

                    if (rewardAmount > 0) {
                        await this.addMoney(-rewardAmount);
                    }
                    await this.saveState();
                    this.render();
                } else if (task.trackTime && !this.startedTasks.has(taskId)) {
                    // Time tracking task - first click starts the timer
                    this.startedTasks.add(taskId);
                    this.taskStartTimes[taskId] = Date.now();
                    await this.saveState();
                    this.render();
                } else if (task.trackTime && this.startedTasks.has(taskId)) {
                    // Time tracking task - second click completes it
                    const duration = Math.floor((Date.now() - this.taskStartTimes[taskId]) / 1000);
                    this.taskDurations[taskId] = duration;

                    // Check if testimony required
                    if (task.requiresTestimony) {
                        this.showTestimonyModal(taskId, true);
                    } else {
                        // Give instant reward without testimony
                        this.completedBonusTasks.add(taskId);

                        // Calculate random reward between min and max (1 decimal place)
                        const minReward = task.minReward || 0;
                        const maxReward = task.maxReward || 0;
                        const rewardAmount = minReward === maxReward
                            ? minReward
                            : parseFloat((Math.random() * (maxReward - minReward) + minReward).toFixed(1));

                        this.bonusRewardsEarned[taskId] = rewardAmount;

                        // Save state and update UI first
                        await this.saveState();
                        this.render();

                        // Then show celebration (after DOM is stable)
                        this.celebrateBonus(rewardAmount);
                        this.animateMoneyIncrease(rewardAmount);
                    }
                } else {
                    // Regular bonus task without time tracking - check if testimony required
                    if (task.requiresTestimony) {
                        this.showTestimonyModal(taskId, true);
                    } else {
                        // Give instant reward without testimony
                        this.completedBonusTasks.add(taskId);

                        // Calculate random reward between min and max (1 decimal place)
                        const minReward = task.minReward || 0;
                        const maxReward = task.maxReward || 0;
                        const rewardAmount = minReward === maxReward
                            ? minReward
                            : parseFloat((Math.random() * (maxReward - minReward) + minReward).toFixed(1));

                        this.bonusRewardsEarned[taskId] = rewardAmount;

                        // Save state and update UI first
                        await this.saveState();
                        this.render();

                        // Then show celebration (after DOM is stable)
                        this.celebrateBonus(rewardAmount);
                        this.animateMoneyIncrease(rewardAmount);
                    }
                }
            }

            render() {
                // Render regular tasks
                const grid = document.getElementById('tasksGrid');
                grid.innerHTML = '';

                this.regularTasks.forEach(task => {
                    const card = document.createElement('div');
                    card.className = 'task-card';
                    if (this.completedTasks.has(task.id)) {
                        card.classList.add('completed');
                    }

                    // Determine icon display (emoji or image)
                    let iconDisplay;
                    if (task.icon.startsWith('IMG:')) {
                        const imageName = task.icon.substring(4);
                        const timestamp = new Date().getTime();
                        iconDisplay = `<img src="emojis/${imageName}?t=${timestamp}" style="width: 60px; height: 60px; object-fit: contain;" />`;
                    } else {
                        iconDisplay = task.icon;
                    }

                    // Add testimony indicator if task requires it
                    const testimonyBadge = task.requiresTestimony ? '<div class="testimony-badge">ğŸ“</div>' : '';
                    const hasTestimony = this.testimonies[task.id];
                    const testimonyIndicator = hasTestimony ? '<div class="testimony-indicator" title="×œ×—×¥ ×œ×§×¨×™××ª ×”×¢×“×•×ª">ğŸ’¬</div>' : '';

                    // Add time tracking indicators
                    let timeTrackingDisplay = '';
                    if (task.trackTime) {
                        const isStarted = this.startedTasks.has(task.id);
                        const isCompleted = this.completedTasks.has(task.id);

                        if (isCompleted && this.taskDurations[task.id] !== undefined) {
                            // Show completed duration
                            const duration = this.formatDuration(this.taskDurations[task.id]);
                            timeTrackingDisplay = `<div class="time-badge" style="position: absolute; bottom: 10px; right: 10px; background: #4CAF50; color: white; padding: 5px 8px; border-radius: 8px; font-size: 12px; font-weight: bold;">â±ï¸ ${duration}</div>`;
                        } else if (isStarted) {
                            // Show elapsed time with "in progress" text
                            const elapsed = this.getElapsedTime(task.id);
                            const elapsedDisplay = this.formatDuration(elapsed);
                            timeTrackingDisplay = `<div class="time-badge started" style="position: absolute; bottom: 10px; right: 10px; background: #FF9800; color: white; padding: 5px 8px; border-radius: 8px; font-size: 12px; font-weight: bold; animation: pulse 1.5s ease-in-out infinite;">â±ï¸ ${elapsedDisplay} - ×‘×ª×”×œ×™×š</div>`;
                            card.classList.add('started');
                        } else {
                            // Show timer icon to indicate it's a time-tracked task
                            timeTrackingDisplay = `<div class="time-badge" style="position: absolute; top: 10px; right: 10px; background: #9E9E9E; color: white; padding: 5px 8px; border-radius: 8px; font-size: 12px;">â±ï¸</div>`;
                        }
                    }

                    card.innerHTML = `
                        <div class="checkmark">âœ“</div>
                        <div class="task-icon">${iconDisplay}</div>
                        <div class="task-title">${task.title}</div>
                        ${testimonyBadge}
                        ${testimonyIndicator}
                        ${timeTrackingDisplay}
                    `;

                    // Handle click events
                    if (hasTestimony && this.completedTasks.has(task.id)) {
                        // Task has testimony - allow reading in both kid and parent mode
                        card.addEventListener('click', (e) => {
                            // Check if clicked on testimony indicator
                            if (e.target.classList.contains('testimony-indicator') || e.target.closest('.testimony-indicator')) {
                                this.showTestimonyReader(task.id);
                            } else if (!this.isParentMode) {
                                // Only allow toggling in kid mode
                                this.toggleTask(task.id);
                            }
                        });
                        if (this.isParentMode) {
                            card.style.cursor = 'default';
                            card.style.opacity = '0.8';
                        } else {
                            card.style.cursor = 'pointer';
                        }
                    } else if (!this.isParentMode) {
                        // No testimony - only kid mode can interact
                        card.style.cursor = 'pointer';
                        card.addEventListener('click', () => this.toggleTask(task.id));
                    } else {
                        // Parent mode with no testimony
                        card.style.cursor = 'default';
                        card.style.opacity = '0.8';
                    }

                    grid.appendChild(card);
                });

                // Render bonus tasks
                const bonusGrid = document.getElementById('bonusTasksGrid');
                const bonusSection = document.getElementById('bonusTasksSection');
                bonusGrid.innerHTML = '';

                if (this.bonusTasks.length > 0) {
                    bonusSection.style.display = 'block';

                    this.bonusTasks.forEach(task => {
                        const card = document.createElement('div');
                        card.className = 'bonus-task-card';
                        if (this.completedBonusTasks.has(task.id)) {
                            card.classList.add('completed');
                        }

                        const symbol = this.getCoinSymbol();
                        const rewardText = task.minReward === task.maxReward
                            ? `${symbol}${task.minReward.toFixed(1)}`
                            : `${symbol}${task.minReward.toFixed(1)}-${symbol}${task.maxReward.toFixed(1)}`;

                        const earnedText = this.bonusRewardsEarned[task.id]
                            ? ` (+${symbol}${this.bonusRewardsEarned[task.id].toFixed(1)})`
                            : '';

                        // Determine icon display (emoji or image)
                        let iconDisplay;
                        if (task.icon.startsWith('IMG:')) {
                            const imageName = task.icon.substring(4);
                            const timestamp = new Date().getTime();
                            iconDisplay = `<img src="emojis/${imageName}?t=${timestamp}" style="width: 60px; height: 60px; object-fit: contain;" />`;
                        } else {
                            iconDisplay = task.icon;
                        }

                        // Add testimony indicator if task requires it
                        const testimonyBadge = task.requiresTestimony ? '<div class="testimony-badge">ğŸ“</div>' : '';
                        const hasTestimony = this.testimonies[task.id];
                        const testimonyIndicator = hasTestimony ? '<div class="testimony-indicator" title="×œ×—×¥ ×œ×§×¨×™××ª ×”×¢×“×•×ª">ğŸ’¬</div>' : '';

                        // Add time tracking indicators
                        let timeTrackingDisplay = '';
                        if (task.trackTime) {
                            const isStarted = this.startedTasks.has(task.id);
                            const isCompleted = this.completedBonusTasks.has(task.id);

                            if (isCompleted && this.taskDurations[task.id] !== undefined) {
                                // Show completed duration
                                const duration = this.formatDuration(this.taskDurations[task.id]);
                                timeTrackingDisplay = `<div class="time-badge" style="position: absolute; bottom: 10px; left: 10px; background: #4CAF50; color: white; padding: 5px 8px; border-radius: 8px; font-size: 12px; font-weight: bold;">â±ï¸ ${duration}</div>`;
                            } else if (isStarted) {
                                // Show elapsed time with "in progress" text
                                const elapsed = this.getElapsedTime(task.id);
                                const elapsedDisplay = this.formatDuration(elapsed);
                                timeTrackingDisplay = `<div class="time-badge started" style="position: absolute; bottom: 10px; left: 10px; background: #FF9800; color: white; padding: 5px 8px; border-radius: 8px; font-size: 12px; font-weight: bold; animation: pulse 1.5s ease-in-out infinite;">â±ï¸ ${elapsedDisplay} - ×‘×ª×”×œ×™×š</div>`;
                                card.classList.add('started');
                            } else {
                                // Show timer icon to indicate it's a time-tracked task
                                timeTrackingDisplay = `<div class="time-badge" style="position: absolute; top: 50px; right: 10px; background: #9E9E9E; color: white; padding: 5px 8px; border-radius: 8px; font-size: 12px;">â±ï¸</div>`;
                            }
                        }

                        card.innerHTML = `
                            <div class="bonus-reward-badge">${rewardText}${earnedText}</div>
                            <div class="checkmark">âœ“</div>
                            <div class="task-icon">${iconDisplay}</div>
                            <div class="task-title">${task.title}</div>
                            ${testimonyBadge}
                            ${testimonyIndicator}
                            ${timeTrackingDisplay}
                        `;

                        // Handle click events
                        if (hasTestimony && this.completedBonusTasks.has(task.id)) {
                            // Task has testimony - allow reading in both kid and parent mode
                            card.addEventListener('click', (e) => {
                                // Check if clicked on testimony indicator
                                if (e.target.classList.contains('testimony-indicator') || e.target.closest('.testimony-indicator')) {
                                    this.showTestimonyReader(task.id);
                                } else if (!this.isParentMode) {
                                    // Only allow toggling in kid mode
                                    this.toggleBonusTask(task.id);
                                }
                            });
                            if (this.isParentMode) {
                                card.style.cursor = 'default';
                                card.style.opacity = '0.8';
                            } else {
                                card.style.cursor = 'pointer';
                            }
                        } else if (!this.isParentMode) {
                            // No testimony - only kid mode can interact
                            card.style.cursor = 'pointer';
                            card.addEventListener('click', () => this.toggleBonusTask(task.id));
                        } else {
                            // Parent mode with no testimony
                            card.style.cursor = 'default';
                            card.style.opacity = '0.8';
                        }

                        bonusGrid.appendChild(card);
                    });
                } else {
                    bonusSection.style.display = 'none';
                }

                // Render calm-down tasks
                const calmDownGrid = document.getElementById('calmDownGrid');
                const calmDownSection = document.getElementById('calmDownSection');
                calmDownGrid.innerHTML = '';

                if (this.calmDownTasks.length > 0) {
                    calmDownSection.style.display = 'block';

                    this.calmDownTasks.forEach(task => {
                        const card = document.createElement('div');
                        card.className = 'calm-down-card';

                        // Determine icon display (emoji or image)
                        let iconDisplay;
                        if (task.icon.startsWith('IMG:')) {
                            const imageName = task.icon.substring(4);
                            const timestamp = new Date().getTime();
                            iconDisplay = `<img src="emojis/${imageName}?t=${timestamp}" style="width: 60px; height: 60px; object-fit: contain;" />`;
                        } else {
                            iconDisplay = task.icon;
                        }

                        card.innerHTML = `
                            <div class="task-icon">${iconDisplay}</div>
                            <div class="task-title">${task.title}</div>
                        `;

                        card.style.cursor = 'pointer';
                        card.addEventListener('click', () => this.openCalmDownActivity(task));

                        calmDownGrid.appendChild(card);
                    });
                } else {
                    calmDownSection.style.display = 'none';
                }
            }

            updateProgress() {
                // Only count regular tasks for the main progress bar
                const totalRegularTasks = this.regularTasks.length;
                const progress = totalRegularTasks > 0
                    ? (this.completedTasks.size / totalRegularTasks) * 100
                    : 0;
                const progressBar = document.getElementById('progressBar');
                progressBar.style.width = progress + '%';
                progressBar.textContent = Math.round(progress) + '%';

                if (progress === 100 && totalRegularTasks > 0 && !this.isParentMode) {
                    this.showMegaCelebration();
                }
            }

            celebrate() {
                const msg = encouragementMessages[Math.floor(Math.random() * encouragementMessages.length)];
                const encouragement = document.getElementById('encouragement');
                encouragement.textContent = msg;
                encouragement.style.display = 'block';
                setTimeout(() => {
                    encouragement.style.display = 'none';
                }, 2000);

                this.createConfetti(15);
                this.createStars();
            }

            celebrateBonus(amount) {
                if (this.isCelebrating) return; // Prevent overlapping celebrations

                this.isCelebrating = true;
                const encouragement = document.getElementById('encouragement');

                // Remove animation temporarily
                encouragement.style.animation = 'none';
                encouragement.style.display = 'none';

                // Update content
                const symbol = this.getCoinSymbol();
                const coinSrc = this.getCoinImageSrc();
                const moneyDisplay = this.coinStyle === 'custom'
                    ? `<img src="${coinSrc}" style="width: 40px; height: 40px; vertical-align: middle;" /> +${amount.toFixed(1)}`
                    : `+${symbol}${amount.toFixed(1)}`;

                encouragement.innerHTML = `
                    <div style="font-size: 1.5em;">!ğŸ‰ ×‘×•× ×•×¡ ğŸ‰</div>
                    <div style="font-size: 2em; margin-top: 10px; color: #ffd700;">
                        !ğŸ’° ${moneyDisplay} ğŸ’°
                    </div>
                `;

                // Show without animation first
                encouragement.style.display = 'block';
                encouragement.style.opacity = '1';
                encouragement.style.transform = 'translate(-50%, -50%) scale(1)';

                // MASSIVE COIN SPLASH EXPLOSION! ğŸ’¥
                this.createMassiveCoinSplash();
                this.createConfetti(50); // More confetti too!

                setTimeout(() => {
                    encouragement.style.display = 'none';
                    encouragement.style.animation = ''; // Restore animation for other uses
                    this.isCelebrating = false;
                }, 3000);
            }

            createConfetti(count) {
                const celebration = document.getElementById('celebration');
                const colors = ['#667eea', '#764ba2', '#f093fb', '#4facfe', '#43e97b', '#fa709a'];

                for (let i = 0; i < count; i++) {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDelay = Math.random() * 0.5 + 's';
                    celebration.appendChild(confetti);
                    setTimeout(() => confetti.remove(), 3000);
                }
            }

            createStars() {
                const celebration = document.getElementById('celebration');
                const starEmojis = ['â­', 'ğŸŒŸ', 'âœ¨', 'ğŸ’«'];

                for (let i = 0; i < 5; i++) {
                    const star = document.createElement('div');
                    star.className = 'star';
                    star.textContent = starEmojis[Math.floor(Math.random() * starEmojis.length)];
                    star.style.left = Math.random() * 100 + '%';
                    star.style.top = Math.random() * 100 + '%';
                    celebration.appendChild(star);
                    setTimeout(() => star.remove(), 1000);
                }
            }

            async showMegaCelebration() {
                if (this.todayRewardGiven) {
                    const encouragement = document.getElementById('encouragement');
                    encouragement.textContent = '×¡×™×™××ª ××ª ×›×œ ×”××©×™××•×ª! ××ª×” ××œ×•×£! ğŸ‰ğŸ†';
                    encouragement.style.display = 'block';
                    this.createConfetti(50);
                    this.createStars();
                    setTimeout(() => {
                        encouragement.style.display = 'none';
                    }, 3000);
                    return;
                }

                this.todayRewardGiven = true;
                await this.saveState();

                const dailyReward = this.kidData.dailyReward || 0.5;
                const symbol = this.getCoinSymbol();
                const coinSrc = this.getCoinImageSrc();
                const rewardDisplay = this.coinStyle === 'custom'
                    ? `<img src="${coinSrc}" style="width: 35px; height: 35px; vertical-align: middle;" /> ${dailyReward.toFixed(2)}`
                    : `${symbol}${dailyReward.toFixed(2)}`;

                const encouragement = document.getElementById('encouragement');
                encouragement.innerHTML = `
                    <div>!ğŸ‰ ×¡×™×™××ª ××ª ×›×œ ×”××©×™××•×ª! ××ª×” ××œ×•×£ ğŸ†</div>
                    <div style="font-size: 1.5em; margin-top: 20px; color: #ffd700;">
                        !ğŸ’° ×§×™×‘×œ×ª ${rewardDisplay} ×œ×§×•×¤×ª ×”×—×™×¡×›×•×Ÿ ğŸ’°
                    </div>
                `;
                encouragement.style.display = 'block';

                this.createConfetti(100);
                this.createStars();
                this.createFallingCoins();

                setTimeout(() => {
                    this.animateMoneyIncrease(dailyReward);
                }, 1000);

                setTimeout(() => {
                    encouragement.style.display = 'none';
                }, 4000);
            }

            createFallingCoins() {
                const celebration = document.getElementById('celebration');
                const coinEmojis = ['ğŸª™', 'ğŸ’°', 'ğŸ’µ', 'ğŸ’´', 'ğŸ’¶', 'ğŸ’·'];

                for (let i = 0; i < 30; i++) {
                    const coin = document.createElement('div');
                    coin.className = 'coins-animation';
                    coin.textContent = coinEmojis[Math.floor(Math.random() * coinEmojis.length)];
                    coin.style.left = Math.random() * 100 + '%';
                    coin.style.animationDelay = Math.random() * 1 + 's';
                    celebration.appendChild(coin);
                    setTimeout(() => coin.remove(), 3000);
                }
            }

            createMassiveCoinSplash() {
                const celebration = document.getElementById('celebration');
                const coinEmojis = ['ğŸª™', 'ğŸ’°', 'ğŸ’µ', 'ğŸ’´', 'ğŸ’¶', 'ğŸ’·', 'ğŸ¤‘', 'ğŸ’¸', 'ğŸ’²'];

                // Create 100+ coins exploding from center!
                for (let i = 0; i < 120; i++) {
                    const coin = document.createElement('div');
                    coin.style.position = 'fixed';
                    coin.style.fontSize = (20 + Math.random() * 40) + 'px';
                    coin.style.zIndex = '1001';
                    coin.style.pointerEvents = 'none';

                    // Start from center
                    coin.style.left = '50%';
                    coin.style.top = '50%';

                    if (this.coinStyle === 'custom' && this.coinImageName && this.coinImageName.trim() !== '') {
                        // Use custom coin image
                        const coinSrc = this.getCoinImageSrc();
                        coin.innerHTML = `<img src="${coinSrc}" style="width: ${30 + Math.random() * 30}px; height: ${30 + Math.random() * 30}px;" />`;
                    } else {
                        // Use default golden coin circle with $ symbol
                        const size = 30 + Math.random() * 30;
                        coin.innerHTML = `<div style="width: ${size}px; height: ${size}px; background: radial-gradient(circle, #ffd700, #ffed4e, #ffd700); border: 2px solid #b8860b; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: ${size * 0.6}px; color: #b8860b; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">$</div>`;
                        coin.style.fontSize = '';
                    }

                    celebration.appendChild(coin);

                    // Random explosion direction
                    const angle = Math.random() * Math.PI * 2;
                    const velocity = 200 + Math.random() * 400;
                    const vx = Math.cos(angle) * velocity;
                    const vy = Math.sin(angle) * velocity;
                    const spin = (Math.random() - 0.5) * 1080; // Random spin

                    // Animate with physics
                    const startTime = Date.now();
                    const duration = 2000 + Math.random() * 1000;

                    const animate = () => {
                        const elapsed = Date.now() - startTime;
                        const progress = elapsed / duration;

                        if (progress < 1) {
                            const t = elapsed / 1000;
                            const gravity = 500;

                            const x = vx * t;
                            const y = vy * t + 0.5 * gravity * t * t;
                            const rotation = spin * progress;

                            coin.style.transform = `translate(${x}px, ${y}px) rotate(${rotation}deg)`;
                            coin.style.opacity = 1 - (progress * 0.5);

                            requestAnimationFrame(animate);
                        } else {
                            coin.remove();
                        }
                    };

                    requestAnimationFrame(animate);
                }
            }

            animateMoneyIncrease(amount) {
                const counter = document.getElementById('moneyCounter');
                const startMoney = this.kidData.totalMoney;
                const duration = 1500;
                const startTime = Date.now();

                const animate = () => {
                    const elapsed = Date.now() - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    const easeProgress = 1 - Math.pow(1 - progress, 3);
                    const currentMoney = startMoney + (amount * easeProgress);

                    if (this.coinStyle === 'custom') {
                        const coinSrc = this.getCoinImageSrc();
                        counter.innerHTML = `<img src="${coinSrc}" style="width: 30px; height: 30px; vertical-align: middle; margin: 0 5px;" /> ${currentMoney.toFixed(2)}`;
                    } else {
                        const symbol = this.getCoinSymbol();
                        counter.textContent = `${symbol}${currentMoney.toFixed(2)}`;
                    }
                    counter.style.transform = `scale(${1 + Math.sin(progress * Math.PI) * 0.3})`;

                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    } else {
                        this.addMoney(amount);
                        counter.style.transform = 'scale(1)';
                    }
                };

                animate();
            }

            showTestimonyModal(taskId, isBonus) {
                this.pendingTestimonyTaskId = taskId;
                this.pendingTestimonyIsBonus = isBonus;

                const modal = document.getElementById('testimonyModal');
                const input = document.getElementById('testimonyInput');

                // Clear previous input
                input.value = '';

                // Get task title for the modal
                const task = isBonus
                    ? this.bonusTasks.find(t => t.id === taskId)
                    : this.regularTasks.find(t => t.id === taskId);

                if (task) {
                    document.getElementById('testimonyTitle').textContent = `×¡×¤×¨ ×œ× ×• ××™×š ×”×©×œ××ª: ${task.title}`;
                }

                modal.classList.add('active');
                input.focus();
            }

            cancelTestimony() {
                const modal = document.getElementById('testimonyModal');
                modal.classList.remove('active');
                this.pendingTestimonyTaskId = null;
                this.pendingTestimonyIsBonus = false;
            }

            async submitTestimony() {
                const testimony = document.getElementById('testimonyInput').value.trim();

                if (!testimony) {
                    alert('× × ×œ×”×–×™×Ÿ ×ª×™××•×¨ ×©×œ ××™×š ×”×©×œ××ª ××ª ×”××©×™××”');
                    return;
                }

                const taskId = this.pendingTestimonyTaskId;
                const isBonus = this.pendingTestimonyIsBonus;

                // Close modal
                this.cancelTestimony();

                // Store testimony
                this.testimonies[taskId] = testimony;

                if (isBonus) {
                    // Complete bonus task with testimony
                    const task = this.bonusTasks.find(t => t.id === taskId);
                    this.completedBonusTasks.add(taskId);

                    // Calculate random reward between min and max (1 decimal place)
                    const minReward = task.minReward || 0;
                    const maxReward = task.maxReward || 0;
                    const rewardAmount = minReward === maxReward
                        ? minReward
                        : parseFloat((Math.random() * (maxReward - minReward) + minReward).toFixed(1));

                    this.bonusRewardsEarned[taskId] = rewardAmount;

                    // Save state and update UI first
                    await this.saveState();
                    this.render();

                    // Then show celebration (after DOM is stable)
                    this.celebrateBonus(rewardAmount);
                    this.animateMoneyIncrease(rewardAmount);
                } else {
                    // Complete regular task with testimony
                    this.completedTasks.add(taskId);
                    this.celebrate();
                    await this.saveState();
                    this.render();
                    this.updateProgress();
                }
            }

            showTestimonyReader(taskId) {
                const testimony = this.testimonies[taskId];
                if (!testimony) return;

                // Find the task to get its title
                const task = this.regularTasks.find(t => t.id === taskId) || this.bonusTasks.find(t => t.id === taskId);

                const modal = document.getElementById('testimonyReaderModal');
                const titleEl = document.getElementById('testimonyReaderTitle');
                const textEl = document.getElementById('testimonyReaderText');

                if (task) {
                    titleEl.textContent = `×”×¢×“×•×ª ×©×œ×š - ${task.title}`;
                }

                textEl.textContent = testimony;
                modal.classList.add('active');
            }

            closeTestimonyReader() {
                const modal = document.getElementById('testimonyReaderModal');
                modal.classList.remove('active');
            }

            openCalmDownActivity(task) {
                const modal = document.getElementById('calmDownModal');
                const frame = document.getElementById('calmDownFrame');
                const title = document.getElementById('calmDownTitle');
                const fallbackDiv = document.getElementById('calmDownFallback');
                const fallbackLink = document.getElementById('calmDownFallbackLink');

                title.textContent = task.title;

                let url = '';
                let isYouTube = false;
                let originalUrl = '';

                if (task.activityType === 'paint') {
                    url = 'paint.html';
                } else if (task.activityType === 'bubbles') {
                    url = 'bubbles.html';
                } else if (task.activityType === 'xylophone') {
                    url = 'xylophone.html';
                } else if (task.activityType === 'breathing') {
                    url = 'breathing.html';
                } else if (task.activityType === 'link' && task.activityUrl) {
                    originalUrl = task.activityUrl;
                    // Convert YouTube watch URLs to embed URLs
                    if (task.activityUrl.includes('youtube.com/watch')) {
                        const urlObj = new URL(task.activityUrl);
                        const videoId = urlObj.searchParams.get('v');
                        url = `https://www.youtube.com/embed/${videoId}?autoplay=0&rel=0&modestbranding=1`;
                        isYouTube = true;
                    } else if (task.activityUrl.includes('youtu.be/')) {
                        const videoId = task.activityUrl.split('youtu.be/')[1].split('?')[0];
                        url = `https://www.youtube.com/embed/${videoId}?autoplay=0&rel=0&modestbranding=1`;
                        isYouTube = true;
                    } else {
                        url = task.activityUrl;
                    }
                }

                if (url) {
                    frame.style.display = 'block';
                    frame.src = url;

                    // Show fallback link for YouTube videos
                    if (isYouTube) {
                        fallbackDiv.style.display = 'block';
                        fallbackLink.href = originalUrl;
                    } else {
                        fallbackDiv.style.display = 'none';
                    }

                    modal.classList.add('active');
                }
            }

            closeCalmDownActivity() {
                const modal = document.getElementById('calmDownModal');
                const frame = document.getElementById('calmDownFrame');
                frame.src = ''; // Clear iframe
                modal.classList.remove('active');
            }
        }

        // Add cache-busting to all images on page load
        function addCacheBustingToImages() {
            const timestamp = new Date().getTime();
            const logo = document.getElementById('appLogo');
            if (logo && logo.src) {
                const logoSrc = logo.src.split('?')[0]; // Remove existing query params
                logo.src = logoSrc + '?t=' + timestamp;
            }
        }

        // Show Kid/Parent Page
        async function showKidPage(kidId, isParentMode) {
            try {
                const doc = await db.collection('kids').doc(kidId).get();
                if (!doc.exists) {
                    document.getElementById('loadingState').textContent = '×™×œ×“ ×œ× × ××¦×';
                    return;
                }

                const kidData = doc.data();

                // Use custom header label or default
                let headerLabel = kidData.headerLabel || `ğŸŒŸ ×”××©×™××•×ª ×©×œ [×©×] ğŸŒŸ`;
                // Replace [×©×] placeholder with actual name
                headerLabel = headerLabel.replace(/\[×©×\]/g, kidData.name);
                document.getElementById('kidTitle').textContent = headerLabel;

                // Use custom savings label or default
                let savingsLabel = kidData.savingsLabel || `×§×•×¤×ª ×”×—×™×¡×›×•×Ÿ ×©×œ [×©×]`;
                // Replace [×©×] placeholder with actual name
                savingsLabel = savingsLabel.replace(/\[×©×\]/g, kidData.name);
                document.getElementById('moneyLabel').textContent = savingsLabel;

                // Set kid image (with cache-busting timestamp for file paths only)
                const kidImage = document.getElementById('kidImage');
                const imageSrc = kidData.imageName || 'me-default-small.jpg';
                // Don't add timestamp to data URLs (breaks them), only to file paths
                if (imageSrc.startsWith('data:')) {
                    kidImage.src = imageSrc;
                } else {
                    kidImage.src = imageSrc + '?t=' + new Date().getTime();
                }
                kidImage.alt = kidData.name;

                // Set section headers (or hide if empty)
                const regularHeader = document.getElementById('regularTasksHeader');
                const regularHeaderText = kidData.regularTasksHeader !== undefined ? kidData.regularTasksHeader : '××©×™××•×ª ×¨×’×™×œ×•×ª';
                if (regularHeaderText.trim() === '') {
                    regularHeader.style.display = 'none';
                } else {
                    regularHeader.style.display = 'block';
                    regularHeader.textContent = regularHeaderText;
                }

                const bonusHeader = document.getElementById('bonusTasksHeader');
                const bonusHeaderText = kidData.bonusTasksHeader !== undefined ? kidData.bonusTasksHeader : 'ğŸ’° ××©×™××•×ª ×‘×•× ×•×¡ ğŸ’°';
                if (bonusHeaderText.trim() === '') {
                    bonusHeader.style.display = 'none';
                } else {
                    bonusHeader.style.display = 'block';
                    bonusHeader.textContent = bonusHeaderText;
                }

                const calmDownHeader = document.getElementById('calmDownHeader');
                const calmDownHeaderText = kidData.calmDownHeader !== undefined ? kidData.calmDownHeader : 'ğŸ§˜ ×¤×™× ×ª ×”×”×¨×’×¢×” ğŸ§˜';
                if (calmDownHeaderText.trim() === '') {
                    calmDownHeader.style.display = 'none';
                } else {
                    calmDownHeader.style.display = 'block';
                    calmDownHeader.textContent = calmDownHeaderText;
                }

                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('kidPage').classList.remove('hidden');

                // Add cache-busting to images
                addCacheBustingToImages();

                window.taskBoard = new TaskBoard(kidId, kidData, isParentMode);
            } catch (error) {
                console.error('Error loading kid page:', error);
                document.getElementById('loadingState').textContent = '×©×’×™××” ×‘×˜×¢×™× ×”';
            }
        }
    </script>
</body>
</html>
